<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function r(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===I&&!!pe[e.nodeName]}function o(e){switch(e.nodeType){case F:return me;case I:case M:if(le&&Ne.has(e))return Ne.get(e);break;default:return ge}var t;return t=r(e.childNodes,a)?ue.test(e.nodeName)?me:ve:Ce,le&&Ne.set(e,t),t}function a(e){return o(e)===me}function s(e){return o(e)===ve}function d(e){return o(e)===Ce}function l(e,t){var r=new n(t,H,s);return r.currentNode=e,r}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function f(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function u(e,t,n){if(e.nodeName!==t)return!1;for(var r in n)if("class"===r){if(!e.getAttribute(r).includes(n[r]))return!1}else if(e.getAttribute(r)!==n[r])return!1;return!0}function p(e,t,n,r){for(;e&&e!==t;){if(u(e,n,r))return e;e=e.parentNode}return null}function g(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function m(e,t){var n,r,i,o,a="";return e&&e!==t&&(a=m(e.parentNode,t),e.nodeType===I&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(r=e.className.trim())&&(i=r.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(o=e.dir)&&(a+="[dir="+o+"]"),i&&(he.call(i,W)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),he.call(i,q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),he.call(i,z)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),he.call(i,K)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function v(e){return e.nodeType===I?e.childNodes.length:e.length||0}function C(e){var t=e.parentNode;return t&&t.removeChild(e),e}function N(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function _(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,r=n?n.length:0;r--;)t.appendChild(e.firstChild);return t}function S(e,n,r,i){var o,a,s,d=e.createElement(n);if(r instanceof Array&&(i=r,r=null),r)for(o in r)r[o]!==t&&d.setAttribute(o,r[o]);if(i)for(a=0,s=i.length;a<s;a+=1)d.appendChild(i[a]);return d}function y(e,t){var n,r,o=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((r=e.firstChild)&&"BR"!==r.nodeName||(n=o.createDefaultBlock(),r?e.replaceChild(n,r):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(r=e.firstChild;ae&&r&&r.nodeType===F&&!r.data;)e.removeChild(r),r=e.firstChild;r||(ae?(n=s.createTextNode(G),o._didAddZWS()):n=s.createTextNode(""))}else if(oe){for(;e.nodeType!==F&&!i(e);){if(!(r=e.firstChild)){n=s.createTextNode("");break}e=r}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=S(s,"BR");(r=e.lastElementChild)&&!a(r);)e=r;if(n)try{e.appendChild(n)}catch(t){o.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function T(e,t){var n,r,i,o,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,r=s.length;n<r;n+=1)i=s[n],o="BR"===i.nodeName,!o&&a(i)?(c||(c=S(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,r-=1):(o||c)&&(c||(c=S(l,h.blockTag,h.blockAttributes)),y(c,t),o?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,r+=1),c=null),d(i)&&T(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,r){var i,o,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,r);if(s===I){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,o=e.cloneNode(!1);t;)a=t.nextSibling,o.appendChild(t),t=a;return"OL"===e.nodeName&&p(e,r,"BLOCKQUOTE")&&(o.start=(+e.start||1)+e.childNodes.length-1),y(e,r),y(o,r),(a=e.nextSibling)?i.insertBefore(o,a):i.appendChild(o),b(i,o,n,r)}return t}function E(e,t){for(var n,r,i,o=e.childNodes,s=o.length,d=[];s--;)if(n=o[s],r=s&&o[s-1],s&&a(n)&&f(n,r)&&!pe[n.nodeName])t.startContainer===n&&(t.startContainer=r,t.startOffset+=v(r)),t.endContainer===n&&(t.endContainer=r,t.endOffset+=v(r)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=r,t.startOffset=v(r))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=r,t.endOffset=v(r))),C(n),n.nodeType===F?r.appendData(n.data):d.push(_(n));else if(n.nodeType===I){for(i=d.length;i--;)n.appendChild(d.pop());E(n,t)}}function k(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===I){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};E(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function x(e,t,n){for(var r,i,o=t;1===o.parentNode.childNodes.length;)o=o.parentNode;C(o),i=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),i-=1),e.appendChild(_(t)),n.setStart(e,i),n.collapse(!0),k(e,n),ee&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function B(e,t){var n,r,i=e.previousSibling,o=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||o&&/^[OU]L$/.test(o.nodeName))if(i&&f(i,e)){if(!d(i)){if(!s)return;r=S(a,"DIV"),r.appendChild(_(i)),i.appendChild(r)}C(e),n=!d(e),i.appendChild(_(e)),n&&T(i,t),o&&B(o,t)}else s&&(i=S(a,"DIV"),e.insertBefore(i,o),y(i,t))}function L(e){this.isShiftDown=e.shiftKey}function A(e,t,n){var r,i;if(e||(e={}),t)for(r in t)!n&&r in e||(i=t[r],e[r]=i&&i.constructor===Object?A(e[r],i,n):i);return e}function O(e,t){e.nodeType===w&&(e=e.body);var n,r=e.ownerDocument,i=r.defaultView;this._win=i,this._doc=r,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,se&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in r?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,de?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",R),this.addEventListener("mousedown",D),this.addEventListener("touchstart",D),this.addEventListener("focus",P),this._awaitingPaste=!1,t&&t.disableCopyPaste||(this.addEventListener(J?"beforecut":"cut",tt),this.addEventListener("copy",nt),this.addEventListener(J?"beforepaste":"paste",rt)),this.addEventListener("keydown",L),this.addEventListener("keyup",L),this.addEventListener("drop",it),this.addEventListener(ee?"keypress":"keydown",Ie),this._keyHandlers=Object.create(He),this.setConfig(t),J&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,r=this.parentNode,i=this.length-e;return n?r.insertBefore(t,n):r.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{r.execCommand("enableObjectResizing",!1,"false"),r.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function R(){this._restoreSelection=!0}function D(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function U(e,t,n){var r,i;for(r=t.firstChild;r;r=i){if(i=r.nextSibling,a(r)){if(r.nodeType===F||"BR"===r.nodeName||"IMG"===r.nodeName){n.appendChild(r);continue}}else if(s(r)){n.appendChild(e.createDefaultBlock([U(e,r,e._doc.createDocumentFragment())]));continue}U(e,r,n)}return n}var I=1,F=3,w=9,M=11,H=1,W="highlight",q="colour",z="font",K="size",G="\ufeff",Z=e.defaultView,j=navigator.userAgent,Q=/Android/.test(j),V=/iP(?:ad|hone|od)/.test(j),$=/Mac OS X/.test(j),Y=/Windows NT/.test(j),X=/Gecko\//.test(j),J=/Trident\/[456]\./.test(j),ee=!!Z.opera,te=/Edge\//.test(j),ne=!te&&/WebKit\//.test(j),re=/Trident\/[4567]\./.test(j),ie=$?"meta-":"ctrl-",oe=J||ee,ae=J||ne,se=J,de="undefined"!=typeof MutationObserver,le="undefined"!=typeof WeakMap,ce=/[^ \t\r\n]/,he=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var fe={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,r=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(fe[e.nodeType]&r&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,r=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(fe[e.nodeType]&r&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,r=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(fe[e.nodeType]&r&&i(e))return this.currentNode=e,e;t=e}};var ue=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,pe={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},ge=0,me=1,ve=2,Ce=3,Ne=le?new WeakMap:null,_e=function(e,t){for(var n=e.childNodes;t&&e.nodeType===I;)e=n[t-1],n=e.childNodes,t=n.length;return e},Se=function(e,t){if(e.nodeType===I){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},ye=function(e,t){var n,r,i,o,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,r=n.childNodes,s===a.length?(s=he.call(r,a)+1,e.collapsed&&(d=n,l=s)):(s&&(o=a.splitText(s),d===a?(l-=s,d=o):d===n&&(l+=1),a=o),s=he.call(r,a)),a=n):r=a.childNodes,i=r.length,s===i?a.appendChild(t):a.insertBefore(t,r[s]),a===d&&(l+=r.length-i),e.setStart(a,s),e.setEnd(d,l)},Te=function(e,t,n){var r=e.startContainer,i=e.startOffset,o=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(o,a,t,n),h=b(r,i,t,n),f=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,f.appendChild(h),h=s;return r=t,i=c?he.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(r=d,i=d.length,d.appendData(l.data),C(l)),e.setStart(r,i),e.collapse(!0),y(t,n),f},be=function(e,t){var n,r,i=Le(e,t),o=Ae(e,t),a=i!==o;return xe(e),Be(e,i,o,t),n=Te(e,null,t),xe(e),a&&(o=Ae(e,t),i&&o&&i!==o&&x(i,o,e)),i&&y(i,t),r=t.firstChild,r&&"BR"!==r.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},Ee=function(e,t,n){for(var r=!0,i=t.childNodes,o=i.length;o--;)if(!a(i[o])){r=!1;break}if(e.collapsed||be(e,n),xe(e),r)ye(e,t),e.startContainer!==e.endContainer&&k(e.endContainer,e),k(e.startContainer,e),e.collapse(!1);else{for(var l,f,u,g,m,v=e.startContainer,C=b(v,e.startOffset,p(v.parentNode,n,"BLOCKQUOTE")||n,n),N=C.previousSibling,_=N,S=_.childNodes.length,T=C,E=0,x=C.parentNode;(l=_.lastChild)&&l.nodeType===I;){if("BR"===l.nodeName){S-=1;break}_=l,S=_.childNodes.length}for(;(l=T.firstChild)&&l.nodeType===I&&"BR"!==l.nodeName;)T=l;for(m=_.childNodes[S]||null;(l=t.firstChild)&&a(l);)_.insertBefore(l,m);for(;(l=t.lastChild)&&a(l);)T.insertBefore(l,T.firstChild),E+=1;for(f=t;f=h(f,n);)y(f,n);if(x.insertBefore(t,C),g=N.nextSibling,(f=c(g,n))&&!/\S/.test(f.textContent))do{x=f.parentNode,x.removeChild(f),f=x}while(f&&!f.lastChild&&f!==n);if(N.parentNode||(N=g.previousSibling),_.parentNode||(_=N||g.parentNode,S=N?N.childNodes.length:0),d(g)&&B(g,n),u=C.previousSibling,(f=s(C)?C:h(C,n))&&!/\S/.test(f.textContent))do{x=f.parentNode,x.removeChild(f),f=x}while(f&&!f.lastChild&&f!==n);C.parentNode||(C=u.nextSibling),E||(T=u,E=u.childNodes.length),C&&d(C)&&B(C,n),e.setStart(_,S),e.setEnd(T,E),xe(e)}},ke=function(e,t,n){var r=t.ownerDocument.createRange();if(r.selectNode(t),n){var i=e.compareBoundaryPoints(3,r)>-1,o=e.compareBoundaryPoints(1,r)<1;return!i&&!o}var a=e.compareBoundaryPoints(0,r)<1,s=e.compareBoundaryPoints(2,r)>-1;return a&&s},xe=function(e){for(var t,n=e.startContainer,r=e.startOffset,o=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[r])&&!i(t);)n=t,r=0;if(a)for(;o.nodeType!==F;){if(!(t=o.childNodes[a-1])||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}o=t,a=v(o)}else for(;o.nodeType!==F&&(t=o.firstChild)&&!i(t);)o=t;e.collapsed?(e.setStart(o,a),e.setEnd(n,r)):(e.setStart(n,r),e.setEnd(o,a))},Be=function(e,t,n,r){var i,o=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&o!==t&&o!==r;)i=o.parentNode,a=he.call(i.childNodes,o),o=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===r||d!==v(s))break;i=s.parentNode,d=he.call(i.childNodes,s)+1,s=i}e.setStart(o,a),e.setEnd(s,d)},Le=function(e,t){var n,r=e.startContainer;return a(r)?n=c(r,t):r!==t&&s(r)?n=r:(n=_e(r,e.startOffset),n=h(n,t)),n&&ke(e,n,!0)?n:null},Ae=function(e,t){var n,r,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(!(n=Se(i,e.endOffset))||!g(t,n))for(n=t;r=n.lastChild;)n=r;n=c(n,t)}return n&&ke(e,n,!0)?n:null},Oe=new n(null,4|H,function(e){return e.nodeType===F?ce.test(e.data):"IMG"===e.nodeName}),Re=function(e,t){var n,r=e.startContainer,i=e.startOffset;if(Oe.root=null,r.nodeType===F){if(i)return!1;n=r}else if(n=Se(r,i),n&&!g(t,n)&&(n=null),!n&&(n=_e(r,i),n.nodeType===F&&n.length))return!1;return Oe.currentNode=n,Oe.root=Le(e,t),!Oe.previousNode()},De=function(e,t){var n,r=e.endContainer,i=e.endOffset;if(Oe.root=null,r.nodeType===F){if((n=r.data.length)&&i<n)return!1;Oe.currentNode=r}else Oe.currentNode=_e(r,i);return Oe.root=Ae(e,t),!Oe.nextNode()},Pe=function(e,t){var n,r=Le(e,t),i=Ae(e,t);r&&i&&(n=r.parentNode,e.setStart(n,he.call(n.childNodes,r)),n=i.parentNode,e.setEnd(n,he.call(n.childNodes,i)+1))},Ue={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},Ie=function(e){var t=e.keyCode,n=Ue[t],r="",i=this.getSelection();if(!e.defaultPrevented)if(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),ee&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(r+="alt-"),e.ctrlKey&&(r+="ctrl-"),e.metaKey&&(r+="meta-")),e.shiftKey&&(r+="shift-"),n=r+n,this._keyHandlers[n])this._keyHandlers[n](this,e,i);else if(1===n.length&&!i.collapsed){var o=i.startOffset;this.saveUndoState(i),be(i,this._root),this._ensureBottomLine();var a=i.startContainer.textContent,s=i.startOffset;i.startContainer===i.endContainer&&" "===a.charAt(s)&&" "===a.charAt(s-1)&&(i.startContainer.textContent=a.substring(0,s)+"\ufeff"+a.substring(s,a.length),i.setStart(i.startContainer,o),i.setEnd(i.startContainer,o+1)),this.setSelection(i),this._updatePath(i,!0)}},Fe=function(e){return function(t,n){n.preventDefault(),t[e]()}},we=function(e,t){return t=t||null,function(n,r){r.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Me=function(e,t){try{t||(t=e.getSelection());var n,r=t.startContainer;for(r.nodeType===F&&(r=r.parentNode),n=r;a(n)&&(!n.textContent||n.textContent===G);)r=n,n=r.parentNode;r!==n&&(t.setStart(n,he.call(n.childNodes,r)),t.collapse(!0),n.removeChild(r),s(n)||(n=c(n,e._root)),y(n,e._root),xe(t)),r===e._root&&(r=r.firstChild)&&"BR"===r.nodeName&&C(r),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},He={enter:function(e,t,n){var r,i,o,a=e._root;if(t.preventDefault(),e._recordUndoState(n),kt(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||be(n,a),!(r=Le(n,a))||/^T[HD]$/.test(r.nodeName))return ye(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if(i=p(r,a,"LI")){var s=i.firstChild;r=s&&"PRE"==s.tagName?r:i}if(!r.textContent||" "==r.textContent){if(p(r,a,"PRE"))return r.textContent=r.textContent.replace(" ","",1),e.modifyBlocks(bt,n);if(p(r,a,"UL")||p(r,a,"OL"))return e.modifyBlocks(Tt,n);if(p(r,a,"BLOCKQUOTE"))return e.modifyBlocks(gt,n)}for(o=ft(e,r,n.startContainer,n.startOffset),lt(r),$e(r),y(r,a);o.nodeType===I;){var d,s=o.firstChild;if("A"===o.nodeName&&(!o.textContent||o.textContent===G)){s=e._doc.createTextNode(""),N(o,s),o=s;break}for(;s&&s.nodeType===F&&!s.data&&(d=s.nextSibling)&&"BR"!==d.nodeName;)C(s),s=d;if(!s||"BR"===s.nodeName||s.nodeType===F&&!ee)break;o=s}n=e._createRange(o,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var r=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(0!=n.endOffset&&e.hasFormat("b",null,n)||e.hasFormat("i",null,n)||e.hasFormat("u",null,n)||e.hasFormat("span",null,n)){var i=Le(n,r);i&&i.firstChild.innerText&&1==v(i.firstChild.innerText.replace(/^\uFEFF*/,""))&&(t.preventDefault(),i.firstChild.innerText="",ye(n,e._doc.createTextNode(G)))}else if(Re(n,r)){t.preventDefault();var o,i=Le(n,r);if(!i)return;if(T(i.parentNode,r),o=c(i,r)){if(!o.isContentEditable)return void C(o);for(x(o,i,n),i=o.parentNode;i!==r&&!i.nextSibling;)i=i.parentNode;i!==r&&(i=i.nextSibling)&&B(i,r),e.setSelection(n)}else if(i){if(p(i,r,"PRE"))return e.modifyBlocks(bt,n);if(p(i,r,"UL")||p(i,r,"OL"))return e.modifyBlocks(Tt,n);if(p(i,r,"BLOCKQUOTE"))return e.modifyBlocks(pt,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Me(e)},0);else t.preventDefault(),be(n,r),Me(e,n)},delete:function(e,t,n){var r,i,o,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(e.hasFormat("b",null,n)||e.hasFormat("i",null,n)||e.hasFormat("u",null,n)||e.hasFormat("span",null,n)){var r=Le(n,l);r&&r.firstChild.innerText&&1==v(r.firstChild.innerText.replace(/^\uFEFF*/,""))&&(t.preventDefault(),r.firstChild.innerText="",ye(n,e._doc.createTextNode(G)))}else if(De(n,l)){if(t.preventDefault(),!(r=Le(n,l)))return;if(T(r.parentNode,l),i=h(r,l)){if(!i.isContentEditable)return void C(i);for(x(r,i,n),i=r.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&B(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(o=n.cloneRange(),Be(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===I&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),C(d),xe(n),void Me(e,n);e.setSelection(o),setTimeout(function(){Me(e)},0)}else t.preventDefault(),be(n,l),Me(e,n)},tab:function(e,t,n){var r,i,o=e._root;if(e._removeZWS(),n.collapsed&&Re(n,o))for(r=Le(n,o);i=r.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.modifyBlocks(yt,n);break}r=i}},"shift-tab":function(e,t,n){var r,i=e._root;e._removeZWS(),n.collapsed&&Re(n,i)&&(r=n.startContainer,(p(r,i,"UL")||p(r,i,"OL"))&&(t.preventDefault(),e.modifyBlocks(Tt,n)))},space:function(e,t,n){var r,i;e._recordUndoState(n),kt(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),r=n.endContainer,i=r.parentNode,n.collapsed&&"A"===i.nodeName&&!r.nextSibling&&n.endOffset===v(r)?n.setStartAfter(i):n.collapsed||(be(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};$&&X&&(He["meta-left"]=function(e,t){t.preventDefault();var n=dt(e);n&&n.modify&&n.modify("move","backward","lineboundary")},He["meta-right"]=function(e,t){t.preventDefault();var n=dt(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),$||(He.pageup=function(e){e.moveCursorToStart()},He.pagedown=function(e){e.moveCursorToEnd()}),He[ie+"b"]=we("B"),He[ie+"i"]=we("I"),He[ie+"u"]=we("U"),He[ie+"shift-7"]=we("S"),He[ie+"shift-5"]=we("SUB",{tag:"SUP"}),He[ie+"shift-6"]=we("SUP",{tag:"SUB"}),He[ie+"shift-8"]=Fe("makeUnorderedList"),He[ie+"shift-9"]=Fe("makeOrderedList"),He[ie+"["]=Fe("decreaseQuoteLevel"),He[ie+"]"]=Fe("increaseQuoteLevel"),He[ie+"y"]=Fe("redo"),He[ie+"z"]=Fe("undo"),He[ie+"shift-z"]=Fe("redo");var We={1:10,2:13,3:16,4:18,5:24,6:32,7:48},qe={backgroundColor:{regexp:ce,replace:function(e,t){return S(e,"SPAN",{class:W,style:"background-color:"+t})}},color:{regexp:ce,replace:function(e,t){return S(e,"SPAN",{class:q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return S(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return S(e,"I")}},fontFamily:{regexp:ce,replace:function(e,t){return S(e,"SPAN",{class:z,style:"font-family:"+t})}},fontSize:{regexp:ce,replace:function(e,t){return S(e,"SPAN",{class:K,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return S(e,"U")}}},ze=function(e){return function(t,n){var r=S(t.ownerDocument,e);return n.replaceChild(r,t),r.appendChild(_(t)),r}},Ke=function(e,t){var n,r,i,o,a,s,d=e.style,l=e.ownerDocument;for(n in qe)r=qe[n],(i=d[n])&&r.regexp.test(i)&&(s=r.replace(l,i),a||(a=s),o&&o.appendChild(s),o=s,e.style[n]="");return a&&(o.appendChild(_(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),o||e},Ge={P:Ke,SPAN:Ke,STRONG:ze("B"),EM:ze("I"),INS:ze("U"),STRIKE:ze("S"),FONT:function(e,t){var n,r,i,o,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=S(c,"SPAN",{class:z,style:"font-family:"+s}),a=n,o=n),d&&(r=S(c,"SPAN",{class:K,style:"font-size:"+We[d]+"px"}),a||(a=r),o&&o.appendChild(r),o=r),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=S(c,"SPAN",{class:q,style:"color:"+l}),a||(a=i),o&&o.appendChild(i),o=i),a||(a=o=S(c,"SPAN")),t.replaceChild(a,e),o.appendChild(_(e)),o},TT:function(e,t){var n=S(e.ownerDocument,"SPAN",{class:z,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(_(e)),n}},Ze=/^(?:A(?:|DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,je=/^(?:HEAD|META|STYLE)/,Qe=new n(null,4|H,function(){return!0}),Ve=function e(t,n){var r,i,o,s,d,l,c,h,f,u,p,g,m=t.childNodes;for(r=t;a(r);)r=r.parentNode;for(Qe.root=r,i=0,o=m.length;i<o;i+=1)if(s=m[i],d=s.nodeName,l=s.nodeType,c=Ge[d],l===I){if(h=s.childNodes.length,c)s=c(s,t);else{if(je.test(d)){t.removeChild(s),i-=1,o-=1;continue}if(!Ze.test(d)&&!a(s)){i-=1,o+=h-1,t.replaceChild(_(s),s);continue}}h&&e(s,n||"PRE"===d)}else{if(l===F){if(p=s.data,f=!ce.test(p.charAt(0)),u=!ce.test(p.charAt(p.length-1)),n||!f&&!u)continue;if(f){for(Qe.currentNode=s;(g=Qe.previousPONode())&&!("IMG"===(d=g.nodeName)||"#text"===d&&ce.test(g.data));)if(!a(g)){g=null;break}p=p.replace(/^[ \t\r\n]+/g,g?" ":"")}if(u){for(Qe.currentNode=s;(g=Qe.nextNode())&&!("IMG"===d||"#text"===d&&ce.test(g.data));)if(!a(g)){g=null;break}p=p.replace(/[ \t\r\n]+$/g,g?" ":"")}if(p){s.data=p;continue}}t.removeChild(s),i-=1,o-=1}return t},$e=function e(t){for(var n,r=t.childNodes,o=r.length;o--;)n=r[o],n.nodeType!==I||i(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},Ye=function(e){return e.nodeType===I?"BR"===e.nodeName:ce.test(e.data)},Xe=function(e,t){for(var r,i=e.parentNode;a(i);)i=i.parentNode;return r=new n(i,4|H,Ye),r.currentNode=e,!!r.nextNode()||t&&!r.previousNode()},Je=function(e,t,n){var r,i,o,s=e.querySelectorAll("BR"),d=[],l=s.length;for(r=0;r<l;r+=1)d[r]=Xe(s[r],n);for(;l--;)i=s[l],(o=i.parentNode)&&(d[l]?a(o)||T(o,t):C(i))},et=function(e,t,n){var r,i,o=t.ownerDocument.body;Je(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),o.appendChild(t),r=t.innerHTML,i=t.innerText||t.textContent,Y&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",r),e.setData("text/plain",i),o.removeChild(t)},tt=function(e){var t,n,r,i,o,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),te||V||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Le(l,c),n=Ae(l,c),r=t===n&&t||c,i=be(l,c),o=l.commonAncestorContainer,o.nodeType===F&&(o=o.parentNode);o&&o!==r;)a=o.cloneNode(!1),a.appendChild(i),i=a,o=o.parentNode;s=this.createElement("div"),s.appendChild(i),et(d,s,c),e.preventDefault()}this.setSelection(l)},nt=function(e){var t,n,r,i,o,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!te&&!V&&d){for(t=Le(l,c),n=Ae(l,c),r=t===n&&t||c,l=l.cloneRange(),xe(l),Be(l,r,r,c),i=l.cloneContents(),o=l.commonAncestorContainer,o.nodeType===F&&(o=o.parentNode);o&&o!==r;)a=o.cloneNode(!1),a.appendChild(i),i=a,o=o.parentNode;s=this.createElement("div"),s.appendChild(i),et(d,s,c),e.preventDefault()}},rt=function(e){var t,n,r,i,o,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,f=this;if(!te&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],r=n.type,!d&&"text/html"===r)return void n.getAsString(function(e){f.insertHTML(e,!0)});"text/plain"===r&&(h=n),!d&&/^image\/.*/.test(r)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){f.insertPlainText(e,!0)}))}if(i=a&&a.types,!te&&i&&(he.call(i,"text/html")>-1||!X&&he.call(i,"text/plain")>-1&&he.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(o=a.getData("text/html"))?this.insertHTML(o,!0):((o=a.getData("text/plain"))||(o=a.getData("text/uri-list")))&&this.insertPlainText(o,!0));this._awaitingPaste=!0;var u=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,N=p.endOffset,_=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});u.appendChild(_),p.selectNodeContents(_),this.setSelection(p),setTimeout(function(){try{f._awaitingPaste=!1;for(var e,t,n="",r=_;_=r;)r=_.nextSibling,C(_),e=_.firstChild,e&&e===_.lastChild&&"DIV"===e.nodeName&&(_=e),n+=_.innerHTML;t=f._createRange(g,m,v,N),f.setSelection(t),n&&f.insertHTML(n,!0)}catch(e){f.didError(e)}},0)},it=function(e){for(var t=e.dataTransfer.types,n=t.length,r=!1,i=!1;n--;)switch(t[n]){case"text/plain":r=!0;break;case"text/html":i=!0;break;default:return}(i||r)&&this.saveUndoState()},ot=O.prototype,at=function(e,t,n){var r=n._doc,i=e?DOMPurify.sanitize(e,{WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?r.importNode(i,!0):r.createDocumentFragment()};ot.setConfig=function(e){return e=A({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null,pre:null},leafNodeNames:pe,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?at:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},ot.createElement=function(e,t,n){return S(this._doc,e,t,n)},ot.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},ot.didError=function(e){console.log(e)},ot.getDocument=function(){return this._doc},ot.getRoot=function(){return this._root},ot.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var st={pathChange:1,select:1,input:1,undoStateChange:1};ot.fireEvent=function(e,t){var n,r,i,o=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=g(this._root,this._doc.activeElement),"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(o)for(t||(t={}),t.type!==e&&(t.type=e),o=o.slice(),r=o.length;r--;){i=o[r];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},ot.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},ot.handleEvent=function(e){this.fireEvent(e.type,e)},ot.addEventListener=function(e,t){var n=this._events[e],r=this._root;return t?(n||(n=this._events[e]=[],st[e]||("selectionchange"===e&&(r=this._doc),r.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},ot.removeEventListener=function(e,t){var n,r=this._events[e],i=this._root;if(r){if(t)for(n=r.length;n--;)r[n]===t&&r.splice(n,1);else r.length=0;r.length||(delete this._events[e],st[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},ot._createRange=function(e,t,n,r){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,r):i.setEnd(e,t),i},ot.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,r=e.getBoundingClientRect();return r&&!r.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=G,ye(e,t),r=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),k(n,e)),r},ot._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return xe(n),this.setSelection(n),this},ot.moveCursorToStart=function(){return this._moveCursorTo(!0)},ot.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var dt=function(e){return e._win.getSelection()||null};ot.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(Q&&!this._restoreSelection)R.call(this),this.blur(),this.focus();else{V&&this._win.focus();var t=dt(this);t&&(t.removeAllRanges(),t.addRange(e))}else R.call(this);return this},ot.getSelection=function(){var e,t,n,r=dt(this),o=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&g(o,e.commonAncestorContainer)?this._lastSelection=e:e=this._lastSelection,e||(e=this._createRange(o.firstChild,0)),e},ot.getSelectedText=function(){var e,t=this.getSelection(),r=new n(t.commonAncestorContainer,4|H,function(e){return ke(t,e,!0)}),i=t.startContainer,o=t.endContainer,s=r.currentNode=i,d="",l=!1;for(r.filter(s)||(s=r.nextNode());s;)s.nodeType===F?(e=s.data)&&/\S/.test(e)&&(s===o&&(e=e.slice(0,t.endOffset)),s===i&&(e=e.slice(t.startOffset)),d+=e,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=r.nextNode();return d},ot.getPath=function(){return this._path};var lt=function(e,t){for(var r,i,o,s=new n(e,4,function(){return!0},!1);i=s.nextNode();)for(;(o=i.data.indexOf(G))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do{r=i.parentNode,r.removeChild(i),i=r,s.currentNode=r}while(a(i)&&!v(i));break}i.deleteData(o,1)}};ot._didAddZWS=function(){this._hasZWS=!0},ot._removeZWS=function(){this._hasZWS&&(lt(this._root),this._hasZWS=!1)},ot._updatePath=function(e,t){var n,r=e.startContainer,i=e.endContainer;(t||r!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=r,this._lastFocusNode=i,n=r&&i?r===i?m(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),e.collapsed||this.fireEvent("select")},ot._updatePathOnEvent=function(){var e=this;e._willUpdatePath||(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))},ot.focus=function(){return this._root.focus(),re&&this.fireEvent("focus"),this},ot.blur=function(){return this._root.blur(),re&&this.fireEvent("blur"),this};var ct="squire-selection-end";ot._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{
id:"squire-selection-start",type:"hidden"}),r=this.createElement("INPUT",{id:ct,type:"hidden"});ye(e,n),e.collapse(!1),ye(e,r),2&n.compareDocumentPosition(r)&&(n.id=ct,r.id="squire-selection-start",t=n,n=r,r=t),e.setStartAfter(n),e.setEndBefore(r)},ot._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),r=t.querySelector("#"+ct);if(n&&r){var i=n.parentNode,o=r.parentNode,a=he.call(i.childNodes,n),s=he.call(o.childNodes,r);i===o&&(s-=1),C(n),C(r),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(o,s),k(i,e),i!==o&&k(o,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(o=i.childNodes[e.startOffset],o&&o.nodeType===F||(o=i.childNodes[e.startOffset-1]),o&&o.nodeType===F&&(e.setStart(o,0),e.collapse(!0))))}return e||null},ot._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},ot._docWasChanged=function(){if(le&&(Ne=new WeakMap),!this._ignoreAllChanges){if(de&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},ot._recordUndoState=function(e){if(!this._isInUndoState){var t,n=this._undoIndex+=1,r=this._undoStack,i=this._config.undo,o=i.documentSizeThreshold,a=i.undoLimit;n<this._undoStackLength&&(r.length=this._undoStackLength=n),e&&this._saveRangeToBookmark(e),t=this._getHTML(),o>-1&&2*t.length>o&&a>-1&&n>a&&(r.splice(0,n-a),n=this._undoIndex=a,this._undoStackLength=a),r[n]=t,this._undoStackLength+=1,this._isInUndoState=!0}},ot.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e),this._getRangeAndRemoveBookmark(e)),this},ot.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},ot.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},ot.hasFormat=function(e,t,r){if(e=e.toUpperCase(),t||(t={}),!r&&!(r=this.getSelection()))return!1;!r.collapsed&&r.startContainer.nodeType===F&&r.startOffset===r.startContainer.length&&r.startContainer.nextSibling&&r.setStartBefore(r.startContainer.nextSibling),!r.collapsed&&r.endContainer.nodeType===F&&0===r.endOffset&&r.endContainer.previousSibling&&r.setEndAfter(r.endContainer.previousSibling);var i,o,a=this._root,s=r.commonAncestorContainer;if(p(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,4,function(e){return ke(r,e,!0)},!1);for(var d=!1;o=i.nextNode();){if(!p(o,a,e,t))return!1;d=!0}return d},ot.getFontInfo=function(e){var n,r,i,o={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return o;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(r=n.style)&&(!o.color&&(i=r.color)&&(o.color=i,a+=1),!o.backgroundColor&&(i=r.backgroundColor)&&(o.backgroundColor=i,a+=1),!o.family&&(i=r.fontFamily)&&(o.family=i,a+=1),!o.size&&(i=r.fontSize)&&(o.size=i,a+=1)),n=n.parentNode;return o},ot._addFormat=function(e,t,r){var i,o,s,d,l,c,h,f,u=this._root;if(r.collapsed){for(i=y(this.createElement(e,t),u),ye(r,i),r.setStart(i.firstChild,i.firstChild.length),r.collapse(!0),f=i;a(f);)f=f.parentNode;lt(f,i)}else{if(o=new n(r.commonAncestorContainer,4|H,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&ke(r,e,!0)},!1),s=r.startContainer,l=r.startOffset,d=r.endContainer,c=r.endOffset,o.currentNode=s,o.filter(s)||(s=o.nextNode(),l=0),!s)return r;do{h=o.currentNode,!p(h,u,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),N(h,i),i.appendChild(h))}while(o.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),r=this._createRange(s,l,d,c)}return r},ot._removeFormat=function(e,t,n,r){this._saveRangeToBookmark(n);var i,o=this._doc;n.collapsed&&(ae?(i=o.createTextNode(G),this._didAddZWS()):i=o.createTextNode(""),ye(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,f=[],p=function(e,t){if(!ke(n,e,!1)){var r,i,o=e.nodeType===F;if(!ke(n,e,!0))return void("INPUT"===e.nodeName||o&&!e.data||f.push([t,e]));if(o)e===c&&h!==e.length&&f.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),f.push([t,e]));else for(r=e.firstChild;r;r=i)i=r.nextSibling,p(r,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(r){return ke(n,r,!0)&&u(r,e,t)});return r||g.forEach(function(e){p(e,e)}),f.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];N(n,t),t.appendChild(n)}),g.forEach(function(e){N(e,_(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),k(s,n),n},ot.changeFormat=function(e,t,n,r){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,r)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),de||this._docWasChanged(),this):this};var ht={DT:"DD",DD:"DT",LI:"LI"},ft=function(e,t,n,r){var i=ht[t.nodeName],o=null,a=b(n,r,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,o=s.blockAttributes),u(a,i,o)||(t=S(a.ownerDocument,i,o),a.dir&&(t.dir=a.dir),N(a,t),t.appendChild(_(a)),a=t),a};ot.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var r=this._root,i=Le(n,r),o=Ae(n,r);if(i&&o)do{if(e(i)||i===o)break}while(i=h(i,r));return t&&(this.setSelection(n),this._updatePath(n,!0),de||this._docWasChanged()),this},ot.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(t):this._recordUndoState(t);var n,r=this._root;return Pe(t,r),Be(t,r,r,r),n=Te(t,r,r),ye(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&B(t.endContainer.childNodes[t.endOffset],r),B(t.startContainer.childNodes[t.startOffset],r),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),de||this._docWasChanged(),this};var ut=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},pt=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!p(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){N(e,_(e))}),e},gt=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:ct,type:"hidden"})])},mt=function(e,t,n){for(var r,i,o,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;r=s.nextNode();)"LI"===r.parentNode.nodeName&&(r=r.parentNode,s.currentNode=r.lastChild),"LI"!==r.nodeName?(a=e.createElement("LI",h),r.dir&&(a.dir=r.dir),(o=r.previousSibling)&&o.nodeName===n?(o.appendChild(a),C(r)):N(r,e.createElement(n,c,[a])),a.appendChild(_(r)),s.currentNode=a):(r=r.parentNode,(i=r.nodeName)!==n&&/^[OU]L$/.test(i)&&N(r,e.createElement(n,c,[_(r)])))},vt=function(e,t,n,r){for(var i,o,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=(e._config.blockTag.toLowerCase(),e._root);i=s.nextNode();)if("div"===i.parentNode.nodeName&&(i=i.parentNode,s.currentNode=i.lastChild),"div"!==i.nodeName){if(a=e.createElement("div"),i.dir&&(a.dir=i.dir),(o=i.previousSibling)&&o.nodeName===n)o.appendChild(a),C(i);else{var f=e.createElement(n,c,[a]);if(r&&(f.style.marginLeft=r),N(i,f),p(i,h,"LI")){var u=e.createElement("LI");f.parentNode.insertBefore(u,f),u.appendChild(f)}}a.appendChild(_(i)),s.currentNode=a}},Ct=function(e){return mt(this,e,"UL"),e},Nt=function(e){return vt(this,e,"PRE","20px"),e},_t=function(e){return mt(this,e,"OL"),e},St=function(e){var t,n,r,i,o,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)r=a[t],i=_(r),T(i,l),N(r,i);for(t=0,n=d.length;t<n;t+=1)o=d[t],s(o)?N(o,this.createDefaultBlock([_(o)])):(T(o,l),N(o,_(o)));return e},yt=function(e){var t,n,r,i,o,a,s=e.querySelectorAll("LI"),l=this._config.tagAttributes;for(t=0,n=s.length;t<n;t+=1)r=s[t],d(r.firstChild)||(i=r.parentNode.nodeName,o=r.previousSibling,o&&(o=o.lastChild)&&o.nodeName===i||(a=l[i.toLowerCase()],o=this.createElement(i,a),N(r,o)),o.appendChild(r));return e},Tt=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!d(e.firstChild)}).forEach(function(n){var r,i=n.parentNode,o=i.parentNode,a=n.firstChild,s=a;if(n.previousSibling&&(i=b(i,n,o,t)),/^[OU]L$/.test(o.nodeName))o.insertBefore(n,i),i.firstChild||o.removeChild(i);else for(;s&&(r=s.nextSibling,!d(s));)o.insertBefore(s,i),s=r;for("LI"===o.nodeName&&a.previousSibling&&b(o,a,o.parentNode,t);n!==e&&!n.childNodes.length;)i=n.parentNode,i.removeChild(n),n=i},this),T(e,t),e},bt=function(e){var t=this._root,n=e.querySelectorAll("div"),r=e.querySelectorAll("PRE");return 0==n.length&&1==r.length&&r[0].remove(),Array.prototype.filter.call(n,function(e){return!d(e.firstChild)}).forEach(function(n){var r,i=n.parentNode,o=i.parentNode,a=n.firstChild,s=a;if(n.previousSibling&&(i=b(i,n,o,t)),/^[OU]L$/.test(o.nodeName))o.insertBefore(n,i),i.firstChild||o.removeChild(i);else for(;s&&(r=s.nextSibling,!d(s));)o.insertBefore(s,i),s=r;for("div"===o.nodeName&&a.previousSibling&&b(o,a,o.parentNode,t);n!==e&&!n.childNodes.length;)i=n.parentNode,i.removeChild(n),n=i},this),T(e,t),e};ot._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},ot.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},ot._getHTML=function(){return this._root.innerHTML},ot._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{y(n,t)}while(n=h(n,t));this._ignoreChange=!0},ot.getHTML=function(e){var t,n,r,i,o,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),oe)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(r=this.createElement("BR"),n.appendChild(r),s.push(r));if(i=this._getHTML().replace(/\uFEFF/g,""),oe)for(o=s.length;o--;)C(s[o]);return a&&this._getRangeAndRemoveBookmark(a),i},ot.setHTML=function(e){var t,n,r,i=this._config,o=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof o?n=o(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(_(t))),Ve(n),Je(n,a,!1),T(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;r=a.lastChild;)a.removeChild(r);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,R.call(this),this._updatePath(d,!0),this},ot.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))ye(t,e),t.setStartAfter(e);else{for(var n,r,i=this._root,o=Le(t,i)||i;o!==i&&!o.nextSibling;)o=o.parentNode;o!==i&&(n=o.parentNode,r=b(n,o.nextSibling,i,i)),r?i.insertBefore(e,r):(i.appendChild(e),r=this.createDefaultBlock(),i.appendChild(r)),t.setStart(r,0),t.setEnd(r,0),xe(t)}return this.focus(),this.setSelection(t),this._updatePath(t),de||this._docWasChanged(),this},ot.insertImage=function(e,t){var n=this.createElement("IMG",A({src:e},t,!0));return this.insertElement(n),n};var Et=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,kt=function(e,t,r){for(var i,o,a,s,d,l,c,h=e.ownerDocument,f=new n(e,4,function(e){return!p(e,t,"A")},!1),u=r._config.tagAttributes.a;i=f.nextNode();)for(o=i.data,a=i.parentNode;s=r.matchLink(o);)d=s.index,l=d+s.original.length,d&&(c=h.createTextNode(o.slice(0,d)),a.insertBefore(c,i)),c=r.createElement("A",A({href:s.href},u,!1)),c.textContent=o.slice(d,l),a.insertBefore(c,i),i.data=o=o.slice(l)};ot.matchLink=function(e){var t=Et.exec(e);if(!t)return null;var n=t[1]?/^(?:ht|f)tps?:/.test(t[1])?t[1]:"http://"+t[1]:"mailto:"+t[2];return{index:t.index,original:t[0],href:n}},ot.insertHTML=function(e,t){var n,r,i,o,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,f=this.getSelection(),u=this._doc;"function"==typeof c?o=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),r=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&r>-1&&(e=e.slice(n+20,r))),i=this.createElement("DIV"),i.innerHTML=e,o=u.createDocumentFragment(),o.appendChild(_(i))),this.saveUndoState(f);try{for(a=this._root,s=o,d={fragment:o,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},kt(o,o,this),Ve(o),Je(o,a,!1),$e(o),o.normalize();s=h(s,o);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Ee(f,d.fragment,a),de||this._docWasChanged(),f.collapse(!1),this._ensureBottomLine()),this.setSelection(f),this._updatePath(f,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var xt=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};ot.insertPlainText=function(e,t){var n,r,i,o,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+xt(l[n])+'"';for(h+=">",r=0,i=a.length;r<i;r+=1)o=a[r],o=xt(o).replace(/ (?= )/g,"&nbsp;"),r&&r+1<i&&(o=h+(o||"<BR>")+c),a[r]=o;return this.insertHTML(a.join(""),t)};var Bt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};ot.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},ot.bold=Bt("changeFormat",{tag:"B"}),ot.italic=Bt("changeFormat",{tag:"I"}),ot.underline=Bt("changeFormat",{tag:"U"}),ot.strikethrough=Bt("changeFormat",{tag:"S"}),ot.subscript=Bt("changeFormat",{tag:"SUB"},{tag:"SUP"}),ot.superscript=Bt("changeFormat",{tag:"SUP"},{tag:"SUB"}),ot.removeBold=Bt("changeFormat",null,{tag:"B"}),ot.removeItalic=Bt("changeFormat",null,{tag:"I"}),ot.removeUnderline=Bt("changeFormat",null,{tag:"U"}),ot.removeStrikethrough=Bt("changeFormat",null,{tag:"S"}),ot.removeSubscript=Bt("changeFormat",null,{tag:"SUB"}),ot.removeSuperscript=Bt("changeFormat",null,{tag:"SUP"}),ot.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var r=e.indexOf(":")+1;if(r)for(;"/"===e[r];)r+=1;ye(n,this._doc.createTextNode(e.slice(r)))}return t=A(A({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},ot.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},ot.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:z,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:z}}),this.focus()},ot.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:K,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:K}}),this.focus()},ot.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:q}}),this.focus()},ot.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:W,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:W}}),this.focus()},ot.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},ot.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},ot.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Pe(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),Be(e,n,n,t);for(var r,i,o=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=o.createDocumentFragment(),f=o.createDocumentFragment(),u=b(l,c,n,t),p=b(a,d,n,t);p!==u;)r=p.nextSibling,h.appendChild(p),p=r;return U(this,h,f),f.normalize(),p=f.firstChild,r=f.lastChild,i=n.childNodes,p?(n.insertBefore(f,u),d=he.call(i,p),c=he.call(i,r)+1):(d=he.call(i,u),c=d),e.setStart(n,d),e.setEnd(n,c),k(n,e),xe(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},ot.increaseQuoteLevel=Bt("modifyBlocks",ut),ot.decreaseQuoteLevel=Bt("modifyBlocks",pt),ot.makeUnorderedList=Bt("modifyBlocks",Ct),ot.makeOrderedList=Bt("modifyBlocks",_t),ot.removeList=Bt("modifyBlocks",St),ot.increaseListLevel=Bt("modifyBlocks",yt),ot.decreaseListLevel=Bt("modifyBlocks",Tt),ot.makePre=Bt("modifyBlocks",Nt),ot.decreaseSpecialElementLevel=Bt("modifyBlocks",bt),O.isInline=a,O.isBlock=s,O.isContainer=d,O.getBlockWalker=l,O.getPreviousBlock=c,O.getNextBlock=h,O.areAlike=f,O.hasTagAttributes=u,O.getNearest=p,O.isOrContains=g,O.detach=C,O.replaceWith=N,O.empty=_,O.getNodeBefore=_e,O.getNodeAfter=Se,O.insertNodeInRange=ye,O.extractContentsOfRange=Te,O.deleteContentsOfRange=be,O.insertTreeFragmentIntoRange=Ee,O.isNodeContainedInRange=ke,O.moveRangeBoundariesDownTree=xe,O.moveRangeBoundariesUpTree=Be,O.getStartBlockOfRange=Le,O.getEndBlockOfRange=Ae,O.contentWalker=Oe,O.rangeDoesStartAtBlockBoundary=Re,O.rangeDoesEndAtBlockBoundary=De,O.expandRangeToBlockBoundaries=Pe,O.onPaste=rt,O.addLinks=kt,O.splitBlock=ft,O.startSelectionId="squire-selection-start",O.endSelectionId=ct,"object"==typeof exports?module.exports=O:"function"==typeof define&&define.amd?define(function(){return O}):(Z.Squire=O,top!==Z&&"true"===e.documentElement.getAttribute("data-squireinit")&&(Z.editor=new O(e),Z.onEditorLoad&&(Z.onEditorLoad(Z.editor),Z.onEditorLoad=null)))}(document);
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!_t[e.nodeName]}function r(e){switch(e.nodeType){case F:return yt;case w:case H:if(gt&&Et.has(e))return Et.get(e);break;default:return St}var t;return t=o(e.childNodes,a)?Ct.test(e.nodeName)?yt:Tt:bt,gt&&Et.set(e,t),t}function a(e){return r(e)===yt}function s(e){return r(e)===Tt}function d(e){return r(e)===bt}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function f(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function p(e,t,n,o){for(;e&&e!==t;){if(f(e,n,o))return e;e=e.parentNode}return null}function g(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function m(e,t){var n,o,i,r,a="";return e&&e!==t&&(a=m(e.parentNode,t),e.nodeType===w&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(r=e.dir)&&(a+="[dir="+r+"]"),i&&(vt.call(i,j)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),vt.call(i,Q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),vt.call(i,V)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),vt.call(i,$)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function v(e){var t=e.nodeType;return t===w?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function _(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function S(e,n,o,i){var r,a,s,d,l=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)a=o[r],a!==t&&l.setAttribute(r,o[r]);if(i)for(s=0,d=i.length;d>s;s+=1)l.appendChild(i[s]);return l}function y(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;ut&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(ut?(n=s.createTextNode(Y),r._didAddZWS()):n=s.createTextNode(""))}else if(ht){for(;e.nodeType!==F&&!i(e);){if(o=e.firstChild,!o){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=S(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(l){r.didError({name:"Squire: fixCursor – "+l,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function T(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;o>n;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=S(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=S(l,h.blockTag,h.blockAttributes)),y(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&T(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&p(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),y(e,o),y(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function E(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&u(n,o)&&!_t[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=v(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=v(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=v(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=v(o))),N(n),n.nodeType===F?o.appendData(n.data):d.push(_(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());E(n,t)}}function k(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};E(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function B(e,t,n){for(var o,i,r=t;1===r.parentNode.childNodes.length;)r=r.parentNode;N(r),i=e.childNodes.length,o=e.lastChild,o&&"BR"===o.nodeName&&(e.removeChild(o),i-=1),e.appendChild(_(t)),n.setStart(e,i),n.collapse(!0),k(e,n),at&&(o=e.lastChild)&&"BR"===o.nodeName&&e.removeChild(o)}function x(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&u(i,e)){if(!d(i)){if(!s)return;o=S(a,"DIV"),o.appendChild(_(i)),i.appendChild(o)}N(e),n=!d(e),i.appendChild(_(e)),n&&T(i,t),r&&x(r,t)}else s&&(i=S(a,"DIV"),e.insertBefore(i,r),y(i,t))}function L(e){this.isShiftDown=e.shiftKey}function A(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?A(e[o],i,n):i);return e}function O(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,ft&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,pt?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",R),this.addEventListener("touchstart",R),this.addEventListener("focus",U),this._awaitingPaste=!1,this.addEventListener(rt?"beforecut":"cut",dn),this.addEventListener("copy",ln),this.addEventListener("keydown",L),this.addEventListener("keyup",L),this.addEventListener(rt?"beforepaste":"paste",cn),this.addEventListener("drop",hn),this.addEventListener(at?"keypress":"keydown",zt),this._keyHandlers=Object.create(Zt),this.setConfig(t),rt&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(r){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function R(){this._restoreSelection=!1}function U(){this._restoreSelection&&this.setSelection(this._lastSelection)}function P(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([P(e,o,e._doc.createDocumentFragment())]));continue}P(e,o,n)}return n}var I=2,w=1,F=3,M=9,H=11,W=1,z=4,q=0,K=1,G=2,Z=3,j="highlight",Q="colour",V="font",$="size",Y="​",X=e.defaultView,J=navigator.userAgent,et=/Android/.test(J),tt=/iP(?:ad|hone|od)/.test(J),nt=/Mac OS X/.test(J),ot=/Windows NT/.test(J),it=/Gecko\//.test(J),rt=/Trident\/[456]\./.test(J),at=!!X.opera,st=/Edge\//.test(J),dt=!st&&/WebKit\//.test(J),lt=/Trident\/[4567]\./.test(J),ct=nt?"meta-":"ctrl-",ht=rt||at,ut=rt||dt,ft=rt,pt="undefined"!=typeof MutationObserver,gt="undefined"!=typeof WeakMap,mt=/[^ \t\r\n]/,vt=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Nt={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)e=t.nextSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)e=t.previousSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var Ct=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,_t={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},St=0,yt=1,Tt=2,bt=3,Et=gt?new WeakMap:null,kt=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Bt=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},xt=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=vt.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=vt.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},Lt=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?vt.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,d.appendData(l.data),N(l)),e.setStart(o,i),e.collapse(!0),y(t,n),u},At=function(e,t){var n,o,i=Pt(e,t),r=It(e,t),a=i!==r;return Rt(e),Ut(e,i,r,t),n=Lt(e,null,t),Rt(e),a&&(r=It(e,t),i&&r&&i!==r&&B(i,r,e)),i&&y(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},Ot=function(e,t,n){for(var o=!0,i=t.childNodes,r=i.length;r--;)if(!a(i[r])){o=!1;break}if(e.collapsed||At(e,n),Rt(e),o)xt(e,t),e.startContainer!==e.endContainer&&k(e.endContainer,e),k(e.startContainer,e),e.collapse(!1);else{for(var l,u,f,g,m,v=e.startContainer,N=b(v,e.startOffset,p(v.parentNode,n,"BLOCKQUOTE")||n,n),C=N.previousSibling,_=C,S=_.childNodes.length,T=N,E=0,B=N.parentNode;(l=_.lastChild)&&l.nodeType===w;){if("BR"===l.nodeName){S-=1;break}_=l,S=_.childNodes.length}for(;(l=T.firstChild)&&l.nodeType===w&&"BR"!==l.nodeName;)T=l;for(m=_.childNodes[S]||null;(l=t.firstChild)&&a(l);)_.insertBefore(l,m);for(;(l=t.lastChild)&&a(l);)T.insertBefore(l,T.firstChild),E+=1;for(u=t;u=h(u,n);)y(u,n);if(B.insertBefore(t,N),g=C.nextSibling,u=c(g,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);if(C.parentNode||(C=g.previousSibling),_.parentNode||(_=C||g.parentNode,S=C?C.childNodes.length:0),d(g)&&x(g,n),f=N.previousSibling,u=s(N)?N:h(N,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);N.parentNode||(N=f.nextSibling),E||(T=f,E=f.childNodes.length),N&&d(N)&&x(N,n),e.setStart(_,S),e.setEnd(T,E),Rt(e)}},Dt=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(Z,o)>-1,r=e.compareBoundaryPoints(K,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(q,o)<1,s=e.compareBoundaryPoints(G,o)>-1;return a&&s},Rt=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o],t&&!i(t));)n=t,o=0;if(a)for(;r.nodeType!==F;){if(t=r.childNodes[a-1],!t||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=v(r)}else for(;r.nodeType!==F&&(t=r.firstChild,t&&!i(t));)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Ut=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=vt.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==v(s))break;i=s.parentNode,d=vt.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},Pt=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=kt(o,e.startOffset),n=h(n,t)),n&&Dt(e,n,!0)?n:null},It=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(n=Bt(i,e.endOffset),!n||!g(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Dt(e,n,!0)?n:null},wt=new n(null,z|W,function(e){return e.nodeType===F?mt.test(e.data):"IMG"===e.nodeName}),Ft=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(wt.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Bt(o,i),n&&!g(t,n)&&(n=null),!n&&(n=kt(o,i),n.nodeType===F&&n.length))return!1;return wt.currentNode=n,wt.root=Pt(e,t),!wt.previousNode()},Mt=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(wt.root=null,o.nodeType===F){if(n=o.data.length,n&&n>i)return!1;wt.currentNode=o}else wt.currentNode=kt(o,i);return wt.root=It(e,t),!wt.nextNode()},Ht=function(e,t){var n,o=Pt(e,t),i=It(e,t);o&&i&&(n=o.parentNode,e.setStart(n,vt.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,vt.call(n.childNodes,i)+1))},Wt={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},zt=function(e){var t=e.keyCode,n=Wt[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),at&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),At(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},qt=function(e){return function(t,n){n.preventDefault(),t[e]()}},Kt=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Gt=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===Y);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,vt.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),y(n,e._root),Rt(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(i){e.didError(i)}},Zt={enter:function(e,t,n){var o,i,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),On(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||At(n,a),o=Pt(n,a),!o||/^T[HD]$/.test(o.nodeName))return i=p(n.endContainer,a,"A"),i&&(i=i.parentNode,Ut(n,i,i,a),n.collapse(!1)),xt(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=p(o,a,"LI"))&&(o=i),!o.textContent){if(p(o,a,"UL")||p(o,a,"OL"))return e.modifyBlocks(Ln,n);if(p(o,a,"BLOCKQUOTE"))return e.modifyBlocks(Tn,n)}for(r=_n(e,o,n.startContainer,n.startOffset),mn(o),nn(o),y(o,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===Y)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling,s&&"BR"!==s.nodeName);)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!at)break;r=d}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ft(n,o)){t.preventDefault();var i,r=Pt(n,o);if(!r)return;if(T(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void N(i);for(B(i,r,n),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&x(r,o),e.setSelection(n)}else if(r){if(p(r,o,"UL")||p(r,o,"OL"))return e.modifyBlocks(Ln,n);if(p(r,o,"BLOCKQUOTE"))return e.modifyBlocks(yn,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Gt(e)},0);else t.preventDefault(),At(n,o),Gt(e,n)},"delete":function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Mt(n,l)){if(t.preventDefault(),o=Pt(n,l),!o)return;if(T(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void N(i);for(B(o,i,n),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&x(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),Ut(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s],d&&"IMG"===d.nodeName))return t.preventDefault(),N(d),Rt(n),void Gt(e,n);e.setSelection(r),setTimeout(function(){Gt(e)},0)}else t.preventDefault(),At(n,l),Gt(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&Ft(n,r))for(o=Pt(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.modifyBlocks(xn,n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&Ft(n,i)&&(o=n.startContainer,(p(o,i,"UL")||p(o,i,"OL"))&&(t.preventDefault(),e.modifyBlocks(Ln,n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),On(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===v(o)?n.setStartAfter(i):n.collapsed||(At(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};nt&&it&&(Zt["meta-left"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Zt["meta-right"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),nt||(Zt.pageup=function(e){e.moveCursorToStart()},Zt.pagedown=function(e){e.moveCursorToEnd()}),Zt[ct+"b"]=Kt("B"),Zt[ct+"i"]=Kt("I"),Zt[ct+"u"]=Kt("U"),Zt[ct+"shift-7"]=Kt("S"),Zt[ct+"shift-5"]=Kt("SUB",{tag:"SUP"}),Zt[ct+"shift-6"]=Kt("SUP",{tag:"SUB"}),Zt[ct+"shift-8"]=qt("makeUnorderedList"),Zt[ct+"shift-9"]=qt("makeOrderedList"),Zt[ct+"["]=qt("decreaseQuoteLevel"),Zt[ct+"]"]=qt("increaseQuoteLevel"),Zt[ct+"y"]=qt("redo"),Zt[ct+"z"]=qt("undo"),Zt[ct+"shift-z"]=qt("redo");var jt={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Qt={backgroundColor:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":j,style:"background-color:"+t})}},color:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":Q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return S(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return S(e,"I")}},fontFamily:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":V,style:"font-family:"+t})}},fontSize:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":$,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return S(e,"U")}}},Vt=function(e){return function(t,n){var o=S(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(_(t)),o}},$t=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in Qt)o=Qt[n],i=d[n],i&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(_(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Yt={P:$t,SPAN:$t,STRONG:Vt("B"),EM:Vt("I"),INS:Vt("U"),STRIKE:Vt("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=S(c,"SPAN",{"class":V,style:"font-family:"+s}),a=n,r=n),d&&(o=S(c,"SPAN",{"class":$,style:"font-size:"+jt[d]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=S(c,"SPAN",{"class":Q,style:"color:"+l}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=S(c,"SPAN")),t.replaceChild(a,e),r.appendChild(_(e)),r},TT:function(e,t){var n=S(e.ownerDocument,"SPAN",{"class":V,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(_(e)),n}},Xt=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Jt=/^(?:HEAD|META|STYLE)/,en=new n(null,z|W,function(){return!0}),tn=function Un(e,t){var n,o,i,r,s,d,l,c,h,u,f,p,g=e.childNodes;for(n=e;a(n);)n=n.parentNode;for(en.root=n,o=0,i=g.length;i>o;o+=1)if(r=g[o],s=r.nodeName,d=r.nodeType,l=Yt[s],d===w){if(c=r.childNodes.length,l)r=l(r,e);else{if(Jt.test(s)){e.removeChild(r),o-=1,i-=1;continue}if(!Xt.test(s)&&!a(r)){o-=1,i+=c-1,e.replaceChild(_(r),r);continue}}c&&Un(r,t||"PRE"===s)}else{if(d===F){if(f=r.data,h=!mt.test(f.charAt(0)),u=!mt.test(f.charAt(f.length-1)),t||!h&&!u)continue;if(h){for(en.currentNode=r;(p=en.previousPONode())&&(s=p.nodeName,!("IMG"===s||"#text"===s&&mt.test(p.data)));)if(!a(p)){p=null;break}f=f.replace(/^[ \t\r\n]+/g,p?" ":"")}if(u){for(en.currentNode=r;(p=en.nextNode())&&!("IMG"===s||"#text"===s&&mt.test(p.data));)if(!a(p)){p=null;break}f=f.replace(/[ \t\r\n]+$/g,p?" ":"")}if(f){r.data=f;continue}}e.removeChild(r),o-=1,i-=1}return e},nn=function Pn(e){for(var t,n=e.childNodes,o=n.length;o--;)t=n[o],t.nodeType!==w||i(t)?t.nodeType!==F||t.data||e.removeChild(t):(Pn(t),a(t)&&!t.firstChild&&e.removeChild(t))},on=function(e){return e.nodeType===w?"BR"===e.nodeName:mt.test(e.data)},rn=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,W|z,on),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},an=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;l>o;o+=1)d[o]=rn(s[o],n);for(;l--;)i=s[l],r=i.parentNode,r&&(d[l]?a(r)||T(r,t):N(i))},sn=function(e,t,n){var o,i,r=t.ownerDocument.body;an(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,ot&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},dn=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),st||tt||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,i=At(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}this.setSelection(l)},ln=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!st&&!tt&&d){for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,l=l.cloneRange(),Rt(l),Ut(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}},cn=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(!st&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!st&&i&&(vt.call(i,"text/html")>-1||!it&&vt.call(i,"text/plain")>-1&&vt.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,C=p.endOffset,_=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(_),p.selectNodeContents(_),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=_;_=o;)o=_.nextSibling,N(_),e=_.firstChild,e&&e===_.lastChild&&"DIV"===e.nodeName&&(_=e),n+=_.innerHTML;t=u._createRange(g,m,v,C),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(i){u.didError(i)}},0)},hn=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},un=O.prototype,fn=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};un.setConfig=function(e){return e=A({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:_t,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?fn:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},un.createElement=function(e,t,n){return S(this._doc,e,t,n)},un.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},un.didError=function(e){console.log(e)},un.getDocument=function(){return this._doc},un.getRoot=function(){return this._root},un.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var pn={pathChange:1,select:1,input:1,undoStateChange:1};un.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=g(this._root,this._doc.activeElement),"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(a){a.details="Squire: fireEvent error. Event type: "+e,this.didError(a)}}return this},un.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},un.handleEvent=function(e){this.fireEvent(e.type,e)},un.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],pn[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},un.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],pn[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},un._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},un.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=Y,xt(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),k(n,e)),o},un._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Rt(n),this.setSelection(n),this},un.moveCursorToStart=function(){return this._moveCursorTo(!0)},un.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var gn=function(e){return e._win.getSelection()||null};un.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(et&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{tt&&this._win.focus();var t=gn(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},un.getSelection=function(){var e,t,n,o=gn(this),r=this._root;return this._isFocused&&o&&o.rangeCount&&(e=o.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&g(r,e.commonAncestorContainer)?this._lastSelection=e:e=this._lastSelection,e||(e=this._createRange(r.firstChild,0)),e},un.getSelectedText=function(){var e,t=this.getSelection(),o=new n(t.commonAncestorContainer,z|W,function(e){return Dt(t,e,!0)}),i=t.startContainer,r=t.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(e=s.data,e&&/\S/.test(e)&&(s===r&&(e=e.slice(0,t.endOffset)),s===i&&(e=e.slice(t.startOffset)),d+=e,l=!0)):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},un.getPath=function(){return this._path};var mn=function(e,t){for(var o,i,r,s=new n(e,z,function(){return!0},!1);i=s.nextNode();)for(;(r=i.data.indexOf(Y))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o;while(a(i)&&!v(i));break}i.deleteData(r,1)}};un._didAddZWS=function(){this._hasZWS=!0},un._removeZWS=function(){this._hasZWS&&(mn(this._root),this._hasZWS=!1)},un._updatePath=function(e,t){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?m(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),e.collapsed||this.fireEvent("select")},un._updatePathOnEvent=function(){var e=this;e._willUpdatePath||(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))},un.focus=function(){return this._root.focus(),lt&&this.fireEvent("focus"),this},un.blur=function(){return this._root.blur(),lt&&this.fireEvent("blur"),this};var vn="squire-selection-start",Nn="squire-selection-end";un._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:vn,type:"hidden"}),o=this.createElement("INPUT",{id:Nn,type:"hidden"});xt(e,n),e.collapse(!1),xt(e,o),n.compareDocumentPosition(o)&I&&(n.id=Nn,o.id=vn,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},un._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+vn),o=t.querySelector("#"+Nn);if(n&&o){var i=n.parentNode,r=o.parentNode,a=vt.call(i.childNodes,n),s=vt.call(r.childNodes,o);i===r&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),k(i,e),i!==r&&k(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},un._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||this._docWasChanged()},un._docWasChanged=function(){if(gt&&(Et=new WeakMap),!this._ignoreAllChanges){if(pt&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")
}},un._recordUndoState=function(e){if(!this._isInUndoState){var t,n=this._undoIndex+=1,o=this._undoStack,i=this._config.undo,r=i.documentSizeThreshold,a=i.undoLimit;n<this._undoStackLength&&(o.length=this._undoStackLength=n),e&&this._saveRangeToBookmark(e),t=this._getHTML(),r>-1&&2*t.length>r&&a>-1&&n>a&&(o.splice(0,n-a),n=this._undoIndex=a,this._undoStackLength=a),o[n]=t,this._undoStackLength+=1,this._isInUndoState=!0}},un.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e),this._getRangeAndRemoveBookmark(e)),this},un.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},un.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(t>e+1&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:t>e+2}),this.fireEvent("input")}return this},un.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(p(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,z,function(e){return Dt(o,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!p(r,a,e,t))return!1;d=!0}return d},un.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);4>a&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},un._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f,g=this._root;if(o.collapsed){for(i=y(this.createElement(e,t),g),xt(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),f=i;a(f);)f=f.parentNode;mn(f,i)}else{if(r=new n(o.commonAncestorContainer,z|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Dt(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do h=r.currentNode,u=!p(h,g,e,t),u&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),C(h,i),i.appendChild(h));while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},un._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(ut?(i=r.createTextNode(Y),this._didAddZWS()):i=r.createTextNode(""),xt(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],p=function(e,t){if(!Dt(n,e,!1)){var o,i,r=e.nodeType===F;if(!Dt(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,p(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Dt(n,o,!0)&&f(o,e,t)});return o||g.forEach(function(e){p(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,_(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),k(s,n),n},un.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged(),this):this};var Cn={DT:"DD",DD:"DT",LI:"LI"},_n=function(e,t,n,o){var i=Cn[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),f(a,i,r)||(t=S(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(_(a)),a=t),a};un.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Pt(n,o),r=It(n,o);if(i&&r)do if(e(i)||i===r)break;while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged()),this},un.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(t):this._recordUndoState(t);var n,o=this._root;return Ht(t,o),Ut(t,o,o,o),n=Lt(t,o,o),xt(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&x(t.endContainer.childNodes[t.endOffset],o),x(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),pt||this._docWasChanged(),this};var Sn=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},yn=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!p(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,_(e))}),e},Tn=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:vn,type:"hidden"}),this.createElement("INPUT",{id:Nn,type:"hidden"})])},bn=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(_(o)),s.currentNode=a):(o=o.parentNode,i=o.nodeName,i!==n&&/^[OU]L$/.test(i)&&C(o,e.createElement(n,c,[_(o)])))},En=function(e){return bn(this,e,"UL"),e},kn=function(e){return bn(this,e,"OL"),e},Bn=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;n>t;t+=1)o=a[t],i=_(o),T(i,l),C(o,i);for(t=0,n=d.length;n>t;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([_(r)])):(T(r,l),C(r,_(r)));return e},xn=function(e){var t,n,o,i,r,a,s=e.querySelectorAll("LI"),l=this._config.tagAttributes;for(t=0,n=s.length;n>t;t+=1)o=s[t],d(o.firstChild)||(i=o.parentNode.nodeName,r=o.previousSibling,r&&(r=r.lastChild)&&r.nodeName===i||(a=l[i.toLowerCase()],r=this.createElement(i,a),C(o,r)),r.appendChild(o));return e},Ln=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!d(e.firstChild)}).forEach(function(n){var o,i=n.parentNode,r=i.parentNode,a=n.firstChild,s=a;if(n.previousSibling&&(i=b(i,n,r,t)),/^[OU]L$/.test(r.nodeName))r.insertBefore(n,i),i.firstChild||r.removeChild(i);else for(;s&&(o=s.nextSibling,!d(s));)r.insertBefore(s,i),s=o;for("LI"===r.nodeName&&a.previousSibling&&b(r,a,r.parentNode,t);n!==e&&!n.childNodes.length;)i=n.parentNode,i.removeChild(n),n=i},this),T(e,t),e};un._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},un.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},un._getHTML=function(){return this._root.innerHTML},un._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do y(n,t);while(n=h(n,t));this._ignoreChange=!0},un.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ht)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ht)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},un.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(_(t))),tn(n),an(n,a,!1),T(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},un.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))xt(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=Pt(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Rt(t)}return this.focus(),this.setSelection(t),this._updatePath(t),pt||this._docWasChanged(),this},un.insertImage=function(e,t){var n=this.createElement("IMG",A({src:e},t,!0));return this.insertElement(n),n};var An=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,On=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,z,function(e){return!p(e,t,"A")},!1),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=An.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",A({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};un.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("<!--StartFragment-->"),o=e.lastIndexOf("<!--EndFragment-->"),n>-1&&o>-1&&(e=e.slice(n+20,o))),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(_(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},On(r,r,this),tn(r),an(r,a,!1),nn(r),r.normalize();s=h(s,r);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Ot(u,d.fragment,a),pt||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(p){this.didError(p)}return this};var Dn=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};un.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Dn(l[n])+'"';for(h+=">",o=0,i=a.length;i>o;o+=1)r=a[o],r=Dn(r).replace(/ (?= )/g,"&nbsp;"),o&&i>o+1&&(r=h+(r||"<BR>")+c),a[o]=r;return this.insertHTML(a.join(""),t)};var Rn=function(e,t,n){return function(){return this[e](t,n),this.focus()}};un.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},un.bold=Rn("changeFormat",{tag:"B"}),un.italic=Rn("changeFormat",{tag:"I"}),un.underline=Rn("changeFormat",{tag:"U"}),un.strikethrough=Rn("changeFormat",{tag:"S"}),un.subscript=Rn("changeFormat",{tag:"SUB"},{tag:"SUP"}),un.superscript=Rn("changeFormat",{tag:"SUP"},{tag:"SUB"}),un.removeBold=Rn("changeFormat",null,{tag:"B"}),un.removeItalic=Rn("changeFormat",null,{tag:"I"}),un.removeUnderline=Rn("changeFormat",null,{tag:"U"}),un.removeStrikethrough=Rn("changeFormat",null,{tag:"S"}),un.removeSubscript=Rn("changeFormat",null,{tag:"SUB"}),un.removeSuperscript=Rn("changeFormat",null,{tag:"SUP"}),un.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;xt(n,this._doc.createTextNode(e.slice(o)))}return t=A(A({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},un.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},un.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":V,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{"class":V}}),this.focus()},un.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":$,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{"class":$}}),this.focus()},un.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{"class":Q}}),this.focus()},un.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":j,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{"class":j}}),this.focus()},un.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},un.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},un.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Ht(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),Ut(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return P(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=vt.call(i,p),c=vt.call(i,o)+1):(d=vt.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),k(n,e),Rt(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},un.increaseQuoteLevel=Rn("modifyBlocks",Sn),un.decreaseQuoteLevel=Rn("modifyBlocks",yn),un.makeUnorderedList=Rn("modifyBlocks",En),un.makeOrderedList=Rn("modifyBlocks",kn),un.removeList=Rn("modifyBlocks",Bn),un.increaseListLevel=Rn("modifyBlocks",xn),un.decreaseListLevel=Rn("modifyBlocks",Ln),O.isInline=a,O.isBlock=s,O.isContainer=d,O.getBlockWalker=l,O.getPreviousBlock=c,O.getNextBlock=h,O.areAlike=u,O.hasTagAttributes=f,O.getNearest=p,O.isOrContains=g,O.detach=N,O.replaceWith=C,O.empty=_,O.getNodeBefore=kt,O.getNodeAfter=Bt,O.insertNodeInRange=xt,O.extractContentsOfRange=Lt,O.deleteContentsOfRange=At,O.insertTreeFragmentIntoRange=Ot,O.isNodeContainedInRange=Dt,O.moveRangeBoundariesDownTree=Rt,O.moveRangeBoundariesUpTree=Ut,O.getStartBlockOfRange=Pt,O.getEndBlockOfRange=It,O.contentWalker=wt,O.rangeDoesStartAtBlockBoundary=Ft,O.rangeDoesEndAtBlockBoundary=Mt,O.expandRangeToBlockBoundaries=Ht,O.onPaste=cn,O.addLinks=On,O.splitBlock=_n,O.startSelectionId=vn,O.endSelectionId=Nn,"object"==typeof exports?module.exports=O:"function"==typeof define&&define.amd?define(function(){return O}):(X.Squire=O,top!==X&&"true"===e.documentElement.getAttribute("data-squireinit")&&(X.editor=new O(e),X.onEditorLoad&&(X.onEditorLoad(X.editor),X.onEditorLoad=null)))}(document);
>>>>>>> bb593e8... Don't insert <br> inside end of <a> on enter
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!_t[e.nodeName]}function r(e){switch(e.nodeType){case F:return yt;case w:case H:if(gt&&Et.has(e))return Et.get(e);break;default:return St}var t;return t=o(e.childNodes,a)?Ct.test(e.nodeName)?yt:Tt:bt,gt&&Et.set(e,t),t}function a(e){return r(e)===yt}function s(e){return r(e)===Tt}function d(e){return r(e)===bt}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function f(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function p(e,t,n,o){for(;e&&e!==t;){if(f(e,n,o))return e;e=e.parentNode}return null}function g(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function m(e,t){var n,o,i,r,a="";return e&&e!==t&&(a=m(e.parentNode,t),e.nodeType===w&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(r=e.dir)&&(a+="[dir="+r+"]"),i&&(vt.call(i,j)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),vt.call(i,Q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),vt.call(i,$)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),vt.call(i,V)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function v(e){var t=e.nodeType;return t===w?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function _(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function S(e,n,o,i){var r,a,s,d,l=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)a=o[r],a!==t&&l.setAttribute(r,o[r]);if(i)for(s=0,d=i.length;d>s;s+=1)l.appendChild(i[s]);return l}function y(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;ut&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(ut?(n=s.createTextNode(Y),r._didAddZWS()):n=s.createTextNode(""))}else if(ht){for(;e.nodeType!==F&&!i(e);){if(o=e.firstChild,!o){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=S(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(l){r.didError({name:"Squire: fixCursor – "+l,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function T(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;o>n;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=S(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=S(l,h.blockTag,h.blockAttributes)),y(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&T(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&p(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),y(e,o),y(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function E(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&u(n,o)&&!_t[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=v(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=v(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=v(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=v(o))),N(n),n.nodeType===F?o.appendData(n.data):d.push(_(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());E(n,t)}}function k(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};E(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function B(e,t,n){for(var o,i,r=t;1===r.parentNode.childNodes.length;)r=r.parentNode;N(r),i=e.childNodes.length,o=e.lastChild,o&&"BR"===o.nodeName&&(e.removeChild(o),i-=1),e.appendChild(_(t)),n.setStart(e,i),n.collapse(!0),k(e,n),at&&(o=e.lastChild)&&"BR"===o.nodeName&&e.removeChild(o)}function x(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&u(i,e)){if(!d(i)){if(!s)return;o=S(a,"DIV"),o.appendChild(_(i)),i.appendChild(o)}N(e),n=!d(e),i.appendChild(_(e)),n&&T(i,t),r&&x(r,t)}else s&&(i=S(a,"DIV"),e.insertBefore(i,r),y(i,t))}function L(e){this.isShiftDown=e.shiftKey}function A(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?A(e[o],i,n):i);return e}function O(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,ft&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,pt?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",R),this.addEventListener("touchstart",R),this.addEventListener("focus",U),this._awaitingPaste=!1,this.addEventListener(rt?"beforecut":"cut",dn),this.addEventListener("copy",ln),this.addEventListener("keydown",L),this.addEventListener("keyup",L),this.addEventListener(rt?"beforepaste":"paste",cn),this.addEventListener("drop",hn),this.addEventListener(at?"keypress":"keydown",zt),this._keyHandlers=Object.create(Zt),this.setConfig(t),rt&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(r){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function R(){this._restoreSelection=!1}function U(){this._restoreSelection&&this.setSelection(this._lastSelection)}function P(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([P(e,o,e._doc.createDocumentFragment())]));continue}P(e,o,n)}return n}var I=2,w=1,F=3,M=9,H=11,W=1,z=4,q=0,K=1,G=2,Z=3,j="highlight",Q="colour",$="font",V="size",Y="​",X=e.defaultView,J=navigator.userAgent,et=/Android/.test(J),tt=/iP(?:ad|hone|od)/.test(J),nt=/Mac OS X/.test(J),ot=/Windows NT/.test(J),it=/Gecko\//.test(J),rt=/Trident\/[456]\./.test(J),at=!!X.opera,st=/Edge\//.test(J),dt=!st&&/WebKit\//.test(J),lt=/Trident\/[4567]\./.test(J),ct=nt?"meta-":"ctrl-",ht=rt||at,ut=rt||dt,ft=rt,pt="undefined"!=typeof MutationObserver,gt="undefined"!=typeof WeakMap,mt=/[^ \t\r\n]/,vt=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Nt={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)e=t.nextSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)e=t.previousSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var Ct=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,_t={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},St=0,yt=1,Tt=2,bt=3,Et=gt?new WeakMap:null,kt=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Bt=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},xt=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=vt.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=vt.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},Lt=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?vt.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,d.appendData(l.data),N(l)),e.setStart(o,i),e.collapse(!0),y(t,n),u},At=function(e,t){var n,o,i=Pt(e,t),r=It(e,t),a=i!==r;return Rt(e),Ut(e,i,r,t),n=Lt(e,null,t),Rt(e),a&&(r=It(e,t),i&&r&&i!==r&&B(i,r,e)),i&&y(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},Ot=function(e,t,n){for(var o=!0,i=t.childNodes,r=i.length;r--;)if(!a(i[r])){o=!1;break}if(e.collapsed||At(e,n),Rt(e),o)xt(e,t),e.startContainer!==e.endContainer&&k(e.endContainer,e),k(e.startContainer,e),e.collapse(!1);else{for(var l,u,f,g,m,v=e.startContainer,N=b(v,e.startOffset,p(v.parentNode,n,"BLOCKQUOTE")||n,n),C=N.previousSibling,_=C,S=_.childNodes.length,T=N,E=0,B=N.parentNode;(l=_.lastChild)&&l.nodeType===w;){if("BR"===l.nodeName){S-=1;break}_=l,S=_.childNodes.length}for(;(l=T.firstChild)&&l.nodeType===w&&"BR"!==l.nodeName;)T=l;for(m=_.childNodes[S]||null;(l=t.firstChild)&&a(l);)_.insertBefore(l,m);for(;(l=t.lastChild)&&a(l);)T.insertBefore(l,T.firstChild),E+=1;for(u=t;u=h(u,n);)y(u,n);if(B.insertBefore(t,N),g=C.nextSibling,u=c(g,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);if(C.parentNode||(C=g.previousSibling),_.parentNode||(_=C||g.parentNode,S=C?C.childNodes.length:0),d(g)&&x(g,n),f=N.previousSibling,u=s(N)?N:h(N,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);N.parentNode||(N=f.nextSibling),E||(T=f,E=f.childNodes.length),N&&d(N)&&x(N,n),e.setStart(_,S),e.setEnd(T,E),Rt(e)}},Dt=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(Z,o)>-1,r=e.compareBoundaryPoints(K,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(q,o)<1,s=e.compareBoundaryPoints(G,o)>-1;return a&&s},Rt=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o],t&&!i(t));)n=t,o=0;if(a)for(;r.nodeType!==F;){if(t=r.childNodes[a-1],!t||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=v(r)}else for(;r.nodeType!==F&&(t=r.firstChild,t&&!i(t));)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Ut=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=vt.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==v(s))break;i=s.parentNode,d=vt.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},Pt=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=kt(o,e.startOffset),n=h(n,t)),n&&Dt(e,n,!0)?n:null},It=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(n=Bt(i,e.endOffset),!n||!g(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Dt(e,n,!0)?n:null},wt=new n(null,z|W,function(e){return e.nodeType===F?mt.test(e.data):"IMG"===e.nodeName}),Ft=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(wt.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Bt(o,i),n&&!g(t,n)&&(n=null),!n&&(n=kt(o,i),n.nodeType===F&&n.length))return!1;return wt.currentNode=n,wt.root=Pt(e,t),!wt.previousNode()},Mt=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(wt.root=null,o.nodeType===F){if(n=o.data.length,n&&n>i)return!1;wt.currentNode=o}else wt.currentNode=kt(o,i);return wt.root=It(e,t),!wt.nextNode()},Ht=function(e,t){var n,o=Pt(e,t),i=It(e,t);o&&i&&(n=o.parentNode,e.setStart(n,vt.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,vt.call(n.childNodes,i)+1))},Wt={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},zt=function(e){var t=e.keyCode,n=Wt[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),at&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),At(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},qt=function(e){return function(t,n){n.preventDefault(),t[e]()}},Kt=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Gt=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===Y);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,vt.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),y(n,e._root),Rt(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(i){e.didError(i)}},Zt={enter:function(e,t,n){var o,i,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),On(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||At(n,a),o=Pt(n,a),!o||/^T[HD]$/.test(o.nodeName))return i=p(n.endContainer,a,"A"),i&&(i=i.parentNode,Ut(n,i,i,a),n.collapse(!1)),xt(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=p(o,a,"LI"))&&(o=i),!o.textContent){if(p(o,a,"UL")||p(o,a,"OL"))return e.modifyBlocks(Ln,n);if(p(o,a,"BLOCKQUOTE"))return e.modifyBlocks(Tn,n)}for(r=_n(e,o,n.startContainer,n.startOffset),mn(o),nn(o),y(o,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===Y)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling,s&&"BR"!==s.nodeName);)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!at)break;r=d}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ft(n,o)){t.preventDefault();var i,r=Pt(n,o);if(!r)return;if(T(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void N(i);for(B(i,r,n),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&x(r,o),e.setSelection(n)}else if(r){if(p(r,o,"UL")||p(r,o,"OL"))return e.modifyBlocks(Ln,n);if(p(r,o,"BLOCKQUOTE"))return e.modifyBlocks(yn,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Gt(e)},0);else t.preventDefault(),At(n,o),Gt(e,n)},"delete":function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Mt(n,l)){if(t.preventDefault(),o=Pt(n,l),!o)return;if(T(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void N(i);for(B(o,i,n),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&x(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),Ut(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s],d&&"IMG"===d.nodeName))return t.preventDefault(),N(d),Rt(n),void Gt(e,n);e.setSelection(r),setTimeout(function(){Gt(e)},0)}else t.preventDefault(),At(n,l),Gt(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&Ft(n,r))for(o=Pt(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.modifyBlocks(xn,n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&Ft(n,i)&&(o=n.startContainer,(p(o,i,"UL")||p(o,i,"OL"))&&(t.preventDefault(),e.modifyBlocks(Ln,n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),On(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===v(o)?n.setStartAfter(i):n.collapsed||(At(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};nt&&it&&(Zt["meta-left"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Zt["meta-right"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),nt||(Zt.pageup=function(e){e.moveCursorToStart()},Zt.pagedown=function(e){e.moveCursorToEnd()}),Zt[ct+"b"]=Kt("B"),Zt[ct+"i"]=Kt("I"),Zt[ct+"u"]=Kt("U"),Zt[ct+"shift-7"]=Kt("S"),Zt[ct+"shift-5"]=Kt("SUB",{tag:"SUP"}),Zt[ct+"shift-6"]=Kt("SUP",{tag:"SUB"}),Zt[ct+"shift-8"]=qt("makeUnorderedList"),Zt[ct+"shift-9"]=qt("makeOrderedList"),Zt[ct+"["]=qt("decreaseQuoteLevel"),Zt[ct+"]"]=qt("increaseQuoteLevel"),Zt[ct+"y"]=qt("redo"),Zt[ct+"z"]=qt("undo"),Zt[ct+"shift-z"]=qt("redo");var jt={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Qt={backgroundColor:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":j,style:"background-color:"+t})}},color:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":Q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return S(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return S(e,"I")}},fontFamily:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":$,style:"font-family:"+t})}},fontSize:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":V,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return S(e,"U")}}},$t=function(e){return function(t,n){var o=S(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(_(t)),o}},Vt=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in Qt)o=Qt[n],i=d[n],i&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(_(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Yt={P:Vt,SPAN:Vt,STRONG:$t("B"),EM:$t("I"),INS:$t("U"),STRIKE:$t("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=S(c,"SPAN",{"class":$,style:"font-family:"+s}),a=n,r=n),d&&(o=S(c,"SPAN",{"class":V,style:"font-size:"+jt[d]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=S(c,"SPAN",{"class":Q,style:"color:"+l}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=S(c,"SPAN")),t.replaceChild(a,e),r.appendChild(_(e)),r},TT:function(e,t){var n=S(e.ownerDocument,"SPAN",{"class":$,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(_(e)),n}},Xt=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Jt=/^(?:HEAD|META|STYLE)/,en=new n(null,z|W,function(){return!0}),tn=function Un(e,t){var n,o,i,r,s,d,l,c,h,u,f,p,g=e.childNodes;for(n=e;a(n);)n=n.parentNode;for(en.root=n,o=0,i=g.length;i>o;o+=1)if(r=g[o],s=r.nodeName,d=r.nodeType,l=Yt[s],d===w){if(c=r.childNodes.length,l)r=l(r,e);else{if(Jt.test(s)){e.removeChild(r),o-=1,i-=1;continue}if(!Xt.test(s)&&!a(r)){o-=1,i+=c-1,e.replaceChild(_(r),r);continue}}c&&Un(r,t||"PRE"===s)}else{if(d===F){if(f=r.data,h=!mt.test(f.charAt(0)),u=!mt.test(f.charAt(f.length-1)),t||!h&&!u)continue;if(h){for(en.currentNode=r;(p=en.previousPONode())&&(s=p.nodeName,!("IMG"===s||"#text"===s&&mt.test(p.data)));)if(!a(p)){p=null;break}f=f.replace(/^[ \t\r\n]+/g,p?" ":"")}if(u){for(en.currentNode=r;(p=en.nextNode())&&!("IMG"===s||"#text"===s&&mt.test(p.data));)if(!a(p)){p=null;break}f=f.replace(/[ \t\r\n]+$/g,p?" ":"")}if(f){r.data=f;continue}}e.removeChild(r),o-=1,i-=1}return e},nn=function Pn(e){for(var t,n=e.childNodes,o=n.length;o--;)t=n[o],t.nodeType!==w||i(t)?t.nodeType!==F||t.data||e.removeChild(t):(Pn(t),a(t)&&!t.firstChild&&e.removeChild(t))},on=function(e){return e.nodeType===w?"BR"===e.nodeName:mt.test(e.data)},rn=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,W|z,on),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},an=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;l>o;o+=1)d[o]=rn(s[o],n);for(;l--;)i=s[l],r=i.parentNode,r&&(d[l]?a(r)||T(r,t):N(i))},sn=function(e,t,n){var o,i,r=t.ownerDocument.body;an(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,ot&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},dn=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),st||tt||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,i=At(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}this.setSelection(l)},ln=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!st&&!tt&&d){for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,l=l.cloneRange(),Rt(l),Ut(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}},cn=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(!st&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!st&&i&&(vt.call(i,"text/html")>-1||!it&&vt.call(i,"text/plain")>-1&&vt.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,C=p.endOffset,_=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(_),p.selectNodeContents(_),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=_;_=o;)o=_.nextSibling,N(_),e=_.firstChild,e&&e===_.lastChild&&"DIV"===e.nodeName&&(_=e),n+=_.innerHTML;t=u._createRange(g,m,v,C),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(i){u.didError(i)}},0)},hn=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},un=O.prototype,fn=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};un.setConfig=function(e){return e=A({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:_t,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?fn:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},un.createElement=function(e,t,n){return S(this._doc,e,t,n)},un.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},un.didError=function(e){console.log(e)},un.getDocument=function(){return this._doc},un.getRoot=function(){return this._root},un.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var pn={pathChange:1,select:1,input:1,undoStateChange:1};un.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=g(this._root,this._doc.activeElement),"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(a){a.details="Squire: fireEvent error. Event type: "+e,this.didError(a)}}return this},un.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},un.handleEvent=function(e){this.fireEvent(e.type,e)},un.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],pn[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},un.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],pn[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},un._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},un.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=Y,xt(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),k(n,e)),o},un._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Rt(n),this.setSelection(n),this},un.moveCursorToStart=function(){return this._moveCursorTo(!0)},un.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var gn=function(e){return e._win.getSelection()||null};un.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(et&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{tt&&this._win.focus();var t=gn(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},un.getSelection=function(){var e,t,n,o=gn(this),r=this._root;return this._isFocused&&o&&o.rangeCount&&(e=o.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&g(r,e.commonAncestorContainer)?this._lastSelection=e:e=this._lastSelection,e||(e=this._createRange(r.firstChild,0)),e},un.getSelectedText=function(){var e,t=this.getSelection(),o=new n(t.commonAncestorContainer,z|W,function(e){return Dt(t,e,!0)}),i=t.startContainer,r=t.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(e=s.data,e&&/\S/.test(e)&&(s===r&&(e=e.slice(0,t.endOffset)),s===i&&(e=e.slice(t.startOffset)),d+=e,l=!0)):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},un.getPath=function(){return this._path};var mn=function(e,t){for(var o,i,r,s=new n(e,z,function(){return!0},!1);i=s.nextNode();)for(;(r=i.data.indexOf(Y))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o;while(a(i)&&!v(i));break}i.deleteData(r,1)}};un._didAddZWS=function(){this._hasZWS=!0},un._removeZWS=function(){this._hasZWS&&(mn(this._root),this._hasZWS=!1)},un._updatePath=function(e,t){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?m(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),e.collapsed||this.fireEvent("select")},un._updatePathOnEvent=function(){var e=this;e._willUpdatePath||(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))},un.focus=function(){return this._root.focus(),lt&&this.fireEvent("focus"),this},un.blur=function(){return this._root.blur(),lt&&this.fireEvent("blur"),this};var vn="squire-selection-start",Nn="squire-selection-end";un._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:vn,type:"hidden"}),o=this.createElement("INPUT",{id:Nn,type:"hidden"});xt(e,n),e.collapse(!1),xt(e,o),n.compareDocumentPosition(o)&I&&(n.id=Nn,o.id=vn,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},un._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+vn),o=t.querySelector("#"+Nn);if(n&&o){var i=n.parentNode,r=o.parentNode,a=vt.call(i.childNodes,n),s=vt.call(r.childNodes,o);i===r&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),k(i,e),i!==r&&k(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},un._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||this._docWasChanged()},un._docWasChanged=function(){if(gt&&(Et=new WeakMap),!this._ignoreAllChanges){if(pt&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")
}},un._recordUndoState=function(e){if(!this._isInUndoState){var t,n=this._undoIndex+=1,o=this._undoStack,i=this._config.undo,r=i.documentSizeThreshold,a=i.undoLimit;n<this._undoStackLength&&(o.length=this._undoStackLength=n),e&&this._saveRangeToBookmark(e),t=this._getHTML(),r>-1&&2*t.length>r&&a>-1&&n>a&&(o.splice(0,n-a),n=this._undoIndex=a,this._undoStackLength=a),o[n]=t,this._undoStackLength+=1,this._isInUndoState=!0}},un.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e),this._getRangeAndRemoveBookmark(e)),this},un.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},un.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(t>e+1&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:t>e+2}),this.fireEvent("input")}return this},un.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(p(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,z,function(e){return Dt(o,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!p(r,a,e,t))return!1;d=!0}return d},un.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);4>a&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},un._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f,g=this._root;if(o.collapsed){for(i=y(this.createElement(e,t),g),xt(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),f=i;a(f);)f=f.parentNode;mn(f,i)}else{if(r=new n(o.commonAncestorContainer,z|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Dt(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do h=r.currentNode,u=!p(h,g,e,t),u&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),C(h,i),i.appendChild(h));while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},un._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(ut?(i=r.createTextNode(Y),this._didAddZWS()):i=r.createTextNode(""),xt(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],p=function(e,t){if(!Dt(n,e,!1)){var o,i,r=e.nodeType===F;if(!Dt(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,p(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Dt(n,o,!0)&&f(o,e,t)});return o||g.forEach(function(e){p(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,_(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),k(s,n),n},un.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged(),this):this};var Cn={DT:"DD",DD:"DT",LI:"LI"},_n=function(e,t,n,o){var i=Cn[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),f(a,i,r)||(t=S(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(_(a)),a=t),a};un.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Pt(n,o),r=It(n,o);if(i&&r)do if(e(i)||i===r)break;while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged()),this},un.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(t):this._recordUndoState(t);var n,o=this._root;return Ht(t,o),Ut(t,o,o,o),n=Lt(t,o,o),xt(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&x(t.endContainer.childNodes[t.endOffset],o),x(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),pt||this._docWasChanged(),this};var Sn=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},yn=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!p(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,_(e))}),e},Tn=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:vn,type:"hidden"}),this.createElement("INPUT",{id:Nn,type:"hidden"})])},bn=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(_(o)),s.currentNode=a):(o=o.parentNode,i=o.nodeName,i!==n&&/^[OU]L$/.test(i)&&C(o,e.createElement(n,c,[_(o)])))},En=function(e){return bn(this,e,"UL"),e},kn=function(e){return bn(this,e,"OL"),e},Bn=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;n>t;t+=1)o=a[t],i=_(o),T(i,l),C(o,i);for(t=0,n=d.length;n>t;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([_(r)])):(T(r,l),C(r,_(r)));return e},xn=function(e){var t,n,o,i,r,a,s=e.querySelectorAll("LI"),l=this._config.tagAttributes;for(t=0,n=s.length;n>t;t+=1)o=s[t],d(o.firstChild)||(i=o.parentNode.nodeName,r=o.previousSibling,r&&(r=r.lastChild)&&r.nodeName===i||(a=l[i.toLowerCase()],r=this.createElement(i,a),C(o,r)),r.appendChild(o));return e},Ln=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!d(e.firstChild)}).forEach(function(n){var o,i=n.parentNode,r=i.parentNode,a=n.firstChild,s=a;if(n.previousSibling&&(i=b(i,n,r,t)),/^[OU]L$/.test(r.nodeName))r.insertBefore(n,i),i.firstChild||r.removeChild(i);else for(;s&&(o=s.nextSibling,!d(s));)r.insertBefore(s,i),s=o;for("LI"===r.nodeName&&a.previousSibling&&b(r,a,r.parentNode,t);n!==e&&!n.childNodes.length;)i=n.parentNode,i.removeChild(n),n=i},this),T(e,t),e};un._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},un.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},un._getHTML=function(){return this._root.innerHTML},un._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do y(n,t);while(n=h(n,t));this._ignoreChange=!0},un.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ht)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ht)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},un.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(_(t))),tn(n),an(n,a,!1),T(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},un.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))xt(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=Pt(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Rt(t)}return this.focus(),this.setSelection(t),this._updatePath(t),pt||this._docWasChanged(),this},un.insertImage=function(e,t){var n=this.createElement("IMG",A({src:e},t,!0));return this.insertElement(n),n};var An=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,On=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,z,function(e){return!p(e,t,"A")},!1),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=An.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",A({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};un.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("<!--StartFragment-->"),o=e.lastIndexOf("<!--EndFragment-->"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(_(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},On(r,r,this),tn(r),an(r,a,!1),nn(r),r.normalize();s=h(s,r);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Ot(u,d.fragment,a),pt||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(p){this.didError(p)}return this};var Dn=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};un.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Dn(l[n])+'"';for(h+=">",o=0,i=a.length;i>o;o+=1)r=a[o],r=Dn(r).replace(/ (?= )/g,"&nbsp;"),o&&i>o+1&&(r=h+(r||"<BR>")+c),a[o]=r;return this.insertHTML(a.join(""),t)};var Rn=function(e,t,n){return function(){return this[e](t,n),this.focus()}};un.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},un.bold=Rn("changeFormat",{tag:"B"}),un.italic=Rn("changeFormat",{tag:"I"}),un.underline=Rn("changeFormat",{tag:"U"}),un.strikethrough=Rn("changeFormat",{tag:"S"}),un.subscript=Rn("changeFormat",{tag:"SUB"},{tag:"SUP"}),un.superscript=Rn("changeFormat",{tag:"SUP"},{tag:"SUB"}),un.removeBold=Rn("changeFormat",null,{tag:"B"}),un.removeItalic=Rn("changeFormat",null,{tag:"I"}),un.removeUnderline=Rn("changeFormat",null,{tag:"U"}),un.removeStrikethrough=Rn("changeFormat",null,{tag:"S"}),un.removeSubscript=Rn("changeFormat",null,{tag:"SUB"}),un.removeSuperscript=Rn("changeFormat",null,{tag:"SUP"}),un.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;xt(n,this._doc.createTextNode(e.slice(o)))}return t=A(A({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},un.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},un.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":$,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{"class":$}}),this.focus()},un.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":V,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{"class":V}}),this.focus()},un.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{"class":Q}}),this.focus()},un.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":j,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{"class":j}}),this.focus()},un.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},un.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},un.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Ht(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),Ut(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return P(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=vt.call(i,p),c=vt.call(i,o)+1):(d=vt.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),k(n,e),Rt(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},un.increaseQuoteLevel=Rn("modifyBlocks",Sn),un.decreaseQuoteLevel=Rn("modifyBlocks",yn),un.makeUnorderedList=Rn("modifyBlocks",En),un.makeOrderedList=Rn("modifyBlocks",kn),un.removeList=Rn("modifyBlocks",Bn),un.increaseListLevel=Rn("modifyBlocks",xn),un.decreaseListLevel=Rn("modifyBlocks",Ln),O.isInline=a,O.isBlock=s,O.isContainer=d,O.getBlockWalker=l,O.getPreviousBlock=c,O.getNextBlock=h,O.areAlike=u,O.hasTagAttributes=f,O.getNearest=p,O.isOrContains=g,O.detach=N,O.replaceWith=C,O.empty=_,O.getNodeBefore=kt,O.getNodeAfter=Bt,O.insertNodeInRange=xt,O.extractContentsOfRange=Lt,O.deleteContentsOfRange=At,O.insertTreeFragmentIntoRange=Ot,O.isNodeContainedInRange=Dt,O.moveRangeBoundariesDownTree=Rt,O.moveRangeBoundariesUpTree=Ut,O.getStartBlockOfRange=Pt,O.getEndBlockOfRange=It,O.contentWalker=wt,O.rangeDoesStartAtBlockBoundary=Ft,O.rangeDoesEndAtBlockBoundary=Mt,O.expandRangeToBlockBoundaries=Ht,O.onPaste=cn,O.addLinks=On,O.splitBlock=_n,O.startSelectionId=vn,O.endSelectionId=Nn,"object"==typeof exports?module.exports=O:"function"==typeof define&&define.amd?define(function(){return O}):(X.Squire=O,top!==X&&"true"===e.documentElement.getAttribute("data-squireinit")&&(X.editor=new O(e),X.onEditorLoad&&(X.onEditorLoad(X.editor),X.onEditorLoad=null)))}(document);
>>>>>>> 632aae0... Code style fixup
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!_t[e.nodeName]}function r(e){switch(e.nodeType){case F:return yt;case w:case H:if(gt&&Et.has(e))return Et.get(e);break;default:return St}var t;return t=o(e.childNodes,a)?Ct.test(e.nodeName)?yt:Tt:bt,gt&&Et.set(e,t),t}function a(e){return r(e)===yt}function s(e){return r(e)===Tt}function d(e){return r(e)===bt}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function f(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function p(e,t,n,o){for(;e&&e!==t;){if(f(e,n,o))return e;e=e.parentNode}return null}function g(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function m(e,t){var n,o,i,r,a="";return e&&e!==t&&(a=m(e.parentNode,t),e.nodeType===w&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(r=e.dir)&&(a+="[dir="+r+"]"),i&&(vt.call(i,j)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),vt.call(i,Q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),vt.call(i,$)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),vt.call(i,V)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function v(e){var t=e.nodeType;return t===w?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function _(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function S(e,n,o,i){var r,a,s,d,l=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)a=o[r],a!==t&&l.setAttribute(r,o[r]);if(i)for(s=0,d=i.length;d>s;s+=1)l.appendChild(i[s]);return l}function y(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;ut&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(ut?(n=s.createTextNode(Y),r._didAddZWS()):n=s.createTextNode(""))}else if(ht){for(;e.nodeType!==F&&!i(e);){if(o=e.firstChild,!o){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=S(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(l){r.didError({name:"Squire: fixCursor – "+l,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function T(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;o>n;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=S(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=S(l,h.blockTag,h.blockAttributes)),y(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&T(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&p(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),y(e,o),y(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function E(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&u(n,o)&&!_t[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=v(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=v(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=v(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=v(o))),N(n),n.nodeType===F?o.appendData(n.data):d.push(_(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());E(n,t)}}function k(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};E(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function B(e,t,n){for(var o,i,r=t;1===r.parentNode.childNodes.length;)r=r.parentNode;N(r),i=e.childNodes.length,o=e.lastChild,o&&"BR"===o.nodeName&&(e.removeChild(o),i-=1),e.appendChild(_(t)),n.setStart(e,i),n.collapse(!0),k(e,n),at&&(o=e.lastChild)&&"BR"===o.nodeName&&e.removeChild(o)}function x(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&u(i,e)){if(!d(i)){if(!s)return;o=S(a,"DIV"),o.appendChild(_(i)),i.appendChild(o)}N(e),n=!d(e),i.appendChild(_(e)),n&&T(i,t),r&&x(r,t)}else s&&(i=S(a,"DIV"),e.insertBefore(i,r),y(i,t))}function L(e){this.isShiftDown=e.shiftKey}function A(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?A(e[o],i,n):i);return e}function O(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,ft&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,pt?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",R),this.addEventListener("touchstart",R),this.addEventListener("focus",U),this._awaitingPaste=!1,this.addEventListener(rt?"beforecut":"cut",dn),this.addEventListener("copy",ln),this.addEventListener("keydown",L),this.addEventListener("keyup",L),this.addEventListener(rt?"beforepaste":"paste",cn),this.addEventListener("drop",hn),this.addEventListener(at?"keypress":"keydown",zt),this._keyHandlers=Object.create(Zt),this.setConfig(t),rt&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(r){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function R(){this._restoreSelection=!1}function U(){this._restoreSelection&&this.setSelection(this._lastSelection)}function P(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([P(e,o,e._doc.createDocumentFragment())]));continue}P(e,o,n)}return n}var I=2,w=1,F=3,M=9,H=11,W=1,z=4,q=0,K=1,G=2,Z=3,j="highlight",Q="colour",$="font",V="size",Y="​",X=e.defaultView,J=navigator.userAgent,et=/Android/.test(J),tt=/iP(?:ad|hone|od)/.test(J),nt=/Mac OS X/.test(J),ot=/Windows NT/.test(J),it=/Gecko\//.test(J),rt=/Trident\/[456]\./.test(J),at=!!X.opera,st=/Edge\//.test(J),dt=!st&&/WebKit\//.test(J),lt=/Trident\/[4567]\./.test(J),ct=nt?"meta-":"ctrl-",ht=rt||at,ut=rt||dt,ft=rt,pt="undefined"!=typeof MutationObserver,gt="undefined"!=typeof WeakMap,mt=/[^ \t\r\n]/,vt=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Nt={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)e=t.nextSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)e=t.previousSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var Ct=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,_t={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},St=0,yt=1,Tt=2,bt=3,Et=gt?new WeakMap:null,kt=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Bt=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},xt=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=vt.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=vt.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},Lt=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?vt.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,d.appendData(l.data),N(l)),e.setStart(o,i),e.collapse(!0),y(t,n),u},At=function(e,t){var n,o,i=Pt(e,t),r=It(e,t),a=i!==r;return Rt(e),Ut(e,i,r,t),n=Lt(e,null,t),Rt(e),a&&(r=It(e,t),i&&r&&i!==r&&B(i,r,e)),i&&y(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},Ot=function(e,t,n){for(var o=!0,i=t.childNodes,r=i.length;r--;)if(!a(i[r])){o=!1;break}if(e.collapsed||At(e,n),Rt(e),o)xt(e,t),e.startContainer!==e.endContainer&&k(e.endContainer,e),k(e.startContainer,e),e.collapse(!1);else{for(var l,u,f,g,m,v=e.startContainer,N=b(v,e.startOffset,p(v.parentNode,n,"BLOCKQUOTE")||n,n),C=N.previousSibling,_=C,S=_.childNodes.length,T=N,E=0,B=N.parentNode;(l=_.lastChild)&&l.nodeType===w;){if("BR"===l.nodeName){S-=1;break}_=l,S=_.childNodes.length}for(;(l=T.firstChild)&&l.nodeType===w&&"BR"!==l.nodeName;)T=l;for(m=_.childNodes[S]||null;(l=t.firstChild)&&a(l);)_.insertBefore(l,m);for(;(l=t.lastChild)&&a(l);)T.insertBefore(l,T.firstChild),E+=1;for(u=t;u=h(u,n);)y(u,n);if(B.insertBefore(t,N),g=C.nextSibling,u=c(g,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);if(C.parentNode||(C=g.previousSibling),_.parentNode||(_=C||g.parentNode,S=C?C.childNodes.length:0),d(g)&&x(g,n),f=N.previousSibling,u=s(N)?N:h(N,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);N.parentNode||(N=f.nextSibling),E||(T=f,E=f.childNodes.length),N&&d(N)&&x(N,n),e.setStart(_,S),e.setEnd(T,E),Rt(e)}},Dt=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(Z,o)>-1,r=e.compareBoundaryPoints(K,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(q,o)<1,s=e.compareBoundaryPoints(G,o)>-1;return a&&s},Rt=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o],t&&!i(t));)n=t,o=0;if(a)for(;r.nodeType!==F;){if(t=r.childNodes[a-1],!t||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=v(r)}else for(;r.nodeType!==F&&(t=r.firstChild,t&&!i(t));)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Ut=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=vt.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==v(s))break;i=s.parentNode,d=vt.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},Pt=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=kt(o,e.startOffset),n=h(n,t)),n&&Dt(e,n,!0)?n:null},It=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(n=Bt(i,e.endOffset),!n||!g(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Dt(e,n,!0)?n:null},wt=new n(null,z|W,function(e){return e.nodeType===F?mt.test(e.data):"IMG"===e.nodeName}),Ft=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(wt.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Bt(o,i),n&&!g(t,n)&&(n=null),!n&&(n=kt(o,i),n.nodeType===F&&n.length))return!1;return wt.currentNode=n,wt.root=Pt(e,t),!wt.previousNode()},Mt=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(wt.root=null,o.nodeType===F){if(n=o.data.length,n&&n>i)return!1;wt.currentNode=o}else wt.currentNode=kt(o,i);return wt.root=It(e,t),!wt.nextNode()},Ht=function(e,t){var n,o=Pt(e,t),i=It(e,t);o&&i&&(n=o.parentNode,e.setStart(n,vt.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,vt.call(n.childNodes,i)+1))},Wt={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},zt=function(e){var t=e.keyCode,n=Wt[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),at&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),At(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},qt=function(e){return function(t,n){n.preventDefault(),t[e]()}},Kt=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Gt=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===Y);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,vt.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),y(n,e._root),Rt(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(i){e.didError(i)}},Zt={enter:function(e,t,n){var o,i,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),On(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||At(n,a),o=Pt(n,a),!o||/^T[HD]$/.test(o.nodeName))return i=p(n.endContainer,a,"A"),i&&(i=i.parentNode,Ut(n,i,i,a),n.collapse(!1)),xt(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=p(o,a,"LI"))&&(o=i),!o.textContent){if(p(o,a,"UL")||p(o,a,"OL"))return e.modifyBlocks(Ln,n);if(p(o,a,"BLOCKQUOTE"))return e.modifyBlocks(Tn,n)}for(r=_n(e,o,n.startContainer,n.startOffset),mn(o),nn(o),y(o,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===Y)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling,s&&"BR"!==s.nodeName);)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!at)break;r=d}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ft(n,o)){t.preventDefault();var i,r=Pt(n,o);if(!r)return;if(T(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void N(i);for(B(i,r,n),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&x(r,o),e.setSelection(n)}else if(r){if(p(r,o,"UL")||p(r,o,"OL"))return e.modifyBlocks(Ln,n);if(p(r,o,"BLOCKQUOTE"))return e.modifyBlocks(yn,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Gt(e)},0);else t.preventDefault(),At(n,o),Gt(e,n)},"delete":function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Mt(n,l)){if(t.preventDefault(),o=Pt(n,l),!o)return;if(T(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void N(i);for(B(o,i,n),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&x(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),Ut(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s],d&&"IMG"===d.nodeName))return t.preventDefault(),N(d),Rt(n),void Gt(e,n);e.setSelection(r),setTimeout(function(){Gt(e)},0)}else t.preventDefault(),At(n,l),Gt(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&Ft(n,r))for(o=Pt(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.modifyBlocks(xn,n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&Ft(n,i)&&(o=n.startContainer,(p(o,i,"UL")||p(o,i,"OL"))&&(t.preventDefault(),e.modifyBlocks(Ln,n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),On(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===v(o)?n.setStartAfter(i):n.collapsed||(At(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};nt&&it&&(Zt["meta-left"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Zt["meta-right"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),nt||(Zt.pageup=function(e){e.moveCursorToStart()},Zt.pagedown=function(e){e.moveCursorToEnd()}),Zt[ct+"b"]=Kt("B"),Zt[ct+"i"]=Kt("I"),Zt[ct+"u"]=Kt("U"),Zt[ct+"shift-7"]=Kt("S"),Zt[ct+"shift-5"]=Kt("SUB",{tag:"SUP"}),Zt[ct+"shift-6"]=Kt("SUP",{tag:"SUB"}),Zt[ct+"shift-8"]=qt("makeUnorderedList"),Zt[ct+"shift-9"]=qt("makeOrderedList"),Zt[ct+"["]=qt("decreaseQuoteLevel"),Zt[ct+"]"]=qt("increaseQuoteLevel"),Zt[ct+"y"]=qt("redo"),Zt[ct+"z"]=qt("undo"),Zt[ct+"shift-z"]=qt("redo");var jt={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Qt={backgroundColor:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":j,style:"background-color:"+t})}},color:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":Q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return S(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return S(e,"I")}},fontFamily:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":$,style:"font-family:"+t})}},fontSize:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":V,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return S(e,"U")}}},$t=function(e){return function(t,n){var o=S(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(_(t)),o}},Vt=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in Qt)o=Qt[n],i=d[n],i&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(_(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Yt={P:Vt,SPAN:Vt,STRONG:$t("B"),EM:$t("I"),INS:$t("U"),STRIKE:$t("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=S(c,"SPAN",{"class":$,style:"font-family:"+s}),a=n,r=n),d&&(o=S(c,"SPAN",{"class":V,style:"font-size:"+jt[d]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=S(c,"SPAN",{"class":Q,style:"color:"+l}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=S(c,"SPAN")),t.replaceChild(a,e),r.appendChild(_(e)),r},TT:function(e,t){var n=S(e.ownerDocument,"SPAN",{"class":$,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(_(e)),n}},Xt=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Jt=/^(?:HEAD|META|STYLE)/,en=new n(null,z|W,function(){return!0}),tn=function Un(e,t){var n,o,i,r,s,d,l,c,h,u,f,p,g=e.childNodes;for(n=e;a(n);)n=n.parentNode;for(en.root=n,o=0,i=g.length;i>o;o+=1)if(r=g[o],s=r.nodeName,d=r.nodeType,l=Yt[s],d===w){if(c=r.childNodes.length,l)r=l(r,e);else{if(Jt.test(s)){e.removeChild(r),o-=1,i-=1;continue}if(!Xt.test(s)&&!a(r)){o-=1,i+=c-1,e.replaceChild(_(r),r);continue}}c&&Un(r,t||"PRE"===s)}else{if(d===F){if(f=r.data,h=!mt.test(f.charAt(0)),u=!mt.test(f.charAt(f.length-1)),t||!h&&!u)continue;if(h){for(en.currentNode=r;(p=en.previousPONode())&&(s=p.nodeName,!("IMG"===s||"#text"===s&&mt.test(p.data)));)if(!a(p)){p=null;break}f=f.replace(/^[ \t\r\n]+/g,p?" ":"")}if(u){for(en.currentNode=r;(p=en.nextNode())&&!("IMG"===s||"#text"===s&&mt.test(p.data));)if(!a(p)){p=null;break}f=f.replace(/[ \t\r\n]+$/g,p?" ":"")}if(f){r.data=f;continue}}e.removeChild(r),o-=1,i-=1}return e},nn=function Pn(e){for(var t,n=e.childNodes,o=n.length;o--;)t=n[o],t.nodeType!==w||i(t)?t.nodeType!==F||t.data||e.removeChild(t):(Pn(t),a(t)&&!t.firstChild&&e.removeChild(t))},on=function(e){return e.nodeType===w?"BR"===e.nodeName:mt.test(e.data)},rn=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,W|z,on),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},an=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;l>o;o+=1)d[o]=rn(s[o],n);for(;l--;)i=s[l],r=i.parentNode,r&&(d[l]?a(r)||T(r,t):N(i))},sn=function(e,t,n){var o,i,r=t.ownerDocument.body;an(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,ot&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},dn=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),st||tt||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,i=At(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}this.setSelection(l)},ln=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!st&&!tt&&d){for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,l=l.cloneRange(),Rt(l),Ut(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}},cn=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(!st&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!st&&i&&(vt.call(i,"text/html")>-1||!it&&vt.call(i,"text/plain")>-1&&vt.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,C=p.endOffset,_=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(_),p.selectNodeContents(_),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=_;_=o;)o=_.nextSibling,N(_),e=_.firstChild,e&&e===_.lastChild&&"DIV"===e.nodeName&&(_=e),n+=_.innerHTML;t=u._createRange(g,m,v,C),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(i){u.didError(i)}},0)},hn=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},un=O.prototype,fn=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};un.setConfig=function(e){return e=A({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:_t,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?fn:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},un.createElement=function(e,t,n){return S(this._doc,e,t,n)},un.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},un.didError=function(e){console.log(e)},un.getDocument=function(){return this._doc},un.getRoot=function(){return this._root},un.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var pn={pathChange:1,select:1,input:1,undoStateChange:1};un.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(a){a.details="Squire: fireEvent error. Event type: "+e,this.didError(a)}}return this},un.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},un.handleEvent=function(e){this.fireEvent(e.type,e)},un.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],pn[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},un.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],pn[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},un._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},un.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=Y,xt(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),k(n,e)),o},un._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Rt(n),this.setSelection(n),this},un.moveCursorToStart=function(){return this._moveCursorTo(!0)},un.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var gn=function(e){return e._win.getSelection()||null};un.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(et&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{tt&&this._win.focus();var t=gn(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},un.getSelection=function(){var e,t,n,o=gn(this),r=this._root;return this._isFocused&&o&&o.rangeCount&&(e=o.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&g(r,e.commonAncestorContainer)?this._lastSelection=e:e=this._lastSelection,e||(e=this._createRange(r.firstChild,0)),e},un.getSelectedText=function(){var e,t=this.getSelection(),o=new n(t.commonAncestorContainer,z|W,function(e){return Dt(t,e,!0)}),i=t.startContainer,r=t.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(e=s.data,e&&/\S/.test(e)&&(s===r&&(e=e.slice(0,t.endOffset)),s===i&&(e=e.slice(t.startOffset)),d+=e,l=!0)):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},un.getPath=function(){return this._path};var mn=function(e,t){for(var o,i,r,s=new n(e,z,function(){return!0},!1);i=s.nextNode();)for(;(r=i.data.indexOf(Y))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o;while(a(i)&&!v(i));break}i.deleteData(r,1)}};un._didAddZWS=function(){this._hasZWS=!0},un._removeZWS=function(){this._hasZWS&&(mn(this._root),this._hasZWS=!1)},un._updatePath=function(e,t){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?m(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),e.collapsed||this.fireEvent("select")},un._updatePathOnEvent=function(){var e=this;e._willUpdatePath||(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))},un.focus=function(){return this._root.focus(),lt&&this.fireEvent("focus"),this},un.blur=function(){return this._root.blur(),lt&&this.fireEvent("blur"),this};var vn="squire-selection-start",Nn="squire-selection-end";un._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:vn,type:"hidden"}),o=this.createElement("INPUT",{id:Nn,type:"hidden"});xt(e,n),e.collapse(!1),xt(e,o),n.compareDocumentPosition(o)&I&&(n.id=Nn,o.id=vn,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},un._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+vn),o=t.querySelector("#"+Nn);if(n&&o){var i=n.parentNode,r=o.parentNode,a=vt.call(i.childNodes,n),s=vt.call(r.childNodes,o);i===r&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),k(i,e),i!==r&&k(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},un._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||this._docWasChanged()},un._docWasChanged=function(){if(gt&&(Et=new WeakMap),!this._ignoreAllChanges){if(pt&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")
}},un._recordUndoState=function(e){if(!this._isInUndoState){var t,n=this._undoIndex+=1,o=this._undoStack,i=this._config.undo,r=i.documentSizeThreshold,a=i.undoLimit;n<this._undoStackLength&&(o.length=this._undoStackLength=n),e&&this._saveRangeToBookmark(e),t=this._getHTML(),r>-1&&2*t.length>r&&a>-1&&n>a&&(o.splice(0,n-a),n=this._undoIndex=a,this._undoStackLength=a),o[n]=t,this._undoStackLength+=1,this._isInUndoState=!0}},un.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e),this._getRangeAndRemoveBookmark(e)),this},un.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},un.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(t>e+1&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:t>e+2}),this.fireEvent("input")}return this},un.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(p(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,z,function(e){return Dt(o,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!p(r,a,e,t))return!1;d=!0}return d},un.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);4>a&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},un._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f,g=this._root;if(o.collapsed){for(i=y(this.createElement(e,t),g),xt(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),f=i;a(f);)f=f.parentNode;mn(f,i)}else{if(r=new n(o.commonAncestorContainer,z|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Dt(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do h=r.currentNode,u=!p(h,g,e,t),u&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),C(h,i),i.appendChild(h));while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},un._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(ut?(i=r.createTextNode(Y),this._didAddZWS()):i=r.createTextNode(""),xt(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],p=function(e,t){if(!Dt(n,e,!1)){var o,i,r=e.nodeType===F;if(!Dt(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,p(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Dt(n,o,!0)&&f(o,e,t)});return o||g.forEach(function(e){p(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,_(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),k(s,n),n},un.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged(),this):this};var Cn={DT:"DD",DD:"DT",LI:"LI"},_n=function(e,t,n,o){var i=Cn[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),f(a,i,r)||(t=S(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(_(a)),a=t),a};un.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Pt(n,o),r=It(n,o);if(i&&r)do if(e(i)||i===r)break;while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged()),this},un.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(t):this._recordUndoState(t);var n,o=this._root;return Ht(t,o),Ut(t,o,o,o),n=Lt(t,o,o),xt(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&x(t.endContainer.childNodes[t.endOffset],o),x(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),pt||this._docWasChanged(),this};var Sn=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},yn=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!p(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,_(e))}),e},Tn=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:vn,type:"hidden"}),this.createElement("INPUT",{id:Nn,type:"hidden"})])},bn=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(_(o)),s.currentNode=a):(o=o.parentNode,i=o.nodeName,i!==n&&/^[OU]L$/.test(i)&&C(o,e.createElement(n,c,[_(o)])))},En=function(e){return bn(this,e,"UL"),e},kn=function(e){return bn(this,e,"OL"),e},Bn=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;n>t;t+=1)o=a[t],i=_(o),T(i,l),C(o,i);for(t=0,n=d.length;n>t;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([_(r)])):(T(r,l),C(r,_(r)));return e},xn=function(e){var t,n,o,i,r,a,s=e.querySelectorAll("LI"),l=this._config.tagAttributes;for(t=0,n=s.length;n>t;t+=1)o=s[t],d(o.firstChild)||(i=o.parentNode.nodeName,r=o.previousSibling,r&&(r=r.lastChild)&&r.nodeName===i||(a=l[i.toLowerCase()],r=this.createElement(i,a),C(o,r)),r.appendChild(o));return e},Ln=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!d(e.firstChild)}).forEach(function(n){var o,i=n.parentNode,r=i.parentNode,a=n.firstChild,s=a;if(n.previousSibling&&(i=b(i,n,r,t)),/^[OU]L$/.test(r.nodeName))r.insertBefore(n,i),i.firstChild||r.removeChild(i);else for(;s&&(o=s.nextSibling,!d(s));)r.insertBefore(s,i),s=o;for("LI"===r.nodeName&&a.previousSibling&&b(r,a,r.parentNode,t);n!==e&&!n.childNodes.length;)i=n.parentNode,i.removeChild(n),n=i},this),T(e,t),e};un._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},un.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},un._getHTML=function(){return this._root.innerHTML},un._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do y(n,t);while(n=h(n,t));this._ignoreChange=!0},un.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ht)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ht)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},un.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(_(t))),tn(n),an(n,a,!1),T(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},un.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))xt(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=Pt(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Rt(t)}return this.focus(),this.setSelection(t),this._updatePath(t),pt||this._docWasChanged(),this},un.insertImage=function(e,t){var n=this.createElement("IMG",A({src:e},t,!0));return this.insertElement(n),n};var An=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,On=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,z,function(e){return!p(e,t,"A")},!1),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=An.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",A({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};un.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("<!--StartFragment-->"),o=e.lastIndexOf("<!--EndFragment-->"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(_(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},On(r,r,this),tn(r),an(r,a,!1),nn(r),r.normalize();s=h(s,r);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Ot(u,d.fragment,a),pt||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(p){this.didError(p)}return this};var Dn=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};un.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Dn(l[n])+'"';for(h+=">",o=0,i=a.length;i>o;o+=1)r=a[o],r=Dn(r).replace(/ (?= )/g,"&nbsp;"),o&&i>o+1&&(r=h+(r||"<BR>")+c),a[o]=r;return this.insertHTML(a.join(""),t)};var Rn=function(e,t,n){return function(){return this[e](t,n),this.focus()}};un.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},un.bold=Rn("changeFormat",{tag:"B"}),un.italic=Rn("changeFormat",{tag:"I"}),un.underline=Rn("changeFormat",{tag:"U"}),un.strikethrough=Rn("changeFormat",{tag:"S"}),un.subscript=Rn("changeFormat",{tag:"SUB"},{tag:"SUP"}),un.superscript=Rn("changeFormat",{tag:"SUP"},{tag:"SUB"}),un.removeBold=Rn("changeFormat",null,{tag:"B"}),un.removeItalic=Rn("changeFormat",null,{tag:"I"}),un.removeUnderline=Rn("changeFormat",null,{tag:"U"}),un.removeStrikethrough=Rn("changeFormat",null,{tag:"S"}),un.removeSubscript=Rn("changeFormat",null,{tag:"SUB"}),un.removeSuperscript=Rn("changeFormat",null,{tag:"SUP"}),un.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;xt(n,this._doc.createTextNode(e.slice(o)))}return t=A(A({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},un.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},un.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":$,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{"class":$}}),this.focus()},un.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":V,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{"class":V}}),this.focus()},un.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{"class":Q}}),this.focus()},un.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":j,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{"class":j}}),this.focus()},un.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},un.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},un.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Ht(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),Ut(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return P(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=vt.call(i,p),c=vt.call(i,o)+1):(d=vt.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),k(n,e),Rt(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},un.increaseQuoteLevel=Rn("modifyBlocks",Sn),un.decreaseQuoteLevel=Rn("modifyBlocks",yn),un.makeUnorderedList=Rn("modifyBlocks",En),un.makeOrderedList=Rn("modifyBlocks",kn),un.removeList=Rn("modifyBlocks",Bn),un.increaseListLevel=Rn("modifyBlocks",xn),un.decreaseListLevel=Rn("modifyBlocks",Ln),O.isInline=a,O.isBlock=s,O.isContainer=d,O.getBlockWalker=l,O.getPreviousBlock=c,O.getNextBlock=h,O.areAlike=u,O.hasTagAttributes=f,O.getNearest=p,O.isOrContains=g,O.detach=N,O.replaceWith=C,O.empty=_,O.getNodeBefore=kt,O.getNodeAfter=Bt,O.insertNodeInRange=xt,O.extractContentsOfRange=Lt,O.deleteContentsOfRange=At,O.insertTreeFragmentIntoRange=Ot,O.isNodeContainedInRange=Dt,O.moveRangeBoundariesDownTree=Rt,O.moveRangeBoundariesUpTree=Ut,O.getStartBlockOfRange=Pt,O.getEndBlockOfRange=It,O.contentWalker=wt,O.rangeDoesStartAtBlockBoundary=Ft,O.rangeDoesEndAtBlockBoundary=Mt,O.expandRangeToBlockBoundaries=Ht,O.onPaste=cn,O.addLinks=On,O.splitBlock=_n,O.startSelectionId=vn,O.endSelectionId=Nn,"object"==typeof exports?module.exports=O:"function"==typeof define&&define.amd?define(function(){return O}):(X.Squire=O,top!==X&&"true"===e.documentElement.getAttribute("data-squireinit")&&(X.editor=new O(e),X.onEditorLoad&&(X.onEditorLoad(X.editor),X.onEditorLoad=null)))}(document);
>>>>>>> 283a7d1... Don't consider editor focused if sub-element focused
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!_t[e.nodeName]}function r(e){switch(e.nodeType){case F:return yt;case w:case H:if(gt&&Et.has(e))return Et.get(e);break;default:return St}var t;return t=o(e.childNodes,a)?Ct.test(e.nodeName)?yt:Tt:bt,gt&&Et.set(e,t),t}function a(e){return r(e)===yt}function s(e){return r(e)===Tt}function d(e){return r(e)===bt}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function f(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function p(e,t,n,o){for(;e&&e!==t;){if(f(e,n,o))return e;e=e.parentNode}return null}function g(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function m(e,t){var n,o,i,r,a="";return e&&e!==t&&(a=m(e.parentNode,t),e.nodeType===w&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(r=e.dir)&&(a+="[dir="+r+"]"),i&&(vt.call(i,j)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),vt.call(i,Q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),vt.call(i,$)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),vt.call(i,V)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function v(e){var t=e.nodeType;return t===w?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function _(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function S(e,n,o,i){var r,a,s,d,l=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)a=o[r],a!==t&&l.setAttribute(r,o[r]);if(i)for(s=0,d=i.length;d>s;s+=1)l.appendChild(i[s]);return l}function y(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;ut&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(ut?(n=s.createTextNode(Y),r._didAddZWS()):n=s.createTextNode(""))}else if(ht){for(;e.nodeType!==F&&!i(e);){if(o=e.firstChild,!o){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=S(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(l){r.didError({name:"Squire: fixCursor – "+l,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function T(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;o>n;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=S(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=S(l,h.blockTag,h.blockAttributes)),y(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&T(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&p(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),y(e,o),y(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function E(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&u(n,o)&&!_t[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=v(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=v(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=v(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=v(o))),N(n),n.nodeType===F?o.appendData(n.data):d.push(_(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());E(n,t)}}function k(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};E(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function B(e,t,n){for(var o,i,r=t;1===r.parentNode.childNodes.length;)r=r.parentNode;N(r),i=e.childNodes.length,o=e.lastChild,o&&"BR"===o.nodeName&&(e.removeChild(o),i-=1),e.appendChild(_(t)),n.setStart(e,i),n.collapse(!0),k(e,n),at&&(o=e.lastChild)&&"BR"===o.nodeName&&e.removeChild(o)}function L(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&u(i,e)){if(!d(i)){if(!s)return;o=S(a,"DIV"),o.appendChild(_(i)),i.appendChild(o)}N(e),n=!d(e),i.appendChild(_(e)),n&&T(i,t),r&&L(r,t)}else s&&(i=S(a,"DIV"),e.insertBefore(i,r),y(i,t))}function x(e){this.isShiftDown=e.shiftKey}function A(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?A(e[o],i,n):i);return e}function O(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,ft&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,pt?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",R),this.addEventListener("mousedown",D),this.addEventListener("touchstart",D),this.addEventListener("focus",U),this._awaitingPaste=!1,this.addEventListener(rt?"beforecut":"cut",dn),this.addEventListener("copy",ln),this.addEventListener("keydown",x),this.addEventListener("keyup",x),this.addEventListener(rt?"beforepaste":"paste",cn),this.addEventListener("drop",hn),this.addEventListener(at?"keypress":"keydown",zt),this._keyHandlers=Object.create(Zt),this.setConfig(t),rt&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(r){}e.__squire__=this,this.setHTML("")}function R(){this._restoreSelection=!0}function D(){this._restoreSelection=!1}function U(){this._restoreSelection&&this.setSelection(this._lastSelection)}function P(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([P(e,o,e._doc.createDocumentFragment())]));continue}P(e,o,n)}return n}var I=2,w=1,F=3,M=9,H=11,W=1,z=4,q=0,K=1,G=2,Z=3,j="highlight",Q="colour",$="font",V="size",Y="​",X=e.defaultView,J=navigator.userAgent,et=/Android/.test(J),tt=/iP(?:ad|hone|od)/.test(J),nt=/Mac OS X/.test(J),ot=/Windows NT/.test(J),it=/Gecko\//.test(J),rt=/Trident\/[456]\./.test(J),at=!!X.opera,st=/Edge\//.test(J),dt=!st&&/WebKit\//.test(J),lt=/Trident\/[4567]\./.test(J),ct=nt?"meta-":"ctrl-",ht=rt||at,ut=rt||dt,ft=rt,pt="undefined"!=typeof MutationObserver,gt="undefined"!=typeof WeakMap,mt=/[^ \t\r\n]/,vt=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Nt={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)e=t.nextSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)e=t.previousSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var Ct=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,_t={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},St=0,yt=1,Tt=2,bt=3,Et=gt?new WeakMap:null,kt=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Bt=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Lt=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=vt.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=vt.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},xt=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?vt.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,d.appendData(l.data),N(l)),e.setStart(o,i),e.collapse(!0),y(t,n),u},At=function(e,t){var n,o,i=Pt(e,t),r=It(e,t),a=i!==r;return Dt(e),Ut(e,i,r,t),n=xt(e,null,t),Dt(e),a&&(r=It(e,t),i&&r&&i!==r&&B(i,r,e)),i&&y(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},Ot=function(e,t,n){for(var o=!0,i=t.childNodes,r=i.length;r--;)if(!a(i[r])){o=!1;break}if(e.collapsed||At(e,n),Dt(e),o)Lt(e,t),e.startContainer!==e.endContainer&&k(e.endContainer,e),k(e.startContainer,e),e.collapse(!1);else{for(var l,u,f,g,m,v=e.startContainer,N=b(v,e.startOffset,p(v.parentNode,n,"BLOCKQUOTE")||n,n),C=N.previousSibling,_=C,S=_.childNodes.length,T=N,E=0,B=N.parentNode;(l=_.lastChild)&&l.nodeType===w;){if("BR"===l.nodeName){S-=1;break}_=l,S=_.childNodes.length}for(;(l=T.firstChild)&&l.nodeType===w&&"BR"!==l.nodeName;)T=l;for(m=_.childNodes[S]||null;(l=t.firstChild)&&a(l);)_.insertBefore(l,m);for(;(l=t.lastChild)&&a(l);)T.insertBefore(l,T.firstChild),E+=1;for(u=t;u=h(u,n);)y(u,n);if(B.insertBefore(t,N),g=C.nextSibling,u=c(g,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);if(C.parentNode||(C=g.previousSibling),_.parentNode||(_=C||g.parentNode,S=C?C.childNodes.length:0),d(g)&&L(g,n),f=N.previousSibling,u=s(N)?N:h(N,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);N.parentNode||(N=f.nextSibling),E||(T=f,E=f.childNodes.length),N&&d(N)&&L(N,n),e.setStart(_,S),e.setEnd(T,E),Dt(e)}},Rt=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(Z,o)>-1,r=e.compareBoundaryPoints(K,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(q,o)<1,s=e.compareBoundaryPoints(G,o)>-1;return a&&s},Dt=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o],t&&!i(t));)n=t,o=0;if(a)for(;r.nodeType!==F;){if(t=r.childNodes[a-1],!t||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=v(r)}else for(;r.nodeType!==F&&(t=r.firstChild,t&&!i(t));)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Ut=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=vt.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==v(s))break;i=s.parentNode,d=vt.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},Pt=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=kt(o,e.startOffset),n=h(n,t)),n&&Rt(e,n,!0)?n:null},It=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(n=Bt(i,e.endOffset),!n||!g(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Rt(e,n,!0)?n:null},wt=new n(null,z|W,function(e){return e.nodeType===F?mt.test(e.data):"IMG"===e.nodeName}),Ft=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(wt.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Bt(o,i),n&&!g(t,n)&&(n=null),!n&&(n=kt(o,i),n.nodeType===F&&n.length))return!1;return wt.currentNode=n,wt.root=Pt(e,t),!wt.previousNode()},Mt=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(wt.root=null,o.nodeType===F){if(n=o.data.length,n&&n>i)return!1;wt.currentNode=o}else wt.currentNode=kt(o,i);return wt.root=It(e,t),!wt.nextNode()},Ht=function(e,t){var n,o=Pt(e,t),i=It(e,t);o&&i&&(n=o.parentNode,e.setStart(n,vt.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,vt.call(n.childNodes,i)+1))},Wt={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},zt=function(e){var t=e.keyCode,n=Wt[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),at&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),At(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},qt=function(e){return function(t,n){n.preventDefault(),t[e]()}},Kt=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Gt=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===Y);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,vt.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),y(n,e._root),Dt(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(i){e.didError(i)}},Zt={enter:function(e,t,n){var o,i,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),On(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||At(n,a),o=Pt(n,a),!o||/^T[HD]$/.test(o.nodeName))return i=p(n.endContainer,a,"A"),i&&(i=i.parentNode,Ut(n,i,i,a),n.collapse(!1)),Lt(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=p(o,a,"LI"))&&(o=i),!o.textContent){if(p(o,a,"UL")||p(o,a,"OL"))return e.modifyBlocks(xn,n);if(p(o,a,"BLOCKQUOTE"))return e.modifyBlocks(Tn,n)}for(r=_n(e,o,n.startContainer,n.startOffset),mn(o),nn(o),y(o,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===Y)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling,s&&"BR"!==s.nodeName);)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!at)break;r=d}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ft(n,o)){t.preventDefault();var i,r=Pt(n,o);if(!r)return;if(T(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void N(i);for(B(i,r,n),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&L(r,o),e.setSelection(n)}else if(r){if(p(r,o,"UL")||p(r,o,"OL"))return e.modifyBlocks(xn,n);if(p(r,o,"BLOCKQUOTE"))return e.modifyBlocks(yn,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Gt(e)},0);else t.preventDefault(),At(n,o),Gt(e,n)},"delete":function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Mt(n,l)){if(t.preventDefault(),o=Pt(n,l),!o)return;if(T(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void N(i);for(B(o,i,n),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&L(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),Ut(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s],d&&"IMG"===d.nodeName))return t.preventDefault(),N(d),Dt(n),void Gt(e,n);e.setSelection(r),setTimeout(function(){Gt(e)},0)}else t.preventDefault(),At(n,l),Gt(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&Ft(n,r))for(o=Pt(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.modifyBlocks(Ln,n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&Ft(n,i)&&(o=n.startContainer,(p(o,i,"UL")||p(o,i,"OL"))&&(t.preventDefault(),e.modifyBlocks(xn,n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),On(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===v(o)?n.setStartAfter(i):n.collapsed||(At(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};nt&&it&&(Zt["meta-left"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Zt["meta-right"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),nt||(Zt.pageup=function(e){e.moveCursorToStart()},Zt.pagedown=function(e){e.moveCursorToEnd()}),Zt[ct+"b"]=Kt("B"),Zt[ct+"i"]=Kt("I"),Zt[ct+"u"]=Kt("U"),Zt[ct+"shift-7"]=Kt("S"),Zt[ct+"shift-5"]=Kt("SUB",{tag:"SUP"}),Zt[ct+"shift-6"]=Kt("SUP",{tag:"SUB"}),Zt[ct+"shift-8"]=qt("makeUnorderedList"),Zt[ct+"shift-9"]=qt("makeOrderedList"),Zt[ct+"["]=qt("decreaseQuoteLevel"),Zt[ct+"]"]=qt("increaseQuoteLevel"),Zt[ct+"y"]=qt("redo"),Zt[ct+"z"]=qt("undo"),Zt[ct+"shift-z"]=qt("redo");var jt={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Qt={backgroundColor:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":j,style:"background-color:"+t})}},color:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":Q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return S(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return S(e,"I")}},fontFamily:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":$,style:"font-family:"+t})}},fontSize:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":V,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return S(e,"U")}}},$t=function(e){return function(t,n){var o=S(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(_(t)),o}},Vt=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in Qt)o=Qt[n],i=d[n],i&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(_(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Yt={P:Vt,SPAN:Vt,STRONG:$t("B"),EM:$t("I"),INS:$t("U"),STRIKE:$t("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=S(c,"SPAN",{"class":$,style:"font-family:"+s}),a=n,r=n),d&&(o=S(c,"SPAN",{"class":V,style:"font-size:"+jt[d]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=S(c,"SPAN",{"class":Q,style:"color:"+l}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=S(c,"SPAN")),t.replaceChild(a,e),r.appendChild(_(e)),r},TT:function(e,t){var n=S(e.ownerDocument,"SPAN",{"class":$,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(_(e)),n}},Xt=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Jt=/^(?:HEAD|META|STYLE)/,en=new n(null,z|W,function(){return!0}),tn=function Un(e,t){var n,o,i,r,s,d,l,c,h,u,f,p,g=e.childNodes;for(n=e;a(n);)n=n.parentNode;for(en.root=n,o=0,i=g.length;i>o;o+=1)if(r=g[o],s=r.nodeName,d=r.nodeType,l=Yt[s],d===w){if(c=r.childNodes.length,l)r=l(r,e);else{if(Jt.test(s)){e.removeChild(r),o-=1,i-=1;continue}if(!Xt.test(s)&&!a(r)){o-=1,i+=c-1,e.replaceChild(_(r),r);continue}}c&&Un(r,t||"PRE"===s)}else{if(d===F){if(f=r.data,h=!mt.test(f.charAt(0)),u=!mt.test(f.charAt(f.length-1)),t||!h&&!u)continue;if(h){for(en.currentNode=r;(p=en.previousPONode())&&(s=p.nodeName,!("IMG"===s||"#text"===s&&mt.test(p.data)));)if(!a(p)){p=null;break}f=f.replace(/^[ \t\r\n]+/g,p?" ":"")}if(u){for(en.currentNode=r;(p=en.nextNode())&&!("IMG"===s||"#text"===s&&mt.test(p.data));)if(!a(p)){p=null;break}f=f.replace(/[ \t\r\n]+$/g,p?" ":"")}if(f){r.data=f;continue}}e.removeChild(r),o-=1,i-=1}return e},nn=function Pn(e){for(var t,n=e.childNodes,o=n.length;o--;)t=n[o],t.nodeType!==w||i(t)?t.nodeType!==F||t.data||e.removeChild(t):(Pn(t),a(t)&&!t.firstChild&&e.removeChild(t))},on=function(e){return e.nodeType===w?"BR"===e.nodeName:mt.test(e.data)},rn=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,W|z,on),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},an=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;l>o;o+=1)d[o]=rn(s[o],n);for(;l--;)i=s[l],r=i.parentNode,r&&(d[l]?a(r)||T(r,t):N(i))},sn=function(e,t,n){var o,i,r=t.ownerDocument.body;an(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,ot&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},dn=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),st||tt||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,i=At(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}this.setSelection(l)},ln=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!st&&!tt&&d){for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,l=l.cloneRange(),Dt(l),Ut(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}},cn=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(!st&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!st&&i&&(vt.call(i,"text/html")>-1||!it&&vt.call(i,"text/plain")>-1&&vt.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,C=p.endOffset,_=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(_),p.selectNodeContents(_),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=_;_=o;)o=_.nextSibling,N(_),e=_.firstChild,e&&e===_.lastChild&&"DIV"===e.nodeName&&(_=e),n+=_.innerHTML;t=u._createRange(g,m,v,C),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(i){u.didError(i)}},0)},hn=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},un=O.prototype,fn=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};un.setConfig=function(e){return e=A({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:_t,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?fn:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},un.createElement=function(e,t,n){return S(this._doc,e,t,n)},un.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},un.didError=function(e){console.log(e)},un.getDocument=function(){return this._doc},un.getRoot=function(){return this._root},un.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var pn={pathChange:1,select:1,input:1,undoStateChange:1};un.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(a){a.details="Squire: fireEvent error. Event type: "+e,this.didError(a)}}return this},un.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},un.handleEvent=function(e){this.fireEvent(e.type,e)},un.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],pn[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},un.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],pn[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},un._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},un.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=Y,Lt(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),k(n,e)),o},un._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Dt(n),this.setSelection(n),this},un.moveCursorToStart=function(){return this._moveCursorTo(!0)},un.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var gn=function(e){return e._win.getSelection()||null};un.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(et&&!this._restoreSelection)R.call(this),this.blur(),this.focus();else{tt&&this._win.focus();var t=gn(this);t&&(t.removeAllRanges(),t.addRange(e))}else R.call(this);return this},un.getSelection=function(){var e,t,n,o=gn(this),r=this._root;return this._isFocused&&o&&o.rangeCount&&(e=o.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&g(r,e.commonAncestorContainer)?this._lastSelection=e:e=this._lastSelection,e||(e=this._createRange(r.firstChild,0)),e},un.getSelectedText=function(){var e,t=this.getSelection(),o=new n(t.commonAncestorContainer,z|W,function(e){return Rt(t,e,!0)}),i=t.startContainer,r=t.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(e=s.data,e&&/\S/.test(e)&&(s===r&&(e=e.slice(0,t.endOffset)),s===i&&(e=e.slice(t.startOffset)),d+=e,l=!0)):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},un.getPath=function(){return this._path};var mn=function(e,t){for(var o,i,r,s=new n(e,z,function(){return!0},!1);i=s.nextNode();)for(;(r=i.data.indexOf(Y))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o;while(a(i)&&!v(i));break}i.deleteData(r,1)}};un._didAddZWS=function(){this._hasZWS=!0},un._removeZWS=function(){this._hasZWS&&(mn(this._root),this._hasZWS=!1)},un._updatePath=function(e,t){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?m(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})},un._updatePathOnEvent=function(){var e=this;e._willUpdatePath||(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))},un.focus=function(){return this._root.focus(),lt&&this.fireEvent("focus"),this},un.blur=function(){return this._root.blur(),lt&&this.fireEvent("blur"),this};var vn="squire-selection-start",Nn="squire-selection-end";un._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:vn,type:"hidden"}),o=this.createElement("INPUT",{id:Nn,type:"hidden"});Lt(e,n),e.collapse(!1),Lt(e,o),n.compareDocumentPosition(o)&I&&(n.id=Nn,o.id=vn,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},un._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+vn),o=t.querySelector("#"+Nn);if(n&&o){var i=n.parentNode,r=o.parentNode,a=vt.call(i.childNodes,n),s=vt.call(r.childNodes,o);i===r&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),k(i,e),i!==r&&k(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},un._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||this._docWasChanged()},un._docWasChanged=function(){if(gt&&(Et=new WeakMap),!this._ignoreAllChanges){if(pt&&this._ignoreChange)return void(this._ignoreChange=!1);
this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},un._recordUndoState=function(e){if(!this._isInUndoState){var t,n=this._undoIndex+=1,o=this._undoStack,i=this._config.undo,r=i.documentSizeThreshold,a=i.undoLimit;n<this._undoStackLength&&(o.length=this._undoStackLength=n),e&&this._saveRangeToBookmark(e),t=this._getHTML(),r>-1&&2*t.length>r&&a>-1&&n>a&&(o.splice(0,n-a),n=this._undoIndex=a,this._undoStackLength=a),o[n]=t,this._undoStackLength+=1,this._isInUndoState=!0}},un.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e),this._getRangeAndRemoveBookmark(e)),this},un.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},un.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(t>e+1&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:t>e+2}),this.fireEvent("input")}return this},un.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(p(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,z,function(e){return Rt(o,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!p(r,a,e,t))return!1;d=!0}return d},un.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);4>a&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},un._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f,g=this._root;if(o.collapsed){for(i=y(this.createElement(e,t),g),Lt(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),f=i;a(f);)f=f.parentNode;mn(f,i)}else{if(r=new n(o.commonAncestorContainer,z|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Rt(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do h=r.currentNode,u=!p(h,g,e,t),u&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),C(h,i),i.appendChild(h));while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},un._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(ut?(i=r.createTextNode(Y),this._didAddZWS()):i=r.createTextNode(""),Lt(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],p=function(e,t){if(!Rt(n,e,!1)){var o,i,r=e.nodeType===F;if(!Rt(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,p(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Rt(n,o,!0)&&f(o,e,t)});return o||g.forEach(function(e){p(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,_(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),k(s,n),n},un.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged(),this):this};var Cn={DT:"DD",DD:"DT",LI:"LI"},_n=function(e,t,n,o){var i=Cn[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),f(a,i,r)||(t=S(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(_(a)),a=t),a};un.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Pt(n,o),r=It(n,o);if(i&&r)do if(e(i)||i===r)break;while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged()),this},un.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(t):this._recordUndoState(t);var n,o=this._root;return Ht(t,o),Ut(t,o,o,o),n=xt(t,o,o),Lt(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&L(t.endContainer.childNodes[t.endOffset],o),L(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),pt||this._docWasChanged(),this};var Sn=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},yn=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!p(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,_(e))}),e},Tn=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:vn,type:"hidden"}),this.createElement("INPUT",{id:Nn,type:"hidden"})])},bn=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(_(o)),s.currentNode=a):(o=o.parentNode,i=o.nodeName,i!==n&&/^[OU]L$/.test(i)&&C(o,e.createElement(n,c,[_(o)])))},En=function(e){return bn(this,e,"UL"),e},kn=function(e){return bn(this,e,"OL"),e},Bn=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;n>t;t+=1)o=a[t],i=_(o),T(i,l),C(o,i);for(t=0,n=d.length;n>t;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([_(r)])):(T(r,l),C(r,_(r)));return e},Ln=function(e){var t,n,o,i,r,a,s=e.querySelectorAll("LI"),l=this._config.tagAttributes;for(t=0,n=s.length;n>t;t+=1)o=s[t],d(o.firstChild)||(i=o.parentNode.nodeName,r=o.previousSibling,r&&(r=r.lastChild)&&r.nodeName===i||(a=l[i.toLowerCase()],r=this.createElement(i,a),C(o,r)),r.appendChild(o));return e},xn=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!d(e.firstChild)}).forEach(function(n){var o,i=n.parentNode,r=i.parentNode,a=n.firstChild,s=a;if(n.previousSibling&&(i=b(i,n,r,t)),/^[OU]L$/.test(r.nodeName))r.insertBefore(n,i),i.firstChild||r.removeChild(i);else for(;s&&(o=s.nextSibling,!d(s));)r.insertBefore(s,i),s=o;for("LI"===r.nodeName&&a.previousSibling&&b(r,a,r.parentNode,t);n!==e&&!n.childNodes.length;)i=n.parentNode,i.removeChild(n),n=i},this),T(e,t),e};un._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},un.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},un._getHTML=function(){return this._root.innerHTML},un._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do y(n,t);while(n=h(n,t));this._ignoreChange=!0},un.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ht)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ht)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},un.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(_(t))),tn(n),an(n,a,!1),T(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,R.call(this),this._updatePath(d,!0),this},un.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))Lt(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=Pt(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Dt(t)}return this.focus(),this.setSelection(t),this._updatePath(t),pt||this._docWasChanged(),this},un.insertImage=function(e,t){var n=this.createElement("IMG",A({src:e},t,!0));return this.insertElement(n),n};var An=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,On=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,z,function(e){return!p(e,t,"A")},!1),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=An.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",A({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};un.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("<!--StartFragment-->"),o=e.lastIndexOf("<!--EndFragment-->"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(_(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},On(r,r,this),tn(r),an(r,a,!1),nn(r),r.normalize();s=h(s,r);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Ot(u,d.fragment,a),pt||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(p){this.didError(p)}return this};var Rn=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};un.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Rn(l[n])+'"';for(h+=">",o=0,i=a.length;i>o;o+=1)r=a[o],r=Rn(r).replace(/ (?= )/g,"&nbsp;"),o&&i>o+1&&(r=h+(r||"<BR>")+c),a[o]=r;return this.insertHTML(a.join(""),t)};var Dn=function(e,t,n){return function(){return this[e](t,n),this.focus()}};un.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},un.bold=Dn("changeFormat",{tag:"B"}),un.italic=Dn("changeFormat",{tag:"I"}),un.underline=Dn("changeFormat",{tag:"U"}),un.strikethrough=Dn("changeFormat",{tag:"S"}),un.subscript=Dn("changeFormat",{tag:"SUB"},{tag:"SUP"}),un.superscript=Dn("changeFormat",{tag:"SUP"},{tag:"SUB"}),un.removeBold=Dn("changeFormat",null,{tag:"B"}),un.removeItalic=Dn("changeFormat",null,{tag:"I"}),un.removeUnderline=Dn("changeFormat",null,{tag:"U"}),un.removeStrikethrough=Dn("changeFormat",null,{tag:"S"}),un.removeSubscript=Dn("changeFormat",null,{tag:"SUB"}),un.removeSuperscript=Dn("changeFormat",null,{tag:"SUP"}),un.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;Lt(n,this._doc.createTextNode(e.slice(o)))}return t=A(A({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},un.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},un.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":$,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{"class":$}}),this.focus()},un.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":V,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{"class":V}}),this.focus()},un.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{"class":Q}}),this.focus()},un.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":j,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{"class":j}}),this.focus()},un.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},un.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},un.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Ht(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),Ut(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return P(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=vt.call(i,p),c=vt.call(i,o)+1):(d=vt.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),k(n,e),Dt(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},un.increaseQuoteLevel=Dn("modifyBlocks",Sn),un.decreaseQuoteLevel=Dn("modifyBlocks",yn),un.makeUnorderedList=Dn("modifyBlocks",En),un.makeOrderedList=Dn("modifyBlocks",kn),un.removeList=Dn("modifyBlocks",Bn),un.increaseListLevel=Dn("modifyBlocks",Ln),un.decreaseListLevel=Dn("modifyBlocks",xn),O.isInline=a,O.isBlock=s,O.isContainer=d,O.getBlockWalker=l,O.getPreviousBlock=c,O.getNextBlock=h,O.areAlike=u,O.hasTagAttributes=f,O.getNearest=p,O.isOrContains=g,O.detach=N,O.replaceWith=C,O.empty=_,O.getNodeBefore=kt,O.getNodeAfter=Bt,O.insertNodeInRange=Lt,O.extractContentsOfRange=xt,O.deleteContentsOfRange=At,O.insertTreeFragmentIntoRange=Ot,O.isNodeContainedInRange=Rt,O.moveRangeBoundariesDownTree=Dt,O.moveRangeBoundariesUpTree=Ut,O.getStartBlockOfRange=Pt,O.getEndBlockOfRange=It,O.contentWalker=wt,O.rangeDoesStartAtBlockBoundary=Ft,O.rangeDoesEndAtBlockBoundary=Mt,O.expandRangeToBlockBoundaries=Ht,O.onPaste=cn,O.addLinks=On,O.splitBlock=_n,O.startSelectionId=vn,O.endSelectionId=Nn,"object"==typeof exports?module.exports=O:"function"==typeof define&&define.amd?define(function(){return O}):(X.Squire=O,top!==X&&"true"===e.documentElement.getAttribute("data-squireinit")&&(X.editor=new O(e),X.onEditorLoad&&(X.onEditorLoad(X.editor),X.onEditorLoad=null)))}(document);
>>>>>>> a8f07d9... Default to allowing URIs with unknown protocols
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!_t[e.nodeName]}function r(e){switch(e.nodeType){case F:return yt;case w:case H:if(gt&&Et.has(e))return Et.get(e);break;default:return St}var t;return t=o(e.childNodes,a)?Ct.test(e.nodeName)?yt:Tt:bt,gt&&Et.set(e,t),t}function a(e){return r(e)===yt}function s(e){return r(e)===Tt}function d(e){return r(e)===bt}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function f(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function p(e,t,n,o){for(;e&&e!==t;){if(f(e,n,o))return e;e=e.parentNode}return null}function g(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function m(e,t){var n,o,i,r,a="";return e&&e!==t&&(a=m(e.parentNode,t),e.nodeType===w&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(r=e.dir)&&(a+="[dir="+r+"]"),i&&(vt.call(i,j)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),vt.call(i,Q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),vt.call(i,$)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),vt.call(i,V)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function v(e){var t=e.nodeType;return t===w?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function _(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function S(e,n,o,i){var r,a,s,d,l=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)a=o[r],a!==t&&l.setAttribute(r,o[r]);if(i)for(s=0,d=i.length;d>s;s+=1)l.appendChild(i[s]);return l}function y(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;ut&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(ut?(n=s.createTextNode(Y),r._didAddZWS()):n=s.createTextNode(""))}else if(ht){for(;e.nodeType!==F&&!i(e);){if(o=e.firstChild,!o){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=S(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(l){r.didError({name:"Squire: fixCursor – "+l,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function T(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;o>n;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=S(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=S(l,h.blockTag,h.blockAttributes)),y(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&T(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&p(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),y(e,o),y(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function E(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&u(n,o)&&!_t[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=v(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=v(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=v(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=v(o))),N(n),n.nodeType===F?o.appendData(n.data):d.push(_(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());E(n,t)}}function k(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};E(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function B(e,t,n){for(var o,i,r=t;1===r.parentNode.childNodes.length;)r=r.parentNode;N(r),i=e.childNodes.length,o=e.lastChild,o&&"BR"===o.nodeName&&(e.removeChild(o),i-=1),e.appendChild(_(t)),n.setStart(e,i),n.collapse(!0),k(e,n),at&&(o=e.lastChild)&&"BR"===o.nodeName&&e.removeChild(o)}function L(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&u(i,e)){if(!d(i)){if(!s)return;o=S(a,"DIV"),o.appendChild(_(i)),i.appendChild(o)}N(e),n=!d(e),i.appendChild(_(e)),n&&T(i,t),r&&L(r,t)}else s&&(i=S(a,"DIV"),e.insertBefore(i,r),y(i,t))}function x(e){this.isShiftDown=e.shiftKey}function A(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?A(e[o],i,n):i);return e}function O(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,ft&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,pt?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",R),this.addEventListener("touchstart",R),this.addEventListener("focus",U),this._awaitingPaste=!1,this.addEventListener(rt?"beforecut":"cut",dn),this.addEventListener("copy",ln),this.addEventListener("keydown",x),this.addEventListener("keyup",x),this.addEventListener(rt?"beforepaste":"paste",cn),this.addEventListener("drop",hn),this.addEventListener(at?"keypress":"keydown",zt),this._keyHandlers=Object.create(Zt),this.setConfig(t),rt&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(r){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function R(){this._restoreSelection=!1}function U(){this._restoreSelection&&this.setSelection(this._lastSelection)}function P(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([P(e,o,e._doc.createDocumentFragment())]));continue}P(e,o,n)}return n}var I=2,w=1,F=3,M=9,H=11,W=1,z=4,q=0,K=1,G=2,Z=3,j="highlight",Q="colour",$="font",V="size",Y="​",X=e.defaultView,J=navigator.userAgent,et=/Android/.test(J),tt=/iP(?:ad|hone|od)/.test(J),nt=/Mac OS X/.test(J),ot=/Windows NT/.test(J),it=/Gecko\//.test(J),rt=/Trident\/[456]\./.test(J),at=!!X.opera,st=/Edge\//.test(J),dt=!st&&/WebKit\//.test(J),lt=/Trident\/[4567]\./.test(J),ct=nt?"meta-":"ctrl-",ht=rt||at,ut=rt||dt,ft=rt,pt="undefined"!=typeof MutationObserver,gt="undefined"!=typeof WeakMap,mt=/[^ \t\r\n]/,vt=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Nt={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)e=t.nextSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)e=t.previousSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var Ct=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,_t={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},St=0,yt=1,Tt=2,bt=3,Et=gt?new WeakMap:null,kt=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Bt=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Lt=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=vt.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=vt.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},xt=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?vt.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,d.appendData(l.data),N(l)),e.setStart(o,i),e.collapse(!0),y(t,n),u},At=function(e,t){var n,o,i=Pt(e,t),r=It(e,t),a=i!==r;return Rt(e),Ut(e,i,r,t),n=xt(e,null,t),Rt(e),a&&(r=It(e,t),i&&r&&i!==r&&B(i,r,e)),i&&y(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},Ot=function(e,t,n){for(var o=!0,i=t.childNodes,r=i.length;r--;)if(!a(i[r])){o=!1;break}if(e.collapsed||At(e,n),Rt(e),o)Lt(e,t),e.startContainer!==e.endContainer&&k(e.endContainer,e),k(e.startContainer,e),e.collapse(!1);else{for(var l,u,f,g,m,v=e.startContainer,N=b(v,e.startOffset,p(v.parentNode,n,"BLOCKQUOTE")||n,n),C=N.previousSibling,_=C,S=_.childNodes.length,T=N,E=0,B=N.parentNode;(l=_.lastChild)&&l.nodeType===w;){if("BR"===l.nodeName){S-=1;break}_=l,S=_.childNodes.length}for(;(l=T.firstChild)&&l.nodeType===w&&"BR"!==l.nodeName;)T=l;for(m=_.childNodes[S]||null;(l=t.firstChild)&&a(l);)_.insertBefore(l,m);for(;(l=t.lastChild)&&a(l);)T.insertBefore(l,T.firstChild),E+=1;for(u=t;u=h(u,n);)y(u,n);if(B.insertBefore(t,N),g=C.nextSibling,u=c(g,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);if(C.parentNode||(C=g.previousSibling),_.parentNode||(_=C||g.parentNode,S=C?C.childNodes.length:0),d(g)&&L(g,n),f=N.previousSibling,u=s(N)?N:h(N,n),u&&!/\S/.test(u.textContent))do B=u.parentNode,B.removeChild(u),u=B;while(u&&!u.lastChild&&u!==n);N.parentNode||(N=f.nextSibling),E||(T=f,E=f.childNodes.length),N&&d(N)&&L(N,n),e.setStart(_,S),e.setEnd(T,E),Rt(e)}},Dt=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(Z,o)>-1,r=e.compareBoundaryPoints(K,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(q,o)<1,s=e.compareBoundaryPoints(G,o)>-1;return a&&s},Rt=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o],t&&!i(t));)n=t,o=0;if(a)for(;r.nodeType!==F;){if(t=r.childNodes[a-1],!t||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=v(r)}else for(;r.nodeType!==F&&(t=r.firstChild,t&&!i(t));)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Ut=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=vt.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==v(s))break;i=s.parentNode,d=vt.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},Pt=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=kt(o,e.startOffset),n=h(n,t)),n&&Dt(e,n,!0)?n:null},It=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(n=Bt(i,e.endOffset),!n||!g(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Dt(e,n,!0)?n:null},wt=new n(null,z|W,function(e){return e.nodeType===F?mt.test(e.data):"IMG"===e.nodeName}),Ft=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(wt.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Bt(o,i),n&&!g(t,n)&&(n=null),!n&&(n=kt(o,i),n.nodeType===F&&n.length))return!1;return wt.currentNode=n,wt.root=Pt(e,t),!wt.previousNode()},Mt=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(wt.root=null,o.nodeType===F){if(n=o.data.length,n&&n>i)return!1;wt.currentNode=o}else wt.currentNode=kt(o,i);return wt.root=It(e,t),!wt.nextNode()},Ht=function(e,t){var n,o=Pt(e,t),i=It(e,t);o&&i&&(n=o.parentNode,e.setStart(n,vt.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,vt.call(n.childNodes,i)+1))},Wt={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},zt=function(e){var t=e.keyCode,n=Wt[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),at&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),At(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},qt=function(e){return function(t,n){n.preventDefault(),t[e]()}},Kt=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Gt=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===Y);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,vt.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),y(n,e._root),Rt(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(i){e.didError(i)}},Zt={enter:function(e,t,n){var o,i,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),On(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||At(n,a),o=Pt(n,a),!o||/^T[HD]$/.test(o.nodeName))return i=p(n.endContainer,a,"A"),i&&(i=i.parentNode,Ut(n,i,i,a),n.collapse(!1)),Lt(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=p(o,a,"LI"))&&(o=i),!o.textContent){if(p(o,a,"UL")||p(o,a,"OL"))return e.modifyBlocks(xn,n);if(p(o,a,"BLOCKQUOTE"))return e.modifyBlocks(Tn,n)}for(r=_n(e,o,n.startContainer,n.startOffset),mn(o),nn(o),y(o,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===Y)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling,s&&"BR"!==s.nodeName);)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!at)break;r=d}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ft(n,o)){t.preventDefault();var i,r=Pt(n,o);if(!r)return;if(T(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void N(i);for(B(i,r,n),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&L(r,o),e.setSelection(n)}else if(r){if(p(r,o,"UL")||p(r,o,"OL"))return e.modifyBlocks(xn,n);if(p(r,o,"BLOCKQUOTE"))return e.modifyBlocks(yn,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Gt(e)},0);else t.preventDefault(),At(n,o),Gt(e,n)},"delete":function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Mt(n,l)){if(t.preventDefault(),o=Pt(n,l),!o)return;if(T(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void N(i);for(B(o,i,n),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&L(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),Ut(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s],d&&"IMG"===d.nodeName))return t.preventDefault(),N(d),Rt(n),void Gt(e,n);e.setSelection(r),setTimeout(function(){Gt(e)},0)}else t.preventDefault(),At(n,l),Gt(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&Ft(n,r))for(o=Pt(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.modifyBlocks(Ln,n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&Ft(n,i)&&(o=n.startContainer,(p(o,i,"UL")||p(o,i,"OL"))&&(t.preventDefault(),e.modifyBlocks(xn,n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),On(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===v(o)?n.setStartAfter(i):n.collapsed||(At(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};nt&&it&&(Zt["meta-left"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Zt["meta-right"]=function(e,t){t.preventDefault();var n=gn(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),nt||(Zt.pageup=function(e){e.moveCursorToStart()},Zt.pagedown=function(e){e.moveCursorToEnd()}),Zt[ct+"b"]=Kt("B"),Zt[ct+"i"]=Kt("I"),Zt[ct+"u"]=Kt("U"),Zt[ct+"shift-7"]=Kt("S"),Zt[ct+"shift-5"]=Kt("SUB",{tag:"SUP"}),Zt[ct+"shift-6"]=Kt("SUP",{tag:"SUB"}),Zt[ct+"shift-8"]=qt("makeUnorderedList"),Zt[ct+"shift-9"]=qt("makeOrderedList"),Zt[ct+"["]=qt("decreaseQuoteLevel"),Zt[ct+"]"]=qt("increaseQuoteLevel"),Zt[ct+"y"]=qt("redo"),Zt[ct+"z"]=qt("undo"),Zt[ct+"shift-z"]=qt("redo");var jt={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Qt={backgroundColor:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":j,style:"background-color:"+t})}},color:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":Q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return S(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return S(e,"I")}},fontFamily:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":$,style:"font-family:"+t})}},fontSize:{regexp:mt,replace:function(e,t){return S(e,"SPAN",{"class":V,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return S(e,"U")}}},$t=function(e){return function(t,n){var o=S(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(_(t)),o}},Vt=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in Qt)o=Qt[n],i=d[n],i&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(_(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Yt={P:Vt,SPAN:Vt,STRONG:$t("B"),EM:$t("I"),INS:$t("U"),STRIKE:$t("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=S(c,"SPAN",{"class":$,style:"font-family:"+s}),a=n,r=n),d&&(o=S(c,"SPAN",{"class":V,style:"font-size:"+jt[d]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=S(c,"SPAN",{"class":Q,style:"color:"+l}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=S(c,"SPAN")),t.replaceChild(a,e),r.appendChild(_(e)),r},TT:function(e,t){var n=S(e.ownerDocument,"SPAN",{"class":$,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(_(e)),n}},Xt=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Jt=/^(?:HEAD|META|STYLE)/,en=new n(null,z|W,function(){return!0}),tn=function Un(e,t){var n,o,i,r,s,d,l,c,h,u,f,p,g=e.childNodes;for(n=e;a(n);)n=n.parentNode;for(en.root=n,o=0,i=g.length;i>o;o+=1)if(r=g[o],s=r.nodeName,d=r.nodeType,l=Yt[s],d===w){if(c=r.childNodes.length,l)r=l(r,e);else{if(Jt.test(s)){e.removeChild(r),o-=1,i-=1;continue}if(!Xt.test(s)&&!a(r)){o-=1,i+=c-1,e.replaceChild(_(r),r);continue}}c&&Un(r,t||"PRE"===s)}else{if(d===F){if(f=r.data,h=!mt.test(f.charAt(0)),u=!mt.test(f.charAt(f.length-1)),t||!h&&!u)continue;if(h){for(en.currentNode=r;(p=en.previousPONode())&&(s=p.nodeName,!("IMG"===s||"#text"===s&&mt.test(p.data)));)if(!a(p)){p=null;break}f=f.replace(/^[ \t\r\n]+/g,p?" ":"")}if(u){for(en.currentNode=r;(p=en.nextNode())&&!("IMG"===s||"#text"===s&&mt.test(p.data));)if(!a(p)){p=null;break}f=f.replace(/[ \t\r\n]+$/g,p?" ":"")}if(f){r.data=f;continue}}e.removeChild(r),o-=1,i-=1}return e},nn=function Pn(e){for(var t,n=e.childNodes,o=n.length;o--;)t=n[o],t.nodeType!==w||i(t)?t.nodeType!==F||t.data||e.removeChild(t):(Pn(t),a(t)&&!t.firstChild&&e.removeChild(t))},on=function(e){return e.nodeType===w?"BR"===e.nodeName:mt.test(e.data)},rn=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,W|z,on),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},an=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;l>o;o+=1)d[o]=rn(s[o],n);for(;l--;)i=s[l],r=i.parentNode,r&&(d[l]?a(r)||T(r,t):N(i))},sn=function(e,t,n){var o,i,r=t.ownerDocument.body;an(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,ot&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},dn=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),st||tt||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,i=At(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}this.setSelection(l)},ln=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!st&&!tt&&d){for(t=Pt(l,c),n=It(l,c),o=t===n&&t||c,l=l.cloneRange(),Rt(l),Ut(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),sn(d,s,c),e.preventDefault()}},cn=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(!st&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!st&&i&&(vt.call(i,"text/html")>-1||!it&&vt.call(i,"text/plain")>-1&&vt.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,C=p.endOffset,_=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(_),p.selectNodeContents(_),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=_;_=o;)o=_.nextSibling,N(_),e=_.firstChild,e&&e===_.lastChild&&"DIV"===e.nodeName&&(_=e),n+=_.innerHTML;t=u._createRange(g,m,v,C),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(i){u.didError(i)}},0)},hn=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},un=O.prototype,fn=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};un.setConfig=function(e){return e=A({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:_t,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?fn:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},un.createElement=function(e,t,n){return S(this._doc,e,t,n)},un.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},un.didError=function(e){console.log(e)},un.getDocument=function(){return this._doc},un.getRoot=function(){return this._root},un.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var pn={pathChange:1,select:1,input:1,undoStateChange:1};un.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(a){a.details="Squire: fireEvent error. Event type: "+e,this.didError(a)}}return this},un.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},un.handleEvent=function(e){this.fireEvent(e.type,e)},un.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],pn[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},un.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],pn[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},un._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},un.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=Y,Lt(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),k(n,e)),o},un._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Rt(n),this.setSelection(n),this},un.moveCursorToStart=function(){return this._moveCursorTo(!0)},un.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var gn=function(e){return e._win.getSelection()||null};un.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(et&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{tt&&this._win.focus();var t=gn(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},un.getSelection=function(){var e,t,n,o,r=gn(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&g(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,o=e.commonAncestorContainer,g(o.ownerDocument,o)||(e=null)),e||(e=this._createRange(a.firstChild,0)),e},un.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,o=new n(e.commonAncestorContainer,z|W,function(t){return Dt(e,t,!0)}),i=e.startContainer,r=e.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(t=s.data,t&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===i&&(t=t.slice(e.startOffset)),d+=t,l=!0)):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},un.getPath=function(){return this._path};var mn=function(e,t){for(var o,i,r,s=new n(e,z,function(){return!0},!1);i=s.nextNode();)for(;(r=i.data.indexOf(Y))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o;while(a(i)&&!v(i));break}i.deleteData(r,1)}};un._didAddZWS=function(){this._hasZWS=!0},un._removeZWS=function(){this._hasZWS&&(mn(this._root),this._hasZWS=!1)},un._updatePath=function(e,t){if(e){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?m(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},un._updatePathOnEvent=function(){var e=this;e._isFocused&&!e._willUpdatePath&&(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))},un.focus=function(){return this._root.focus(),lt&&this.fireEvent("focus"),this},un.blur=function(){return this._root.blur(),lt&&this.fireEvent("blur"),this};var vn="squire-selection-start",Nn="squire-selection-end";un._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:vn,type:"hidden"}),o=this.createElement("INPUT",{id:Nn,type:"hidden"});Lt(e,n),e.collapse(!1),Lt(e,o),n.compareDocumentPosition(o)&I&&(n.id=Nn,o.id=vn,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},un._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+vn),o=t.querySelector("#"+Nn);if(n&&o){var i=n.parentNode,r=o.parentNode,a=vt.call(i.childNodes,n),s=vt.call(r.childNodes,o);i===r&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),k(i,e),i!==r&&k(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},un._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||this._docWasChanged()
},un._docWasChanged=function(){if(gt&&(Et=new WeakMap),!this._ignoreAllChanges){if(pt&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},un._recordUndoState=function(e){if(!this._isInUndoState){var t,n=this._undoIndex+=1,o=this._undoStack,i=this._config.undo,r=i.documentSizeThreshold,a=i.undoLimit;n<this._undoStackLength&&(o.length=this._undoStackLength=n),e&&this._saveRangeToBookmark(e),t=this._getHTML(),r>-1&&2*t.length>r&&a>-1&&n>a&&(o.splice(0,n-a),n=this._undoIndex=a,this._undoStackLength=a),o[n]=t,this._undoStackLength+=1,this._isInUndoState=!0}},un.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e),this._getRangeAndRemoveBookmark(e)),this},un.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},un.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(t>e+1&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:t>e+2}),this.fireEvent("input")}return this},un.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(p(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,z,function(e){return Dt(o,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!p(r,a,e,t))return!1;d=!0}return d},un.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);4>a&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},un._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f,g=this._root;if(o.collapsed){for(i=y(this.createElement(e,t),g),Lt(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),f=i;a(f);)f=f.parentNode;mn(f,i)}else{if(r=new n(o.commonAncestorContainer,z|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Dt(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do h=r.currentNode,u=!p(h,g,e,t),u&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),C(h,i),i.appendChild(h));while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},un._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(ut?(i=r.createTextNode(Y),this._didAddZWS()):i=r.createTextNode(""),Lt(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],p=function(e,t){if(!Dt(n,e,!1)){var o,i,r=e.nodeType===F;if(!Dt(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,p(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Dt(n,o,!0)&&f(o,e,t)});return o||g.forEach(function(e){p(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,_(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),k(s,n),n},un.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged(),this):this};var Cn={DT:"DD",DD:"DT",LI:"LI"},_n=function(e,t,n,o){var i=Cn[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),f(a,i,r)||(t=S(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(_(a)),a=t),a};un.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Pt(n,o),r=It(n,o);if(i&&r)do if(e(i)||i===r)break;while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),pt||this._docWasChanged()),this},un.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(t):this._recordUndoState(t);var n,o=this._root;return Ht(t,o),Ut(t,o,o,o),n=xt(t,o,o),Lt(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&L(t.endContainer.childNodes[t.endOffset],o),L(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),pt||this._docWasChanged(),this};var Sn=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},yn=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!p(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,_(e))}),e},Tn=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:vn,type:"hidden"}),this.createElement("INPUT",{id:Nn,type:"hidden"})])},bn=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(_(o)),s.currentNode=a):(o=o.parentNode,i=o.nodeName,i!==n&&/^[OU]L$/.test(i)&&C(o,e.createElement(n,c,[_(o)])))},En=function(e){return bn(this,e,"UL"),e},kn=function(e){return bn(this,e,"OL"),e},Bn=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;n>t;t+=1)o=a[t],i=_(o),T(i,l),C(o,i);for(t=0,n=d.length;n>t;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([_(r)])):(T(r,l),C(r,_(r)));return e},Ln=function(e){var t,n,o,i,r,a,s=e.querySelectorAll("LI"),l=this._config.tagAttributes;for(t=0,n=s.length;n>t;t+=1)o=s[t],d(o.firstChild)||(i=o.parentNode.nodeName,r=o.previousSibling,r&&(r=r.lastChild)&&r.nodeName===i||(a=l[i.toLowerCase()],r=this.createElement(i,a),C(o,r)),r.appendChild(o));return e},xn=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!d(e.firstChild)}).forEach(function(n){var o,i=n.parentNode,r=i.parentNode,a=n.firstChild,s=a;if(n.previousSibling&&(i=b(i,n,r,t)),/^[OU]L$/.test(r.nodeName))r.insertBefore(n,i),i.firstChild||r.removeChild(i);else for(;s&&(o=s.nextSibling,!d(s));)r.insertBefore(s,i),s=o;for("LI"===r.nodeName&&a.previousSibling&&b(r,a,r.parentNode,t);n!==e&&!n.childNodes.length;)i=n.parentNode,i.removeChild(n),n=i},this),T(e,t),e};un._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},un.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},un._getHTML=function(){return this._root.innerHTML},un._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do y(n,t);while(n=h(n,t));this._ignoreChange=!0},un.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ht)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ht)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},un.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(_(t))),tn(n),an(n,a,!1),T(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},un.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))Lt(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=Pt(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Rt(t)}return this.focus(),this.setSelection(t),this._updatePath(t),pt||this._docWasChanged(),this},un.insertImage=function(e,t){var n=this.createElement("IMG",A({src:e},t,!0));return this.insertElement(n),n};var An=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,On=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,z,function(e){return!p(e,t,"A")},!1),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=An.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",A({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};un.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("<!--StartFragment-->"),o=e.lastIndexOf("<!--EndFragment-->"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(_(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},On(r,r,this),tn(r),an(r,a,!1),nn(r),r.normalize();s=h(s,r);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Ot(u,d.fragment,a),pt||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(p){this.didError(p)}return this};var Dn=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};un.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Dn(l[n])+'"';for(h+=">",o=0,i=a.length;i>o;o+=1)r=a[o],r=Dn(r).replace(/ (?= )/g,"&nbsp;"),o&&i>o+1&&(r=h+(r||"<BR>")+c),a[o]=r;return this.insertHTML(a.join(""),t)};var Rn=function(e,t,n){return function(){return this[e](t,n),this.focus()}};un.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},un.bold=Rn("changeFormat",{tag:"B"}),un.italic=Rn("changeFormat",{tag:"I"}),un.underline=Rn("changeFormat",{tag:"U"}),un.strikethrough=Rn("changeFormat",{tag:"S"}),un.subscript=Rn("changeFormat",{tag:"SUB"},{tag:"SUP"}),un.superscript=Rn("changeFormat",{tag:"SUP"},{tag:"SUB"}),un.removeBold=Rn("changeFormat",null,{tag:"B"}),un.removeItalic=Rn("changeFormat",null,{tag:"I"}),un.removeUnderline=Rn("changeFormat",null,{tag:"U"}),un.removeStrikethrough=Rn("changeFormat",null,{tag:"S"}),un.removeSubscript=Rn("changeFormat",null,{tag:"SUB"}),un.removeSuperscript=Rn("changeFormat",null,{tag:"SUP"}),un.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;Lt(n,this._doc.createTextNode(e.slice(o)))}return t=A(A({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},un.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},un.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":$,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{"class":$}}),this.focus()},un.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":V,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{"class":V}}),this.focus()},un.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{"class":Q}}),this.focus()},un.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":j,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{"class":j}}),this.focus()},un.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},un.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},un.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Ht(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),Ut(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return P(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=vt.call(i,p),c=vt.call(i,o)+1):(d=vt.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),k(n,e),Rt(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},un.increaseQuoteLevel=Rn("modifyBlocks",Sn),un.decreaseQuoteLevel=Rn("modifyBlocks",yn),un.makeUnorderedList=Rn("modifyBlocks",En),un.makeOrderedList=Rn("modifyBlocks",kn),un.removeList=Rn("modifyBlocks",Bn),un.increaseListLevel=Rn("modifyBlocks",Ln),un.decreaseListLevel=Rn("modifyBlocks",xn),O.isInline=a,O.isBlock=s,O.isContainer=d,O.getBlockWalker=l,O.getPreviousBlock=c,O.getNextBlock=h,O.areAlike=u,O.hasTagAttributes=f,O.getNearest=p,O.isOrContains=g,O.detach=N,O.replaceWith=C,O.empty=_,O.getNodeBefore=kt,O.getNodeAfter=Bt,O.insertNodeInRange=Lt,O.extractContentsOfRange=xt,O.deleteContentsOfRange=At,O.insertTreeFragmentIntoRange=Ot,O.isNodeContainedInRange=Dt,O.moveRangeBoundariesDownTree=Rt,O.moveRangeBoundariesUpTree=Ut,O.getStartBlockOfRange=Pt,O.getEndBlockOfRange=It,O.contentWalker=wt,O.rangeDoesStartAtBlockBoundary=Ft,O.rangeDoesEndAtBlockBoundary=Mt,O.expandRangeToBlockBoundaries=Ht,O.onPaste=cn,O.addLinks=On,O.splitBlock=_n,O.startSelectionId=vn,O.endSelectionId=Nn,"object"==typeof exports?module.exports=O:"function"==typeof define&&define.amd?define(function(){return O}):(X.Squire=O,top!==X&&"true"===e.documentElement.getAttribute("data-squireinit")&&(X.editor=new O(e),X.onEditorLoad&&(X.onEditorLoad(X.editor),X.onEditorLoad=null)))}(document);
>>>>>>> 239b7d1... Ignore saved selection if not in document
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function r(e){return e.nodeType===F&&!!St[e.nodeName]}function i(e){switch(e.nodeType){case M:return Tt;case F:case W:if(mt&&kt.has(e))return kt.get(e);break;default:return yt}var t;return t=o(e.childNodes,a)?Ct.test(e.nodeName)?Tt:Et:bt,mt&&kt.set(e,t),t}function a(e){return i(e)===Tt}function s(e){return i(e)===Et}function d(e){return i(e)===bt}function l(e,t){var o=new n(t,z,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function u(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function h(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!r(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function g(e,t,n,o){for(;e&&e!==t;){if(p(e,n,o))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t){var n,o,r,i,a="";return e&&e!==t&&(a=v(e.parentNode,t),e.nodeType===F&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(r=o.split(/\s\s*/),r.sort(),a+=".",a+=r.join(".")),(i=e.dir)&&(a+="[dir="+i+"]"),r&&(_t.call(r,Q)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),_t.call(r,$)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),_t.call(r,V)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),_t.call(r,Y)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function _(e){var t=e.nodeType;return t===F||t===W?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function y(e,n,o,r){var i,a,s,d,l=e.createElement(n);if(o instanceof Array&&(r=o,o=null),o)for(i in o)a=o[i],a!==t&&l.setAttribute(i,o[i]);if(r)for(s=0,d=r.length;d>s;s+=1)l.appendChild(r[s]);return l}function T(e,t){var n,o,i=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=i.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===M)return d;if(a(e)){for(o=e.firstChild;ft&&o&&o.nodeType===M&&!o.data;)e.removeChild(o),o=e.firstChild;o||(ft?(n=s.createTextNode(X),i._didAddZWS()):n=s.createTextNode(""))}else if(ht){for(;e.nodeType!==M&&!r(e);){if(o=e.firstChild,!o){n=s.createTextNode("");break}e=o}e.nodeType===M?/^ +$/.test(e.data)&&(e.data=""):r(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=y(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(l){i.didError({name:"Squire: fixCursor – "+l,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,o,r,i,s=e.childNodes,l=e.ownerDocument,c=null,u=t.__squire__._config;for(n=0,o=s.length;o>n;n+=1)r=s[n],i="BR"===r.nodeName,!i&&a(r)?(c||(c=y(l,u.blockTag,u.blockAttributes)),c.appendChild(r),n-=1,o-=1):(i||c)&&(c||(c=y(l,u.blockTag,u.blockAttributes)),T(c,t),i?e.replaceChild(c,r):(e.insertBefore(c,r),n+=1,o+=1),c=null),d(r)&&E(r,t);return c&&e.appendChild(T(c,t)),e}function b(e,t,n,o){var r,i,a,s=e.nodeType;if(s===M&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===F){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(r=e.parentNode,i=e.cloneNode(!1);t;)a=t.nextSibling,i.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,o,"BLOCKQUOTE")&&(i.start=(+e.start||1)+e.childNodes.length-1),T(e,o),T(i,o),(a=e.nextSibling)?r.insertBefore(i,a):r.appendChild(i),b(r,i,n,o)}return t}function k(e,t){for(var n,o,r,i=e.childNodes,s=i.length,d=[];s--;)if(n=i[s],o=s&&i[s-1],s&&a(n)&&f(n,o)&&!St[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=_(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=_(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=_(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=_(o))),N(n),n.nodeType===M?o.appendData(n.data):d.push(S(n));else if(n.nodeType===F){for(r=d.length;r--;)n.appendChild(d.pop());k(n,t)}}function B(e,t){if(e.nodeType===M&&(e=e.parentNode),e.nodeType===F){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function L(e,t,n,o){for(var r,i,a,s=t;(r=s.parentNode)&&r!==o&&r.nodeType===F&&1===r.childNodes.length;)s=r;N(s),a=e.childNodes.length,i=e.lastChild,i&&"BR"===i.nodeName&&(e.removeChild(i),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),B(e,n),st&&(i=e.lastChild)&&"BR"===i.nodeName&&e.removeChild(i)}function A(e,t){var n,o,r=e.previousSibling,i=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||i&&/^[OU]L$/.test(i.nodeName))if(r&&f(r,e)){if(!d(r)){if(!s)return;o=y(a,"DIV"),o.appendChild(S(r)),r.appendChild(o)}N(e),n=!d(e),r.appendChild(S(e)),n&&E(r,t),i&&A(i,t)}else s&&(r=y(a,"DIV"),e.insertBefore(r,i),T(r,t))}function O(e){this.isShiftDown=e.shiftKey}function x(e,t,n){var o,r;if(e||(e={}),t)for(o in t)!n&&o in e||(r=t[o],e[o]=r&&r.constructor===Object?x(e[o],r,n):r);return e}function D(e,t){e.nodeType===H&&(e=e.body);var n,o=e.ownerDocument,r=o.defaultView;this._win=r,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,pt&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,gt?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",R),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(at?"beforecut":"cut",ln),this.addEventListener("copy",cn),this.addEventListener("keydown",O),this.addEventListener("keyup",O),this.addEventListener(at?"beforepaste":"paste",un),this.addEventListener("drop",hn),this.addEventListener(st?"keypress":"keydown",qt),this._keyHandlers=Object.create(jt),this.setConfig(t),at&&(r.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,r=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),r&&this.deleteData(e,r),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(i){}e.__squire__=this,this.setHTML("")}function R(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var o,r;for(o=t.firstChild;o;o=r){if(r=o.nextSibling,a(o)){if(o.nodeType===M||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([I(e,o,e._doc.createDocumentFragment())]));continue}I(e,o,n)}return n}var w=2,F=1,M=3,H=9,W=11,z=1,q=4,K=0,G=1,Z=2,j=3,Q="highlight",$="colour",V="font",Y="size",X="​",J=e.defaultView,et=navigator.userAgent,tt=/Android/.test(et),nt=/iP(?:ad|hone|od)/.test(et),ot=/Mac OS X/.test(et),rt=/Windows NT/.test(et),it=/Gecko\//.test(et),at=/Trident\/[456]\./.test(et),st=!!J.opera,dt=/Edge\//.test(et),lt=!dt&&/WebKit\//.test(et),ct=/Trident\/[4567]\./.test(et),ut=ot?"meta-":"ctrl-",ht=at||st,ft=at||lt,pt=at,gt="undefined"!=typeof MutationObserver,mt="undefined"!=typeof WeakMap,vt=/[^ \t\r\n]/,_t=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Nt={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)e=t.nextSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(Nt[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)e=t.previousSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}};var Ct=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,St={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},yt=0,Tt=1,Et=2,bt=3,kt=mt?new WeakMap:null,Bt=function(e,t){for(var n=e.childNodes;t&&e.nodeType===F;)e=n[t-1],n=e.childNodes,t=n.length;return e},Lt=function(e,t){if(e.nodeType===F){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},At=function(e,t){var n,o,r,i,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===M?(n=a.parentNode,o=n.childNodes,s===a.length?(s=_t.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(i=a.splitText(s),d===a?(l-=s,d=i):d===n&&(l+=1),a=i),s=_t.call(o,a)),a=n):o=a.childNodes,r=o.length,s===r?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-r),e.setStart(a,s),e.setEnd(d,l)},Ot=function(e,t,n){var o=e.startContainer,r=e.startOffset,i=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===M&&(t=t.parentNode);for(var s,d,l,c=b(i,a,t,n),u=b(o,r,t,n),h=t.ownerDocument.createDocumentFragment();u!==c;)s=u.nextSibling,h.appendChild(u),u=s;return o=t,r=c?_t.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[r],d=l&&l.previousSibling,d&&d.nodeType===M&&l.nodeType===M&&(o=d,r=d.length,d.appendData(l.data),N(l)),e.setStart(o,r),e.collapse(!0),T(t,n),h},xt=function(e,t){var n,o,r=It(e,t),i=wt(e,t),a=r!==i;return Ut(e),Pt(e,r,i,t),n=Ot(e,null,t),Ut(e),a&&(i=wt(e,t),r&&i&&r!==i&&L(r,i,e,t)),r&&T(r,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(T(t,t),e.selectNodeContents(t.firstChild)),n},Dt=function(e,t,n){var o,r,i,s,l,h,f,p,m;for(E(t,n),o=t;o=u(o,n);)T(o,n);if(e.collapsed||xt(e,n),Ut(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,r=It(e)){if(Pt(e,r,r,n),e.collapse(!0),l=e.endContainer,h=e.endOffset,sn(r,n,!1),a(l)&&(f=b(l,h,c(l,n),n),l=f.parentNode,h=_t.call(l.childNodes,f)),h!==_(l))for(i=n.ownerDocument.createDocumentFragment();o=l.childNodes[h];)i.appendChild(o);L(l,u(t,t),e,n),h=_t.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,h)}_(t)&&(Pt(e,s,s,n),f=b(e.endContainer,e.endOffset,s,n),p=f?f.previousSibling:s.lastChild,s.insertBefore(t,f),f?e.setEndBefore(f):e.setEnd(s,_(s)),r=wt(e,n),Ut(e),l=e.endContainer,h=e.endOffset,f&&d(f)&&A(f,n),f=p&&p.nextSibling,f&&d(f)&&A(f,n),e.setEnd(l,h)),i&&(m=e.cloneRange(),L(r,i,m,n),e.setEnd(m.endContainer,m.endOffset)),Ut(e)},Rt=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var r=e.compareBoundaryPoints(j,o)>-1,i=e.compareBoundaryPoints(G,o)<1;return!r&&!i}var a=e.compareBoundaryPoints(K,o)<1,s=e.compareBoundaryPoints(Z,o)>-1;return a&&s},Ut=function(e){for(var t,n=e.startContainer,o=e.startOffset,i=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==M&&(t=n.childNodes[o],t&&!r(t));)n=t,o=0;if(a)for(;i.nodeType!==M;){if(t=i.childNodes[a-1],!t||r(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}i=t,a=_(i)}else for(;i.nodeType!==M&&(t=i.firstChild,t&&!r(t));)i=t;e.collapsed?(e.setStart(i,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(i,a))},Pt=function(e,t,n,o){var r,i=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&i!==t&&i!==o;)r=i.parentNode,a=_t.call(r.childNodes,i),i=r;for(;;){if(l&&s.nodeType!==M&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==_(s))break;r=s.parentNode,d=_t.call(r.childNodes,s)+1,s=r}e.setStart(i,a),e.setEnd(s,d)},It=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=Bt(o,e.startOffset),n=u(n,t)),n&&Rt(e,n,!0)?n:null},wt=function(e,t){var n,o,r=e.endContainer;if(a(r))n=c(r,t);else if(r!==t&&s(r))n=r;else{if(n=Lt(r,e.endOffset),!n||!m(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Rt(e,n,!0)?n:null},Ft=new n(null,q|z,function(e){return e.nodeType===M?vt.test(e.data):"IMG"===e.nodeName}),Mt=function(e,t){var n,o=e.startContainer,r=e.startOffset;if(Ft.root=null,o.nodeType===M){if(r)return!1;n=o}else if(n=Lt(o,r),n&&!m(t,n)&&(n=null),!n&&(n=Bt(o,r),n.nodeType===M&&n.length))return!1;return Ft.currentNode=n,Ft.root=It(e,t),!Ft.previousNode()},Ht=function(e,t){var n,o=e.endContainer,r=e.endOffset;if(Ft.root=null,o.nodeType===M){if(n=o.data.length,n&&n>r)return!1;Ft.currentNode=o}else Ft.currentNode=Bt(o,r);return Ft.root=wt(e,t),!Ft.nextNode()},Wt=function(e,t){var n,o=It(e,t),r=wt(e,t);o&&r&&(n=o.parentNode,e.setStart(n,_t.call(n.childNodes,o)),n=r.parentNode,e.setEnd(n,_t.call(n.childNodes,r)+1))},zt={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},qt=function(e){var t=e.keyCode,n=zt[t],o="",r=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),st&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,r):1!==n.length||r.collapsed||(this.saveUndoState(r),xt(r,this._root),this._ensureBottomLine(),this.setSelection(r),this._updatePath(r,!0)))},Kt=function(e){return function(t,n){n.preventDefault(),t[e]()}},Gt=function(e,t){return t=t||null,function(n,o){o.preventDefault();var r=n.getSelection();n.hasFormat(e,null,r)?n.changeFormat(null,{tag:e},r):n.changeFormat({tag:e},t,r)}},Zt=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===M&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===X);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,_t.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),T(n,e._root),Ut(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(r){e.didError(r)}},jt={enter:function(e,t,n){var o,r,i,a=e._root;if(t.preventDefault(),e._recordUndoState(n),Dn(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||xt(n,a),o=It(n,a),!o||/^T[HD]$/.test(o.nodeName))return r=g(n.endContainer,a,"A"),r&&(r=r.parentNode,Pt(n,r,r,a),n.collapse(!1)),At(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((r=g(o,a,"LI"))&&(o=r),h(o)){if(g(o,a,"UL")||g(o,a,"OL"))return e.modifyBlocks(On,n);if(g(o,a,"BLOCKQUOTE"))return e.modifyBlocks(En,n)}for(i=Sn(e,o,n.startContainer,n.startOffset),vn(o),on(o),T(o,a);i.nodeType===F;){var s,d=i.firstChild;if("A"===i.nodeName&&(!i.textContent||i.textContent===X)){d=e._doc.createTextNode(""),C(i,d),i=d;break}for(;d&&d.nodeType===M&&!d.data&&(s=d.nextSibling,s&&"BR"!==s.nodeName);)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===M&&!st)break;i=d}n=e._createRange(i,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Mt(n,o)){t.preventDefault();var r,i=It(n,o);if(!i)return;if(E(i.parentNode,o),r=c(i,o)){if(!r.isContentEditable)return void N(r);for(L(r,i,n,o),i=r.parentNode;i!==o&&!i.nextSibling;)i=i.parentNode;i!==o&&(i=i.nextSibling)&&A(i,o),e.setSelection(n)}else if(i){if(g(i,o,"UL")||g(i,o,"OL"))return e.modifyBlocks(On,n);if(g(i,o,"BLOCKQUOTE"))return e.modifyBlocks(Tn,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Zt(e)},0);else t.preventDefault(),xt(n,o),Zt(e,n)},"delete":function(e,t,n){var o,r,i,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ht(n,l)){if(t.preventDefault(),o=It(n,l),!o)return;if(E(o.parentNode,l),r=u(o,l)){if(!r.isContentEditable)return void N(r);for(L(o,r,n,l),r=o.parentNode;r!==l&&!r.nextSibling;)r=r.parentNode;r!==l&&(r=r.nextSibling)&&A(r,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(i=n.cloneRange(),Pt(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===F&&(d=a.childNodes[s],d&&"IMG"===d.nodeName))return t.preventDefault(),N(d),Ut(n),void Zt(e,n);e.setSelection(i),setTimeout(function(){Zt(e)},0)}else t.preventDefault(),xt(n,l),Zt(e,n)},tab:function(e,t,n){var o,r,i=e._root;if(e._removeZWS(),n.collapsed&&Mt(n,i))for(o=It(n,i);r=o.parentNode;){if("UL"===r.nodeName||"OL"===r.nodeName){t.preventDefault(),e.modifyBlocks(An,n);break}o=r}},"shift-tab":function(e,t,n){var o,r=e._root;e._removeZWS(),n.collapsed&&Mt(n,r)&&(o=n.startContainer,(g(o,r,"UL")||g(o,r,"OL"))&&(t.preventDefault(),e.modifyBlocks(On,n)))},space:function(e,t,n){var o,r;e._recordUndoState(n),Dn(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,r=o.parentNode,n.collapsed&&"A"===r.nodeName&&!o.nextSibling&&n.endOffset===_(o)?n.setStartAfter(r):n.collapsed||(xt(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};ot&&it&&(jt["meta-left"]=function(e,t){t.preventDefault();var n=mn(e);n&&n.modify&&n.modify("move","backward","lineboundary")},jt["meta-right"]=function(e,t){t.preventDefault();var n=mn(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),ot||(jt.pageup=function(e){e.moveCursorToStart()},jt.pagedown=function(e){e.moveCursorToEnd()}),jt[ut+"b"]=Gt("B"),jt[ut+"i"]=Gt("I"),jt[ut+"u"]=Gt("U"),jt[ut+"shift-7"]=Gt("S"),jt[ut+"shift-5"]=Gt("SUB",{tag:"SUP"}),jt[ut+"shift-6"]=Gt("SUP",{tag:"SUB"}),jt[ut+"shift-8"]=Kt("makeUnorderedList"),jt[ut+"shift-9"]=Kt("makeOrderedList"),jt[ut+"["]=Kt("decreaseQuoteLevel"),jt[ut+"]"]=Kt("increaseQuoteLevel"),jt[ut+"y"]=Kt("redo"),jt[ut+"z"]=Kt("undo"),jt[ut+"shift-z"]=Kt("redo");var Qt={1:10,2:13,3:16,4:18,5:24,6:32,7:48},$t={backgroundColor:{regexp:vt,replace:function(e,t){return y(e,"SPAN",{"class":Q,style:"background-color:"+t})}},color:{regexp:vt,replace:function(e,t){return y(e,"SPAN",{"class":$,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return y(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return y(e,"I")}},fontFamily:{regexp:vt,replace:function(e,t){return y(e,"SPAN",{"class":V,style:"font-family:"+t})}},fontSize:{regexp:vt,replace:function(e,t){return y(e,"SPAN",{"class":Y,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return y(e,"U")}}},Vt=function(e){return function(t,n){var o=y(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(S(t)),o}},Yt=function(e,t){var n,o,r,i,a,s,d=e.style,l=e.ownerDocument;for(n in $t)o=$t[n],r=d[n],r&&o.regexp.test(r)&&(s=o.replace(l,r),a||(a=s),i&&i.appendChild(s),i=s,e.style[n]="");return a&&(i.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),i||e},Xt={P:Yt,SPAN:Yt,STRONG:Vt("B"),EM:Vt("I"),INS:Vt("U"),STRIKE:Vt("S"),FONT:function(e,t){var n,o,r,i,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=y(c,"SPAN",{"class":V,style:"font-family:"+s}),a=n,i=n),d&&(o=y(c,"SPAN",{"class":Y,style:"font-size:"+Qt[d]+"px"}),a||(a=o),i&&i.appendChild(o),i=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),r=y(c,"SPAN",{"class":$,style:"color:"+l}),a||(a=r),i&&i.appendChild(r),i=r),a||(a=i=y(c,"SPAN")),t.replaceChild(a,e),i.appendChild(S(e)),i},TT:function(e,t){var n=y(e.ownerDocument,"SPAN",{"class":V,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(S(e)),n}},Jt=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,en=/^(?:HEAD|META|STYLE)/,tn=new n(null,q|z,function(){return!0}),nn=function Pn(e,t){var n,o,r,i,s,d,l,c,u,h,f,p,g=e.childNodes;for(n=e;a(n);)n=n.parentNode;for(tn.root=n,o=0,r=g.length;r>o;o+=1)if(i=g[o],s=i.nodeName,d=i.nodeType,l=Xt[s],d===F){if(c=i.childNodes.length,l)i=l(i,e);else{if(en.test(s)){e.removeChild(i),o-=1,r-=1;continue}if(!Jt.test(s)&&!a(i)){o-=1,r+=c-1,e.replaceChild(S(i),i);continue}}c&&Pn(i,t||"PRE"===s)}else{if(d===M){if(f=i.data,u=!vt.test(f.charAt(0)),h=!vt.test(f.charAt(f.length-1)),t||!u&&!h)continue;if(u){for(tn.currentNode=i;(p=tn.previousPONode())&&(s=p.nodeName,!("IMG"===s||"#text"===s&&vt.test(p.data)));)if(!a(p)){p=null;break}f=f.replace(/^[ \t\r\n]+/g,p?" ":"")}if(h){for(tn.currentNode=i;(p=tn.nextNode())&&!("IMG"===s||"#text"===s&&vt.test(p.data));)if(!a(p)){p=null;break}f=f.replace(/[ \t\r\n]+$/g,p?" ":"")}if(f){i.data=f;continue}}e.removeChild(i),o-=1,r-=1}return e},on=function In(e){for(var t,n=e.childNodes,o=n.length;o--;)t=n[o],t.nodeType!==F||r(t)?t.nodeType!==M||t.data||e.removeChild(t):(In(t),a(t)&&!t.firstChild&&e.removeChild(t))},rn=function(e){return e.nodeType===F?"BR"===e.nodeName:vt.test(e.data)},an=function(e,t){for(var o,r=e.parentNode;a(r);)r=r.parentNode;return o=new n(r,z|q,rn),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},sn=function(e,t,n){var o,r,i,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;l>o;o+=1)d[o]=an(s[o],n);for(;l--;)r=s[l],i=r.parentNode,i&&(d[l]?a(i)||E(i,t):N(r))},dn=function(e,t,n){var o,r,i=t.ownerDocument.body;sn(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),i.appendChild(t),o=t.innerHTML,r=t.innerText||t.textContent,rt&&(r=r.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",r),i.removeChild(t)},ln=function(e){var t,n,o,r,i,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,u=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),dt||nt||!d)setTimeout(function(){try{u._ensureBottomLine()}catch(e){u.didError(e)}},0);else{for(t=It(l,c),n=wt(l,c),o=t===n&&t||c,r=xt(l,c),i=l.commonAncestorContainer,i.nodeType===M&&(i=i.parentNode);i&&i!==o;)a=i.cloneNode(!1),a.appendChild(r),r=a,i=i.parentNode;s=this.createElement("div"),s.appendChild(r),dn(d,s,c),e.preventDefault()}this.setSelection(l)},cn=function(e){var t,n,o,r,i,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!dt&&!nt&&d){for(t=It(l,c),n=wt(l,c),o=t===n&&t||c,l=l.cloneRange(),Ut(l),Pt(l,o,o,c),r=l.cloneContents(),i=l.commonAncestorContainer,i.nodeType===M&&(i=i.parentNode);i&&i!==o;)a=i.cloneNode(!1),a.appendChild(r),r=a,i=i.parentNode;s=this.createElement("div"),s.appendChild(r),dn(d,s,c),e.preventDefault()}},un=function(e){var t,n,o,r,i,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,u=null,h=this;if(!dt&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){h.insertHTML(e,!0)});"text/plain"===o&&(u=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):u&&u.getAsString(function(e){h.insertPlainText(e,!0)}))}if(r=a&&a.types,!dt&&r&&(_t.call(r,"text/html")>-1||!it&&_t.call(r,"text/plain")>-1&&_t.call(r,"text/rtf")<0))return e.preventDefault(),void(!d&&(i=a.getData("text/html"))?this.insertHTML(i,!0):((i=a.getData("text/plain"))||(i=a.getData("text/uri-list")))&&this.insertPlainText(i,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{h._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,N(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=h._createRange(g,m,v,_),h.setSelection(t),n&&h.insertHTML(n,!0)}catch(r){h.didError(r)}},0)},hn=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,r=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":r=!0;break;default:return}(r||o)&&this.saveUndoState()},fn=D.prototype,pn=function(e,t,n){var o=n._doc,r=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return r?o.importNode(r,!0):o.createDocumentFragment()};fn.setConfig=function(e){return e=x({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:St,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?pn:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},fn.createElement=function(e,t,n){return y(this._doc,e,t,n)},fn.createDefaultBlock=function(e){var t=this._config;return T(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},fn.didError=function(e){console.log(e)},fn.getDocument=function(){return this._doc},fn.getRoot=function(){return this._root},fn.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var gn={pathChange:1,select:1,input:1,undoStateChange:1};fn.fireEvent=function(e,t){var n,o,r,i=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(i)for(t||(t={}),t.type!==e&&(t.type=e),i=i.slice(),o=i.length;o--;){r=i[o];try{r.handleEvent?r.handleEvent(t):r.call(this,t)}catch(a){a.details="Squire: fireEvent error. Event type: "+e,this.didError(a)}}return this},fn.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},fn.handleEvent=function(e){this.fireEvent(e.type,e)},fn.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],gn[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},fn.removeEventListener=function(e,t){var n,o=this._events[e],r=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],gn[e]||("selectionchange"===e&&(r=this._doc),r.removeEventListener(e,this,!0)))}return this},fn._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var r=this._doc.createRange();return r.setStart(e,t),n?r.setEnd(n,o):r.setEnd(e,t),r},fn.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=X,At(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),B(n,e)),o},fn._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Ut(n),this.setSelection(n),this},fn.moveCursorToStart=function(){return this._moveCursorTo(!0)},fn.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var mn=function(e){return e._win.getSelection()||null};fn.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(tt&&!this._restoreSelection)R.call(this),this.blur(),this.focus();else{nt&&this._win.focus();var t=mn(this);t&&(t.removeAllRanges(),t.addRange(e))}else R.call(this);return this},fn.getSelection=function(){var e,t,n,o,i=mn(this),a=this._root;return this._isFocused&&i&&i.rangeCount&&(e=i.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&r(t)&&e.setStartBefore(t),n&&r(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,o=e.commonAncestorContainer,m(o.ownerDocument,o)||(e=null)),e||(e=this._createRange(a.firstChild,0)),e},fn.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,o=new n(e.commonAncestorContainer,q|z,function(t){return Rt(e,t,!0)}),r=e.startContainer,i=e.endContainer,s=o.currentNode=r,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===M?(t=s.data,t&&/\S/.test(t)&&(s===i&&(t=t.slice(0,e.endOffset)),s===r&&(t=t.slice(e.startOffset)),d+=t,l=!0)):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},fn.getPath=function(){return this._path};var vn=function(e,t){for(var o,r,i,s=new n(e,q,function(){return!0},!1);r=s.nextNode();)for(;(i=r.data.indexOf(X))>-1&&(!t||r.parentNode!==t);){if(1===r.length){do o=r.parentNode,o.removeChild(r),r=o,s.currentNode=o;while(a(r)&&!_(r));break}r.deleteData(i,1)}};fn._didAddZWS=function(){this._hasZWS=!0},fn._removeZWS=function(){this._hasZWS&&(vn(this._root),this._hasZWS=!1)},fn._updatePath=function(e,t){if(e){var n,o=e.startContainer,r=e.endContainer;(t||o!==this._lastAnchorNode||r!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=r,n=o&&r?o===r?v(r,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},fn._updatePathOnEvent=function(){var e=this;e._isFocused&&!e._willUpdatePath&&(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))},fn.focus=function(){return this._root.focus(),ct&&this.fireEvent("focus"),this},fn.blur=function(){return this._root.blur(),ct&&this.fireEvent("blur"),this};var _n="squire-selection-start",Nn="squire-selection-end";fn._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:_n,type:"hidden"}),o=this.createElement("INPUT",{id:Nn,type:"hidden"});At(e,n),e.collapse(!1),At(e,o),n.compareDocumentPosition(o)&w&&(n.id=Nn,o.id=_n,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},fn._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+_n),o=t.querySelector("#"+Nn);if(n&&o){var r=n.parentNode,i=o.parentNode,a=_t.call(r.childNodes,n),s=_t.call(i.childNodes,o);r===i&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(r,a),e.setEnd(i,s),B(r,e),r!==i&&B(i,e),e.collapsed&&(r=e.startContainer,r.nodeType===M&&(i=r.childNodes[e.startOffset],i&&i.nodeType===M||(i=r.childNodes[e.startOffset-1]),i&&i.nodeType===M&&(e.setStart(i,0),e.collapse(!0))))}return e||null},fn._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||this._docWasChanged()},fn._docWasChanged=function(){if(mt&&(kt=new WeakMap),!this._ignoreAllChanges){if(gt&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},fn._recordUndoState=function(e){if(!this._isInUndoState){var t,n=this._undoIndex+=1,o=this._undoStack,r=this._config.undo,i=r.documentSizeThreshold,a=r.undoLimit;
n<this._undoStackLength&&(o.length=this._undoStackLength=n),e&&this._saveRangeToBookmark(e),t=this._getHTML(),i>-1&&2*t.length>i&&a>-1&&n>a&&(o.splice(0,n-a),n=this._undoIndex=a,this._undoStackLength=a),o[n]=t,this._undoStackLength+=1,this._isInUndoState=!0}},fn.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._isInUndoState||(this._recordUndoState(e),this._getRangeAndRemoveBookmark(e)),this},fn.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection()),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},fn.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(t>e+1&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:t>e+2}),this.fireEvent("input")}return this},fn.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===M&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===M&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var r,i,a=this._root,s=o.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===M)return!1;r=new n(s,q,function(e){return Rt(o,e,!0)},!1);for(var d=!1;i=r.nextNode();){if(!g(i,a,e,t))return!1;d=!0}return d},fn.getFontInfo=function(e){var n,o,r,i={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return i;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===M)for(n.nodeType===M&&(n=n.parentNode);4>a&&n;)(o=n.style)&&(!i.color&&(r=o.color)&&(i.color=r,a+=1),!i.backgroundColor&&(r=o.backgroundColor)&&(i.backgroundColor=r,a+=1),!i.family&&(r=o.fontFamily)&&(i.family=r,a+=1),!i.size&&(r=o.fontSize)&&(i.size=r,a+=1)),n=n.parentNode;return i},fn._addFormat=function(e,t,o){var r,i,s,d,l,c,u,h,f,p=this._root;if(o.collapsed){for(r=T(this.createElement(e,t),p),At(o,r),o.setStart(r.firstChild,r.firstChild.length),o.collapse(!0),f=r;a(f);)f=f.parentNode;vn(f,r)}else{if(i=new n(o.commonAncestorContainer,q|z,function(e){return(e.nodeType===M||"BR"===e.nodeName||"IMG"===e.nodeName)&&Rt(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,i.currentNode=s,i.filter(s)||(s=i.nextNode(),l=0),!s)return o;do u=i.currentNode,h=!g(u,p,e,t),h&&(u===d&&u.length>c&&u.splitText(c),u===s&&l&&(u=u.splitText(l),d===s&&(d=u,c-=l),s=u,l=0),r=this.createElement(e,t),C(u,r),r.appendChild(u));while(i.nextNode());d.nodeType!==M&&(u.nodeType===M?(d=u,c=u.length):(d=u.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},fn._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var r,i=this._doc;n.collapsed&&(ft?(r=i.createTextNode(X),this._didAddZWS()):r=i.createTextNode(""),At(n,r));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,u=n.endOffset,h=[],f=function(e,t){if(!Rt(n,e,!1)){var o,r,i=e.nodeType===M;if(!Rt(n,e,!0))return void("INPUT"===e.nodeName||i&&!e.data||h.push([t,e]));if(i)e===c&&u!==e.length&&h.push([t,e.splitText(u)]),e===d&&l&&(e.splitText(l),h.push([t,e]));else for(o=e.firstChild;o;o=r)r=o.nextSibling,f(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Rt(n,o,!0)&&p(o,e,t)});return o||g.forEach(function(e){f(e,e)}),h.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),r&&n.collapse(!1),B(s,n),n},fn.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),gt||this._docWasChanged(),this):this};var Cn={DT:"DD",DD:"DT",LI:"LI"},Sn=function(e,t,n,o){var r=Cn[t.nodeName],i=null,a=b(n,o,t.parentNode,e._root),s=e._config;return r||(r=s.blockTag,i=s.blockAttributes),p(a,r,i)||(t=y(a.ownerDocument,r,i),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};fn.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,r=It(n,o),i=wt(n,o);if(r&&i)do if(e(r)||r===i)break;while(r=u(r,o));return t&&(this.setSelection(n),this._updatePath(n,!0),gt||this._docWasChanged()),this},fn.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._isInUndoState?this._saveRangeToBookmark(t):this._recordUndoState(t);var n,o=this._root;return Wt(t,o),Pt(t,o,o,o),n=Ot(t,o,o),At(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&A(t.endContainer.childNodes[t.endOffset],o),A(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),gt||this._docWasChanged(),this};var yn=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},Tn=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},En=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:_n,type:"hidden"}),this.createElement("INPUT",{id:Nn,type:"hidden"})])},bn=function(e,t,n){for(var o,r,i,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],u=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",u),o.dir&&(a.dir=o.dir),(i=o.previousSibling)&&i.nodeName===n?(i.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(S(o)),s.currentNode=a):(o=o.parentNode,r=o.nodeName,r!==n&&/^[OU]L$/.test(r)&&C(o,e.createElement(n,c,[S(o)])))},kn=function(e){return bn(this,e,"UL"),e},Bn=function(e){return bn(this,e,"OL"),e},Ln=function(e){var t,n,o,r,i,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;n>t;t+=1)o=a[t],r=S(o),E(r,l),C(o,r);for(t=0,n=d.length;n>t;t+=1)i=d[t],s(i)?C(i,this.createDefaultBlock([S(i)])):(E(i,l),C(i,S(i)));return e},An=function(e){var t,n,o,r,i,a,s=e.querySelectorAll("LI"),l=this._config.tagAttributes;for(t=0,n=s.length;n>t;t+=1)o=s[t],d(o.firstChild)||(r=o.parentNode.nodeName,i=o.previousSibling,i&&(i=i.lastChild)&&i.nodeName===r||(a=l[r.toLowerCase()],i=this.createElement(r,a),C(o,i)),i.appendChild(o));return e},On=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!d(e.firstChild)}).forEach(function(n){var o,r=n.parentNode,i=r.parentNode,a=n.firstChild,s=a;if(n.previousSibling&&(r=b(r,n,i,t)),/^[OU]L$/.test(i.nodeName))i.insertBefore(n,r),r.firstChild||i.removeChild(r);else for(;s&&(o=s.nextSibling,!d(s));)i.insertBefore(s,r),s=o;for("LI"===i.nodeName&&a.previousSibling&&b(i,a,i.parentNode,t);n!==e&&!n.childNodes.length;)r=n.parentNode,r.removeChild(n),n=r},this),E(e,t),e};fn._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},fn.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},fn._getHTML=function(){return this._root.innerHTML},fn._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do T(n,t);while(n=u(n,t));this._ignoreChange=!0},fn.getHTML=function(e){var t,n,o,r,i,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ht)for(t=this._root,n=t;n=u(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(r=this._getHTML().replace(/\u200B/g,""),ht)for(i=s.length;i--;)N(s[i]);return a&&this._getRangeAndRemoveBookmark(a),r},fn.setHTML=function(e){var t,n,o,r=this._config,i=r.isSetHTMLSanitized?r.sanitizeToDOMFragment:null,a=this._root;"function"==typeof i?n=i(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),nn(n),sn(n,a,!1),E(n,a);for(var s=n;s=u(s,a);)T(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),T(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,R.call(this),this._updatePath(d,!0),this},fn.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))At(t,e),t.setStartAfter(e);else{for(var n,o,r=this._root,i=It(t,r)||r;i!==r&&!i.nextSibling;)i=i.parentNode;i!==r&&(n=i.parentNode,o=b(n,i.nextSibling,r,r)),o?r.insertBefore(e,o):(r.appendChild(e),o=this.createDefaultBlock(),r.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Ut(t)}return this.focus(),this.setSelection(t),this._updatePath(t),gt||this._docWasChanged(),this},fn.insertImage=function(e,t){var n=this.createElement("IMG",x({src:e},t,!0));return this.insertElement(n),n};var xn=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,Dn=function(e,t,o){for(var r,i,a,s,d,l,c,u=e.ownerDocument,h=new n(e,q,function(e){return!g(e,t,"A")},!1),f=o._config.tagAttributes.a;r=h.nextNode();)for(i=r.data,a=r.parentNode;s=xn.exec(i);)d=s.index,l=d+s[0].length,d&&(c=u.createTextNode(i.slice(0,d)),a.insertBefore(c,r)),c=o.createElement("A",x({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=i.slice(d,l),a.insertBefore(c,r),r.data=i=i.slice(l)};fn.insertHTML=function(e,t){var n,o,r,i,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,h=this.getSelection(),f=this._doc;"function"==typeof c?i=c(e,t,this):(t&&(n=e.indexOf("<!--StartFragment-->"),o=e.lastIndexOf("<!--EndFragment-->"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),r=this.createElement("DIV"),r.innerHTML=e,i=f.createDocumentFragment(),i.appendChild(S(r))),this.saveUndoState(h);try{for(a=this._root,s=i,d={fragment:i,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},Dn(i,i,this),nn(i),sn(i,a,!1),on(i),i.normalize();s=u(s,i);)T(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Dt(h,d.fragment,a),gt||this._docWasChanged(),h.collapse(!1),this._ensureBottomLine()),this.setSelection(h),this._updatePath(h,!0),t&&this.focus()}catch(p){this.didError(p)}return this};var Rn=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};fn.insertPlainText=function(e,t){var n,o,r,i,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",u="<"+d;for(n in l)u+=" "+n+'="'+Rn(l[n])+'"';for(u+=">",o=0,r=a.length;r>o;o+=1)i=a[o],i=Rn(i).replace(/ (?= )/g,"&nbsp;"),a[o]=u+(i||"<BR>")+c;return this.insertHTML(a.join(""),t)};var Un=function(e,t,n){return function(){return this[e](t,n),this.focus()}};fn.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},fn.bold=Un("changeFormat",{tag:"B"}),fn.italic=Un("changeFormat",{tag:"I"}),fn.underline=Un("changeFormat",{tag:"U"}),fn.strikethrough=Un("changeFormat",{tag:"S"}),fn.subscript=Un("changeFormat",{tag:"SUB"},{tag:"SUP"}),fn.superscript=Un("changeFormat",{tag:"SUP"},{tag:"SUB"}),fn.removeBold=Un("changeFormat",null,{tag:"B"}),fn.removeItalic=Un("changeFormat",null,{tag:"I"}),fn.removeUnderline=Un("changeFormat",null,{tag:"U"}),fn.removeStrikethrough=Un("changeFormat",null,{tag:"S"}),fn.removeSubscript=Un("changeFormat",null,{tag:"SUB"}),fn.removeSuperscript=Un("changeFormat",null,{tag:"SUP"}),fn.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;At(n,this._doc.createTextNode(e.slice(o)))}return t=x(x({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},fn.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},fn.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":V,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{"class":V}}),this.focus()},fn.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Y,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{"class":Y}}),this.focus()},fn.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":$,style:"color:"+e}}:null,{tag:"SPAN",attributes:{"class":$}}),this.focus()},fn.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Q,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{"class":Q}}),this.focus()},fn.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},fn.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},fn.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Wt(e,t),n=t),n.nodeType===M)return this;this.saveUndoState(e),Pt(e,n,n,t);for(var o,r,i=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,u=i.createDocumentFragment(),h=i.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,u.appendChild(p),p=o;return I(this,u,h),h.normalize(),p=h.firstChild,o=h.lastChild,r=n.childNodes,p?(n.insertBefore(h,f),d=_t.call(r,p),c=_t.call(r,o)+1):(d=_t.call(r,f),c=d),e.setStart(n,d),e.setEnd(n,c),B(n,e),Ut(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},fn.increaseQuoteLevel=Un("modifyBlocks",yn),fn.decreaseQuoteLevel=Un("modifyBlocks",Tn),fn.makeUnorderedList=Un("modifyBlocks",kn),fn.makeOrderedList=Un("modifyBlocks",Bn),fn.removeList=Un("modifyBlocks",Ln),fn.increaseListLevel=Un("modifyBlocks",An),fn.decreaseListLevel=Un("modifyBlocks",On),D.isInline=a,D.isBlock=s,D.isContainer=d,D.getBlockWalker=l,D.getPreviousBlock=c,D.getNextBlock=u,D.areAlike=f,D.hasTagAttributes=p,D.getNearest=g,D.isOrContains=m,D.detach=N,D.replaceWith=C,D.empty=S,D.getNodeBefore=Bt,D.getNodeAfter=Lt,D.insertNodeInRange=At,D.extractContentsOfRange=Ot,D.deleteContentsOfRange=xt,D.insertTreeFragmentIntoRange=Dt,D.isNodeContainedInRange=Rt,D.moveRangeBoundariesDownTree=Ut,D.moveRangeBoundariesUpTree=Pt,D.getStartBlockOfRange=It,D.getEndBlockOfRange=wt,D.contentWalker=Ft,D.rangeDoesStartAtBlockBoundary=Mt,D.rangeDoesEndAtBlockBoundary=Ht,D.expandRangeToBlockBoundaries=Wt,D.onPaste=un,D.addLinks=Dn,D.splitBlock=Sn,D.startSelectionId=_n,D.endSelectionId=Nn,"object"==typeof exports?module.exports=D:"function"==typeof define&&define.amd?define(function(){return D}):(J.Squire=D,top!==J&&"true"===e.documentElement.getAttribute("data-squireinit")&&(J.editor=new D(e),J.onEditorLoad&&(J.onEditorLoad(J.editor),J.onEditorLoad=null)))}(document);
>>>>>>> 48fabd4... Improved algorithm for inserting tree into range
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function r(e){return e.nodeType===F&&!!St[e.nodeName]}function i(e){switch(e.nodeType){case M:return Tt;case F:case W:if(mt&&kt.has(e))return kt.get(e);break;default:return yt}var t;return t=o(e.childNodes,a)?Ct.test(e.nodeName)?Tt:Et:bt,mt&&kt.set(e,t),t}function a(e){return i(e)===Tt}function s(e){return i(e)===Et}function d(e){return i(e)===bt}function l(e,t){var o=new n(t,z,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function u(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function h(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!r(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function g(e,t,n,o){for(;e&&e!==t;){if(p(e,n,o))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t){var n,o,r,i,a="";return e&&e!==t&&(a=v(e.parentNode,t),e.nodeType===F&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(r=o.split(/\s\s*/),r.sort(),a+=".",a+=r.join(".")),(i=e.dir)&&(a+="[dir="+i+"]"),r&&(_t.call(r,Q)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),_t.call(r,$)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),_t.call(r,V)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),_t.call(r,Y)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function _(e){var t=e.nodeType;return t===F||t===W?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function y(e,n,o,r){var i,a,s,d,l=e.createElement(n);if(o instanceof Array&&(r=o,o=null),o)for(i in o)a=o[i],a!==t&&l.setAttribute(i,o[i]);if(r)for(s=0,d=r.length;d>s;s+=1)l.appendChild(r[s]);return l}function T(e,t){var n,o,i=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=i.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===M)return d;if(a(e)){for(o=e.firstChild;ft&&o&&o.nodeType===M&&!o.data;)e.removeChild(o),o=e.firstChild;o||(ft?(n=s.createTextNode(X),i._didAddZWS()):n=s.createTextNode(""))}else if(ht){for(;e.nodeType!==M&&!r(e);){if(o=e.firstChild,!o){n=s.createTextNode("");break}e=o}e.nodeType===M?/^ +$/.test(e.data)&&(e.data=""):r(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=y(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(l){i.didError({name:"Squire: fixCursor – "+l,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,o,r,i,s=e.childNodes,l=e.ownerDocument,c=null,u=t.__squire__._config;for(n=0,o=s.length;o>n;n+=1)r=s[n],i="BR"===r.nodeName,!i&&a(r)?(c||(c=y(l,u.blockTag,u.blockAttributes)),c.appendChild(r),n-=1,o-=1):(i||c)&&(c||(c=y(l,u.blockTag,u.blockAttributes)),T(c,t),i?e.replaceChild(c,r):(e.insertBefore(c,r),n+=1,o+=1),c=null),d(r)&&E(r,t);return c&&e.appendChild(T(c,t)),e}function b(e,t,n,o){var r,i,a,s=e.nodeType;if(s===M&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===F){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(r=e.parentNode,i=e.cloneNode(!1);t;)a=t.nextSibling,i.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,o,"BLOCKQUOTE")&&(i.start=(+e.start||1)+e.childNodes.length-1),T(e,o),T(i,o),(a=e.nextSibling)?r.insertBefore(i,a):r.appendChild(i),b(r,i,n,o)}return t}function k(e,t){for(var n,o,r,i=e.childNodes,s=i.length,d=[];s--;)if(n=i[s],o=s&&i[s-1],s&&a(n)&&f(n,o)&&!St[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=_(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=_(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=_(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=_(o))),N(n),n.nodeType===M?o.appendData(n.data):d.push(S(n));else if(n.nodeType===F){for(r=d.length;r--;)n.appendChild(d.pop());k(n,t)}}function L(e,t){if(e.nodeType===M&&(e=e.parentNode),e.nodeType===F){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function B(e,t,n,o){for(var r,i,a,s=t;(r=s.parentNode)&&r!==o&&r.nodeType===F&&1===r.childNodes.length;)s=r;N(s),a=e.childNodes.length,i=e.lastChild,i&&"BR"===i.nodeName&&(e.removeChild(i),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),L(e,n),st&&(i=e.lastChild)&&"BR"===i.nodeName&&e.removeChild(i)}function A(e,t){var n,o,r=e.previousSibling,i=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||i&&/^[OU]L$/.test(i.nodeName))if(r&&f(r,e)){if(!d(r)){if(!s)return;o=y(a,"DIV"),o.appendChild(S(r)),r.appendChild(o)}N(e),n=!d(e),r.appendChild(S(e)),n&&E(r,t),i&&A(i,t)}else s&&(r=y(a,"DIV"),e.insertBefore(r,i),T(r,t))}function O(e){this.isShiftDown=e.shiftKey}function x(e,t,n){var o,r;if(e||(e={}),t)for(o in t)!n&&o in e||(r=t[o],e[o]=r&&r.constructor===Object?x(e[o],r,n):r);return e}function D(e,t){e.nodeType===H&&(e=e.body);var n,o=e.ownerDocument,r=o.defaultView;this._win=r,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,pt&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,gt?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",R),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(at?"beforecut":"cut",ln),this.addEventListener("copy",cn),this.addEventListener("keydown",O),this.addEventListener("keyup",O),this.addEventListener(at?"beforepaste":"paste",un),this.addEventListener("drop",hn),this.addEventListener(st?"keypress":"keydown",qt),this._keyHandlers=Object.create(jt),this.setConfig(t),at&&(r.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,r=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),r&&this.deleteData(e,r),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(i){}e.__squire__=this,this.setHTML("")}function R(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var o,r;for(o=t.firstChild;o;o=r){if(r=o.nextSibling,a(o)){if(o.nodeType===M||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([I(e,o,e._doc.createDocumentFragment())]));continue}I(e,o,n)}return n}var w=2,F=1,M=3,H=9,W=11,z=1,q=4,K=0,G=1,Z=2,j=3,Q="highlight",$="colour",V="font",Y="size",X="​",J=e.defaultView,et=navigator.userAgent,tt=/Android/.test(et),nt=/iP(?:ad|hone|od)/.test(et),ot=/Mac OS X/.test(et),rt=/Windows NT/.test(et),it=/Gecko\//.test(et),at=/Trident\/[456]\./.test(et),st=!!J.opera,dt=/Edge\//.test(et),lt=!dt&&/WebKit\//.test(et),ct=/Trident\/[4567]\./.test(et),ut=ot?"meta-":"ctrl-",ht=at||st,ft=at||lt,pt=at,gt="undefined"!=typeof MutationObserver,mt="undefined"!=typeof WeakMap,vt=/[^ \t\r\n]/,_t=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Nt={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)e=t.nextSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(Nt[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,r=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)e=t.previousSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&r(e))return this.currentNode=e,e;t=e}};var Ct=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,St={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},yt=0,Tt=1,Et=2,bt=3,kt=mt?new WeakMap:null,Lt=function(e,t){for(var n=e.childNodes;t&&e.nodeType===F;)e=n[t-1],n=e.childNodes,t=n.length;return e},Bt=function(e,t){if(e.nodeType===F){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},At=function(e,t){var n,o,r,i,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===M?(n=a.parentNode,o=n.childNodes,s===a.length?(s=_t.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(i=a.splitText(s),d===a?(l-=s,d=i):d===n&&(l+=1),a=i),s=_t.call(o,a)),a=n):o=a.childNodes,r=o.length,s===r?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-r),e.setStart(a,s),e.setEnd(d,l)},Ot=function(e,t,n){var o=e.startContainer,r=e.startOffset,i=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===M&&(t=t.parentNode);for(var s,d,l,c=b(i,a,t,n),u=b(o,r,t,n),h=t.ownerDocument.createDocumentFragment();u!==c;)s=u.nextSibling,h.appendChild(u),u=s;return o=t,r=c?_t.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[r],d=l&&l.previousSibling,d&&d.nodeType===M&&l.nodeType===M&&(o=d,r=d.length,d.appendData(l.data),N(l)),e.setStart(o,r),e.collapse(!0),T(t,n),h},xt=function(e,t){var n,o,r=It(e,t),i=wt(e,t),a=r!==i;return Ut(e),Pt(e,r,i,t),n=Ot(e,null,t),Ut(e),a&&(i=wt(e,t),r&&i&&r!==i&&B(r,i,e,t)),r&&T(r,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(T(t,t),e.selectNodeContents(t.firstChild)),n},Dt=function(e,t,n){var o,r,i,s,l,h,f,p,m;for(E(t,n),o=t;o=u(o,n);)T(o,n);if(e.collapsed||xt(e,n),Ut(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,r=It(e)){if(Pt(e,r,r,n),e.collapse(!0),l=e.endContainer,h=e.endOffset,sn(r,n,!1),a(l)&&(f=b(l,h,c(l,n),n),l=f.parentNode,h=_t.call(l.childNodes,f)),h!==_(l))for(i=n.ownerDocument.createDocumentFragment();o=l.childNodes[h];)i.appendChild(o);B(l,u(t,t),e,n),h=_t.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,h)}_(t)&&(Pt(e,s,s,n),f=b(e.endContainer,e.endOffset,s,n),p=f?f.previousSibling:s.lastChild,s.insertBefore(t,f),f?e.setEndBefore(f):e.setEnd(s,_(s)),r=wt(e,n),Ut(e),l=e.endContainer,h=e.endOffset,f&&d(f)&&A(f,n),f=p&&p.nextSibling,f&&d(f)&&A(f,n),e.setEnd(l,h)),i&&(m=e.cloneRange(),B(r,i,m,n),e.setEnd(m.endContainer,m.endOffset)),Ut(e)},Rt=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var r=e.compareBoundaryPoints(j,o)>-1,i=e.compareBoundaryPoints(G,o)<1;return!r&&!i}var a=e.compareBoundaryPoints(K,o)<1,s=e.compareBoundaryPoints(Z,o)>-1;return a&&s},Ut=function(e){for(var t,n=e.startContainer,o=e.startOffset,i=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==M&&(t=n.childNodes[o],t&&!r(t));)n=t,o=0;if(a)for(;i.nodeType!==M;){if(t=i.childNodes[a-1],!t||r(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}i=t,a=_(i)}else for(;i.nodeType!==M&&(t=i.firstChild,t&&!r(t));)i=t;e.collapsed?(e.setStart(i,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(i,a))},Pt=function(e,t,n,o){var r,i=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&i!==t&&i!==o;)r=i.parentNode,a=_t.call(r.childNodes,i),i=r;for(;;){if(l&&s.nodeType!==M&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==_(s))break;r=s.parentNode,d=_t.call(r.childNodes,s)+1,s=r}e.setStart(i,a),e.setEnd(s,d)},It=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=Lt(o,e.startOffset),n=u(n,t)),n&&Rt(e,n,!0)?n:null},wt=function(e,t){var n,o,r=e.endContainer;if(a(r))n=c(r,t);else if(r!==t&&s(r))n=r;else{if(n=Bt(r,e.endOffset),!n||!m(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Rt(e,n,!0)?n:null},Ft=new n(null,q|z,function(e){return e.nodeType===M?vt.test(e.data):"IMG"===e.nodeName}),Mt=function(e,t){var n,o=e.startContainer,r=e.startOffset;if(Ft.root=null,o.nodeType===M){if(r)return!1;n=o}else if(n=Bt(o,r),n&&!m(t,n)&&(n=null),!n&&(n=Lt(o,r),n.nodeType===M&&n.length))return!1;return Ft.currentNode=n,Ft.root=It(e,t),!Ft.previousNode()},Ht=function(e,t){var n,o=e.endContainer,r=e.endOffset;if(Ft.root=null,o.nodeType===M){if(n=o.data.length,n&&n>r)return!1;Ft.currentNode=o}else Ft.currentNode=Lt(o,r);return Ft.root=wt(e,t),!Ft.nextNode()},Wt=function(e,t){var n,o=It(e,t),r=wt(e,t);o&&r&&(n=o.parentNode,e.setStart(n,_t.call(n.childNodes,o)),n=r.parentNode,e.setEnd(n,_t.call(n.childNodes,r)+1))},zt={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},qt=function(e){var t=e.keyCode,n=zt[t],o="",r=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),st&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,r):1!==n.length||r.collapsed||(this.saveUndoState(r),xt(r,this._root),this._ensureBottomLine(),this.setSelection(r),this._updatePath(r,!0)))},Kt=function(e){return function(t,n){n.preventDefault(),t[e]()}},Gt=function(e,t){return t=t||null,function(n,o){o.preventDefault();var r=n.getSelection();n.hasFormat(e,null,r)?n.changeFormat(null,{tag:e},r):n.changeFormat({tag:e},t,r)}},Zt=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===M&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===X);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,_t.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),T(n,e._root),Ut(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(r){e.didError(r)}},jt={enter:function(e,t,n){var o,r,i,a=e._root;if(t.preventDefault(),e._recordUndoState(n),Dn(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||xt(n,a),o=It(n,a),!o||/^T[HD]$/.test(o.nodeName))return r=g(n.endContainer,a,"A"),r&&(r=r.parentNode,Pt(n,r,r,a),n.collapse(!1)),At(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((r=g(o,a,"LI"))&&(o=r),h(o)){if(g(o,a,"UL")||g(o,a,"OL"))return e.modifyBlocks(On,n);if(g(o,a,"BLOCKQUOTE"))return e.modifyBlocks(En,n)}for(i=Sn(e,o,n.startContainer,n.startOffset),vn(o),on(o),T(o,a);i.nodeType===F;){var s,d=i.firstChild;if("A"===i.nodeName&&(!i.textContent||i.textContent===X)){d=e._doc.createTextNode(""),C(i,d),i=d;break}for(;d&&d.nodeType===M&&!d.data&&(s=d.nextSibling,s&&"BR"!==s.nodeName);)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===M&&!st)break;i=d}n=e._createRange(i,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Mt(n,o)){t.preventDefault();var r,i=It(n,o);if(!i)return;if(E(i.parentNode,o),r=c(i,o)){if(!r.isContentEditable)return void N(r);for(B(r,i,n,o),i=r.parentNode;i!==o&&!i.nextSibling;)i=i.parentNode;i!==o&&(i=i.nextSibling)&&A(i,o),e.setSelection(n)}else if(i){if(g(i,o,"UL")||g(i,o,"OL"))return e.modifyBlocks(On,n);if(g(i,o,"BLOCKQUOTE"))return e.modifyBlocks(Tn,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Zt(e)},0);else t.preventDefault(),xt(n,o),Zt(e,n)},"delete":function(e,t,n){var o,r,i,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ht(n,l)){if(t.preventDefault(),o=It(n,l),!o)return;if(E(o.parentNode,l),r=u(o,l)){if(!r.isContentEditable)return void N(r);for(B(o,r,n,l),r=o.parentNode;r!==l&&!r.nextSibling;)r=r.parentNode;r!==l&&(r=r.nextSibling)&&A(r,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(i=n.cloneRange(),Pt(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===F&&(d=a.childNodes[s],d&&"IMG"===d.nodeName))return t.preventDefault(),N(d),Ut(n),void Zt(e,n);e.setSelection(i),setTimeout(function(){Zt(e)},0)}else t.preventDefault(),xt(n,l),Zt(e,n)},tab:function(e,t,n){var o,r,i=e._root;if(e._removeZWS(),n.collapsed&&Mt(n,i))for(o=It(n,i);r=o.parentNode;){if("UL"===r.nodeName||"OL"===r.nodeName){t.preventDefault(),e.modifyBlocks(An,n);break}o=r}},"shift-tab":function(e,t,n){var o,r=e._root;e._removeZWS(),n.collapsed&&Mt(n,r)&&(o=n.startContainer,(g(o,r,"UL")||g(o,r,"OL"))&&(t.preventDefault(),e.modifyBlocks(On,n)))},space:function(e,t,n){var o,r;e._recordUndoState(n),Dn(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,r=o.parentNode,n.collapsed&&"A"===r.nodeName&&!o.nextSibling&&n.endOffset===_(o)?n.setStartAfter(r):n.collapsed||(xt(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};ot&&it&&(jt["meta-left"]=function(e,t){t.preventDefault();var n=mn(e);n&&n.modify&&n.modify("move","backward","lineboundary")},jt["meta-right"]=function(e,t){t.preventDefault();var n=mn(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),ot||(jt.pageup=function(e){e.moveCursorToStart()},jt.pagedown=function(e){e.moveCursorToEnd()}),jt[ut+"b"]=Gt("B"),jt[ut+"i"]=Gt("I"),jt[ut+"u"]=Gt("U"),jt[ut+"shift-7"]=Gt("S"),jt[ut+"shift-5"]=Gt("SUB",{tag:"SUP"}),jt[ut+"shift-6"]=Gt("SUP",{tag:"SUB"}),jt[ut+"shift-8"]=Kt("makeUnorderedList"),jt[ut+"shift-9"]=Kt("makeOrderedList"),jt[ut+"["]=Kt("decreaseQuoteLevel"),jt[ut+"]"]=Kt("increaseQuoteLevel"),jt[ut+"y"]=Kt("redo"),jt[ut+"z"]=Kt("undo"),jt[ut+"shift-z"]=Kt("redo");var Qt={1:10,2:13,3:16,4:18,5:24,6:32,7:48},$t={backgroundColor:{regexp:vt,replace:function(e,t){return y(e,"SPAN",{"class":Q,style:"background-color:"+t})}},color:{regexp:vt,replace:function(e,t){return y(e,"SPAN",{"class":$,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return y(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return y(e,"I")}},fontFamily:{regexp:vt,replace:function(e,t){return y(e,"SPAN",{"class":V,style:"font-family:"+t})}},fontSize:{regexp:vt,replace:function(e,t){return y(e,"SPAN",{"class":Y,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return y(e,"U")}}},Vt=function(e){return function(t,n){var o=y(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(S(t)),o}},Yt=function(e,t){var n,o,r,i,a,s,d=e.style,l=e.ownerDocument;for(n in $t)o=$t[n],r=d[n],r&&o.regexp.test(r)&&(s=o.replace(l,r),a||(a=s),i&&i.appendChild(s),i=s,e.style[n]="");return a&&(i.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),i||e},Xt={P:Yt,SPAN:Yt,STRONG:Vt("B"),EM:Vt("I"),INS:Vt("U"),STRIKE:Vt("S"),FONT:function(e,t){var n,o,r,i,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=y(c,"SPAN",{"class":V,style:"font-family:"+s}),a=n,i=n),d&&(o=y(c,"SPAN",{"class":Y,style:"font-size:"+Qt[d]+"px"}),a||(a=o),i&&i.appendChild(o),i=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),r=y(c,"SPAN",{"class":$,style:"color:"+l}),a||(a=r),i&&i.appendChild(r),i=r),a||(a=i=y(c,"SPAN")),t.replaceChild(a,e),i.appendChild(S(e)),i},TT:function(e,t){var n=y(e.ownerDocument,"SPAN",{"class":V,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(S(e)),n}},Jt=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,en=/^(?:HEAD|META|STYLE)/,tn=new n(null,q|z,function(){return!0}),nn=function Pn(e,t){var n,o,r,i,s,d,l,c,u,h,f,p,g=e.childNodes;for(n=e;a(n);)n=n.parentNode;for(tn.root=n,o=0,r=g.length;r>o;o+=1)if(i=g[o],s=i.nodeName,d=i.nodeType,l=Xt[s],d===F){if(c=i.childNodes.length,l)i=l(i,e);else{if(en.test(s)){e.removeChild(i),o-=1,r-=1;continue}if(!Jt.test(s)&&!a(i)){o-=1,r+=c-1,e.replaceChild(S(i),i);continue}}c&&Pn(i,t||"PRE"===s)}else{if(d===M){if(f=i.data,u=!vt.test(f.charAt(0)),h=!vt.test(f.charAt(f.length-1)),t||!u&&!h)continue;if(u){for(tn.currentNode=i;(p=tn.previousPONode())&&(s=p.nodeName,!("IMG"===s||"#text"===s&&vt.test(p.data)));)if(!a(p)){p=null;break}f=f.replace(/^[ \t\r\n]+/g,p?" ":"")}if(h){for(tn.currentNode=i;(p=tn.nextNode())&&!("IMG"===s||"#text"===s&&vt.test(p.data));)if(!a(p)){p=null;break}f=f.replace(/[ \t\r\n]+$/g,p?" ":"")}if(f){i.data=f;continue}}e.removeChild(i),o-=1,r-=1}return e},on=function In(e){for(var t,n=e.childNodes,o=n.length;o--;)t=n[o],t.nodeType!==F||r(t)?t.nodeType!==M||t.data||e.removeChild(t):(In(t),a(t)&&!t.firstChild&&e.removeChild(t))},rn=function(e){return e.nodeType===F?"BR"===e.nodeName:vt.test(e.data)},an=function(e,t){for(var o,r=e.parentNode;a(r);)r=r.parentNode;return o=new n(r,z|q,rn),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},sn=function(e,t,n){var o,r,i,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;l>o;o+=1)d[o]=an(s[o],n);for(;l--;)r=s[l],i=r.parentNode,i&&(d[l]?a(i)||E(i,t):N(r))},dn=function(e,t,n){var o,r,i=t.ownerDocument.body;sn(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),i.appendChild(t),o=t.innerHTML,r=t.innerText||t.textContent,rt&&(r=r.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",r),i.removeChild(t)},ln=function(e){var t,n,o,r,i,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,u=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),dt||nt||!d)setTimeout(function(){try{u._ensureBottomLine()}catch(e){u.didError(e)}},0);else{for(t=It(l,c),n=wt(l,c),o=t===n&&t||c,r=xt(l,c),i=l.commonAncestorContainer,i.nodeType===M&&(i=i.parentNode);i&&i!==o;)a=i.cloneNode(!1),a.appendChild(r),r=a,i=i.parentNode;s=this.createElement("div"),s.appendChild(r),dn(d,s,c),e.preventDefault()}this.setSelection(l)},cn=function(e){var t,n,o,r,i,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!dt&&!nt&&d){for(t=It(l,c),n=wt(l,c),o=t===n&&t||c,l=l.cloneRange(),Ut(l),Pt(l,o,o,c),r=l.cloneContents(),i=l.commonAncestorContainer,i.nodeType===M&&(i=i.parentNode);i&&i!==o;)a=i.cloneNode(!1),a.appendChild(r),r=a,i=i.parentNode;s=this.createElement("div"),s.appendChild(r),dn(d,s,c),e.preventDefault()}},un=function(e){var t,n,o,r,i,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,u=null,h=this;if(!dt&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){h.insertHTML(e,!0)});"text/plain"===o&&(u=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):u&&u.getAsString(function(e){h.insertPlainText(e,!0)}))}if(r=a&&a.types,!dt&&r&&(_t.call(r,"text/html")>-1||!it&&_t.call(r,"text/plain")>-1&&_t.call(r,"text/rtf")<0))return e.preventDefault(),void(!d&&(i=a.getData("text/html"))?this.insertHTML(i,!0):((i=a.getData("text/plain"))||(i=a.getData("text/uri-list")))&&this.insertPlainText(i,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{h._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,N(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=h._createRange(g,m,v,_),h.setSelection(t),n&&h.insertHTML(n,!0)}catch(r){h.didError(r)}},0)},hn=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,r=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":r=!0;break;default:return}(r||o)&&this.saveUndoState()},fn=D.prototype,pn=function(e,t,n){var o=n._doc,r=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return r?o.importNode(r,!0):o.createDocumentFragment()};fn.setConfig=function(e){return e=x({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:St,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?pn:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},fn.createElement=function(e,t,n){return y(this._doc,e,t,n)},fn.createDefaultBlock=function(e){var t=this._config;return T(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},fn.didError=function(e){console.log(e)},fn.getDocument=function(){return this._doc},fn.getRoot=function(){return this._root},fn.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var gn={pathChange:1,select:1,input:1,undoStateChange:1};fn.fireEvent=function(e,t){var n,o,r,i=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(i)for(t||(t={}),t.type!==e&&(t.type=e),i=i.slice(),o=i.length;o--;){r=i[o];try{r.handleEvent?r.handleEvent(t):r.call(this,t)}catch(a){a.details="Squire: fireEvent error. Event type: "+e,this.didError(a)}}return this},fn.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},fn.handleEvent=function(e){this.fireEvent(e.type,e)},fn.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],gn[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},fn.removeEventListener=function(e,t){var n,o=this._events[e],r=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],gn[e]||("selectionchange"===e&&(r=this._doc),r.removeEventListener(e,this,!0)))}return this},fn._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var r=this._doc.createRange();return r.setStart(e,t),n?r.setEnd(n,o):r.setEnd(e,t),r},fn.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=X,At(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),L(n,e)),o},fn._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Ut(n),this.setSelection(n),this},fn.moveCursorToStart=function(){return this._moveCursorTo(!0)},fn.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var mn=function(e){return e._win.getSelection()||null};fn.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(tt&&!this._restoreSelection)R.call(this),this.blur(),this.focus();else{nt&&this._win.focus();var t=mn(this);t&&(t.removeAllRanges(),t.addRange(e))}else R.call(this);return this},fn.getSelection=function(){var e,t,n,o,i=mn(this),a=this._root;return this._isFocused&&i&&i.rangeCount&&(e=i.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&r(t)&&e.setStartBefore(t),n&&r(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,o=e.commonAncestorContainer,m(o.ownerDocument,o)||(e=null)),e||(e=this._createRange(a.firstChild,0)),e},fn.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,o=new n(e.commonAncestorContainer,q|z,function(t){return Rt(e,t,!0)}),r=e.startContainer,i=e.endContainer,s=o.currentNode=r,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===M?(t=s.data,t&&/\S/.test(t)&&(s===i&&(t=t.slice(0,e.endOffset)),s===r&&(t=t.slice(e.startOffset)),d+=t,l=!0)):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},fn.getPath=function(){return this._path};var vn=function(e,t){for(var o,r,i,s=new n(e,q,function(){return!0},!1);r=s.nextNode();)for(;(i=r.data.indexOf(X))>-1&&(!t||r.parentNode!==t);){if(1===r.length){do o=r.parentNode,o.removeChild(r),r=o,s.currentNode=o;while(a(r)&&!_(r));break}r.deleteData(i,1)}};fn._didAddZWS=function(){this._hasZWS=!0},fn._removeZWS=function(){this._hasZWS&&(vn(this._root),this._hasZWS=!1)},fn._updatePath=function(e,t){if(e){var n,o=e.startContainer,r=e.endContainer;(t||o!==this._lastAnchorNode||r!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=r,n=o&&r?o===r?v(r,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},fn._updatePathOnEvent=function(){var e=this;e._isFocused&&!e._willUpdatePath&&(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))},fn.focus=function(){return this._root.focus(),ct&&this.fireEvent("focus"),this},fn.blur=function(){return this._root.blur(),ct&&this.fireEvent("blur"),this};var _n="squire-selection-start",Nn="squire-selection-end";fn._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:_n,type:"hidden"}),o=this.createElement("INPUT",{id:Nn,type:"hidden"});At(e,n),e.collapse(!1),At(e,o),n.compareDocumentPosition(o)&w&&(n.id=Nn,o.id=_n,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},fn._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+_n),o=t.querySelector("#"+Nn);if(n&&o){var r=n.parentNode,i=o.parentNode,a=_t.call(r.childNodes,n),s=_t.call(i.childNodes,o);r===i&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(r,a),e.setEnd(i,s),L(r,e),r!==i&&L(i,e),e.collapsed&&(r=e.startContainer,r.nodeType===M&&(i=r.childNodes[e.startOffset],i&&i.nodeType===M||(i=r.childNodes[e.startOffset-1]),i&&i.nodeType===M&&(e.setStart(i,0),e.collapse(!0))))}return e||null},fn._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||this._docWasChanged()},fn._docWasChanged=function(){if(mt&&(kt=new WeakMap),!this._ignoreAllChanges){if(gt&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},fn._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,o=this._undoIndex,r=this._undoStack,i=this._config.undo,a=i.documentSizeThreshold,s=i.undoLimit;
t||(o+=1),o<this._undoStackLength&&(r.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&o>s&&(r.splice(0,o-s),o=s,this._undoStackLength=s),r[o]=n,this._undoIndex=o,this._undoStackLength+=1,this._isInUndoState=!0}},fn.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},fn.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},fn.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(t>e+1&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:t>e+2}),this.fireEvent("input")}return this},fn.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===M&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===M&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var r,i,a=this._root,s=o.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===M)return!1;r=new n(s,q,function(e){return Rt(o,e,!0)},!1);for(var d=!1;i=r.nextNode();){if(!g(i,a,e,t))return!1;d=!0}return d},fn.getFontInfo=function(e){var n,o,r,i={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return i;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===M)for(n.nodeType===M&&(n=n.parentNode);4>a&&n;)(o=n.style)&&(!i.color&&(r=o.color)&&(i.color=r,a+=1),!i.backgroundColor&&(r=o.backgroundColor)&&(i.backgroundColor=r,a+=1),!i.family&&(r=o.fontFamily)&&(i.family=r,a+=1),!i.size&&(r=o.fontSize)&&(i.size=r,a+=1)),n=n.parentNode;return i},fn._addFormat=function(e,t,o){var r,i,s,d,l,c,u,h,f,p=this._root;if(o.collapsed){for(r=T(this.createElement(e,t),p),At(o,r),o.setStart(r.firstChild,r.firstChild.length),o.collapse(!0),f=r;a(f);)f=f.parentNode;vn(f,r)}else{if(i=new n(o.commonAncestorContainer,q|z,function(e){return(e.nodeType===M||"BR"===e.nodeName||"IMG"===e.nodeName)&&Rt(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,i.currentNode=s,i.filter(s)||(s=i.nextNode(),l=0),!s)return o;do u=i.currentNode,h=!g(u,p,e,t),h&&(u===d&&u.length>c&&u.splitText(c),u===s&&l&&(u=u.splitText(l),d===s&&(d=u,c-=l),s=u,l=0),r=this.createElement(e,t),C(u,r),r.appendChild(u));while(i.nextNode());d.nodeType!==M&&(u.nodeType===M?(d=u,c=u.length):(d=u.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},fn._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var r,i=this._doc;n.collapsed&&(ft?(r=i.createTextNode(X),this._didAddZWS()):r=i.createTextNode(""),At(n,r));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,u=n.endOffset,h=[],f=function(e,t){if(!Rt(n,e,!1)){var o,r,i=e.nodeType===M;if(!Rt(n,e,!0))return void("INPUT"===e.nodeName||i&&!e.data||h.push([t,e]));if(i)e===c&&u!==e.length&&h.push([t,e.splitText(u)]),e===d&&l&&(e.splitText(l),h.push([t,e]));else for(o=e.firstChild;o;o=r)r=o.nextSibling,f(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Rt(n,o,!0)&&p(o,e,t)});return o||g.forEach(function(e){f(e,e)}),h.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),r&&n.collapse(!1),L(s,n),n},fn.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),gt||this._docWasChanged(),this):this};var Cn={DT:"DD",DD:"DT",LI:"LI"},Sn=function(e,t,n,o){var r=Cn[t.nodeName],i=null,a=b(n,o,t.parentNode,e._root),s=e._config;return r||(r=s.blockTag,i=s.blockAttributes),p(a,r,i)||(t=y(a.ownerDocument,r,i),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};fn.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,r=It(n,o),i=wt(n,o);if(r&&i)do if(e(r)||r===i)break;while(r=u(r,o));return t&&(this.setSelection(n),this._updatePath(n,!0),gt||this._docWasChanged()),this},fn.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,o=this._root;return Wt(t,o),Pt(t,o,o,o),n=Ot(t,o,o),At(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&A(t.endContainer.childNodes[t.endOffset],o),A(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),gt||this._docWasChanged(),this};var yn=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},Tn=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},En=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:_n,type:"hidden"}),this.createElement("INPUT",{id:Nn,type:"hidden"})])},bn=function(e,t,n){for(var o,r,i,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],u=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",u),o.dir&&(a.dir=o.dir),(i=o.previousSibling)&&i.nodeName===n?(i.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(S(o)),s.currentNode=a):(o=o.parentNode,r=o.nodeName,r!==n&&/^[OU]L$/.test(r)&&C(o,e.createElement(n,c,[S(o)])))},kn=function(e){return bn(this,e,"UL"),e},Ln=function(e){return bn(this,e,"OL"),e},Bn=function(e){var t,n,o,r,i,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;n>t;t+=1)o=a[t],r=S(o),E(r,l),C(o,r);for(t=0,n=d.length;n>t;t+=1)i=d[t],s(i)?C(i,this.createDefaultBlock([S(i)])):(E(i,l),C(i,S(i)));return e},An=function(e){var t,n,o,r,i,a,s=e.querySelectorAll("LI"),l=this._config.tagAttributes;for(t=0,n=s.length;n>t;t+=1)o=s[t],d(o.firstChild)||(r=o.parentNode.nodeName,i=o.previousSibling,i&&(i=i.lastChild)&&i.nodeName===r||(a=l[r.toLowerCase()],i=this.createElement(r,a),C(o,i)),i.appendChild(o));return e},On=function(e){var t=this._root,n=e.querySelectorAll("LI");return Array.prototype.filter.call(n,function(e){return!d(e.firstChild)}).forEach(function(n){var o,r=n.parentNode,i=r.parentNode,a=n.firstChild,s=a;if(n.previousSibling&&(r=b(r,n,i,t)),/^[OU]L$/.test(i.nodeName))i.insertBefore(n,r),r.firstChild||i.removeChild(r);else for(;s&&(o=s.nextSibling,!d(s));)i.insertBefore(s,r),s=o;for("LI"===i.nodeName&&a.previousSibling&&b(i,a,i.parentNode,t);n!==e&&!n.childNodes.length;)r=n.parentNode,r.removeChild(n),n=r},this),E(e,t),e};fn._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},fn.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},fn._getHTML=function(){return this._root.innerHTML},fn._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do T(n,t);while(n=u(n,t));this._ignoreChange=!0},fn.getHTML=function(e){var t,n,o,r,i,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ht)for(t=this._root,n=t;n=u(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(r=this._getHTML().replace(/\u200B/g,""),ht)for(i=s.length;i--;)N(s[i]);return a&&this._getRangeAndRemoveBookmark(a),r},fn.setHTML=function(e){var t,n,o,r=this._config,i=r.isSetHTMLSanitized?r.sanitizeToDOMFragment:null,a=this._root;"function"==typeof i?n=i(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),nn(n),sn(n,a,!1),E(n,a);for(var s=n;s=u(s,a);)T(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),T(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,R.call(this),this._updatePath(d,!0),this},fn.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))At(t,e),t.setStartAfter(e);else{for(var n,o,r=this._root,i=It(t,r)||r;i!==r&&!i.nextSibling;)i=i.parentNode;i!==r&&(n=i.parentNode,o=b(n,i.nextSibling,r,r)),o?r.insertBefore(e,o):(r.appendChild(e),o=this.createDefaultBlock(),r.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Ut(t)}return this.focus(),this.setSelection(t),this._updatePath(t),gt||this._docWasChanged(),this},fn.insertImage=function(e,t){var n=this.createElement("IMG",x({src:e},t,!0));return this.insertElement(n),n};var xn=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,Dn=function(e,t,o){for(var r,i,a,s,d,l,c,u=e.ownerDocument,h=new n(e,q,function(e){return!g(e,t,"A")},!1),f=o._config.tagAttributes.a;r=h.nextNode();)for(i=r.data,a=r.parentNode;s=xn.exec(i);)d=s.index,l=d+s[0].length,d&&(c=u.createTextNode(i.slice(0,d)),a.insertBefore(c,r)),c=o.createElement("A",x({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=i.slice(d,l),a.insertBefore(c,r),r.data=i=i.slice(l)};fn.insertHTML=function(e,t){var n,o,r,i,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,h=this.getSelection(),f=this._doc;"function"==typeof c?i=c(e,t,this):(t&&(n=e.indexOf("<!--StartFragment-->"),o=e.lastIndexOf("<!--EndFragment-->"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),r=this.createElement("DIV"),r.innerHTML=e,i=f.createDocumentFragment(),i.appendChild(S(r))),this.saveUndoState(h);try{for(a=this._root,s=i,d={fragment:i,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},Dn(i,i,this),nn(i),sn(i,a,!1),on(i),i.normalize();s=u(s,i);)T(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Dt(h,d.fragment,a),gt||this._docWasChanged(),h.collapse(!1),this._ensureBottomLine()),this.setSelection(h),this._updatePath(h,!0),t&&this.focus()}catch(p){this.didError(p)}return this};var Rn=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};fn.insertPlainText=function(e,t){var n,o,r,i,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",u="<"+d;for(n in l)u+=" "+n+'="'+Rn(l[n])+'"';for(u+=">",o=0,r=a.length;r>o;o+=1)i=a[o],i=Rn(i).replace(/ (?= )/g,"&nbsp;"),a[o]=u+(i||"<BR>")+c;return this.insertHTML(a.join(""),t)};var Un=function(e,t,n){return function(){return this[e](t,n),this.focus()}};fn.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},fn.bold=Un("changeFormat",{tag:"B"}),fn.italic=Un("changeFormat",{tag:"I"}),fn.underline=Un("changeFormat",{tag:"U"}),fn.strikethrough=Un("changeFormat",{tag:"S"}),fn.subscript=Un("changeFormat",{tag:"SUB"},{tag:"SUP"}),fn.superscript=Un("changeFormat",{tag:"SUP"},{tag:"SUB"}),fn.removeBold=Un("changeFormat",null,{tag:"B"}),fn.removeItalic=Un("changeFormat",null,{tag:"I"}),fn.removeUnderline=Un("changeFormat",null,{tag:"U"}),fn.removeStrikethrough=Un("changeFormat",null,{tag:"S"}),fn.removeSubscript=Un("changeFormat",null,{tag:"SUB"}),fn.removeSuperscript=Un("changeFormat",null,{tag:"SUP"}),fn.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;At(n,this._doc.createTextNode(e.slice(o)))}return t=x(x({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},fn.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},fn.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":V,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{"class":V}}),this.focus()},fn.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Y,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{"class":Y}}),this.focus()},fn.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":$,style:"color:"+e}}:null,{tag:"SPAN",attributes:{"class":$}}),this.focus()},fn.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Q,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{"class":Q}}),this.focus()},fn.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},fn.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},fn.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Wt(e,t),n=t),n.nodeType===M)return this;this.saveUndoState(e),Pt(e,n,n,t);for(var o,r,i=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,u=i.createDocumentFragment(),h=i.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,u.appendChild(p),p=o;return I(this,u,h),h.normalize(),p=h.firstChild,o=h.lastChild,r=n.childNodes,p?(n.insertBefore(h,f),d=_t.call(r,p),c=_t.call(r,o)+1):(d=_t.call(r,f),c=d),e.setStart(n,d),e.setEnd(n,c),L(n,e),Ut(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},fn.increaseQuoteLevel=Un("modifyBlocks",yn),fn.decreaseQuoteLevel=Un("modifyBlocks",Tn),fn.makeUnorderedList=Un("modifyBlocks",kn),fn.makeOrderedList=Un("modifyBlocks",Ln),fn.removeList=Un("modifyBlocks",Bn),fn.increaseListLevel=Un("modifyBlocks",An),fn.decreaseListLevel=Un("modifyBlocks",On),D.isInline=a,D.isBlock=s,D.isContainer=d,D.getBlockWalker=l,D.getPreviousBlock=c,D.getNextBlock=u,D.areAlike=f,D.hasTagAttributes=p,D.getNearest=g,D.isOrContains=m,D.detach=N,D.replaceWith=C,D.empty=S,D.getNodeBefore=Lt,D.getNodeAfter=Bt,D.insertNodeInRange=At,D.extractContentsOfRange=Ot,D.deleteContentsOfRange=xt,D.insertTreeFragmentIntoRange=Dt,D.isNodeContainedInRange=Rt,D.moveRangeBoundariesDownTree=Ut,D.moveRangeBoundariesUpTree=Pt,D.getStartBlockOfRange=It,D.getEndBlockOfRange=wt,D.contentWalker=Ft,D.rangeDoesStartAtBlockBoundary=Mt,D.rangeDoesEndAtBlockBoundary=Ht,D.expandRangeToBlockBoundaries=Wt,D.onPaste=un,D.addLinks=Dn,D.splitBlock=Sn,D.startSelectionId=_n,D.endSelectionId=Nn,"object"==typeof exports?module.exports=D:"function"==typeof define&&define.amd?define(function(){return D}):(J.Squire=D,top!==J&&"true"===e.documentElement.getAttribute("data-squireinit")&&(J.editor=new D(e),J.onEditorLoad&&(J.onEditorLoad(J.editor),J.onEditorLoad=null)))}(document);
>>>>>>> 6842cb9... Fix undo does not always restore cursor position.
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===F&&!!St[e.nodeName]}function r(e){switch(e.nodeType){case M:return yt;case F:case W:if(mt&&kt.has(e))return kt.get(e);break;default:return Tt}var t;return t=o(e.childNodes,a)?Ct.test(e.nodeName)?yt:Et:bt,mt&&kt.set(e,t),t}function a(e){return r(e)===yt}function s(e){return r(e)===Et}function d(e){return r(e)===bt}function l(e,t){var o=new n(t,z,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function g(e,t,n,o){for(;e&&e!==t;){if(p(e,n,o))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t){var n,o,i,r,a="";return e&&e!==t&&(a=v(e.parentNode,t),e.nodeType===F&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(r=e.dir)&&(a+="[dir="+r+"]"),i&&(_t.call(i,$)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),_t.call(i,Q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),_t.call(i,V)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),_t.call(i,Y)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function _(e){var t=e.nodeType;return t===F||t===W?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function T(e,n,o,i){var r,a,s,d,l=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)a=o[r],a!==t&&l.setAttribute(r,o[r]);if(i)for(s=0,d=i.length;d>s;s+=1)l.appendChild(i[s]);return l}function y(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===M)return d;if(a(e)){for(o=e.firstChild;ft&&o&&o.nodeType===M&&!o.data;)e.removeChild(o),o=e.firstChild;o||(ft?(n=s.createTextNode(X),r._didAddZWS()):n=s.createTextNode(""))}else if(ut){for(;e.nodeType!==M&&!i(e);){if(o=e.firstChild,!o){n=s.createTextNode("");break}e=o}e.nodeType===M?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=T(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(l){r.didError({name:"Squire: fixCursor – "+l,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;o>n;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=T(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=T(l,h.blockTag,h.blockAttributes)),y(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&E(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===M&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===F){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),y(e,o),y(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function k(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&f(n,o)&&!St[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=_(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=_(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=_(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=_(o))),N(n),n.nodeType===M?o.appendData(n.data):d.push(S(n));else if(n.nodeType===F){for(i=d.length;i--;)n.appendChild(d.pop());k(n,t)}}function L(e,t){if(e.nodeType===M&&(e=e.parentNode),e.nodeType===F){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function x(e,t,n,o){for(var i,r,a,s=t;(i=s.parentNode)&&i!==o&&i.nodeType===F&&1===i.childNodes.length;)s=i;N(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),L(e,n),st&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function O(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&f(i,e)){if(!d(i)){if(!s)return;o=T(a,"DIV"),o.appendChild(S(i)),i.appendChild(o)}N(e),n=!d(e),i.appendChild(S(e)),n&&E(i,t),r&&O(r,t)}else s&&(i=T(a,"DIV"),e.insertBefore(i,r),y(i,t))}function A(e){this.isShiftDown=e.shiftKey}function B(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?B(e[o],i,n):i);return e}function D(e,t){e.nodeType===H&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,pt&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,gt?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",R),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(at?"beforecut":"cut",ln),this.addEventListener("copy",cn),this.addEventListener("keydown",A),this.addEventListener("keyup",A),this.addEventListener(at?"beforepaste":"paste",hn),this.addEventListener("drop",un),this.addEventListener(st?"keypress":"keydown",qt),this._keyHandlers=Object.create(jt),this.setConfig(t),at&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(r){}e.__squire__=this,this.setHTML("")}function R(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===M||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([I(e,o,e._doc.createDocumentFragment())]));continue}I(e,o,n)}return n}var w=2,F=1,M=3,H=9,W=11,z=1,q=4,K=0,G=1,Z=2,j=3,$="highlight",Q="colour",V="font",Y="size",X="​",J=e.defaultView,et=navigator.userAgent,tt=/Android/.test(et),nt=/iP(?:ad|hone|od)/.test(et),ot=/Mac OS X/.test(et),it=/Windows NT/.test(et),rt=/Gecko\//.test(et),at=/Trident\/[456]\./.test(et),st=!!J.opera,dt=/Edge\//.test(et),lt=!dt&&/WebKit\//.test(et),ct=/Trident\/[4567]\./.test(et),ht=ot?"meta-":"ctrl-",ut=at||st,ft=at||lt,pt=at,gt="undefined"!=typeof MutationObserver,mt="undefined"!=typeof WeakMap,vt=/[^ \t\r\n]/,_t=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var Nt={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)e=t.nextSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)e=t.previousSibling,e||(t=t.parentNode);if(!e)return null;if(Nt[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var Ct=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,St={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},Tt=0,yt=1,Et=2,bt=3,kt=mt?new WeakMap:null,Lt=function(e,t){for(var n=e.childNodes;t&&e.nodeType===F;)e=n[t-1],n=e.childNodes,t=n.length;return e},xt=function(e,t){if(e.nodeType===F){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Ot=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===M?(n=a.parentNode,o=n.childNodes,s===a.length?(s=_t.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=_t.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},At=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===M&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?_t.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===M&&l.nodeType===M&&(o=d,i=d.length,d.appendData(l.data),N(l)),e.setStart(o,i),e.collapse(!0),y(t,n),u},Bt=function(e,t){var n,o,i=It(e,t),r=wt(e,t),a=i!==r;return Ut(e),Pt(e,i,r,t),n=At(e,null,t),Ut(e),a&&(r=wt(e,t),i&&r&&i!==r&&x(i,r,e,t)),i&&y(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},Dt=function(e,t,n){var o,i,r,s,l,u,f,p,m,v;for(E(t,n),o=t;o=h(o,n);)y(o,n);if(e.collapsed||Bt(e,n),Ut(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,i=It(e,n),f=h(t,t),i&&f&&!g(f,t,"TABLE")){if(Pt(e,i,i,n),e.collapse(!0),l=e.endContainer,u=e.endOffset,sn(i,n,!1),a(l)&&(p=b(l,u,c(l,n),n),l=p.parentNode,u=_t.call(l.childNodes,p)),u!==_(l))for(r=n.ownerDocument.createDocumentFragment();o=l.childNodes[u];)r.appendChild(o);x(l,f,e,n),u=_t.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,u)}_(t)&&(Pt(e,s,s,n),p=b(e.endContainer,e.endOffset,s,n),m=p?p.previousSibling:s.lastChild,s.insertBefore(t,p),p?e.setEndBefore(p):e.setEnd(s,_(s)),i=wt(e,n),Ut(e),l=e.endContainer,u=e.endOffset,p&&d(p)&&O(p,n),p=m&&m.nextSibling,p&&d(p)&&O(p,n),e.setEnd(l,u)),r&&(v=e.cloneRange(),x(i,r,v,n),e.setEnd(v.endContainer,v.endOffset)),Ut(e)},Rt=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(j,o)>-1,r=e.compareBoundaryPoints(G,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(K,o)<1,s=e.compareBoundaryPoints(Z,o)>-1;return a&&s},Ut=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==M&&(t=n.childNodes[o],t&&!i(t));)n=t,o=0;if(a)for(;r.nodeType!==M;){if(t=r.childNodes[a-1],!t||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=_(r)}else for(;r.nodeType!==M&&(t=r.firstChild,t&&!i(t));)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Pt=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=_t.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==M&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==_(s))break;i=s.parentNode,d=_t.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},It=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=Lt(o,e.startOffset),n=h(n,t)),n&&Rt(e,n,!0)?n:null},wt=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(n=xt(i,e.endOffset),!n||!m(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Rt(e,n,!0)?n:null},Ft=new n(null,q|z,function(e){return e.nodeType===M?vt.test(e.data):"IMG"===e.nodeName}),Mt=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(Ft.root=null,o.nodeType===M){if(i)return!1;n=o}else if(n=xt(o,i),n&&!m(t,n)&&(n=null),!n&&(n=Lt(o,i),n.nodeType===M&&n.length))return!1;return Ft.currentNode=n,Ft.root=It(e,t),!Ft.previousNode()},Ht=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(Ft.root=null,o.nodeType===M){if(n=o.data.length,n&&n>i)return!1;Ft.currentNode=o}else Ft.currentNode=Lt(o,i);return Ft.root=wt(e,t),!Ft.nextNode()},Wt=function(e,t){var n,o=It(e,t),i=wt(e,t);o&&i&&(n=o.parentNode,e.setStart(n,_t.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,_t.call(n.childNodes,i)+1))},zt={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},qt=function(e){var t=e.keyCode,n=zt[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),st&&46===e.which&&(n="."),t>111&&124>t&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),Bt(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},Kt=function(e){return function(t,n){n.preventDefault(),t[e]()}},Gt=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Zt=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===M&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===X);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,_t.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),y(n,e._root),Ut(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(i){e.didError(i)}},jt={enter:function(e,t,n){var o,i,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),Bn(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||Bt(n,a),o=It(n,a),!o||/^T[HD]$/.test(o.nodeName))return i=g(n.endContainer,a,"A"),i&&(i=i.parentNode,Pt(n,i,i,a),n.collapse(!1)),Ot(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=g(o,a,"LI"))&&(o=i),u(o)){if(g(o,a,"UL")||g(o,a,"OL"))return e.decreaseListLevel(n);if(g(o,a,"BLOCKQUOTE"))return e.modifyBlocks(En,n)}for(r=Sn(e,o,n.startContainer,n.startOffset),vn(o),on(o),y(o,a);r.nodeType===F;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===X)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===M&&!d.data&&(s=d.nextSibling,s&&"BR"!==s.nodeName);)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===M&&!st)break;r=d}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Mt(n,o)){t.preventDefault();var i,r=It(n,o);if(!r)return;if(E(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void N(i);for(x(i,r,n,o),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&O(r,o),e.setSelection(n)}else if(r){if(g(r,o,"UL")||g(r,o,"OL"))return e.decreaseListLevel(n);if(g(r,o,"BLOCKQUOTE"))return e.modifyBlocks(yn,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Zt(e)},0);else t.preventDefault(),Bt(n,o),Zt(e,n)},"delete":function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ht(n,l)){if(t.preventDefault(),o=It(n,l),!o)return;if(E(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void N(i);for(x(o,i,n,l),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&O(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),Pt(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===F&&(d=a.childNodes[s],d&&"IMG"===d.nodeName))return t.preventDefault(),N(d),Ut(n),void Zt(e,n);e.setSelection(r),setTimeout(function(){Zt(e)},0)}else t.preventDefault(),Bt(n,l),Zt(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&Mt(n,r))for(o=It(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.increaseListLevel(n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&Mt(n,i)&&(o=n.startContainer,(g(o,i,"UL")||g(o,i,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),Bn(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===_(o)?n.setStartAfter(i):n.collapsed||(Bt(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};ot&&rt&&(jt["meta-left"]=function(e,t){t.preventDefault();var n=mn(e);n&&n.modify&&n.modify("move","backward","lineboundary")},jt["meta-right"]=function(e,t){t.preventDefault();var n=mn(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),ot||(jt.pageup=function(e){e.moveCursorToStart()},jt.pagedown=function(e){e.moveCursorToEnd()}),jt[ht+"b"]=Gt("B"),jt[ht+"i"]=Gt("I"),jt[ht+"u"]=Gt("U"),jt[ht+"shift-7"]=Gt("S"),jt[ht+"shift-5"]=Gt("SUB",{tag:"SUP"}),jt[ht+"shift-6"]=Gt("SUP",{tag:"SUB"}),jt[ht+"shift-8"]=Kt("makeUnorderedList"),jt[ht+"shift-9"]=Kt("makeOrderedList"),jt[ht+"["]=Kt("decreaseQuoteLevel"),jt[ht+"]"]=Kt("increaseQuoteLevel"),jt[ht+"y"]=Kt("redo"),jt[ht+"z"]=Kt("undo"),jt[ht+"shift-z"]=Kt("redo");var $t={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Qt={backgroundColor:{regexp:vt,replace:function(e,t){return T(e,"SPAN",{"class":$,style:"background-color:"+t})}},color:{regexp:vt,replace:function(e,t){return T(e,"SPAN",{"class":Q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return T(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return T(e,"I")}},fontFamily:{regexp:vt,replace:function(e,t){return T(e,"SPAN",{"class":V,style:"font-family:"+t})}},fontSize:{regexp:vt,replace:function(e,t){return T(e,"SPAN",{"class":Y,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return T(e,"U")}}},Vt=function(e){return function(t,n){var o=T(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(S(t)),o}},Yt=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in Qt)o=Qt[n],i=d[n],i&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Xt={P:Yt,SPAN:Yt,STRONG:Vt("B"),EM:Vt("I"),INS:Vt("U"),STRIKE:Vt("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=T(c,"SPAN",{"class":V,style:"font-family:"+s}),a=n,r=n),d&&(o=T(c,"SPAN",{"class":Y,style:"font-size:"+$t[d]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=T(c,"SPAN",{"class":Q,style:"color:"+l}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=T(c,"SPAN")),t.replaceChild(a,e),r.appendChild(S(e)),r},TT:function(e,t){var n=T(e.ownerDocument,"SPAN",{"class":V,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(S(e)),n}},Jt=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,en=/^(?:HEAD|META|STYLE)/,tn=new n(null,q|z,function(){return!0}),nn=function Un(e,t){var n,o,i,r,s,d,l,c,h,u,f,p,g=e.childNodes;for(n=e;a(n);)n=n.parentNode;for(tn.root=n,o=0,i=g.length;i>o;o+=1)if(r=g[o],s=r.nodeName,d=r.nodeType,l=Xt[s],d===F){if(c=r.childNodes.length,l)r=l(r,e);else{if(en.test(s)){e.removeChild(r),o-=1,i-=1;continue}if(!Jt.test(s)&&!a(r)){o-=1,i+=c-1,e.replaceChild(S(r),r);continue}}c&&Un(r,t||"PRE"===s)}else{if(d===M){if(f=r.data,h=!vt.test(f.charAt(0)),u=!vt.test(f.charAt(f.length-1)),t||!h&&!u)continue;if(h){for(tn.currentNode=r;(p=tn.previousPONode())&&(s=p.nodeName,!("IMG"===s||"#text"===s&&vt.test(p.data)));)if(!a(p)){p=null;break}f=f.replace(/^[ \t\r\n]+/g,p?" ":"")}if(u){for(tn.currentNode=r;(p=tn.nextNode())&&!("IMG"===s||"#text"===s&&vt.test(p.data));)if(!a(p)){p=null;break}f=f.replace(/[ \t\r\n]+$/g,p?" ":"")}if(f){r.data=f;continue}}e.removeChild(r),o-=1,i-=1}return e},on=function Pn(e){for(var t,n=e.childNodes,o=n.length;o--;)t=n[o],t.nodeType!==F||i(t)?t.nodeType!==M||t.data||e.removeChild(t):(Pn(t),a(t)&&!t.firstChild&&e.removeChild(t))},rn=function(e){return e.nodeType===F?"BR"===e.nodeName:vt.test(e.data)},an=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,z|q,rn),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},sn=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;l>o;o+=1)d[o]=an(s[o],n);for(;l--;)i=s[l],r=i.parentNode,r&&(d[l]?a(r)||E(r,t):N(i))},dn=function(e,t,n){var o,i,r=t.ownerDocument.body;sn(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,it&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},ln=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),dt||nt||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=It(l,c),n=wt(l,c),o=t===n&&t||c,i=Bt(l,c),r=l.commonAncestorContainer,r.nodeType===M&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),dn(d,s,c),e.preventDefault()}this.setSelection(l)},cn=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!dt&&!nt&&d){for(t=It(l,c),n=wt(l,c),o=t===n&&t||c,l=l.cloneRange(),Ut(l),Pt(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===M&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),dn(d,s,c),e.preventDefault()}},hn=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(!dt&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!dt&&i&&(_t.call(i,"text/html")>-1||!rt&&_t.call(i,"text/plain")>-1&&_t.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,N(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u._createRange(g,m,v,_),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(i){u.didError(i)}},0)},un=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},fn=D.prototype,pn=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};fn.setConfig=function(e){return e=B({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:St,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?pn:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},fn.createElement=function(e,t,n){return T(this._doc,e,t,n)},fn.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},fn.didError=function(e){console.log(e)},fn.getDocument=function(){return this._doc},fn.getRoot=function(){return this._root},fn.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var gn={pathChange:1,select:1,input:1,undoStateChange:1};fn.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(a){a.details="Squire: fireEvent error. Event type: "+e,this.didError(a)}}return this},fn.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},fn.handleEvent=function(e){this.fireEvent(e.type,e)},fn.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],gn[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},fn.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],gn[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},fn._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},fn.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=X,Ot(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),L(n,e)),o},fn._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return Ut(n),this.setSelection(n),this},fn.moveCursorToStart=function(){return this._moveCursorTo(!0)},fn.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var mn=function(e){return e._win.getSelection()||null};fn.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(tt&&!this._restoreSelection)R.call(this),this.blur(),this.focus();else{nt&&this._win.focus();var t=mn(this);t&&(t.removeAllRanges(),t.addRange(e))}else R.call(this);return this},fn.getSelection=function(){var e,t,n,o,r=mn(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,o=e.commonAncestorContainer,m(o.ownerDocument,o)||(e=null)),e||(e=this._createRange(a.firstChild,0)),e},fn.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,o=new n(e.commonAncestorContainer,q|z,function(t){return Rt(e,t,!0)}),i=e.startContainer,r=e.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===M?(t=s.data,t&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===i&&(t=t.slice(e.startOffset)),d+=t,l=!0)):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},fn.getPath=function(){return this._path};var vn=function(e,t){for(var o,i,r,s=new n(e,q,function(){return!0},!1);i=s.nextNode();)for(;(r=i.data.indexOf(X))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o;while(a(i)&&!_(i));break}i.deleteData(r,1)}};fn._didAddZWS=function(){this._hasZWS=!0},fn._removeZWS=function(){this._hasZWS&&(vn(this._root),this._hasZWS=!1)},fn._updatePath=function(e,t){if(e){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?v(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},fn._updatePathOnEvent=function(){var e=this;e._isFocused&&!e._willUpdatePath&&(e._willUpdatePath=!0,setTimeout(function(){e._willUpdatePath=!1,e._updatePath(e.getSelection())},0))},fn.focus=function(){return this._root.focus(),ct&&this.fireEvent("focus"),this},fn.blur=function(){return this._root.blur(),ct&&this.fireEvent("blur"),this};var _n="squire-selection-start",Nn="squire-selection-end";fn._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:_n,type:"hidden"}),o=this.createElement("INPUT",{id:Nn,type:"hidden"});Ot(e,n),e.collapse(!1),Ot(e,o),n.compareDocumentPosition(o)&w&&(n.id=Nn,o.id=_n,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},fn._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+_n),o=t.querySelector("#"+Nn);if(n&&o){var i=n.parentNode,r=o.parentNode,a=_t.call(i.childNodes,n),s=_t.call(r.childNodes,o);i===r&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),L(i,e),i!==r&&L(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===M&&(r=i.childNodes[e.startOffset],r&&r.nodeType===M||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===M&&(e.setStart(r,0),e.collapse(!0))))}return e||null},fn._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(16>t||t>20)||!(33>t||t>45)||this._docWasChanged()},fn._docWasChanged=function(){if(mt&&(kt=new WeakMap),!this._ignoreAllChanges){if(gt&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")
}},fn._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,o=this._undoIndex,i=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(o+=1),o<this._undoStackLength&&(i.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&o>s&&(i.splice(0,o-s),o=s,this._undoStackLength=s),i[o]=n,this._undoIndex=o,this._undoStackLength+=1,this._isInUndoState=!0}},fn.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},fn.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},fn.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(t>e+1&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:t>e+2}),this.fireEvent("input")}return this},fn.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===M&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===M&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===M)return!1;i=new n(s,q,function(e){return Rt(o,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},fn.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===M)for(n.nodeType===M&&(n=n.parentNode);4>a&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},fn._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f,p=this._root;if(o.collapsed){for(i=y(this.createElement(e,t),p),Ot(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),f=i;a(f);)f=f.parentNode;vn(f,i)}else{if(r=new n(o.commonAncestorContainer,q|z,function(e){return(e.nodeType===M||"BR"===e.nodeName||"IMG"===e.nodeName)&&Rt(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do h=r.currentNode,u=!g(h,p,e,t),u&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),C(h,i),i.appendChild(h));while(r.nextNode());d.nodeType!==M&&(h.nodeType===M?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},fn._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(ft?(i=r.createTextNode(X),this._didAddZWS()):i=r.createTextNode(""),Ot(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Rt(n,e,!1)){var o,i,r=e.nodeType===M;if(!Rt(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,f(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Rt(n,o,!0)&&p(o,e,t)});return o||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),L(s,n),n},fn.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),gt||this._docWasChanged(),this):this};var Cn={DT:"DD",DD:"DT",LI:"LI"},Sn=function(e,t,n,o){var i=Cn[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),p(a,i,r)||(t=T(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};fn.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=It(n,o),r=wt(n,o);if(i&&r)do if(e(i)||i===r)break;while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),gt||this._docWasChanged()),this},fn.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,o=this._root;return Wt(t,o),Pt(t,o,o,o),n=At(t,o,o),Ot(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&O(t.endContainer.childNodes[t.endOffset],o),O(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),gt||this._docWasChanged(),this};var Tn=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},yn=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},En=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:_n,type:"hidden"}),this.createElement("INPUT",{id:Nn,type:"hidden"})])},bn=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(S(o)),s.currentNode=a):(o=o.parentNode,i=o.nodeName,i!==n&&/^[OU]L$/.test(i)&&C(o,e.createElement(n,c,[S(o)])))},kn=function(e){return bn(this,e,"UL"),e},Ln=function(e){return bn(this,e,"OL"),e},xn=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;n>t;t+=1)o=a[t],i=S(o),E(i,l),C(o,i);for(t=0,n=d.length;n>t;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([S(r)])):(E(r,l),C(r,S(r)));return e},On=function(e,t){for(var n=e.commonAncestorContainer,o=e.startContainer,i=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(o===n&&(o=o.childNodes[e.startOffset]),i===n&&(i=i.childNodes[e.endOffset]);o&&o.parentNode!==n;)o=o.parentNode;for(;i&&i.parentNode!==n;)i=i.parentNode;return[n,o,i]};fn.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=On(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];if(!i||i===o.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=o.nodeName,l=i.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),o.insertBefore(l,i));do s=i===r?null:i.nextSibling,l.appendChild(i);while(i=s);return s=l.nextSibling,s&&O(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),gt||this._docWasChanged(),this.focus()},fn.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=On(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];i||(i=o.firstChild),r||(r=o.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=o.parentNode,d=r.nextSibling?b(o,r.nextSibling,s,t):o.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=o.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do a=i===r?null:i.nextSibling,o.removeChild(i),l&&"LI"===i.nodeName&&(i=this.createDefaultBlock([S(i)])),s.insertBefore(i,d);while(i=a);return o.firstChild||N(o),d&&O(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),gt||this._docWasChanged(),this.focus()},fn._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},fn.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},fn._getHTML=function(){return this._root.innerHTML},fn._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do y(n,t);while(n=h(n,t));this._ignoreChange=!0},fn.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ut)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ut)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},fn.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),nn(n),sn(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,R.call(this),this._updatePath(d,!0),this},fn.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))Ot(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=It(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),Ut(t)}return this.focus(),this.setSelection(t),this._updatePath(t),gt||this._docWasChanged(),this},fn.insertImage=function(e,t){var n=this.createElement("IMG",B({src:e},t,!0));return this.insertElement(n),n};var An=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,Bn=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,q,function(e){return!g(e,t,"A")},!1),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=An.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",B({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};fn.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("<!--StartFragment-->"),o=e.lastIndexOf("<!--EndFragment-->"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},Bn(r,r,this),nn(r),sn(r,a,!1),on(r),r.normalize();s=h(s,r);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Dt(u,d.fragment,a),gt||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(p){this.didError(p)}return this};var Dn=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};fn.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Dn(l[n])+'"';for(h+=">",o=0,i=a.length;i>o;o+=1)r=a[o],r=Dn(r).replace(/ (?= )/g,"&nbsp;"),a[o]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var Rn=function(e,t,n){return function(){return this[e](t,n),this.focus()}};fn.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},fn.bold=Rn("changeFormat",{tag:"B"}),fn.italic=Rn("changeFormat",{tag:"I"}),fn.underline=Rn("changeFormat",{tag:"U"}),fn.strikethrough=Rn("changeFormat",{tag:"S"}),fn.subscript=Rn("changeFormat",{tag:"SUB"},{tag:"SUP"}),fn.superscript=Rn("changeFormat",{tag:"SUP"},{tag:"SUB"}),fn.removeBold=Rn("changeFormat",null,{tag:"B"}),fn.removeItalic=Rn("changeFormat",null,{tag:"I"}),fn.removeUnderline=Rn("changeFormat",null,{tag:"U"}),fn.removeStrikethrough=Rn("changeFormat",null,{tag:"S"}),fn.removeSubscript=Rn("changeFormat",null,{tag:"SUB"}),fn.removeSuperscript=Rn("changeFormat",null,{tag:"SUP"}),fn.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;Ot(n,this._doc.createTextNode(e.slice(o)))}return t=B(B({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},fn.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},fn.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":V,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{"class":V}}),this.focus()},fn.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Y,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{"class":Y}}),this.focus()},fn.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":Q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{"class":Q}}),this.focus()},fn.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{"class":$,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{"class":$}}),this.focus()},fn.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},fn.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},fn.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Wt(e,t),n=t),n.nodeType===M)return this;this.saveUndoState(e),Pt(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return I(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=_t.call(i,p),c=_t.call(i,o)+1):(d=_t.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),L(n,e),Ut(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},fn.increaseQuoteLevel=Rn("modifyBlocks",Tn),fn.decreaseQuoteLevel=Rn("modifyBlocks",yn),fn.makeUnorderedList=Rn("modifyBlocks",kn),fn.makeOrderedList=Rn("modifyBlocks",Ln),fn.removeList=Rn("modifyBlocks",xn),D.isInline=a,D.isBlock=s,D.isContainer=d,D.getBlockWalker=l,D.getPreviousBlock=c,D.getNextBlock=h,D.areAlike=f,D.hasTagAttributes=p,D.getNearest=g,D.isOrContains=m,D.detach=N,D.replaceWith=C,D.empty=S,D.getNodeBefore=Lt,D.getNodeAfter=xt,D.insertNodeInRange=Ot,D.extractContentsOfRange=At,D.deleteContentsOfRange=Bt,D.insertTreeFragmentIntoRange=Dt,D.isNodeContainedInRange=Rt,D.moveRangeBoundariesDownTree=Ut,D.moveRangeBoundariesUpTree=Pt,D.getStartBlockOfRange=It,D.getEndBlockOfRange=wt,D.contentWalker=Ft,D.rangeDoesStartAtBlockBoundary=Mt,D.rangeDoesEndAtBlockBoundary=Ht,D.expandRangeToBlockBoundaries=Wt,D.onPaste=hn,D.addLinks=Bn,D.splitBlock=Sn,D.startSelectionId=_n,D.endSelectionId=Nn,"object"==typeof exports?module.exports=D:"function"==typeof define&&define.amd?define(function(){return D}):(J.Squire=D,top!==J&&"true"===e.documentElement.getAttribute("data-squireinit")&&(J.editor=new D(e),J.onEditorLoad&&(J.onEditorLoad(J.editor),J.onEditorLoad=null)))}(document);
>>>>>>> 033370e... Don't try to merge table cell into block on paste
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!ge[e.nodeName]}function r(e){switch(e.nodeType){case F:return ve;case w:case H:if(ce&&Ce.has(e))return Ce.get(e);break;default:return me}var t;return t=o(e.childNodes,a)?pe.test(e.nodeName)?ve:_e:Ne,ce&&Ce.set(e,t),t}function a(e){return r(e)===ve}function s(e){return r(e)===_e}function d(e){return r(e)===Ne}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function g(e,t,n,o){for(;e&&e!==t;){if(p(e,n,o))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t){var n,o,i,r,a="";return e&&e!==t&&(a=v(e.parentNode,t),e.nodeType===w&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(r=e.dir)&&(a+="[dir="+r+"]"),i&&(ue.call(i,z)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),ue.call(i,q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),ue.call(i,K)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),ue.call(i,G)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function _(e){var t=e.nodeType;return t===w||t===H?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function T(e,n,o,i){var r,a,s,d=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)o[r]!==t&&d.setAttribute(r,o[r]);if(i)for(a=0,s=i.length;a<s;a+=1)d.appendChild(i[a]);return d}function y(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;se&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(se?(n=s.createTextNode(Z),r._didAddZWS()):n=s.createTextNode(""))}else if(ae){for(;e.nodeType!==F&&!i(e);){if(!(o=e.firstChild)){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=T(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;n<o;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=T(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=T(l,h.blockTag,h.blockAttributes)),y(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&E(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),y(e,o),y(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function k(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&f(n,o)&&!ge[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=_(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=_(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=_(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=_(o))),N(n),n.nodeType===F?o.appendData(n.data):d.push(S(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());k(n,t)}}function L(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function x(e,t,n,o){for(var i,r,a,s=t;(i=s.parentNode)&&i!==o&&i.nodeType===w&&1===i.childNodes.length;)s=i;N(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),L(e,n),te&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function O(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&f(i,e)){if(!d(i)){if(!s)return;o=T(a,"DIV"),o.appendChild(S(i)),i.appendChild(o)}N(e),n=!d(e),i.appendChild(S(e)),n&&E(i,t),r&&O(r,t)}else s&&(i=T(a,"DIV"),e.insertBefore(i,r),y(i,t))}function A(e){this.isShiftDown=e.shiftKey}function B(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?B(e[o],i,n):i);return e}function R(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,de&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,le?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(ee?"beforecut":"cut",nt),this.addEventListener("copy",ot),this.addEventListener("keydown",A),this.addEventListener("keyup",A),this.addEventListener(ee?"beforepaste":"paste",it),this.addEventListener("drop",rt),this.addEventListener(te?"keypress":"keydown",we),this._keyHandlers=Object.create(We),this.setConfig(t),ee&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([I(e,o,e._doc.createDocumentFragment())]));continue}I(e,o,n)}return n}var w=1,F=3,M=9,H=11,W=1,z="highlight",q="colour",K="font",G="size",Z="​",j=e.defaultView,$=navigator.userAgent,Q=/Android/.test($),V=/iP(?:ad|hone|od)/.test($),Y=/Mac OS X/.test($),X=/Windows NT/.test($),J=/Gecko\//.test($),ee=/Trident\/[456]\./.test($),te=!!j.opera,ne=/Edge\//.test($),oe=!ne&&/WebKit\//.test($),ie=/Trident\/[4567]\./.test($),re=Y?"meta-":"ctrl-",ae=ee||te,se=ee||oe,de=ee,le="undefined"!=typeof MutationObserver,ce="undefined"!=typeof WeakMap,he=/[^ \t\r\n]/,ue=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var fe={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(fe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(fe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(fe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var pe=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,ge={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},me=0,ve=1,_e=2,Ne=3,Ce=ce?new WeakMap:null,Se=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Te=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},ye=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=ue.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=ue.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},Ee=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?ue.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,d.appendData(l.data),N(l)),e.setStart(o,i),e.collapse(!0),y(t,n),u},be=function(e,t){var n,o,i=Ae(e,t),r=Be(e,t),a=i!==r;return xe(e),Oe(e,i,r,t),n=Ee(e,null,t),xe(e),a&&(r=Be(e,t),i&&r&&i!==r&&x(i,r,e,t)),i&&y(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},ke=function(e,t,n){var o,i,r,s,l,u,f,p,m,v;for(E(t,n),o=t;o=h(o,n);)y(o,n);if(e.collapsed||be(e,n),xe(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,i=Ae(e,n),f=h(t,t),i&&f&&!g(f,t,"PRE")&&!g(f,t,"TABLE")){if(Oe(e,i,i,n),e.collapse(!0),l=e.endContainer,u=e.endOffset,et(i,n,!1),a(l)&&(p=b(l,u,c(l,n),n),l=p.parentNode,u=ue.call(l.childNodes,p)),u!==_(l))for(r=n.ownerDocument.createDocumentFragment();o=l.childNodes[u];)r.appendChild(o);x(l,f,e,n),u=ue.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,u)}_(t)&&(Oe(e,s,s,n),p=b(e.endContainer,e.endOffset,s,n),m=p?p.previousSibling:s.lastChild,s.insertBefore(t,p),p?e.setEndBefore(p):e.setEnd(s,_(s)),i=Be(e,n),xe(e),l=e.endContainer,u=e.endOffset,p&&d(p)&&O(p,n),p=m&&m.nextSibling,p&&d(p)&&O(p,n),e.setEnd(l,u)),r&&(v=e.cloneRange(),x(i,r,v,n),e.setEnd(v.endContainer,v.endOffset)),xe(e)},Le=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(3,o)>-1,r=e.compareBoundaryPoints(1,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(0,o)<1,s=e.compareBoundaryPoints(2,o)>-1;return a&&s},xe=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o])&&!i(t);)n=t,o=0;if(a)for(;r.nodeType!==F;){if(!(t=r.childNodes[a-1])||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=_(r)}else for(;r.nodeType!==F&&(t=r.firstChild)&&!i(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Oe=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=ue.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==_(s))break;i=s.parentNode,d=ue.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},Ae=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=Se(o,e.startOffset),n=h(n,t)),n&&Le(e,n,!0)?n:null},Be=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(!(n=Te(i,e.endOffset))||!m(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Le(e,n,!0)?n:null},Re=new n(null,4|W,function(e){return e.nodeType===F?he.test(e.data):"IMG"===e.nodeName}),De=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(Re.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Te(o,i),n&&!m(t,n)&&(n=null),!n&&(n=Se(o,i),n.nodeType===F&&n.length))return!1;return Re.currentNode=n,Re.root=Ae(e,t),!Re.previousNode()},Ue=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(Re.root=null,o.nodeType===F){if((n=o.data.length)&&i<n)return!1;Re.currentNode=o}else Re.currentNode=Se(o,i);return Re.root=Be(e,t),!Re.nextNode()},Pe=function(e,t){var n,o=Ae(e,t),i=Be(e,t);o&&i&&(n=o.parentNode,e.setStart(n,ue.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,ue.call(n.childNodes,i)+1))},Ie={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},we=function(e){var t=e.keyCode,n=Ie[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),te&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),be(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},Fe=function(e){return function(t,n){n.preventDefault(),t[e]()}},Me=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},He=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===Z);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,ue.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),y(n,e._root),xe(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},We={enter:function(e,t,n){var o,i,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),yt(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||be(n,a),!(o=Ae(n,a))||/^T[HD]$/.test(o.nodeName))return i=g(n.endContainer,a,"A"),i&&(i=i.parentNode,Oe(n,i,i,a),n.collapse(!1)),ye(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=g(o,a,"LI"))&&(o=i),u(o)){if(g(o,a,"UL")||g(o,a,"OL"))return e.decreaseListLevel(n);if(g(o,a,"BLOCKQUOTE"))return e.modifyBlocks(mt,n)}for(r=ft(e,o,n.startContainer,n.startOffset),ct(o),Ye(o),y(o,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===Z)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling)&&"BR"!==s.nodeName;)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!te)break;r=d}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(De(n,o)){t.preventDefault();var i,r=Ae(n,o);if(!r)return;if(E(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void N(i);for(x(i,r,n,o),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&O(r,o),e.setSelection(n)}else if(r){if(g(r,o,"UL")||g(r,o,"OL"))return e.decreaseListLevel(n);if(g(r,o,"BLOCKQUOTE"))return e.modifyBlocks(gt,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){He(e)},0);else t.preventDefault(),be(n,o),He(e,n)},delete:function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ue(n,l)){if(t.preventDefault(),!(o=Ae(n,l)))return;if(E(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void N(i);for(x(o,i,n,l),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&O(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),Oe(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),N(d),xe(n),void He(e,n);e.setSelection(r),setTimeout(function(){He(e)},0)}else t.preventDefault(),be(n,l),He(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&De(n,r))for(o=Ae(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.increaseListLevel(n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&De(n,i)&&(o=n.startContainer,(g(o,i,"UL")||g(o,i,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),yt(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===_(o)?n.setStartAfter(i):n.collapsed||(be(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};Y&&J&&(We["meta-left"]=function(e,t){t.preventDefault();var n=lt(e);n&&n.modify&&n.modify("move","backward","lineboundary")},We["meta-right"]=function(e,t){t.preventDefault();var n=lt(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),Y||(We.pageup=function(e){e.moveCursorToStart()},We.pagedown=function(e){e.moveCursorToEnd()}),We[re+"b"]=Me("B"),We[re+"i"]=Me("I"),We[re+"u"]=Me("U"),We[re+"shift-7"]=Me("S"),We[re+"shift-5"]=Me("SUB",{tag:"SUP"}),We[re+"shift-6"]=Me("SUP",{tag:"SUB"}),We[re+"shift-8"]=Fe("makeUnorderedList"),We[re+"shift-9"]=Fe("makeOrderedList"),We[re+"["]=Fe("decreaseQuoteLevel"),We[re+"]"]=Fe("increaseQuoteLevel"),We[re+"y"]=Fe("redo"),We[re+"z"]=Fe("undo"),We[re+"shift-z"]=Fe("redo");var ze={1:10,2:13,3:16,4:18,5:24,6:32,7:48},qe={backgroundColor:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:z,style:"background-color:"+t})}},color:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return T(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return T(e,"I")}},fontFamily:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:K,style:"font-family:"+t})}},fontSize:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:G,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return T(e,"U")}}},Ke=function(e){return function(t,n){var o=T(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(S(t)),o}},Ge=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in qe)o=qe[n],(i=d[n])&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Ze={P:Ge,SPAN:Ge,STRONG:Ke("B"),EM:Ke("I"),INS:Ke("U"),STRIKE:Ke("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=T(c,"SPAN",{class:K,style:"font-family:"+s}),a=n,r=n),d&&(o=T(c,"SPAN",{class:G,style:"font-size:"+ze[d]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=T(c,"SPAN",{class:q,style:"color:"+l}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=T(c,"SPAN")),t.replaceChild(a,e),r.appendChild(S(e)),r},TT:function(e,t){var n=T(e.ownerDocument,"SPAN",{class:K,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(S(e)),n}},je=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,$e=/^(?:HEAD|META|STYLE)/,Qe=new n(null,4|W,function(){return!0}),Ve=function e(t,n){var o,i,r,s,d,l,c,h,u,f,p,g,m=t.childNodes;for(o=t;a(o);)o=o.parentNode;for(Qe.root=o,i=0,r=m.length;i<r;i+=1)if(s=m[i],d=s.nodeName,l=s.nodeType,c=Ze[d],l===w){if(h=s.childNodes.length,c)s=c(s,t);else{if($e.test(d)){t.removeChild(s),i-=1,r-=1;continue}if(!je.test(d)&&!a(s)){i-=1,r+=h-1,t.replaceChild(S(s),s);continue}}h&&e(s,n||"PRE"===d)}else{if(l===F){if(p=s.data,u=!he.test(p.charAt(0)),f=!he.test(p.charAt(p.length-1)),n||!u&&!f)continue;if(u){for(Qe.currentNode=s;(g=Qe.previousPONode())&&!("IMG"===(d=g.nodeName)||"#text"===d&&he.test(g.data));)if(!a(g)){g=null;break}p=p.replace(/^[ \t\r\n]+/g,g?" ":"")}if(f){for(Qe.currentNode=s;(g=Qe.nextNode())&&!("IMG"===d||"#text"===d&&he.test(g.data));)if(!a(g)){g=null;break}p=p.replace(/[ \t\r\n]+$/g,g?" ":"")}if(p){s.data=p;continue}}t.removeChild(s),i-=1,r-=1}return t},Ye=function e(t){for(var n,o=t.childNodes,r=o.length;r--;)n=o[r],n.nodeType!==w||i(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},Xe=function(e){return e.nodeType===w?"BR"===e.nodeName:he.test(e.data)},Je=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,4|W,Xe),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},et=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;o<l;o+=1)d[o]=Je(s[o],n);for(;l--;)i=s[l],(r=i.parentNode)&&(d[l]?a(r)||E(r,t):N(i))},tt=function(e,t,n){var o,i,r=t.ownerDocument.body;et(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,X&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},nt=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),ne||V||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Ae(l,c),n=Be(l,c),o=t===n&&t||c,i=be(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),tt(d,s,c),e.preventDefault()}this.setSelection(l)},ot=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!ne&&!V&&d){for(t=Ae(l,c),n=Be(l,c),o=t===n&&t||c,l=l.cloneRange(),xe(l),Oe(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),tt(d,s,c),e.preventDefault()}},it=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(!ne&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!ne&&i&&(ue.call(i,"text/html")>-1||!J&&ue.call(i,"text/plain")>-1&&ue.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,N(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u._createRange(g,m,v,_),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)},rt=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},at=R.prototype,st=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};at.setConfig=function(e){return e=B({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:ge,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?st:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},at.createElement=function(e,t,n){return T(this._doc,e,t,n)},at.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},at.didError=function(e){console.log(e)},at.getDocument=function(){return this._doc},at.getRoot=function(){return this._root},at.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var dt={pathChange:1,select:1,input:1,undoStateChange:1};at.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},at.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},at.handleEvent=function(e){this.fireEvent(e.type,e)},at.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],dt[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},at.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],dt[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},at._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},at.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=Z,ye(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),L(n,e)),o},at._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return xe(n),this.setSelection(n),this},at.moveCursorToStart=function(){return this._moveCursorTo(!0)},at.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var lt=function(e){return e._win.getSelection()||null};at.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(Q&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{V&&this._win.focus();var t=lt(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},at.getSelection=function(){var e,t,n,o,r=lt(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,o=e.commonAncestorContainer,m(o.ownerDocument,o)||(e=null)),e||(e=this._createRange(a.firstChild,0)),e},at.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,o=new n(e.commonAncestorContainer,4|W,function(t){return Le(e,t,!0)}),i=e.startContainer,r=e.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===i&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},at.getPath=function(){return this._path};var ct=function(e,t){for(var o,i,r,s=new n(e,4,function(){return!0},!1);i=s.nextNode();)for(;(r=i.data.indexOf(Z))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do{o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o}while(a(i)&&!_(i));break}i.deleteData(r,1)}};at._didAddZWS=function(){this._hasZWS=!0},at._removeZWS=function(){this._hasZWS&&(ct(this._root),this._hasZWS=!1)},at._updatePath=function(e,t){if(e){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?v(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},at._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},at.focus=function(){return this._root.focus(),ie&&this.fireEvent("focus"),this},at.blur=function(){return this._root.blur(),ie&&this.fireEvent("blur"),this};var ht="squire-selection-end";at._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),o=this.createElement("INPUT",{id:ht,type:"hidden"});ye(e,n),e.collapse(!1),ye(e,o),2&n.compareDocumentPosition(o)&&(n.id=ht,o.id="squire-selection-start",t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},at._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),o=t.querySelector("#"+ht);if(n&&o){var i=n.parentNode,r=o.parentNode,a=ue.call(i.childNodes,n),s=ue.call(r.childNodes,o);i===r&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),L(i,e),i!==r&&L(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},at._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},at._docWasChanged=function(){if(ce&&(Ce=new WeakMap),!this._ignoreAllChanges){if(le&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},
at._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,o=this._undoIndex,i=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(o+=1),o<this._undoStackLength&&(i.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&o>s&&(i.splice(0,o-s),o=s,this._undoStackLength=s),i[o]=n,this._undoIndex=o,this._undoStackLength+=1,this._isInUndoState=!0}},at.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},at.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},at.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},at.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,4,function(e){return Le(o,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},at.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},at._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f=this._root;if(o.collapsed){for(i=y(this.createElement(e,t),f),ye(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),u=i;a(u);)u=u.parentNode;ct(u,i)}else{if(r=new n(o.commonAncestorContainer,4|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Le(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do{h=r.currentNode,!g(h,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),C(h,i),i.appendChild(h))}while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},at._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(se?(i=r.createTextNode(Z),this._didAddZWS()):i=r.createTextNode(""),ye(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Le(n,e,!1)){var o,i,r=e.nodeType===F;if(!Le(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,f(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Le(n,o,!0)&&p(o,e,t)});return o||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),L(s,n),n},at.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),le||this._docWasChanged(),this):this};var ut={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},ft=function(e,t,n,o){var i=ut[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),p(a,i,r)||(t=T(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};at.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Ae(n,o),r=Be(n,o);if(i&&r)do{if(e(i)||i===r)break}while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),le||this._docWasChanged()),this},at.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,o=this._root;return Pe(t,o),Oe(t,o,o,o),n=Ee(t,o,o),ye(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&O(t.endContainer.childNodes[t.endOffset],o),O(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),le||this._docWasChanged(),this};var pt=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},gt=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},mt=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:ht,type:"hidden"})])},vt=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(S(o)),s.currentNode=a):(o=o.parentNode,(i=o.nodeName)!==n&&/^[OU]L$/.test(i)&&C(o,e.createElement(n,c,[S(o)])))},_t=function(e){return vt(this,e,"UL"),e},Nt=function(e){return vt(this,e,"OL"),e},Ct=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)o=a[t],i=S(o),E(i,l),C(o,i);for(t=0,n=d.length;t<n;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([S(r)])):(E(r,l),C(r,S(r)));return e},St=function(e,t){for(var n=e.commonAncestorContainer,o=e.startContainer,i=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(o===n&&(o=o.childNodes[e.startOffset]),i===n&&(i=i.childNodes[e.endOffset]);o&&o.parentNode!==n;)o=o.parentNode;for(;i&&i.parentNode!==n;)i=i.parentNode;return[n,o,i]};at.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=St(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];if(!i||i===o.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=o.nodeName,l=i.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),o.insertBefore(l,i));do{s=i===r?null:i.nextSibling,l.appendChild(i)}while(i=s);return s=l.nextSibling,s&&O(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),le||this._docWasChanged(),this.focus()},at.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=St(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];i||(i=o.firstChild),r||(r=o.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=o.parentNode,d=r.nextSibling?b(o,r.nextSibling,s,t):o.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=o.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=i===r?null:i.nextSibling,o.removeChild(i),l&&"LI"===i.nodeName&&(i=this.createDefaultBlock([S(i)])),s.insertBefore(i,d)}while(i=a);return o.firstChild||N(o),d&&O(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),le||this._docWasChanged(),this.focus()},at._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},at.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},at._getHTML=function(){return this._root.innerHTML},at._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{y(n,t)}while(n=h(n,t));this._ignoreChange=!0},at.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ae)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ae)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},at.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),Ve(n),et(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},at.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))ye(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=Ae(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),xe(t)}return this.focus(),this.setSelection(t),this._updatePath(t),le||this._docWasChanged(),this},at.insertImage=function(e,t){var n=this.createElement("IMG",B({src:e},t,!0));return this.insertElement(n),n};var Tt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,yt=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,4,function(e){return!g(e,t,"A")},!1),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=Tt.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",B({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};at.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),o=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},yt(r,r,this),Ve(r),et(r,a,!1),Ye(r),r.normalize();s=h(s,r);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(ke(u,d.fragment,a),le||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var Et=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};at.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Et(l[n])+'"';for(h+=">",o=0,i=a.length;o<i;o+=1)r=a[o],r=Et(r).replace(/ (?= )/g,"&nbsp;"),a[o]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var bt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};at.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},at.bold=bt("changeFormat",{tag:"B"}),at.italic=bt("changeFormat",{tag:"I"}),at.underline=bt("changeFormat",{tag:"U"}),at.strikethrough=bt("changeFormat",{tag:"S"}),at.subscript=bt("changeFormat",{tag:"SUB"},{tag:"SUP"}),at.superscript=bt("changeFormat",{tag:"SUP"},{tag:"SUB"}),at.removeBold=bt("changeFormat",null,{tag:"B"}),at.removeItalic=bt("changeFormat",null,{tag:"I"}),at.removeUnderline=bt("changeFormat",null,{tag:"U"}),at.removeStrikethrough=bt("changeFormat",null,{tag:"S"}),at.removeSubscript=bt("changeFormat",null,{tag:"SUB"}),at.removeSuperscript=bt("changeFormat",null,{tag:"SUP"}),at.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;ye(n,this._doc.createTextNode(e.slice(o)))}return t=B(B({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},at.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},at.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:K,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:K}}),this.focus()},at.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:G,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:G}}),this.focus()},at.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:q}}),this.focus()},at.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:z,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:z}}),this.focus()},at.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},at.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},at.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Pe(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),Oe(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return I(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=ue.call(i,p),c=ue.call(i,o)+1):(d=ue.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),L(n,e),xe(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},at.increaseQuoteLevel=bt("modifyBlocks",pt),at.decreaseQuoteLevel=bt("modifyBlocks",gt),at.makeUnorderedList=bt("modifyBlocks",_t),at.makeOrderedList=bt("modifyBlocks",Nt),at.removeList=bt("modifyBlocks",Ct),R.isInline=a,R.isBlock=s,R.isContainer=d,R.getBlockWalker=l,R.getPreviousBlock=c,R.getNextBlock=h,R.areAlike=f,R.hasTagAttributes=p,R.getNearest=g,R.isOrContains=m,R.detach=N,R.replaceWith=C,R.empty=S,R.getNodeBefore=Se,R.getNodeAfter=Te,R.insertNodeInRange=ye,R.extractContentsOfRange=Ee,R.deleteContentsOfRange=be,R.insertTreeFragmentIntoRange=ke,R.isNodeContainedInRange=Le,R.moveRangeBoundariesDownTree=xe,R.moveRangeBoundariesUpTree=Oe,R.getStartBlockOfRange=Ae,R.getEndBlockOfRange=Be,R.contentWalker=Re,R.rangeDoesStartAtBlockBoundary=De,R.rangeDoesEndAtBlockBoundary=Ue,R.expandRangeToBlockBoundaries=Pe,R.onPaste=it,R.addLinks=yt,R.splitBlock=ft,R.startSelectionId="squire-selection-start",R.endSelectionId=ht,"object"==typeof exports?module.exports=R:"function"==typeof define&&define.amd?define(function(){return R}):(j.Squire=R,top!==j&&"true"===e.documentElement.getAttribute("data-squireinit")&&(j.editor=new R(e),j.onEditorLoad&&(j.onEditorLoad(j.editor),j.onEditorLoad=null)))}(document);
>>>>>>> 306230d... Better handling of <pre>
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!ge[e.nodeName]}function r(e){switch(e.nodeType){case F:return ve;case w:case H:if(ce&&Ce.has(e))return Ce.get(e);break;default:return me}var t;return t=o(e.childNodes,a)?pe.test(e.nodeName)?ve:_e:Ne,ce&&Ce.set(e,t),t}function a(e){return r(e)===ve}function s(e){return r(e)===_e}function d(e){return r(e)===Ne}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function g(e,t,n,o){for(;e&&e!==t;){if(p(e,n,o))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t){var n,o,i,r,a="";return e&&e!==t&&(a=v(e.parentNode,t),e.nodeType===w&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(r=e.dir)&&(a+="[dir="+r+"]"),i&&(ue.call(i,z)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),ue.call(i,q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),ue.call(i,K)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),ue.call(i,G)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function _(e){var t=e.nodeType;return t===w||t===H?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function T(e,n,o,i){var r,a,s,d=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)o[r]!==t&&d.setAttribute(r,o[r]);if(i)for(a=0,s=i.length;a<s;a+=1)d.appendChild(i[a]);return d}function y(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;se&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(se?(n=s.createTextNode(Z),r._didAddZWS()):n=s.createTextNode(""))}else if(ae){for(;e.nodeType!==F&&!i(e);){if(!(o=e.firstChild)){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=T(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;n<o;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=T(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=T(l,h.blockTag,h.blockAttributes)),y(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&E(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),y(e,o),y(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function k(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&f(n,o)&&!ge[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=_(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=_(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=_(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=_(o))),N(n),n.nodeType===F?o.appendData(n.data):d.push(S(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());k(n,t)}}function L(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function x(e,t,n,o){for(var i,r,a,s=t;(i=s.parentNode)&&i!==o&&i.nodeType===w&&1===i.childNodes.length;)s=i;N(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),L(e,n),te&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function O(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&f(i,e)){if(!d(i)){if(!s)return;o=T(a,"DIV"),o.appendChild(S(i)),i.appendChild(o)}N(e),n=!d(e),i.appendChild(S(e)),n&&E(i,t),r&&O(r,t)}else s&&(i=T(a,"DIV"),e.insertBefore(i,r),y(i,t))}function A(e){this.isShiftDown=e.shiftKey}function B(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?B(e[o],i,n):i);return e}function R(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,de&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,le?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(ee?"beforecut":"cut",nt),this.addEventListener("copy",ot),this.addEventListener("keydown",A),this.addEventListener("keyup",A),this.addEventListener(ee?"beforepaste":"paste",it),this.addEventListener("drop",rt),this.addEventListener(te?"keypress":"keydown",we),this._keyHandlers=Object.create(We),this.setConfig(t),ee&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([I(e,o,e._doc.createDocumentFragment())]));continue}I(e,o,n)}return n}var w=1,F=3,M=9,H=11,W=1,z="highlight",q="colour",K="font",G="size",Z="​",j=e.defaultView,$=navigator.userAgent,Q=/Android/.test($),V=/iP(?:ad|hone|od)/.test($),Y=/Mac OS X/.test($),X=/Windows NT/.test($),J=/Gecko\//.test($),ee=/Trident\/[456]\./.test($),te=!!j.opera,ne=/Edge\//.test($),oe=!ne&&/WebKit\//.test($),ie=/Trident\/[4567]\./.test($),re=Y?"meta-":"ctrl-",ae=ee||te,se=ee||oe,de=ee,le="undefined"!=typeof MutationObserver,ce="undefined"!=typeof WeakMap,he=/[^ \t\r\n]/,ue=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var fe={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(fe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(fe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(fe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var pe=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,ge={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},me=0,ve=1,_e=2,Ne=3,Ce=ce?new WeakMap:null,Se=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Te=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},ye=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=ue.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=ue.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},Ee=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?ue.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,d.appendData(l.data),N(l)),e.setStart(o,i),e.collapse(!0),y(t,n),u},be=function(e,t){var n,o,i=Ae(e,t),r=Be(e,t),a=i!==r;return xe(e),Oe(e,i,r,t),n=Ee(e,null,t),xe(e),a&&(r=Be(e,t),i&&r&&i!==r&&x(i,r,e,t)),i&&y(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},ke=function(e,t,n){var o,i,r,s,l,f,p,m,v,C,S;for(E(t,n),o=t;o=h(o,n);)y(o,n);if(e.collapsed||be(e,n),xe(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,i=Ae(e,n),m=h(t,t),p=!!i&&u(i),i&&m&&!p&&!g(m,t,"PRE")&&!g(m,t,"TABLE")){if(Oe(e,i,i,n),e.collapse(!0),l=e.endContainer,f=e.endOffset,et(i,n,!1),a(l)&&(v=b(l,f,c(l,n),n),l=v.parentNode,f=ue.call(l.childNodes,v)),f!==_(l))for(r=n.ownerDocument.createDocumentFragment();o=l.childNodes[f];)r.appendChild(o);x(l,m,e,n),f=ue.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,f)}_(t)&&(p&&(e.setEndBefore(i),e.collapse(!1),N(i)),Oe(e,s,s,n),v=b(e.endContainer,e.endOffset,s,n),C=v?v.previousSibling:s.lastChild,s.insertBefore(t,v),v?e.setEndBefore(v):e.setEnd(s,_(s)),i=Be(e,n),xe(e),l=e.endContainer,f=e.endOffset,v&&d(v)&&O(v,n),v=C&&C.nextSibling,v&&d(v)&&O(v,n),e.setEnd(l,f)),r&&(S=e.cloneRange(),x(i,r,S,n),e.setEnd(S.endContainer,S.endOffset)),xe(e)},Le=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(3,o)>-1,r=e.compareBoundaryPoints(1,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(0,o)<1,s=e.compareBoundaryPoints(2,o)>-1;return a&&s},xe=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o])&&!i(t);)n=t,o=0;if(a)for(;r.nodeType!==F;){if(!(t=r.childNodes[a-1])||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=_(r)}else for(;r.nodeType!==F&&(t=r.firstChild)&&!i(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Oe=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=ue.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==_(s))break;i=s.parentNode,d=ue.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},Ae=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=Se(o,e.startOffset),n=h(n,t)),n&&Le(e,n,!0)?n:null},Be=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(!(n=Te(i,e.endOffset))||!m(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Le(e,n,!0)?n:null},Re=new n(null,4|W,function(e){return e.nodeType===F?he.test(e.data):"IMG"===e.nodeName}),De=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(Re.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Te(o,i),n&&!m(t,n)&&(n=null),!n&&(n=Se(o,i),n.nodeType===F&&n.length))return!1;return Re.currentNode=n,Re.root=Ae(e,t),!Re.previousNode()},Ue=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(Re.root=null,o.nodeType===F){if((n=o.data.length)&&i<n)return!1;Re.currentNode=o}else Re.currentNode=Se(o,i);return Re.root=Be(e,t),!Re.nextNode()},Pe=function(e,t){var n,o=Ae(e,t),i=Be(e,t);o&&i&&(n=o.parentNode,e.setStart(n,ue.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,ue.call(n.childNodes,i)+1))},Ie={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},we=function(e){var t=e.keyCode,n=Ie[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),te&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),be(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},Fe=function(e){return function(t,n){n.preventDefault(),t[e]()}},Me=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},He=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===Z);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,ue.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),y(n,e._root),xe(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},We={enter:function(e,t,n){var o,i,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),yt(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||be(n,a),!(o=Ae(n,a))||/^T[HD]$/.test(o.nodeName))return i=g(n.endContainer,a,"A"),i&&(i=i.parentNode,Oe(n,i,i,a),n.collapse(!1)),ye(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=g(o,a,"LI"))&&(o=i),u(o)){if(g(o,a,"UL")||g(o,a,"OL"))return e.decreaseListLevel(n);if(g(o,a,"BLOCKQUOTE"))return e.modifyBlocks(mt,n)}for(r=ft(e,o,n.startContainer,n.startOffset),ct(o),Ye(o),y(o,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===Z)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling)&&"BR"!==s.nodeName;)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!te)break;r=d}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(De(n,o)){t.preventDefault();var i,r=Ae(n,o);if(!r)return;if(E(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void N(i);for(x(i,r,n,o),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&O(r,o),e.setSelection(n)}else if(r){if(g(r,o,"UL")||g(r,o,"OL"))return e.decreaseListLevel(n);if(g(r,o,"BLOCKQUOTE"))return e.modifyBlocks(gt,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){He(e)},0);else t.preventDefault(),be(n,o),He(e,n)},delete:function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ue(n,l)){if(t.preventDefault(),!(o=Ae(n,l)))return;if(E(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void N(i);for(x(o,i,n,l),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&O(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),Oe(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),N(d),xe(n),void He(e,n);e.setSelection(r),setTimeout(function(){He(e)},0)}else t.preventDefault(),be(n,l),He(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&De(n,r))for(o=Ae(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.increaseListLevel(n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&De(n,i)&&(o=n.startContainer,(g(o,i,"UL")||g(o,i,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),yt(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===_(o)?n.setStartAfter(i):n.collapsed||(be(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};Y&&J&&(We["meta-left"]=function(e,t){t.preventDefault();var n=lt(e);n&&n.modify&&n.modify("move","backward","lineboundary")},We["meta-right"]=function(e,t){t.preventDefault();var n=lt(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),Y||(We.pageup=function(e){e.moveCursorToStart()},We.pagedown=function(e){e.moveCursorToEnd()}),We[re+"b"]=Me("B"),We[re+"i"]=Me("I"),We[re+"u"]=Me("U"),We[re+"shift-7"]=Me("S"),We[re+"shift-5"]=Me("SUB",{tag:"SUP"}),We[re+"shift-6"]=Me("SUP",{tag:"SUB"}),We[re+"shift-8"]=Fe("makeUnorderedList"),We[re+"shift-9"]=Fe("makeOrderedList"),We[re+"["]=Fe("decreaseQuoteLevel"),We[re+"]"]=Fe("increaseQuoteLevel"),We[re+"y"]=Fe("redo"),We[re+"z"]=Fe("undo"),We[re+"shift-z"]=Fe("redo");var ze={1:10,2:13,3:16,4:18,5:24,6:32,7:48},qe={backgroundColor:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:z,style:"background-color:"+t})}},color:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return T(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return T(e,"I")}},fontFamily:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:K,style:"font-family:"+t})}},fontSize:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:G,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return T(e,"U")}}},Ke=function(e){return function(t,n){var o=T(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(S(t)),o}},Ge=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in qe)o=qe[n],(i=d[n])&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Ze={P:Ge,SPAN:Ge,STRONG:Ke("B"),EM:Ke("I"),INS:Ke("U"),STRIKE:Ke("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=T(c,"SPAN",{class:K,style:"font-family:"+s}),a=n,r=n),d&&(o=T(c,"SPAN",{class:G,style:"font-size:"+ze[d]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=T(c,"SPAN",{class:q,style:"color:"+l}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=T(c,"SPAN")),t.replaceChild(a,e),r.appendChild(S(e)),r},TT:function(e,t){var n=T(e.ownerDocument,"SPAN",{class:K,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(S(e)),n}},je=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,$e=/^(?:HEAD|META|STYLE)/,Qe=new n(null,4|W,function(){return!0}),Ve=function e(t,n){var o,i,r,s,d,l,c,h,u,f,p,g,m=t.childNodes;for(o=t;a(o);)o=o.parentNode;for(Qe.root=o,i=0,r=m.length;i<r;i+=1)if(s=m[i],d=s.nodeName,l=s.nodeType,c=Ze[d],l===w){if(h=s.childNodes.length,c)s=c(s,t);else{if($e.test(d)){t.removeChild(s),i-=1,r-=1;continue}if(!je.test(d)&&!a(s)){i-=1,r+=h-1,t.replaceChild(S(s),s);continue}}h&&e(s,n||"PRE"===d)}else{if(l===F){if(p=s.data,u=!he.test(p.charAt(0)),f=!he.test(p.charAt(p.length-1)),n||!u&&!f)continue;if(u){for(Qe.currentNode=s;(g=Qe.previousPONode())&&!("IMG"===(d=g.nodeName)||"#text"===d&&he.test(g.data));)if(!a(g)){g=null;break}p=p.replace(/^[ \t\r\n]+/g,g?" ":"")}if(f){for(Qe.currentNode=s;(g=Qe.nextNode())&&!("IMG"===d||"#text"===d&&he.test(g.data));)if(!a(g)){g=null;break}p=p.replace(/[ \t\r\n]+$/g,g?" ":"")}if(p){s.data=p;continue}}t.removeChild(s),i-=1,r-=1}return t},Ye=function e(t){for(var n,o=t.childNodes,r=o.length;r--;)n=o[r],n.nodeType!==w||i(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},Xe=function(e){return e.nodeType===w?"BR"===e.nodeName:he.test(e.data)},Je=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,4|W,Xe),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},et=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;o<l;o+=1)d[o]=Je(s[o],n);for(;l--;)i=s[l],(r=i.parentNode)&&(d[l]?a(r)||E(r,t):N(i))},tt=function(e,t,n){var o,i,r=t.ownerDocument.body;et(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,X&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},nt=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),ne||V||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Ae(l,c),n=Be(l,c),o=t===n&&t||c,i=be(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),tt(d,s,c),e.preventDefault()}this.setSelection(l)},ot=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!ne&&!V&&d){for(t=Ae(l,c),n=Be(l,c),o=t===n&&t||c,l=l.cloneRange(),xe(l),Oe(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),tt(d,s,c),e.preventDefault()}},it=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(!ne&&s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!ne&&i&&(ue.call(i,"text/html")>-1||!J&&ue.call(i,"text/plain")>-1&&ue.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,N(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u._createRange(g,m,v,_),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)},rt=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},at=R.prototype,st=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};at.setConfig=function(e){return e=B({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:ge,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?st:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},at.createElement=function(e,t,n){return T(this._doc,e,t,n)},at.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},at.didError=function(e){console.log(e)},at.getDocument=function(){return this._doc},at.getRoot=function(){return this._root},at.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var dt={pathChange:1,select:1,input:1,undoStateChange:1};at.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},at.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},at.handleEvent=function(e){this.fireEvent(e.type,e)},at.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],dt[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},at.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],dt[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},at._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},at.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=Z,ye(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),L(n,e)),o},at._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return xe(n),this.setSelection(n),this},at.moveCursorToStart=function(){return this._moveCursorTo(!0)},at.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var lt=function(e){return e._win.getSelection()||null};at.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(Q&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{V&&this._win.focus();var t=lt(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},at.getSelection=function(){var e,t,n,o,r=lt(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,o=e.commonAncestorContainer,m(o.ownerDocument,o)||(e=null)),e||(e=this._createRange(a.firstChild,0)),e},at.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,o=new n(e.commonAncestorContainer,4|W,function(t){return Le(e,t,!0)}),i=e.startContainer,r=e.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===i&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},at.getPath=function(){return this._path};var ct=function(e,t){for(var o,i,r,s=new n(e,4,function(){return!0},!1);i=s.nextNode();)for(;(r=i.data.indexOf(Z))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do{o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o}while(a(i)&&!_(i));break}i.deleteData(r,1)}};at._didAddZWS=function(){this._hasZWS=!0},at._removeZWS=function(){this._hasZWS&&(ct(this._root),this._hasZWS=!1)},at._updatePath=function(e,t){if(e){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?v(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},at._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},at.focus=function(){return this._root.focus(),ie&&this.fireEvent("focus"),this},at.blur=function(){return this._root.blur(),ie&&this.fireEvent("blur"),this};var ht="squire-selection-end";at._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),o=this.createElement("INPUT",{id:ht,type:"hidden"});ye(e,n),e.collapse(!1),ye(e,o),2&n.compareDocumentPosition(o)&&(n.id=ht,o.id="squire-selection-start",t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},at._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),o=t.querySelector("#"+ht);if(n&&o){var i=n.parentNode,r=o.parentNode,a=ue.call(i.childNodes,n),s=ue.call(r.childNodes,o);i===r&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),L(i,e),i!==r&&L(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},at._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},at._docWasChanged=function(){if(ce&&(Ce=new WeakMap),!this._ignoreAllChanges){if(le&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{
canUndo:!0,canRedo:!1})),this.fireEvent("input")}},at._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,o=this._undoIndex,i=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(o+=1),o<this._undoStackLength&&(i.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&o>s&&(i.splice(0,o-s),o=s,this._undoStackLength=s),i[o]=n,this._undoIndex=o,this._undoStackLength+=1,this._isInUndoState=!0}},at.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},at.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},at.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},at.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,4,function(e){return Le(o,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},at.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},at._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f=this._root;if(o.collapsed){for(i=y(this.createElement(e,t),f),ye(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),u=i;a(u);)u=u.parentNode;ct(u,i)}else{if(r=new n(o.commonAncestorContainer,4|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Le(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do{h=r.currentNode,!g(h,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),C(h,i),i.appendChild(h))}while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},at._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(se?(i=r.createTextNode(Z),this._didAddZWS()):i=r.createTextNode(""),ye(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Le(n,e,!1)){var o,i,r=e.nodeType===F;if(!Le(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,f(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Le(n,o,!0)&&p(o,e,t)});return o||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),L(s,n),n},at.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),le||this._docWasChanged(),this):this};var ut={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},ft=function(e,t,n,o){var i=ut[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),p(a,i,r)||(t=T(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};at.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Ae(n,o),r=Be(n,o);if(i&&r)do{if(e(i)||i===r)break}while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),le||this._docWasChanged()),this},at.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,o=this._root;return Pe(t,o),Oe(t,o,o,o),n=Ee(t,o,o),ye(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&O(t.endContainer.childNodes[t.endOffset],o),O(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),le||this._docWasChanged(),this};var pt=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},gt=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},mt=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:ht,type:"hidden"})])},vt=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(S(o)),s.currentNode=a):(o=o.parentNode,(i=o.nodeName)!==n&&/^[OU]L$/.test(i)&&C(o,e.createElement(n,c,[S(o)])))},_t=function(e){return vt(this,e,"UL"),e},Nt=function(e){return vt(this,e,"OL"),e},Ct=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)o=a[t],i=S(o),E(i,l),C(o,i);for(t=0,n=d.length;t<n;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([S(r)])):(E(r,l),C(r,S(r)));return e},St=function(e,t){for(var n=e.commonAncestorContainer,o=e.startContainer,i=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(o===n&&(o=o.childNodes[e.startOffset]),i===n&&(i=i.childNodes[e.endOffset]);o&&o.parentNode!==n;)o=o.parentNode;for(;i&&i.parentNode!==n;)i=i.parentNode;return[n,o,i]};at.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=St(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];if(!i||i===o.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=o.nodeName,l=i.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),o.insertBefore(l,i));do{s=i===r?null:i.nextSibling,l.appendChild(i)}while(i=s);return s=l.nextSibling,s&&O(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),le||this._docWasChanged(),this.focus()},at.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=St(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];i||(i=o.firstChild),r||(r=o.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=o.parentNode,d=r.nextSibling?b(o,r.nextSibling,s,t):o.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=o.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=i===r?null:i.nextSibling,o.removeChild(i),l&&"LI"===i.nodeName&&(i=this.createDefaultBlock([S(i)])),s.insertBefore(i,d)}while(i=a);return o.firstChild||N(o),d&&O(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),le||this._docWasChanged(),this.focus()},at._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},at.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},at._getHTML=function(){return this._root.innerHTML},at._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{y(n,t)}while(n=h(n,t));this._ignoreChange=!0},at.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ae)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ae)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},at.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),Ve(n),et(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},at.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))ye(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=Ae(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),xe(t)}return this.focus(),this.setSelection(t),this._updatePath(t),le||this._docWasChanged(),this},at.insertImage=function(e,t){var n=this.createElement("IMG",B({src:e},t,!0));return this.insertElement(n),n};var Tt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,yt=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,4,function(e){return!g(e,t,"A")},!1),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=Tt.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",B({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};at.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),o=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},yt(r,r,this),Ve(r),et(r,a,!1),Ye(r),r.normalize();s=h(s,r);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(ke(u,d.fragment,a),le||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var Et=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};at.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Et(l[n])+'"';for(h+=">",o=0,i=a.length;o<i;o+=1)r=a[o],r=Et(r).replace(/ (?= )/g,"&nbsp;"),a[o]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var bt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};at.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},at.bold=bt("changeFormat",{tag:"B"}),at.italic=bt("changeFormat",{tag:"I"}),at.underline=bt("changeFormat",{tag:"U"}),at.strikethrough=bt("changeFormat",{tag:"S"}),at.subscript=bt("changeFormat",{tag:"SUB"},{tag:"SUP"}),at.superscript=bt("changeFormat",{tag:"SUP"},{tag:"SUB"}),at.removeBold=bt("changeFormat",null,{tag:"B"}),at.removeItalic=bt("changeFormat",null,{tag:"I"}),at.removeUnderline=bt("changeFormat",null,{tag:"U"}),at.removeStrikethrough=bt("changeFormat",null,{tag:"S"}),at.removeSubscript=bt("changeFormat",null,{tag:"SUB"}),at.removeSuperscript=bt("changeFormat",null,{tag:"SUP"}),at.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;ye(n,this._doc.createTextNode(e.slice(o)))}return t=B(B({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},at.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},at.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:K,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:K}}),this.focus()},at.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:G,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:G}}),this.focus()},at.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:q}}),this.focus()},at.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:z,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:z}}),this.focus()},at.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},at.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},at.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Pe(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),Oe(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return I(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=ue.call(i,p),c=ue.call(i,o)+1):(d=ue.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),L(n,e),xe(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},at.increaseQuoteLevel=bt("modifyBlocks",pt),at.decreaseQuoteLevel=bt("modifyBlocks",gt),at.makeUnorderedList=bt("modifyBlocks",_t),at.makeOrderedList=bt("modifyBlocks",Nt),at.removeList=bt("modifyBlocks",Ct),R.isInline=a,R.isBlock=s,R.isContainer=d,R.getBlockWalker=l,R.getPreviousBlock=c,R.getNextBlock=h,R.areAlike=f,R.hasTagAttributes=p,R.getNearest=g,R.isOrContains=m,R.detach=N,R.replaceWith=C,R.empty=S,R.getNodeBefore=Se,R.getNodeAfter=Te,R.insertNodeInRange=ye,R.extractContentsOfRange=Ee,R.deleteContentsOfRange=be,R.insertTreeFragmentIntoRange=ke,R.isNodeContainedInRange=Le,R.moveRangeBoundariesDownTree=xe,R.moveRangeBoundariesUpTree=Oe,R.getStartBlockOfRange=Ae,R.getEndBlockOfRange=Be,R.contentWalker=Re,R.rangeDoesStartAtBlockBoundary=De,R.rangeDoesEndAtBlockBoundary=Ue,R.expandRangeToBlockBoundaries=Pe,R.onPaste=it,R.addLinks=yt,R.splitBlock=ft,R.startSelectionId="squire-selection-start",R.endSelectionId=ht,"object"==typeof exports?module.exports=R:"function"==typeof define&&define.amd?define(function(){return R}):(j.Squire=R,top!==j&&"true"===e.documentElement.getAttribute("data-squireinit")&&(j.editor=new R(e),j.onEditorLoad&&(j.onEditorLoad(j.editor),j.onEditorLoad=null)))}(document);
>>>>>>> 50fb7c7... Preserve block style if pasting on blank line
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!ge[e.nodeName]}function r(e){switch(e.nodeType){case F:return ve;case w:case H:if(ce&&Ce.has(e))return Ce.get(e);break;default:return me}var t;return t=o(e.childNodes,a)?pe.test(e.nodeName)?ve:_e:Ne,ce&&Ce.set(e,t),t}function a(e){return r(e)===ve}function s(e){return r(e)===_e}function d(e){return r(e)===Ne}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function g(e,t,n,o){for(;e&&e!==t;){if(p(e,n,o))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t){var n,o,i,r,a="";return e&&e!==t&&(a=v(e.parentNode,t),e.nodeType===w&&(a+=(a?">":"")+e.nodeName,(n=e.id)&&(a+="#"+n),(o=e.className.trim())&&(i=o.split(/\s\s*/),i.sort(),a+=".",a+=i.join(".")),(r=e.dir)&&(a+="[dir="+r+"]"),i&&(ue.call(i,z)>-1&&(a+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),ue.call(i,q)>-1&&(a+="[color="+e.style.color.replace(/ /g,"")+"]"),ue.call(i,K)>-1&&(a+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),ue.call(i,G)>-1&&(a+="[fontSize="+e.style.fontSize+"]")))),a}function _(e){var t=e.nodeType;return t===w||t===H?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function T(e,n,o,i){var r,a,s,d=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)o[r]!==t&&d.setAttribute(r,o[r]);if(i)for(a=0,s=i.length;a<s;a+=1)d.appendChild(i[a]);return d}function y(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;se&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(se?(n=s.createTextNode(Z),r._didAddZWS()):n=s.createTextNode(""))}else if(ae){for(;e.nodeType!==F&&!i(e);){if(!(o=e.firstChild)){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=T(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;n<o;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=T(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=T(l,h.blockTag,h.blockAttributes)),y(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&E(i,t);return c&&e.appendChild(y(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),y(e,o),y(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function k(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&f(n,o)&&!ge[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=_(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=_(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=_(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=_(o))),N(n),n.nodeType===F?o.appendData(n.data):d.push(S(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());k(n,t)}}function L(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function x(e,t,n,o){for(var i,r,a,s=t;(i=s.parentNode)&&i!==o&&i.nodeType===w&&1===i.childNodes.length;)s=i;N(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),L(e,n),te&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function O(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&f(i,e)){if(!d(i)){if(!s)return;o=T(a,"DIV"),o.appendChild(S(i)),i.appendChild(o)}N(e),n=!d(e),i.appendChild(S(e)),n&&E(i,t),r&&O(r,t)}else s&&(i=T(a,"DIV"),e.insertBefore(i,r),y(i,t))}function A(e){this.isShiftDown=e.shiftKey}function B(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?B(e[o],i,n):i);return e}function R(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,de&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,le?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(ee?"beforecut":"cut",nt),this.addEventListener("copy",ot),this.addEventListener("keydown",A),this.addEventListener("keyup",A),this.addEventListener(ee?"beforepaste":"paste",it),this.addEventListener("drop",rt),this.addEventListener(te?"keypress":"keydown",we),this._keyHandlers=Object.create(We),this.setConfig(t),ee&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([I(e,o,e._doc.createDocumentFragment())]));continue}I(e,o,n)}return n}var w=1,F=3,M=9,H=11,W=1,z="highlight",q="colour",K="font",G="size",Z="​",j=e.defaultView,$=navigator.userAgent,Q=/Android/.test($),V=/iP(?:ad|hone|od)/.test($),Y=/Mac OS X/.test($),X=/Windows NT/.test($),J=/Gecko\//.test($),ee=/Trident\/[456]\./.test($),te=!!j.opera,ne=/Edge\//.test($),oe=!ne&&/WebKit\//.test($),ie=/Trident\/[4567]\./.test($),re=Y?"meta-":"ctrl-",ae=ee||te,se=ee||oe,de=ee,le="undefined"!=typeof MutationObserver,ce="undefined"!=typeof WeakMap,he=/[^ \t\r\n]/,ue=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var fe={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(fe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(fe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(fe[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var pe=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,ge={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},me=0,ve=1,_e=2,Ne=3,Ce=ce?new WeakMap:null,Se=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Te=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},ye=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=ue.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=ue.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},Ee=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?ue.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,d.appendData(l.data),N(l)),e.setStart(o,i),e.collapse(!0),y(t,n),u},be=function(e,t){var n,o,i=Ae(e,t),r=Be(e,t),a=i!==r;return xe(e),Oe(e,i,r,t),n=Ee(e,null,t),xe(e),a&&(r=Be(e,t),i&&r&&i!==r&&x(i,r,e,t)),i&&y(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(y(t,t),e.selectNodeContents(t.firstChild)),n},ke=function(e,t,n){var o,i,r,s,l,f,p,m,v,C,S;for(E(t,n),o=t;o=h(o,n);)y(o,n);if(e.collapsed||be(e,n),xe(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,i=Ae(e,n),m=h(t,t),p=!!i&&u(i),i&&m&&!p&&!g(m,t,"PRE")&&!g(m,t,"TABLE")){if(Oe(e,i,i,n),e.collapse(!0),l=e.endContainer,f=e.endOffset,et(i,n,!1),a(l)&&(v=b(l,f,c(l,n),n),l=v.parentNode,f=ue.call(l.childNodes,v)),f!==_(l))for(r=n.ownerDocument.createDocumentFragment();o=l.childNodes[f];)r.appendChild(o);x(l,m,e,n),f=ue.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,f)}_(t)&&(p&&(e.setEndBefore(i),e.collapse(!1),N(i)),Oe(e,s,s,n),v=b(e.endContainer,e.endOffset,s,n),C=v?v.previousSibling:s.lastChild,s.insertBefore(t,v),v?e.setEndBefore(v):e.setEnd(s,_(s)),i=Be(e,n),xe(e),l=e.endContainer,f=e.endOffset,v&&d(v)&&O(v,n),v=C&&C.nextSibling,v&&d(v)&&O(v,n),e.setEnd(l,f)),r&&(S=e.cloneRange(),x(i,r,S,n),e.setEnd(S.endContainer,S.endOffset)),xe(e)},Le=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(3,o)>-1,r=e.compareBoundaryPoints(1,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(0,o)<1,s=e.compareBoundaryPoints(2,o)>-1;return a&&s},xe=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o])&&!i(t);)n=t,o=0;if(a)for(;r.nodeType!==F;){if(!(t=r.childNodes[a-1])||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=_(r)}else for(;r.nodeType!==F&&(t=r.firstChild)&&!i(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},Oe=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=ue.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==_(s))break;i=s.parentNode,d=ue.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},Ae=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=Se(o,e.startOffset),n=h(n,t)),n&&Le(e,n,!0)?n:null},Be=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(!(n=Te(i,e.endOffset))||!m(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Le(e,n,!0)?n:null},Re=new n(null,4|W,function(e){return e.nodeType===F?he.test(e.data):"IMG"===e.nodeName}),De=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(Re.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Te(o,i),n&&!m(t,n)&&(n=null),!n&&(n=Se(o,i),n.nodeType===F&&n.length))return!1;return Re.currentNode=n,Re.root=Ae(e,t),!Re.previousNode()},Ue=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(Re.root=null,o.nodeType===F){if((n=o.data.length)&&i<n)return!1;Re.currentNode=o}else Re.currentNode=Se(o,i);return Re.root=Be(e,t),!Re.nextNode()},Pe=function(e,t){var n,o=Ae(e,t),i=Be(e,t);o&&i&&(n=o.parentNode,e.setStart(n,ue.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,ue.call(n.childNodes,i)+1))},Ie={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},we=function(e){var t=e.keyCode,n=Ie[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),te&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),be(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},Fe=function(e){return function(t,n){n.preventDefault(),t[e]()}},Me=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},He=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===Z);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,ue.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),y(n,e._root),xe(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&N(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},We={enter:function(e,t,n){var o,i,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),yt(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||be(n,a),!(o=Ae(n,a))||/^T[HD]$/.test(o.nodeName))return i=g(n.endContainer,a,"A"),i&&(i=i.parentNode,Oe(n,i,i,a),n.collapse(!1)),ye(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=g(o,a,"LI"))&&(o=i),u(o)){if(g(o,a,"UL")||g(o,a,"OL"))return e.decreaseListLevel(n);if(g(o,a,"BLOCKQUOTE"))return e.modifyBlocks(mt,n)}for(r=ft(e,o,n.startContainer,n.startOffset),ct(o),Ye(o),y(o,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===Z)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling)&&"BR"!==s.nodeName;)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!te)break;r=d}n=e._createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(De(n,o)){t.preventDefault();var i,r=Ae(n,o);if(!r)return;if(E(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void N(i);for(x(i,r,n,o),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&O(r,o),e.setSelection(n)}else if(r){if(g(r,o,"UL")||g(r,o,"OL"))return e.decreaseListLevel(n);if(g(r,o,"BLOCKQUOTE"))return e.modifyBlocks(gt,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){He(e)},0);else t.preventDefault(),be(n,o),He(e,n)},delete:function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ue(n,l)){if(t.preventDefault(),!(o=Ae(n,l)))return;if(E(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void N(i);for(x(o,i,n,l),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&O(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),Oe(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),N(d),xe(n),void He(e,n);e.setSelection(r),setTimeout(function(){He(e)},0)}else t.preventDefault(),be(n,l),He(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&De(n,r))for(o=Ae(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.increaseListLevel(n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&De(n,i)&&(o=n.startContainer,(g(o,i,"UL")||g(o,i,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),yt(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&"A"===i.nodeName&&!o.nextSibling&&n.endOffset===_(o)?n.setStartAfter(i):n.collapsed||(be(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};Y&&J&&(We["meta-left"]=function(e,t){t.preventDefault();var n=lt(e);n&&n.modify&&n.modify("move","backward","lineboundary")},We["meta-right"]=function(e,t){t.preventDefault();var n=lt(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),Y||(We.pageup=function(e){e.moveCursorToStart()},We.pagedown=function(e){e.moveCursorToEnd()}),We[re+"b"]=Me("B"),We[re+"i"]=Me("I"),We[re+"u"]=Me("U"),We[re+"shift-7"]=Me("S"),We[re+"shift-5"]=Me("SUB",{tag:"SUP"}),We[re+"shift-6"]=Me("SUP",{tag:"SUB"}),We[re+"shift-8"]=Fe("makeUnorderedList"),We[re+"shift-9"]=Fe("makeOrderedList"),We[re+"["]=Fe("decreaseQuoteLevel"),We[re+"]"]=Fe("increaseQuoteLevel"),We[re+"y"]=Fe("redo"),We[re+"z"]=Fe("undo"),We[re+"shift-z"]=Fe("redo");var ze={1:10,2:13,3:16,4:18,5:24,6:32,7:48},qe={backgroundColor:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:z,style:"background-color:"+t})}},color:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:q,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return T(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return T(e,"I")}},fontFamily:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:K,style:"font-family:"+t})}},fontSize:{regexp:he,replace:function(e,t){return T(e,"SPAN",{class:G,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return T(e,"U")}}},Ke=function(e){return function(t,n){var o=T(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(S(t)),o}},Ge=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in qe)o=qe[n],(i=d[n])&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Ze={P:Ge,SPAN:Ge,STRONG:Ke("B"),EM:Ke("I"),INS:Ke("U"),STRIKE:Ke("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,d=e.size,l=e.color,c=e.ownerDocument;return s&&(n=T(c,"SPAN",{class:K,style:"font-family:"+s}),a=n,r=n),d&&(o=T(c,"SPAN",{class:G,style:"font-size:"+ze[d]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),l&&/^#?([\dA-F]{3}){1,2}$/i.test(l)&&("#"!==l.charAt(0)&&(l="#"+l),i=T(c,"SPAN",{class:q,style:"color:"+l}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=T(c,"SPAN")),t.replaceChild(a,e),r.appendChild(S(e)),r},TT:function(e,t){var n=T(e.ownerDocument,"SPAN",{class:K,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(S(e)),n}},je=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,$e=/^(?:HEAD|META|STYLE)/,Qe=new n(null,4|W,function(){return!0}),Ve=function e(t,n){var o,i,r,s,d,l,c,h,u,f,p,g,m=t.childNodes;for(o=t;a(o);)o=o.parentNode;for(Qe.root=o,i=0,r=m.length;i<r;i+=1)if(s=m[i],d=s.nodeName,l=s.nodeType,c=Ze[d],l===w){if(h=s.childNodes.length,c)s=c(s,t);else{if($e.test(d)){t.removeChild(s),i-=1,r-=1;continue}if(!je.test(d)&&!a(s)){i-=1,r+=h-1,t.replaceChild(S(s),s);continue}}h&&e(s,n||"PRE"===d)}else{if(l===F){if(p=s.data,u=!he.test(p.charAt(0)),f=!he.test(p.charAt(p.length-1)),n||!u&&!f)continue;if(u){for(Qe.currentNode=s;(g=Qe.previousPONode())&&!("IMG"===(d=g.nodeName)||"#text"===d&&he.test(g.data));)if(!a(g)){g=null;break}p=p.replace(/^[ \t\r\n]+/g,g?" ":"")}if(f){for(Qe.currentNode=s;(g=Qe.nextNode())&&!("IMG"===d||"#text"===d&&he.test(g.data));)if(!a(g)){g=null;break}p=p.replace(/[ \t\r\n]+$/g,g?" ":"")}if(p){s.data=p;continue}}t.removeChild(s),i-=1,r-=1}return t},Ye=function e(t){for(var n,o=t.childNodes,r=o.length;r--;)n=o[r],n.nodeType!==w||i(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},Xe=function(e){return e.nodeType===w?"BR"===e.nodeName:he.test(e.data)},Je=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,4|W,Xe),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},et=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;o<l;o+=1)d[o]=Je(s[o],n);for(;l--;)i=s[l],(r=i.parentNode)&&(d[l]?a(r)||E(r,t):N(i))},tt=function(e,t,n){var o,i,r=t.ownerDocument.body;et(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,X&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},nt=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),ne||V||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Ae(l,c),n=Be(l,c),o=t===n&&t||c,i=be(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),tt(d,s,c),e.preventDefault()}this.setSelection(l)},ot=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!ne&&!V&&d){for(t=Ae(l,c),n=Be(l,c),o=t===n&&t||c,l=l.cloneRange(),xe(l),Oe(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),tt(d,s,c),e.preventDefault()}},it=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(ne&&s){for(t=s.length;t--;)!d&&/^image\/.*/.test(s[t].type)&&(c=!0);c||(s=null)}if(s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!ne&&i&&(ue.call(i,"text/html")>-1||!J&&ue.call(i,"text/plain")>-1&&ue.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,N(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u._createRange(g,m,v,_),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)},rt=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},at=R.prototype,st=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};at.setConfig=function(e){return e=B({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:ge,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?st:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},at.createElement=function(e,t,n){return T(this._doc,e,t,n)},at.createDefaultBlock=function(e){var t=this._config;return y(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},at.didError=function(e){console.log(e)},at.getDocument=function(){return this._doc},at.getRoot=function(){return this._root},at.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var dt={pathChange:1,select:1,input:1,undoStateChange:1};at.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},at.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},at.handleEvent=function(e){this.fireEvent(e.type,e)},at.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],dt[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},at.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],dt[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},at._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},at.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=Z,ye(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),L(n,e)),o},at._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return xe(n),this.setSelection(n),this},at.moveCursorToStart=function(){return this._moveCursorTo(!0)},at.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var lt=function(e){return e._win.getSelection()||null};at.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(Q&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{V&&this._win.focus();var t=lt(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},at.getSelection=function(){var e,t,n,o,r=lt(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,o=e.commonAncestorContainer,m(o.ownerDocument,o)||(e=null)),e||(e=this._createRange(a.firstChild,0)),e},at.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,o=new n(e.commonAncestorContainer,4|W,function(t){return Le(e,t,!0)}),i=e.startContainer,r=e.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===i&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},at.getPath=function(){return this._path};var ct=function(e,t){for(var o,i,r,s=new n(e,4,function(){return!0},!1);i=s.nextNode();)for(;(r=i.data.indexOf(Z))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do{o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o}while(a(i)&&!_(i));break}i.deleteData(r,1)}};at._didAddZWS=function(){this._hasZWS=!0},at._removeZWS=function(){this._hasZWS&&(ct(this._root),this._hasZWS=!1)},at._updatePath=function(e,t){if(e){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?v(i,this._root):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},at._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},at.focus=function(){return this._root.focus(),ie&&this.fireEvent("focus"),this},at.blur=function(){return this._root.blur(),ie&&this.fireEvent("blur"),this};var ht="squire-selection-end";at._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),o=this.createElement("INPUT",{id:ht,type:"hidden"});ye(e,n),e.collapse(!1),ye(e,o),2&n.compareDocumentPosition(o)&&(n.id=ht,o.id="squire-selection-start",t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},at._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),o=t.querySelector("#"+ht);if(n&&o){var i=n.parentNode,r=o.parentNode,a=ue.call(i.childNodes,n),s=ue.call(r.childNodes,o);i===r&&(s-=1),N(n),N(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),L(i,e),i!==r&&L(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},at._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},at._docWasChanged=function(){if(ce&&(Ce=new WeakMap),!this._ignoreAllChanges){if(le&&this._ignoreChange)return void(this._ignoreChange=!1)
;this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},at._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,o=this._undoIndex,i=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(o+=1),o<this._undoStackLength&&(i.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&o>s&&(i.splice(0,o-s),o=s,this._undoStackLength=s),i[o]=n,this._undoIndex=o,this._undoStackLength+=1,this._isInUndoState=!0}},at.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},at.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},at.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},at.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,4,function(e){return Le(o,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},at.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},at._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f=this._root;if(o.collapsed){for(i=y(this.createElement(e,t),f),ye(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),u=i;a(u);)u=u.parentNode;ct(u,i)}else{if(r=new n(o.commonAncestorContainer,4|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Le(o,e,!0)},!1),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do{h=r.currentNode,!g(h,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),C(h,i),i.appendChild(h))}while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this._createRange(s,l,d,c)}return o},at._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(se?(i=r.createTextNode(Z),this._didAddZWS()):i=r.createTextNode(""),ye(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Le(n,e,!1)){var o,i,r=e.nodeType===F;if(!Le(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,f(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Le(n,o,!0)&&p(o,e,t)});return o||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),L(s,n),n},at.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),le||this._docWasChanged(),this):this};var ut={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},ft=function(e,t,n,o){var i=ut[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),p(a,i,r)||(t=T(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};at.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Ae(n,o),r=Be(n,o);if(i&&r)do{if(e(i)||i===r)break}while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),le||this._docWasChanged()),this},at.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,o=this._root;return Pe(t,o),Oe(t,o,o,o),n=Ee(t,o,o),ye(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&O(t.endContainer.childNodes[t.endOffset],o),O(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),le||this._docWasChanged(),this};var pt=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},gt=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},mt=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:ht,type:"hidden"})])},vt=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(o)):C(o,e.createElement(n,c,[a])),a.appendChild(S(o)),s.currentNode=a):(o=o.parentNode,(i=o.nodeName)!==n&&/^[OU]L$/.test(i)&&C(o,e.createElement(n,c,[S(o)])))},_t=function(e){return vt(this,e,"UL"),e},Nt=function(e){return vt(this,e,"OL"),e},Ct=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)o=a[t],i=S(o),E(i,l),C(o,i);for(t=0,n=d.length;t<n;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([S(r)])):(E(r,l),C(r,S(r)));return e},St=function(e,t){for(var n=e.commonAncestorContainer,o=e.startContainer,i=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(o===n&&(o=o.childNodes[e.startOffset]),i===n&&(i=i.childNodes[e.endOffset]);o&&o.parentNode!==n;)o=o.parentNode;for(;i&&i.parentNode!==n;)i=i.parentNode;return[n,o,i]};at.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=St(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];if(!i||i===o.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=o.nodeName,l=i.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),o.insertBefore(l,i));do{s=i===r?null:i.nextSibling,l.appendChild(i)}while(i=s);return s=l.nextSibling,s&&O(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),le||this._docWasChanged(),this.focus()},at.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=St(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];i||(i=o.firstChild),r||(r=o.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=o.parentNode,d=r.nextSibling?b(o,r.nextSibling,s,t):o.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=o.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=i===r?null:i.nextSibling,o.removeChild(i),l&&"LI"===i.nodeName&&(i=this.createDefaultBlock([S(i)])),s.insertBefore(i,d)}while(i=a);return o.firstChild||N(o),d&&O(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),le||this._docWasChanged(),this.focus()},at._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},at.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},at._getHTML=function(){return this._root.innerHTML},at._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{y(n,t)}while(n=h(n,t));this._ignoreChange=!0},at.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ae)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ae)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},at.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),Ve(n),et(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)y(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),y(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},at.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))ye(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=Ae(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),xe(t)}return this.focus(),this.setSelection(t),this._updatePath(t),le||this._docWasChanged(),this},at.insertImage=function(e,t){var n=this.createElement("IMG",B({src:e},t,!0));return this.insertElement(n),n};var Tt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,yt=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,4,function(e){return!g(e,t,"A")},!1),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=Tt.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",B({href:s[1]?/^(?:ht|f)tps?:/.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[2]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};at.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),o=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},yt(r,r,this),Ve(r),et(r,a,!1),Ye(r),r.normalize();s=h(s,r);)y(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(ke(u,d.fragment,a),le||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var Et=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};at.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Et(l[n])+'"';for(h+=">",o=0,i=a.length;o<i;o+=1)r=a[o],r=Et(r).replace(/ (?= )/g,"&nbsp;"),a[o]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var bt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};at.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},at.bold=bt("changeFormat",{tag:"B"}),at.italic=bt("changeFormat",{tag:"I"}),at.underline=bt("changeFormat",{tag:"U"}),at.strikethrough=bt("changeFormat",{tag:"S"}),at.subscript=bt("changeFormat",{tag:"SUB"},{tag:"SUP"}),at.superscript=bt("changeFormat",{tag:"SUP"},{tag:"SUB"}),at.removeBold=bt("changeFormat",null,{tag:"B"}),at.removeItalic=bt("changeFormat",null,{tag:"I"}),at.removeUnderline=bt("changeFormat",null,{tag:"U"}),at.removeStrikethrough=bt("changeFormat",null,{tag:"S"}),at.removeSubscript=bt("changeFormat",null,{tag:"SUB"}),at.removeSuperscript=bt("changeFormat",null,{tag:"SUP"}),at.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;ye(n,this._doc.createTextNode(e.slice(o)))}return t=B(B({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},at.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},at.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:K,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:K}}),this.focus()},at.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:G,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:G}}),this.focus()},at.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:q,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:q}}),this.focus()},at.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:z,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:z}}),this.focus()},at.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},at.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},at.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Pe(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),Oe(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return I(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=ue.call(i,p),c=ue.call(i,o)+1):(d=ue.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),L(n,e),xe(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},at.increaseQuoteLevel=bt("modifyBlocks",pt),at.decreaseQuoteLevel=bt("modifyBlocks",gt),at.makeUnorderedList=bt("modifyBlocks",_t),at.makeOrderedList=bt("modifyBlocks",Nt),at.removeList=bt("modifyBlocks",Ct),R.isInline=a,R.isBlock=s,R.isContainer=d,R.getBlockWalker=l,R.getPreviousBlock=c,R.getNextBlock=h,R.areAlike=f,R.hasTagAttributes=p,R.getNearest=g,R.isOrContains=m,R.detach=N,R.replaceWith=C,R.empty=S,R.getNodeBefore=Se,R.getNodeAfter=Te,R.insertNodeInRange=ye,R.extractContentsOfRange=Ee,R.deleteContentsOfRange=be,R.insertTreeFragmentIntoRange=ke,R.isNodeContainedInRange=Le,R.moveRangeBoundariesDownTree=xe,R.moveRangeBoundariesUpTree=Oe,R.getStartBlockOfRange=Ae,R.getEndBlockOfRange=Be,R.contentWalker=Re,R.rangeDoesStartAtBlockBoundary=De,R.rangeDoesEndAtBlockBoundary=Ue,R.expandRangeToBlockBoundaries=Pe,R.onPaste=it,R.addLinks=yt,R.splitBlock=ft,R.startSelectionId="squire-selection-start",R.endSelectionId=ht,"object"==typeof exports?module.exports=R:"function"==typeof define&&define.amd?define(function(){return R}):(j.Squire=R,top!==j&&"true"===e.documentElement.getAttribute("data-squireinit")&&(j.editor=new R(e),j.onEditorLoad&&(j.onEditorLoad(j.editor),j.onEditorLoad=null)))}(document);
>>>>>>> 070f2e5... Support pasting images in Edge
=======
!function(e,t){"use strict";var n=1,o=3,i=9,r=11,a=1,s="highlight",d="colour",l="font",c="size",h="​",u=e.defaultView,f=navigator.userAgent,p=/Android/.test(f),g=/iP(?:ad|hone|od)/.test(f),m=/Mac OS X/.test(f),v=/Windows NT/.test(f),_=/Gecko\//.test(f),N=/Trident\/[456]\./.test(f),C=!!u.opera,S=/Edge\//.test(f),T=!S&&/WebKit\//.test(f),y=/Trident\/[4567]\./.test(f),E=m?"meta-":"ctrl-",b=N||C,k=N||T,L=N,x="undefined"!=typeof MutationObserver,A="undefined"!=typeof WeakMap,O=/[^ \t\r\n]/,B=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var R={1:1,2:2,3:4,8:128,9:256,11:1024};function D(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}D.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(R[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},D.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(R[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},D.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(R[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var U=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,P={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1};var I=0,w=1,F=2,M=3,H=A?new WeakMap:null;function W(e){return e.nodeType===n&&!!P[e.nodeName]}function z(e){switch(e.nodeType){case o:return w;case n:case r:if(A&&H.has(e))return H.get(e);break;default:return I}var t;return t=function(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}(e.childNodes,q)?U.test(e.nodeName)?w:F:M,A&&H.set(e,t),t}function q(e){return z(e)===w}function K(e){return z(e)===F}function G(e){return z(e)===M}function Z(e,t){var n=new D(t,a,K);return n.currentNode=e,n}function j(e,t){return(e=Z(e,t).previousNode())!==t?e:null}function $(e,t){return(e=Z(e,t).nextNode())!==t?e:null}function Q(e){return!e.textContent&&!e.querySelector("IMG")}function V(e,t){return!W(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function Y(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function X(e,t,n,o){for(;e&&e!==t;){if(Y(e,n,o))return e;e=e.parentNode}return null}function J(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function ee(e){var t=e.nodeType;return t===n||t===r?e.childNodes.length:e.length||0}function te(e){var t=e.parentNode;return t&&t.removeChild(e),e}function ne(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function oe(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function ie(e,n,o,i){var r,a,s,d=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)o[r]!==t&&d.setAttribute(r,o[r]);if(i)for(a=0,s=i.length;a<s;a+=1)d.appendChild(i[a]);return d}function re(e,t){var n,i,r=t.__squire__,a=e.ownerDocument,s=e;if(e===t&&((i=e.firstChild)&&"BR"!==i.nodeName||(n=r.createDefaultBlock(),i?e.replaceChild(n,i):e.appendChild(n),e=n,n=null)),e.nodeType===o)return s;if(q(e)){for(i=e.firstChild;k&&i&&i.nodeType===o&&!i.data;)e.removeChild(i),i=e.firstChild;i||(k?(n=a.createTextNode(h),r._didAddZWS()):n=a.createTextNode(""))}else if(b){for(;e.nodeType!==o&&!W(e);){if(!(i=e.firstChild)){n=a.createTextNode("");break}e=i}e.nodeType===o?/^ +$/.test(e.data)&&(e.data=""):W(e)&&e.parentNode.insertBefore(a.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=ie(a,"BR");(i=e.lastElementChild)&&!q(i);)e=i;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return s}function ae(e,t){var n,o,i,r,a=e.childNodes,s=e.ownerDocument,d=null,l=t.__squire__._config;for(n=0,o=a.length;n<o;n+=1)!(r="BR"===(i=a[n]).nodeName)&&q(i)?(d||(d=ie(s,l.blockTag,l.blockAttributes)),d.appendChild(i),n-=1,o-=1):(r||d)&&(d||(d=ie(s,l.blockTag,l.blockAttributes)),re(d,t),r?e.replaceChild(d,i):(e.insertBefore(d,i),n+=1,o+=1),d=null),G(i)&&ae(i,t);return d&&e.appendChild(re(d,t)),e}function se(e,t,i,r){var a,s,d,l=e.nodeType;if(l===o&&e!==i)return se(e.parentNode,e.splitText(t),i,r);if(l===n){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===i)return t;for(a=e.parentNode,s=e.cloneNode(!1);t;)d=t.nextSibling,s.appendChild(t),t=d;return"OL"===e.nodeName&&X(e,r,"BLOCKQUOTE")&&(s.start=(+e.start||1)+e.childNodes.length-1),re(e,r),re(s,r),(d=e.nextSibling)?a.insertBefore(s,d):a.appendChild(s),se(a,s,i,r)}return t}function de(e,t){if(e.nodeType===o&&(e=e.parentNode),e.nodeType===n){var i={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};!function e(t,i){for(var r,a,s,d=t.childNodes,l=d.length,c=[];l--;)if(r=d[l],a=l&&d[l-1],l&&q(r)&&V(r,a)&&!P[r.nodeName])i.startContainer===r&&(i.startContainer=a,i.startOffset+=ee(a)),i.endContainer===r&&(i.endContainer=a,i.endOffset+=ee(a)),i.startContainer===t&&(i.startOffset>l?i.startOffset-=1:i.startOffset===l&&(i.startContainer=a,i.startOffset=ee(a))),i.endContainer===t&&(i.endOffset>l?i.endOffset-=1:i.endOffset===l&&(i.endContainer=a,i.endOffset=ee(a))),te(r),r.nodeType===o?a.appendData(r.data):c.push(oe(r));else if(r.nodeType===n){for(s=c.length;s--;)r.appendChild(c.pop());e(r,i)}}(e,i),t.setStart(i.startContainer,i.startOffset),t.setEnd(i.endContainer,i.endOffset)}}function le(e,t,o,i){for(var r,a,s,d=t;(r=d.parentNode)&&r!==i&&r.nodeType===n&&1===r.childNodes.length;)d=r;te(d),s=e.childNodes.length,(a=e.lastChild)&&"BR"===a.nodeName&&(e.removeChild(a),s-=1),e.appendChild(oe(t)),o.setStart(e,s),o.collapse(!0),de(e,o),C&&(a=e.lastChild)&&"BR"===a.nodeName&&e.removeChild(a)}function ce(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&V(i,e)){if(!G(i)){if(!s)return;(o=ie(a,"DIV")).appendChild(oe(i)),i.appendChild(o)}te(e),n=!G(e),i.appendChild(oe(e)),n&&ae(i,t),r&&ce(r,t)}else s&&(i=ie(a,"DIV"),e.insertBefore(i,r),re(i,t))}var he=function(e,t){for(var o=e.childNodes;t&&e.nodeType===n;)t=(o=(e=o[t-1]).childNodes).length;return e},ue=function(e,t){if(e.nodeType===n){var o=e.childNodes;if(t<o.length)e=o[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},fe=function(e,t){var n,i,r,a,s=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset;s.nodeType===o?(i=(n=s.parentNode).childNodes,d===s.length?(d=B.call(i,s)+1,e.collapsed&&(l=n,c=d)):(d&&(a=s.splitText(d),l===s?(c-=d,l=a):l===n&&(c+=1),s=a),d=B.call(i,s)),s=n):i=s.childNodes,d===(r=i.length)?s.appendChild(t):s.insertBefore(t,i[d]),s===l&&(c+=i.length-r),e.setStart(s,d),e.setEnd(l,c)},pe=function(e,t,n){var i=e.startContainer,r=e.startOffset,a=e.endContainer,s=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===o&&(t=t.parentNode);for(var d,l,c,h=se(a,s,t,n),u=se(i,r,t,n),f=t.ownerDocument.createDocumentFragment();u!==h;)d=u.nextSibling,f.appendChild(u),u=d;return i=t,r=h?B.call(t.childNodes,h):t.childNodes.length,(l=(c=t.childNodes[r])&&c.previousSibling)&&l.nodeType===o&&c.nodeType===o&&(i=l,r=l.length,l.appendData(c.data),te(c)),e.setStart(i,r),e.collapse(!0),re(t,n),f},ge=function(e,t){var n,o,i=Ce(e,t),r=Se(e,t),a=i!==r;return _e(e),Ne(e,i,r,t),n=pe(e,null,t),_e(e),a&&(r=Se(e,t),i&&r&&i!==r&&le(i,r,e,t)),i&&re(i,t),(o=t.firstChild)&&"BR"!==o.nodeName?e.collapse(!0):(re(t,t),e.selectNodeContents(t.firstChild)),n},me=function(e,t,n){var o,i,r,a,s,d,l,c,h,u,f;for(ae(t,n),o=t;o=$(o,n);)re(o,n);if(e.collapsed||ge(e,n),_e(e),e.collapse(!1),a=X(e.endContainer,n,"BLOCKQUOTE")||n,i=Ce(e,n),c=$(t,t),l=!!i&&Q(i),i&&c&&!l&&!X(c,t,"PRE")&&!X(c,t,"TABLE")){if(Ne(e,i,i,n),e.collapse(!0),s=e.endContainer,d=e.endOffset,Ke(i,n,!1),q(s)&&(s=(h=se(s,d,j(s,n),n)).parentNode,d=B.call(s.childNodes,h)),d!==ee(s))for(r=n.ownerDocument.createDocumentFragment();o=s.childNodes[d];)r.appendChild(o);le(s,c,e,n),d=B.call(s.parentNode.childNodes,s)+1,s=s.parentNode,e.setEnd(s,d)}ee(t)&&(l&&(e.setEndBefore(i),e.collapse(!1),te(i)),Ne(e,a,a,n),u=(h=se(e.endContainer,e.endOffset,a,n))?h.previousSibling:a.lastChild,a.insertBefore(t,h),h?e.setEndBefore(h):e.setEnd(a,ee(a)),i=Se(e,n),_e(e),s=e.endContainer,d=e.endOffset,h&&G(h)&&ce(h,n),(h=u&&u.nextSibling)&&G(h)&&ce(h,n),e.setEnd(s,d)),r&&(le(i,r,f=e.cloneRange(),n),e.setEnd(f.endContainer,f.endOffset)),_e(e)},ve=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(3,o)>-1,r=e.compareBoundaryPoints(1,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(0,o)<1,s=e.compareBoundaryPoints(2,o)>-1;return a&&s},_e=function(e){for(var t,n=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==o&&(t=n.childNodes[i])&&!W(t);)n=t,i=0;if(a)for(;r.nodeType!==o;){if(!(t=r.childNodes[a-1])||W(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}a=ee(r=t)}else for(;r.nodeType!==o&&(t=r.firstChild)&&!W(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,i)):(e.setStart(n,i),e.setEnd(r,a))},Ne=function(e,t,n,i){var r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset,c=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!s&&a!==t&&a!==i;)r=a.parentNode,s=B.call(r.childNodes,a),a=r;for(;c&&d.nodeType!==o&&d.childNodes[l]&&"BR"===d.childNodes[l].nodeName&&(l+=1,c=!1),d!==n&&d!==i&&l===ee(d);)r=d.parentNode,l=B.call(r.childNodes,d)+1,d=r;e.setStart(a,s),e.setEnd(d,l)},Ce=function(e,t){var n,o=e.startContainer;return(n=q(o)?j(o,t):o!==t&&K(o)?o:$(n=he(o,e.startOffset),t))&&ve(e,n,!0)?n:null},Se=function(e,t){var n,o,i=e.endContainer;if(q(i))n=j(i,t);else if(i!==t&&K(i))n=i;else{if(!(n=ue(i,e.endOffset))||!J(t,n))for(n=t;o=n.lastChild;)n=o;n=j(n,t)}return n&&ve(e,n,!0)?n:null},Te=new D(null,4|a,function(e){return e.nodeType===o?O.test(e.data):"IMG"===e.nodeName}),ye=function(e,t){var n,i=e.startContainer,r=e.startOffset;if(Te.root=null,i.nodeType===o){if(r)return!1;n=i}else if((n=ue(i,r))&&!J(t,n)&&(n=null),!n&&(n=he(i,r)).nodeType===o&&n.length)return!1;return Te.currentNode=n,Te.root=Ce(e,t),!Te.previousNode()},Ee=function(e,t){var n,i=e.endContainer,r=e.endOffset;if(Te.root=null,i.nodeType===o){if((n=i.data.length)&&r<n)return!1;Te.currentNode=i}else Te.currentNode=he(i,r);return Te.root=Se(e,t),!Te.nextNode()},be=function(e,t){var n,o=Ce(e,t),i=Se(e,t);o&&i&&(n=o.parentNode,e.setStart(n,B.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,B.call(n.childNodes,i)+1))},ke={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},Le=function(e){var t=e.keyCode,n=ke[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),C&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):1!==n.length||i.collapsed||(this.saveUndoState(i),ge(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},xe=function(e){return function(t,n){n.preventDefault(),t[e]()}},Ae=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Oe=function(e,t){try{t||(t=e.getSelection());var n,i=t.startContainer;for(i.nodeType===o&&(i=i.parentNode),n=i;q(n)&&(!n.textContent||n.textContent===h);)n=(i=n).parentNode;i!==n&&(t.setStart(n,B.call(n.childNodes,i)),t.collapse(!0),n.removeChild(i),K(n)||(n=j(n,e._root)),re(n,e._root),_e(t)),i===e._root&&(i=i.firstChild)&&"BR"===i.nodeName&&te(i),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},Be={enter:function(e,t,i){var r,a,s,d=e._root;if(t.preventDefault(),e._recordUndoState(i),mt(i.startContainer,d,e),e._removeZWS(),e._getRangeAndRemoveBookmark(i),i.collapsed||ge(i,d),!(r=Ce(i,d))||/^T[HD]$/.test(r.nodeName))return(a=X(i.endContainer,d,"A"))&&(a=a.parentNode,Ne(i,a,a,d),i.collapse(!1)),fe(i,e.createElement("BR")),i.collapse(!1),e.setSelection(i),void e._updatePath(i,!0);if((a=X(r,d,"LI"))&&(r=a),Q(r)){if(X(r,d,"UL")||X(r,d,"OL"))return e.decreaseListLevel(i);if(X(r,d,"BLOCKQUOTE"))return e.modifyBlocks(ut,i)}for(s=ct(e,r,i.startContainer,i.startOffset),at(r),We(r),re(r,d);s.nodeType===n;){var l,c=s.firstChild;if("A"===s.nodeName&&(!s.textContent||s.textContent===h)){ne(s,c=e._doc.createTextNode("")),s=c;break}for(;c&&c.nodeType===o&&!c.data&&(l=c.nextSibling)&&"BR"!==l.nodeName;)te(c),c=l;if(!c||"BR"===c.nodeName||c.nodeType===o&&!C)break;s=c}i=e._createRange(s,0),e.setSelection(i),e._updatePath(i,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(ye(n,o)){t.preventDefault();var i,r=Ce(n,o);if(!r)return;if(ae(r.parentNode,o),i=j(r,o)){if(!i.isContentEditable)return void te(i);for(le(i,r,n,o),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&ce(r,o),e.setSelection(n)}else if(r){if(X(r,o,"UL")||X(r,o,"OL"))return e.decreaseListLevel(n);if(X(r,o,"BLOCKQUOTE"))return e.modifyBlocks(ht,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Oe(e)},0);else t.preventDefault(),ge(n,o),Oe(e,n)},delete:function(e,t,o){var i,r,a,s,d,l,c=e._root;if(e._removeZWS(),e.saveUndoState(o),o.collapsed)if(Ee(o,c)){if(t.preventDefault(),!(i=Ce(o,c)))return;if(ae(i.parentNode,c),r=$(i,c)){if(!r.isContentEditable)return void te(r);for(le(i,r,o,c),r=i.parentNode;r!==c&&!r.nextSibling;)r=r.parentNode;r!==c&&(r=r.nextSibling)&&ce(r,c),e.setSelection(o),e._updatePath(o,!0)}}else{if(a=o.cloneRange(),Ne(o,c,c,c),s=o.endContainer,d=o.endOffset,s.nodeType===n&&(l=s.childNodes[d])&&"IMG"===l.nodeName)return t.preventDefault(),te(l),_e(o),void Oe(e,o);e.setSelection(a),setTimeout(function(){Oe(e)},0)}else t.preventDefault(),ge(o,c),Oe(e,o)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&ye(n,r))for(o=Ce(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.increaseListLevel(n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&ye(n,i)&&(X(o=n.startContainer,i,"UL")||X(o,i,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n))},space:function(e,t,n){var o,i;e._recordUndoState(n),mt(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),i=(o=n.endContainer).parentNode,n.collapsed&&n.endOffset===ee(o)&&("A"===o.nodeName?n.setStartAfter(o):"A"!==i.nodeName||o.nextSibling||n.setStartAfter(i)),n.collapsed||(ge(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};m&&_&&(Be["meta-left"]=function(e,t){t.preventDefault();var n=nt(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Be["meta-right"]=function(e,t){t.preventDefault();var n=nt(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),m||(Be.pageup=function(e){e.moveCursorToStart()},Be.pagedown=function(e){e.moveCursorToEnd()}),Be[E+"b"]=Ae("B"),Be[E+"i"]=Ae("I"),Be[E+"u"]=Ae("U"),Be[E+"shift-7"]=Ae("S"),Be[E+"shift-5"]=Ae("SUB",{tag:"SUP"}),Be[E+"shift-6"]=Ae("SUP",{tag:"SUB"}),Be[E+"shift-8"]=xe("makeUnorderedList"),Be[E+"shift-9"]=xe("makeOrderedList"),Be[E+"["]=xe("decreaseQuoteLevel"),Be[E+"]"]=xe("increaseQuoteLevel"),Be[E+"y"]=xe("redo"),Be[E+"z"]=xe("undo"),Be[E+"shift-z"]=xe("redo");var Re={1:10,2:13,3:16,4:18,5:24,6:32,7:48},De={backgroundColor:{regexp:O,replace:function(e,t){return ie(e,"SPAN",{class:s,style:"background-color:"+t})}},color:{regexp:O,replace:function(e,t){return ie(e,"SPAN",{class:d,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return ie(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return ie(e,"I")}},fontFamily:{regexp:O,replace:function(e,t){return ie(e,"SPAN",{class:l,style:"font-family:"+t})}},fontSize:{regexp:O,replace:function(e,t){return ie(e,"SPAN",{class:c,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return ie(e,"U")}}},Ue=function(e){return function(t,n){var o=ie(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(oe(t)),o}},Pe=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in De)o=De[n],(i=d[n])&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(oe(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Ie={P:Pe,SPAN:Pe,STRONG:Ue("B"),EM:Ue("I"),INS:Ue("U"),STRIKE:Ue("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,h=e.size,u=e.color,f=e.ownerDocument;return s&&(a=n=ie(f,"SPAN",{class:l,style:"font-family:"+s}),r=n),h&&(o=ie(f,"SPAN",{class:c,style:"font-size:"+Re[h]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),u&&/^#?([\dA-F]{3}){1,2}$/i.test(u)&&("#"!==u.charAt(0)&&(u="#"+u),i=ie(f,"SPAN",{class:d,style:"color:"+u}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=ie(f,"SPAN")),t.replaceChild(a,e),r.appendChild(oe(e)),r},TT:function(e,t){var n=ie(e.ownerDocument,"SPAN",{class:l,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(oe(e)),n}},we=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Fe=/^(?:HEAD|META|STYLE)/,Me=new D(null,4|a,function(){return!0}),He=function e(t,i){var r,a,s,d,l,c,h,u,f,p,g,m,v=t.childNodes;for(r=t;q(r);)r=r.parentNode;for(Me.root=r,a=0,s=v.length;a<s;a+=1)if(l=(d=v[a]).nodeName,c=d.nodeType,h=Ie[l],c===n){if(u=d.childNodes.length,h)d=h(d,t);else{if(Fe.test(l)){t.removeChild(d),a-=1,s-=1;continue}if(!we.test(l)&&!q(d)){a-=1,s+=u-1,t.replaceChild(oe(d),d);continue}}u&&e(d,i||"PRE"===l)}else{if(c===o){if(g=d.data,f=!O.test(g.charAt(0)),p=!O.test(g.charAt(g.length-1)),i||!f&&!p)continue;if(f){for(Me.currentNode=d;(m=Me.previousPONode())&&!("IMG"===(l=m.nodeName)||"#text"===l&&O.test(m.data));)if(!q(m)){m=null;break}g=g.replace(/^[ \t\r\n]+/g,m?" ":"")}if(p){for(Me.currentNode=d;(m=Me.nextNode())&&!("IMG"===l||"#text"===l&&O.test(m.data));)if(!q(m)){m=null;break}g=g.replace(/[ \t\r\n]+$/g,m?" ":"")}if(g){d.data=g;continue}}t.removeChild(d),a-=1,s-=1}return t},We=function e(t){for(var i,r=t.childNodes,a=r.length;a--;)(i=r[a]).nodeType!==n||W(i)?i.nodeType!==o||i.data||t.removeChild(i):(e(i),q(i)&&!i.firstChild&&t.removeChild(i))},ze=function(e){return e.nodeType===n?"BR"===e.nodeName:O.test(e.data)},qe=function(e,t){for(var n,o=e.parentNode;q(o);)o=o.parentNode;return(n=new D(o,4|a,ze)).currentNode=e,!!n.nextNode()||t&&!n.previousNode()},Ke=function(e,t,n){var o,i,r,a=e.querySelectorAll("BR"),s=[],d=a.length;for(o=0;o<d;o+=1)s[o]=qe(a[o],n);for(;d--;)(r=(i=a[d]).parentNode)&&(s[d]?q(r)||ae(r,t):te(i))},Ge=function(e,t,n){var o,i,r=t.ownerDocument.body;Ke(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,v&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},Ze=function(e){var t,n,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)e.preventDefault();else{if(this.saveUndoState(l),S||g||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(n=(t=Ce(l,c))===Se(l,c)&&t||c,i=ge(l,c),(r=l.commonAncestorContainer).nodeType===o&&(r=r.parentNode);r&&r!==n;)(a=r.cloneNode(!1)).appendChild(i),i=a,r=r.parentNode;(s=this.createElement("div")).appendChild(i),Ge(d,s,c),e.preventDefault()}this.setSelection(l)}},je=function(e){var t,n,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!S&&!g&&d){for(n=(t=Ce(l,c))===Se(l,c)&&t||c,l=l.cloneRange(),_e(l),Ne(l,n,n,c),i=l.cloneContents(),(r=l.commonAncestorContainer).nodeType===o&&(r=r.parentNode);r&&r!==n;)(a=r.cloneNode(!1)).appendChild(i),i=a,r=r.parentNode;(s=this.createElement("div")).appendChild(i),Ge(d,s,c),e.preventDefault()}};function $e(e){this.isShiftDown=e.shiftKey}var Qe=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(S&&s){for(t=s.length;t--;)!d&&/^image\/.*/.test(s[t].type)&&(c=!0);c||(s=null)}if(s){for(e.preventDefault(),t=s.length;t--;){if(o=(n=s[t]).type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)})}else{if(i=a&&a.types,!S&&i&&(B.call(i,"text/html")>-1||!_&&B.call(i,"text/plain")>-1&&B.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,N=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,te(C),(e=C.firstChild)&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u._createRange(g,m,v,N),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)}},Ve=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()};function Ye(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?Ye(e[o],i,n):i);return e}function Xe(e,t){e.nodeType===i&&(e=e.body);var n,o=e.ownerDocument,r=o.defaultView;this._win=r,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,L&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,x?((n=new MutationObserver(this._docWasChanged.bind(this))).observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",ot),this.addEventListener("mousedown",it),this.addEventListener("touchstart",it),this.addEventListener("focus",rt),this._awaitingPaste=!1,this.addEventListener(N?"beforecut":"cut",Ze),this.addEventListener("copy",je),this.addEventListener("keydown",$e),this.addEventListener("keyup",$e),this.addEventListener(N?"beforepaste":"paste",Qe),this.addEventListener("drop",Ve),this.addEventListener(C?"keypress":"keydown",Le),this._keyHandlers=Object.create(Be),this.setConfig(t),N&&(r.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}var Je=Xe.prototype,et=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};Je.setConfig=function(e){return(e=Ye({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:P,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?et:null},e,!0)).blockTag=e.blockTag.toUpperCase(),this._config=e,this},Je.createElement=function(e,t,n){return ie(this._doc,e,t,n)},Je.createDefaultBlock=function(e){var t=this._config;return re(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},Je.didError=function(e){console.log(e)},Je.getDocument=function(){return this._doc},Je.getRoot=function(){return this._root},Je.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var tt={pathChange:1,select:1,input:1,undoStateChange:1};Je.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),o=(r=r.slice()).length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},Je.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},Je.handleEvent=function(e){this.fireEvent(e.type,e)},Je.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],tt[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},Je.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],tt[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},Je._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},Je.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,(t=this._doc.createElement("SPAN")).textContent=h,fe(e,t),o=t.getBoundingClientRect(),(n=t.parentNode).removeChild(t),de(n,e)),o},Je._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return _e(n),this.setSelection(n),this},Je.moveCursorToStart=function(){return this._moveCursorTo(!0)},Je.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var nt=function(e){return e._win.getSelection()||null};function ot(){this._restoreSelection=!0}function it(){this._restoreSelection=!1}function rt(){this._restoreSelection&&this.setSelection(this._lastSelection)}Je.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(p&&!this._restoreSelection)ot.call(this),this.blur(),this.focus();else{g&&this._win.focus();var t=nt(this);t&&(t.removeAllRanges(),t.addRange(e))}else ot.call(this);return this},Je.getSelection=function(){var e,t,n,o,i=nt(this),r=this._root;return this._isFocused&&i&&i.rangeCount&&(t=(e=i.getRangeAt(0).cloneRange()).startContainer,n=e.endContainer,t&&W(t)&&e.setStartBefore(t),n&&W(n)&&e.setEndBefore(n)),e&&J(r,e.commonAncestorContainer)?this._lastSelection=e:J((o=(e=this._lastSelection).commonAncestorContainer).ownerDocument,o)||(e=null),e||(e=this._createRange(r.firstChild,0)),e},Je.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,n=new D(e.commonAncestorContainer,4|a,function(t){return ve(e,t,!0)}),i=e.startContainer,r=e.endContainer,s=n.currentNode=i,d="",l=!1;for(n.filter(s)||(s=n.nextNode());s;)s.nodeType===o?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===i&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!q(s))&&(d+="\n",l=!1),s=n.nextNode();return d},Je.getPath=function(){return this._path};var at=function(e,t){for(var n,o,i,r=new D(e,4,function(){return!0},!1);o=r.nextNode();)for(;(i=o.data.indexOf(h))>-1&&(!t||o.parentNode!==t);){if(1===o.length){do{(n=o.parentNode).removeChild(o),o=n,r.currentNode=n}while(q(o)&&!ee(o));break}o.deleteData(i,1)}};Je._didAddZWS=function(){this._hasZWS=!0},Je._removeZWS=function(){this._hasZWS&&(at(this._root),this._hasZWS=!1)},Je._updatePath=function(e,t){if(e){var o,i=e.startContainer,r=e.endContainer;(t||i!==this._lastAnchorNode||r!==this._lastFocusNode)&&(this._lastAnchorNode=i,this._lastFocusNode=r,o=i&&r?i===r?function e(t,o){var i,r,a,h,u="";return t&&t!==o&&(u=e(t.parentNode,o),t.nodeType===n&&(u+=(u?">":"")+t.nodeName,(i=t.id)&&(u+="#"+i),(r=t.className.trim())&&((a=r.split(/\s\s*/)).sort(),u+=".",u+=a.join(".")),(h=t.dir)&&(u+="[dir="+h+"]"),a&&(B.call(a,s)>-1&&(u+="[backgroundColor="+t.style.backgroundColor.replace(/ /g,"")+"]"),B.call(a,d)>-1&&(u+="[color="+t.style.color.replace(/ /g,"")+"]"),B.call(a,l)>-1&&(u+="[fontFamily="+t.style.fontFamily.replace(/ /g,"")+"]"),B.call(a,c)>-1&&(u+="[fontSize="+t.style.fontSize+"]")))),u}(r,this._root):"(selection)":"",this._path!==o&&(this._path=o,this.fireEvent("pathChange",{path:o}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},Je._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},Je.focus=function(){return this._root.focus(),y&&this.fireEvent("focus"),this},Je.blur=function(){return this._root.blur(),y&&this.fireEvent("blur"),this};var st="squire-selection-start",dt="squire-selection-end";Je._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:st,type:"hidden"}),o=this.createElement("INPUT",{id:dt,type:"hidden"});fe(e,n),e.collapse(!1),fe(e,o),2&n.compareDocumentPosition(o)&&(n.id=dt,o.id=st,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},Je._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+st),i=t.querySelector("#"+dt);if(n&&i){var r=n.parentNode,a=i.parentNode,s=B.call(r.childNodes,n),d=B.call(a.childNodes,i);r===a&&(d-=1),te(n),te(i),e||(e=this._doc.createRange()),e.setStart(r,s),e.setEnd(a,d),de(r,e),r!==a&&de(a,e),e.collapsed&&(r=e.startContainer).nodeType===o&&((a=r.childNodes[e.startOffset])&&a.nodeType===o||(a=r.childNodes[e.startOffset-1]),a&&a.nodeType===o&&(e.setStart(a,0),e.collapse(!0)))}return e||null},Je._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},Je._docWasChanged=function(){A&&(H=new WeakMap),this._ignoreAllChanges||(x&&this._ignoreChange?this._ignoreChange=!1:(this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")))},Je._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,o=this._undoIndex,i=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(o+=1),o<this._undoStackLength&&(i.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&o>s&&(i.splice(0,o-s),o=s,this._undoStackLength=s),i[o]=n,this._undoIndex=o,this._undoStackLength+=1,this._isInUndoState=!0}},Je.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},Je.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},Je.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},Je.hasFormat=function(e,t,n){if(e=e.toUpperCase(),t||(t={}),!n&&!(n=this.getSelection()))return!1;!n.collapsed&&n.startContainer.nodeType===o&&n.startOffset===n.startContainer.length&&n.startContainer.nextSibling&&n.setStartBefore(n.startContainer.nextSibling),!n.collapsed&&n.endContainer.nodeType===o&&0===n.endOffset&&n.endContainer.previousSibling&&n.setEndAfter(n.endContainer.previousSibling);var i,r,a=this._root,s=n.commonAncestorContainer;if(X(s,a,e,t))return!0;if(s.nodeType===o)return!1;i=new D(s,4,function(e){return ve(n,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!X(r,a,e,t))return!1;d=!0}return d},Je.getFontInfo=function(e){var n,i,r,a={color:t,backgroundColor:t,family:t,size:t},s=0;if(!e&&!(e=this.getSelection()))return a;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===o)for(n.nodeType===o&&(n=n.parentNode);s<4&&n;)(i=n.style)&&(!a.color&&(r=i.color)&&(a.color=r,s+=1),!a.backgroundColor&&(r=i.backgroundColor)&&(a.backgroundColor=r,s+=1),!a.family&&(r=i.fontFamily)&&(a.family=r,s+=1),!a.size&&(r=i.fontSize)&&(a.size=r,s+=1)),n=n.parentNode;return a},Je._addFormat=function(e,t,n){var i,r,s,d,l,c,h,u,f=this._root;if(n.collapsed){for(i=re(this.createElement(e,t),f),fe(n,i),n.setStart(i.firstChild,i.firstChild.length),n.collapse(!0),u=i;q(u);)u=u.parentNode;at(u,i)}else{if(r=new D(n.commonAncestorContainer,4|a,function(e){return(e.nodeType===o||"BR"===e.nodeName||"IMG"===e.nodeName)&&ve(n,e,!0)},!1),s=n.startContainer,l=n.startOffset,d=n.endContainer,c=n.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return n;do{!X(h=r.currentNode,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),ne(h,i=this.createElement(e,t)),i.appendChild(h))}while(r.nextNode());d.nodeType!==o&&(h.nodeType===o?(d=h,c=h.length):(d=h.parentNode,c=1)),n=this._createRange(s,l,d,c)}return n},Je._removeFormat=function(e,t,n,i){this._saveRangeToBookmark(n);var r,a=this._doc;n.collapsed&&(k?(r=a.createTextNode(h),this._didAddZWS()):r=a.createTextNode(""),fe(n,r));for(var s=n.commonAncestorContainer;q(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,u=n.endOffset,f=[],p=function(e,t){if(!ve(n,e,!1)){var i,r,a=e.nodeType===o;if(ve(n,e,!0))if(a)e===c&&u!==e.length&&f.push([t,e.splitText(u)]),e===d&&l&&(e.splitText(l),f.push([t,e]));else for(i=e.firstChild;i;i=r)r=i.nextSibling,p(i,t);else"INPUT"===e.nodeName||a&&!e.data||f.push([t,e])}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return ve(n,o,!0)&&Y(o,e,t)});return i||g.forEach(function(e){p(e,e)}),f.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];ne(n,t),t.appendChild(n)}),g.forEach(function(e){ne(e,oe(e))}),this._getRangeAndRemoveBookmark(n),r&&n.collapse(!1),de(s,n),n},Je.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),x||this._docWasChanged(),this):this};var lt={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},ct=function(e,t,n,o){var i=lt[t.nodeName],r=null,a=se(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),Y(a,i,r)||(t=ie(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),ne(a,t),t.appendChild(oe(a)),a=t),a};Je.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Ce(n,o),r=Se(n,o);if(i&&r)do{if(e(i)||i===r)break}while(i=$(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),x||this._docWasChanged()),this},Je.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,o=this._root;return be(t,o),Ne(t,o,o,o),n=pe(t,o,o),fe(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&ce(t.endContainer.childNodes[t.endOffset],o),ce(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),x||this._docWasChanged(),this};var ht=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!X(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){ne(e,oe(e))}),e},ut=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:st,type:"hidden"}),this.createElement("INPUT",{id:dt,type:"hidden"})])},ft=function(e,t,n){for(var o,i,r,a,s=Z(t,e._root),d=e._config.tagAttributes,l=d[n.toLowerCase()],c=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",c),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),te(o)):ne(o,e.createElement(n,l,[a])),a.appendChild(oe(o)),s.currentNode=a):(i=(o=o.parentNode).nodeName)!==n&&/^[OU]L$/.test(i)&&ne(o,e.createElement(n,l,[oe(o)]))},pt=function(e,t){for(var n=e.commonAncestorContainer,o=e.startContainer,i=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(o===n&&(o=o.childNodes[e.startOffset]),i===n&&(i=i.childNodes[e.endOffset]);o&&o.parentNode!==n;)o=o.parentNode;for(;i&&i.parentNode!==n;)i=i.parentNode;return[n,o,i]};Je.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=pt(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];if(!i||i===o.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=o.nodeName,l=i.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),o.insertBefore(l,i));do{s=i===r?null:i.nextSibling,l.appendChild(i)}while(i=s);return(s=l.nextSibling)&&ce(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),x||this._docWasChanged(),this.focus()},Je.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=pt(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];i||(i=o.firstChild),r||(r=o.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=o.parentNode,d=r.nextSibling?se(o,r.nextSibling,s,t):o.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=o.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=i===r?null:i.nextSibling,o.removeChild(i),l&&"LI"===i.nodeName&&(i=this.createDefaultBlock([oe(i)])),s.insertBefore(i,d)}while(i=a);return o.firstChild||te(o),d&&ce(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),x||this._docWasChanged(),this.focus()},Je._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&K(t)||e.appendChild(this.createDefaultBlock())},Je.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},Je._getHTML=function(){return this._root.innerHTML},Je._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{re(n,t)}while(n=$(n,t));this._ignoreChange=!0},Je.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),b)for(n=t=this._root;n=$(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),b)for(r=s.length;r--;)te(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},Je.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):((t=this.createElement("DIV")).innerHTML=e,(n=this._doc.createDocumentFragment()).appendChild(oe(t))),He(n),Ke(n,a,!1),ae(n,a);for(var s=n;s=$(s,a);)re(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),re(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,ot.call(this),this._updatePath(d,!0),this},Je.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),q(e))fe(t,e),t.setStartAfter(e);else{for(var n,o=this._root,i=Ce(t,o)||o;i!==o&&!i.nextSibling;)i=i.parentNode;i!==o&&(n=se(i.parentNode,i.nextSibling,o,o)),n?o.insertBefore(e,n):(o.appendChild(e),n=this.createDefaultBlock(),o.appendChild(n)),t.setStart(n,0),t.setEnd(n,0),_e(t)}return this.focus(),this.setSelection(t),this._updatePath(t),x||this._docWasChanged(),this},Je.insertImage=function(e,t){var n=this.createElement("IMG",Ye({src:e},t,!0));return this.insertElement(n),n};var gt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,mt=function(e,t,n){for(var o,i,r,a,s,d,l,c=e.ownerDocument,h=new D(e,4,function(e){return!X(e,t,"A")},!1),u=n._config.tagAttributes.a;o=h.nextNode();)for(i=o.data,r=o.parentNode;a=gt.exec(i);)d=(s=a.index)+a[0].length,s&&(l=c.createTextNode(i.slice(0,s)),r.insertBefore(l,o)),(l=n.createElement("A",Ye({href:a[1]?/^(?:ht|f)tps?:/.test(a[1])?a[1]:"http://"+a[1]:"mailto:"+a[2]},u,!1))).textContent=i.slice(s,d),r.insertBefore(l,o),o.data=i=i.slice(d)};Je.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,h=this.getSelection(),u=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),o=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),(i=this.createElement("DIV")).innerHTML=e,(r=u.createDocumentFragment()).appendChild(oe(i))),this.saveUndoState(h);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},mt(r,r,this),He(r),Ke(r,a,!1),We(r),r.normalize();s=$(s,r);)re(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(me(h,d.fragment,a),x||this._docWasChanged(),h.collapse(!1),this._ensureBottomLine()),this.setSelection(h),this._updatePath(h,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var vt=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};Je.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+vt(l[n])+'"';for(h+=">",o=0,i=a.length;o<i;o+=1)r=a[o],r=vt(r).replace(/ (?= )/g,"&nbsp;"),a[o]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var _t=function(e,t,n){return function(){return this[e](t,n),this.focus()}};Je.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},Je.bold=_t("changeFormat",{tag:"B"}),Je.italic=_t("changeFormat",{tag:"I"}),Je.underline=_t("changeFormat",{tag:"U"}),Je.strikethrough=_t("changeFormat",{tag:"S"}),Je.subscript=_t("changeFormat",{tag:"SUB"},{tag:"SUP"}),Je.superscript=_t("changeFormat",{tag:"SUP"},{tag:"SUB"}),Je.removeBold=_t("changeFormat",null,{tag:"B"}),Je.removeItalic=_t("changeFormat",null,{tag:"I"}),Je.removeUnderline=_t("changeFormat",null,{tag:"U"}),Je.removeStrikethrough=_t("changeFormat",null,{tag:"S"}),Je.removeSubscript=_t("changeFormat",null,{tag:"SUB"}),Je.removeSuperscript=_t("changeFormat",null,{tag:"SUP"}),Je.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;fe(n,this._doc.createTextNode(e.slice(o)))}return t=Ye(Ye({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},Je.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},Je.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:l,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:l}}),this.focus()},Je.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:c,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:c}}),this.focus()},Je.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:d,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:d}}),this.focus()},Je.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:s,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:s}}),this.focus()},Je.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},Je.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},Je.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!K(n);)n=n.parentNode;if(n||(be(e,t),n=t),n.nodeType===o)return this;this.saveUndoState(e),Ne(e,n,n,t);for(var i,r,a=n.ownerDocument,s=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=a.createDocumentFragment(),u=a.createDocumentFragment(),f=se(l,c,n,t),p=se(s,d,n,t);p!==f;)i=p.nextSibling,h.appendChild(p),p=i;return function e(t,n,i){var r,a;for(r=n.firstChild;r;r=a){if(a=r.nextSibling,q(r)){if(r.nodeType===o||"BR"===r.nodeName||"IMG"===r.nodeName){i.appendChild(r);continue}}else if(K(r)){i.appendChild(t.createDefaultBlock([e(t,r,t._doc.createDocumentFragment())]));continue}e(t,r,i)}return i}(this,h,u),u.normalize(),p=u.firstChild,i=u.lastChild,r=n.childNodes,p?(n.insertBefore(u,f),d=B.call(r,p),c=B.call(r,i)+1):c=d=B.call(r,f),e.setStart(n,d),e.setEnd(n,c),de(n,e),_e(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},Je.increaseQuoteLevel=_t("modifyBlocks",function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])}),Je.decreaseQuoteLevel=_t("modifyBlocks",ht),Je.makeUnorderedList=_t("modifyBlocks",function(e){return ft(this,e,"UL"),e}),Je.makeOrderedList=_t("modifyBlocks",function(e){return ft(this,e,"OL"),e}),Je.removeList=_t("modifyBlocks",function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),s=e.querySelectorAll("LI"),d=this._root;for(t=0,n=a.length;t<n;t+=1)ae(i=oe(o=a[t]),d),ne(o,i);for(t=0,n=s.length;t<n;t+=1)K(r=s[t])?ne(r,this.createDefaultBlock([oe(r)])):(ae(r,d),ne(r,oe(r)));return e}),Xe.isInline=q,Xe.isBlock=K,Xe.isContainer=G,Xe.getBlockWalker=Z,Xe.getPreviousBlock=j,Xe.getNextBlock=$,Xe.areAlike=V,Xe.hasTagAttributes=Y,Xe.getNearest=X,Xe.isOrContains=J,Xe.detach=te,Xe.replaceWith=ne,Xe.empty=oe,Xe.getNodeBefore=he,Xe.getNodeAfter=ue,Xe.insertNodeInRange=fe,Xe.extractContentsOfRange=pe,Xe.deleteContentsOfRange=ge,Xe.insertTreeFragmentIntoRange=me,Xe.isNodeContainedInRange=ve,Xe.moveRangeBoundariesDownTree=_e,Xe.moveRangeBoundariesUpTree=Ne,Xe.getStartBlockOfRange=Ce,Xe.getEndBlockOfRange=Se,Xe.contentWalker=Te,Xe.rangeDoesStartAtBlockBoundary=ye,Xe.rangeDoesEndAtBlockBoundary=Ee,Xe.expandRangeToBlockBoundaries=be,Xe.onPaste=Qe,Xe.addLinks=mt,Xe.splitBlock=ct,Xe.startSelectionId=st,Xe.endSelectionId=dt,"object"==typeof exports?module.exports=Xe:"function"==typeof define&&define.amd?define(function(){return Xe}):(u.Squire=Xe,top!==u&&"true"===e.documentElement.getAttribute("data-squireinit")&&(u.editor=new Xe(e),u.onEditorLoad&&(u.onEditorLoad(u.editor),u.onEditorLoad=null)))}(document);
>>>>>>> 9dda7cc... Fix FF does not leave <a> on space
=======
!function(e,t){"use strict";var n=1,o=3,i=9,r=11,a=1,s="highlight",d="colour",l="font",c="size",h="​",u=e.defaultView,f=navigator.userAgent,p=/Android/.test(f),g=/iP(?:ad|hone|od)/.test(f),m=/Mac OS X/.test(f),v=/Windows NT/.test(f),_=/Gecko\//.test(f),N=/Trident\/[456]\./.test(f),C=!!u.opera,S=/Edge\//.test(f),y=!S&&/WebKit\//.test(f),T=/Trident\/[4567]\./.test(f),E=m?"meta-":"ctrl-",b=N||C,k=N||y,L=N,x="undefined"!=typeof MutationObserver,A="undefined"!=typeof WeakMap,O=/[^ \t\r\n]/,B=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var R={1:1,2:2,3:4,8:128,9:256,11:1024};function D(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}D.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(R[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},D.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(R[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},D.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(R[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var U=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,P={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1};var I=0,w=1,F=2,M=3,H=A?new WeakMap:null;function W(e){return e.nodeType===n&&!!P[e.nodeName]}function z(e){switch(e.nodeType){case o:return w;case n:case r:if(A&&H.has(e))return H.get(e);break;default:return I}var t;return t=function(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}(e.childNodes,q)?U.test(e.nodeName)?w:F:M,A&&H.set(e,t),t}function q(e){return z(e)===w}function K(e){return z(e)===F}function G(e){return z(e)===M}function Z(e,t){var n=new D(t,a,K);return n.currentNode=e,n}function j(e,t){return(e=Z(e,t).previousNode())!==t?e:null}function $(e,t){return(e=Z(e,t).nextNode())!==t?e:null}function Q(e){return!e.textContent&&!e.querySelector("IMG")}function V(e,t){return!W(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function Y(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function X(e,t,n,o){for(;e&&e!==t;){if(Y(e,n,o))return e;e=e.parentNode}return null}function J(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function ee(e){var t=e.nodeType;return t===n||t===r?e.childNodes.length:e.length||0}function te(e){var t=e.parentNode;return t&&t.removeChild(e),e}function ne(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function oe(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function ie(e,n,o,i){var r,a,s,d=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)o[r]!==t&&d.setAttribute(r,o[r]);if(i)for(a=0,s=i.length;a<s;a+=1)d.appendChild(i[a]);return d}function re(e,t){var n,i,r=t.__squire__,a=e.ownerDocument,s=e;if(e===t&&((i=e.firstChild)&&"BR"!==i.nodeName||(n=r.createDefaultBlock(),i?e.replaceChild(n,i):e.appendChild(n),e=n,n=null)),e.nodeType===o)return s;if(q(e)){for(i=e.firstChild;k&&i&&i.nodeType===o&&!i.data;)e.removeChild(i),i=e.firstChild;i||(k?(n=a.createTextNode(h),r._didAddZWS()):n=a.createTextNode(""))}else if(b){for(;e.nodeType!==o&&!W(e);){if(!(i=e.firstChild)){n=a.createTextNode("");break}e=i}e.nodeType===o?/^ +$/.test(e.data)&&(e.data=""):W(e)&&e.parentNode.insertBefore(a.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=ie(a,"BR");(i=e.lastElementChild)&&!q(i);)e=i;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return s}function ae(e,t){var n,o,i,r,a=e.childNodes,s=e.ownerDocument,d=null,l=t.__squire__._config;for(n=0,o=a.length;n<o;n+=1)!(r="BR"===(i=a[n]).nodeName)&&q(i)?(d||(d=ie(s,l.blockTag,l.blockAttributes)),d.appendChild(i),n-=1,o-=1):(r||d)&&(d||(d=ie(s,l.blockTag,l.blockAttributes)),re(d,t),r?e.replaceChild(d,i):(e.insertBefore(d,i),n+=1,o+=1),d=null),G(i)&&ae(i,t);return d&&e.appendChild(re(d,t)),e}function se(e,t,i,r){var a,s,d,l=e.nodeType;if(l===o&&e!==i)return se(e.parentNode,e.splitText(t),i,r);if(l===n){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===i)return t;for(a=e.parentNode,s=e.cloneNode(!1);t;)d=t.nextSibling,s.appendChild(t),t=d;return"OL"===e.nodeName&&X(e,r,"BLOCKQUOTE")&&(s.start=(+e.start||1)+e.childNodes.length-1),re(e,r),re(s,r),(d=e.nextSibling)?a.insertBefore(s,d):a.appendChild(s),se(a,s,i,r)}return t}function de(e,t){if(e.nodeType===o&&(e=e.parentNode),e.nodeType===n){var i={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};!function e(t,i){for(var r,a,s,d=t.childNodes,l=d.length,c=[];l--;)if(r=d[l],a=l&&d[l-1],l&&q(r)&&V(r,a)&&!P[r.nodeName])i.startContainer===r&&(i.startContainer=a,i.startOffset+=ee(a)),i.endContainer===r&&(i.endContainer=a,i.endOffset+=ee(a)),i.startContainer===t&&(i.startOffset>l?i.startOffset-=1:i.startOffset===l&&(i.startContainer=a,i.startOffset=ee(a))),i.endContainer===t&&(i.endOffset>l?i.endOffset-=1:i.endOffset===l&&(i.endContainer=a,i.endOffset=ee(a))),te(r),r.nodeType===o?a.appendData(r.data):c.push(oe(r));else if(r.nodeType===n){for(s=c.length;s--;)r.appendChild(c.pop());e(r,i)}}(e,i),t.setStart(i.startContainer,i.startOffset),t.setEnd(i.endContainer,i.endOffset)}}function le(e,t,o,i){for(var r,a,s,d=t;(r=d.parentNode)&&r!==i&&r.nodeType===n&&1===r.childNodes.length;)d=r;te(d),s=e.childNodes.length,(a=e.lastChild)&&"BR"===a.nodeName&&(e.removeChild(a),s-=1),e.appendChild(oe(t)),o.setStart(e,s),o.collapse(!0),de(e,o),C&&(a=e.lastChild)&&"BR"===a.nodeName&&e.removeChild(a)}function ce(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&V(i,e)){if(!G(i)){if(!s)return;(o=ie(a,"DIV")).appendChild(oe(i)),i.appendChild(o)}te(e),n=!G(e),i.appendChild(oe(e)),n&&ae(i,t),r&&ce(r,t)}else s&&(i=ie(a,"DIV"),e.insertBefore(i,r),re(i,t))}var he=function(e,t){for(var o=e.childNodes;t&&e.nodeType===n;)t=(o=(e=o[t-1]).childNodes).length;return e},ue=function(e,t){if(e.nodeType===n){var o=e.childNodes;if(t<o.length)e=o[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},fe=function(e,t){var n,i,r,a,s=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset;s.nodeType===o?(i=(n=s.parentNode).childNodes,d===s.length?(d=B.call(i,s)+1,e.collapsed&&(l=n,c=d)):(d&&(a=s.splitText(d),l===s?(c-=d,l=a):l===n&&(c+=1),s=a),d=B.call(i,s)),s=n):i=s.childNodes,d===(r=i.length)?s.appendChild(t):s.insertBefore(t,i[d]),s===l&&(c+=i.length-r),e.setStart(s,d),e.setEnd(l,c)},pe=function(e,t,n){var i=e.startContainer,r=e.startOffset,a=e.endContainer,s=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===o&&(t=t.parentNode);for(var d,l,c,h=se(a,s,t,n),u=se(i,r,t,n),f=t.ownerDocument.createDocumentFragment();u!==h;)d=u.nextSibling,f.appendChild(u),u=d;return i=t,r=h?B.call(t.childNodes,h):t.childNodes.length,(l=(c=t.childNodes[r])&&c.previousSibling)&&l.nodeType===o&&c.nodeType===o&&(i=l,r=l.length,l.appendData(c.data),te(c)),e.setStart(i,r),e.collapse(!0),re(t,n),f},ge=function(e,t){var n,o,i=Ce(e,t),r=Se(e,t),a=i!==r;return _e(e),Ne(e,i,r,t),n=pe(e,null,t),_e(e),a&&(r=Se(e,t),i&&r&&i!==r&&le(i,r,e,t)),i&&re(i,t),(o=t.firstChild)&&"BR"!==o.nodeName?e.collapse(!0):(re(t,t),e.selectNodeContents(t.firstChild)),n},me=function(e,t,n){var o,i,r,a,s,d,l,c,h,u,f;for(ae(t,n),o=t;o=$(o,n);)re(o,n);if(e.collapsed||ge(e,n),_e(e),e.collapse(!1),a=X(e.endContainer,n,"BLOCKQUOTE")||n,i=Ce(e,n),c=$(t,t),l=!!i&&Q(i),i&&c&&!l&&!X(c,t,"PRE")&&!X(c,t,"TABLE")){if(Ne(e,i,i,n),e.collapse(!0),s=e.endContainer,d=e.endOffset,Ke(i,n,!1),q(s)&&(s=(h=se(s,d,j(s,n),n)).parentNode,d=B.call(s.childNodes,h)),d!==ee(s))for(r=n.ownerDocument.createDocumentFragment();o=s.childNodes[d];)r.appendChild(o);le(s,c,e,n),d=B.call(s.parentNode.childNodes,s)+1,s=s.parentNode,e.setEnd(s,d)}ee(t)&&(l&&(e.setEndBefore(i),e.collapse(!1),te(i)),Ne(e,a,a,n),u=(h=se(e.endContainer,e.endOffset,a,n))?h.previousSibling:a.lastChild,a.insertBefore(t,h),h?e.setEndBefore(h):e.setEnd(a,ee(a)),i=Se(e,n),_e(e),s=e.endContainer,d=e.endOffset,h&&G(h)&&ce(h,n),(h=u&&u.nextSibling)&&G(h)&&ce(h,n),e.setEnd(s,d)),r&&(le(i,r,f=e.cloneRange(),n),e.setEnd(f.endContainer,f.endOffset)),_e(e)},ve=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(3,o)>-1,r=e.compareBoundaryPoints(1,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(0,o)<1,s=e.compareBoundaryPoints(2,o)>-1;return a&&s},_e=function(e){for(var t,n=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==o&&(t=n.childNodes[i])&&!W(t);)n=t,i=0;if(a)for(;r.nodeType!==o;){if(!(t=r.childNodes[a-1])||W(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}a=ee(r=t)}else for(;r.nodeType!==o&&(t=r.firstChild)&&!W(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,i)):(e.setStart(n,i),e.setEnd(r,a))},Ne=function(e,t,n,i){var r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset,c=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!s&&a!==t&&a!==i;)r=a.parentNode,s=B.call(r.childNodes,a),a=r;for(;c&&d.nodeType!==o&&d.childNodes[l]&&"BR"===d.childNodes[l].nodeName&&(l+=1,c=!1),d!==n&&d!==i&&l===ee(d);)r=d.parentNode,l=B.call(r.childNodes,d)+1,d=r;e.setStart(a,s),e.setEnd(d,l)},Ce=function(e,t){var n,o=e.startContainer;return(n=q(o)?j(o,t):o!==t&&K(o)?o:$(n=he(o,e.startOffset),t))&&ve(e,n,!0)?n:null},Se=function(e,t){var n,o,i=e.endContainer;if(q(i))n=j(i,t);else if(i!==t&&K(i))n=i;else{if(!(n=ue(i,e.endOffset))||!J(t,n))for(n=t;o=n.lastChild;)n=o;n=j(n,t)}return n&&ve(e,n,!0)?n:null},ye=new D(null,4|a,function(e){return e.nodeType===o?O.test(e.data):"IMG"===e.nodeName}),Te=function(e,t){var n,i=e.startContainer,r=e.startOffset;if(ye.root=null,i.nodeType===o){if(r)return!1;n=i}else if((n=ue(i,r))&&!J(t,n)&&(n=null),!n&&(n=he(i,r)).nodeType===o&&n.length)return!1;return ye.currentNode=n,ye.root=Ce(e,t),!ye.previousNode()},Ee=function(e,t){var n,i=e.endContainer,r=e.endOffset;if(ye.root=null,i.nodeType===o){if((n=i.data.length)&&r<n)return!1;ye.currentNode=i}else ye.currentNode=he(i,r);return ye.root=Se(e,t),!ye.nextNode()},be=function(e,t){var n,o=Ce(e,t),i=Se(e,t);o&&i&&(n=o.parentNode,e.setStart(n,B.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,B.call(n.childNodes,i)+1))},ke={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},Le=function(e){var t=e.keyCode,n=ke[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),C&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):i.collapsed||1!==(e.key||n).length||(this.saveUndoState(i),ge(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},xe=function(e){return function(t,n){n.preventDefault(),t[e]()}},Ae=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},Oe=function(e,t){try{t||(t=e.getSelection());var n,i=t.startContainer;for(i.nodeType===o&&(i=i.parentNode),n=i;q(n)&&(!n.textContent||n.textContent===h);)n=(i=n).parentNode;i!==n&&(t.setStart(n,B.call(n.childNodes,i)),t.collapse(!0),n.removeChild(i),K(n)||(n=j(n,e._root)),re(n,e._root),_e(t)),i===e._root&&(i=i.firstChild)&&"BR"===i.nodeName&&te(i),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},Be={enter:function(e,t,i){var r,a,s,d=e._root;if(t.preventDefault(),e._recordUndoState(i),mt(i.startContainer,d,e),e._removeZWS(),e._getRangeAndRemoveBookmark(i),i.collapsed||ge(i,d),!(r=Ce(i,d))||/^T[HD]$/.test(r.nodeName))return(a=X(i.endContainer,d,"A"))&&(a=a.parentNode,Ne(i,a,a,d),i.collapse(!1)),fe(i,e.createElement("BR")),i.collapse(!1),e.setSelection(i),void e._updatePath(i,!0);if((a=X(r,d,"LI"))&&(r=a),Q(r)){if(X(r,d,"UL")||X(r,d,"OL"))return e.decreaseListLevel(i);if(X(r,d,"BLOCKQUOTE"))return e.modifyBlocks(ut,i)}for(s=ct(e,r,i.startContainer,i.startOffset),at(r),We(r),re(r,d);s.nodeType===n;){var l,c=s.firstChild;if("A"===s.nodeName&&(!s.textContent||s.textContent===h)){ne(s,c=e._doc.createTextNode("")),s=c;break}for(;c&&c.nodeType===o&&!c.data&&(l=c.nextSibling)&&"BR"!==l.nodeName;)te(c),c=l;if(!c||"BR"===c.nodeName||c.nodeType===o&&!C)break;s=c}i=e._createRange(s,0),e.setSelection(i),e._updatePath(i,!0)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Te(n,o)){t.preventDefault();var i,r=Ce(n,o);if(!r)return;if(ae(r.parentNode,o),i=j(r,o)){if(!i.isContentEditable)return void te(i);for(le(i,r,n,o),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&ce(r,o),e.setSelection(n)}else if(r){if(X(r,o,"UL")||X(r,o,"OL"))return e.decreaseListLevel(n);if(X(r,o,"BLOCKQUOTE"))return e.modifyBlocks(ht,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Oe(e)},0);else t.preventDefault(),ge(n,o),Oe(e,n)},delete:function(e,t,o){var i,r,a,s,d,l,c=e._root;if(e._removeZWS(),e.saveUndoState(o),o.collapsed)if(Ee(o,c)){if(t.preventDefault(),!(i=Ce(o,c)))return;if(ae(i.parentNode,c),r=$(i,c)){if(!r.isContentEditable)return void te(r);for(le(i,r,o,c),r=i.parentNode;r!==c&&!r.nextSibling;)r=r.parentNode;r!==c&&(r=r.nextSibling)&&ce(r,c),e.setSelection(o),e._updatePath(o,!0)}}else{if(a=o.cloneRange(),Ne(o,c,c,c),s=o.endContainer,d=o.endOffset,s.nodeType===n&&(l=s.childNodes[d])&&"IMG"===l.nodeName)return t.preventDefault(),te(l),_e(o),void Oe(e,o);e.setSelection(a),setTimeout(function(){Oe(e)},0)}else t.preventDefault(),ge(o,c),Oe(e,o)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&Te(n,r))for(o=Ce(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.increaseListLevel(n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&Te(n,i)&&(X(o=n.startContainer,i,"UL")||X(o,i,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n))},space:function(e,t,n){var o,i;e._recordUndoState(n),mt(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),i=(o=n.endContainer).parentNode,n.collapsed&&n.endOffset===ee(o)&&("A"===o.nodeName?n.setStartAfter(o):"A"!==i.nodeName||o.nextSibling||n.setStartAfter(i)),n.collapsed||(ge(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};m&&_&&(Be["meta-left"]=function(e,t){t.preventDefault();var n=nt(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Be["meta-right"]=function(e,t){t.preventDefault();var n=nt(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),m||(Be.pageup=function(e){e.moveCursorToStart()},Be.pagedown=function(e){e.moveCursorToEnd()}),Be[E+"b"]=Ae("B"),Be[E+"i"]=Ae("I"),Be[E+"u"]=Ae("U"),Be[E+"shift-7"]=Ae("S"),Be[E+"shift-5"]=Ae("SUB",{tag:"SUP"}),Be[E+"shift-6"]=Ae("SUP",{tag:"SUB"}),Be[E+"shift-8"]=xe("makeUnorderedList"),Be[E+"shift-9"]=xe("makeOrderedList"),Be[E+"["]=xe("decreaseQuoteLevel"),Be[E+"]"]=xe("increaseQuoteLevel"),Be[E+"y"]=xe("redo"),Be[E+"z"]=xe("undo"),Be[E+"shift-z"]=xe("redo");var Re={1:10,2:13,3:16,4:18,5:24,6:32,7:48},De={backgroundColor:{regexp:O,replace:function(e,t){return ie(e,"SPAN",{class:s,style:"background-color:"+t})}},color:{regexp:O,replace:function(e,t){return ie(e,"SPAN",{class:d,style:"color:"+t})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return ie(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return ie(e,"I")}},fontFamily:{regexp:O,replace:function(e,t){return ie(e,"SPAN",{class:l,style:"font-family:"+t})}},fontSize:{regexp:O,replace:function(e,t){return ie(e,"SPAN",{class:c,style:"font-size:"+t})}},textDecoration:{regexp:/^underline/i,replace:function(e){return ie(e,"U")}}},Ue=function(e){return function(t,n){var o=ie(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(oe(t)),o}},Pe=function(e,t){var n,o,i,r,a,s,d=e.style,l=e.ownerDocument;for(n in De)o=De[n],(i=d[n])&&o.regexp.test(i)&&(s=o.replace(l,i),a||(a=s),r&&r.appendChild(s),r=s,e.style[n]="");return a&&(r.appendChild(oe(e)),"SPAN"===e.nodeName?t.replaceChild(a,e):e.appendChild(a)),r||e},Ie={P:Pe,SPAN:Pe,STRONG:Ue("B"),EM:Ue("I"),INS:Ue("U"),STRIKE:Ue("S"),FONT:function(e,t){var n,o,i,r,a,s=e.face,h=e.size,u=e.color,f=e.ownerDocument;return s&&(a=n=ie(f,"SPAN",{class:l,style:"font-family:"+s}),r=n),h&&(o=ie(f,"SPAN",{class:c,style:"font-size:"+Re[h]+"px"}),a||(a=o),r&&r.appendChild(o),r=o),u&&/^#?([\dA-F]{3}){1,2}$/i.test(u)&&("#"!==u.charAt(0)&&(u="#"+u),i=ie(f,"SPAN",{class:d,style:"color:"+u}),a||(a=i),r&&r.appendChild(i),r=i),a||(a=r=ie(f,"SPAN")),t.replaceChild(a,e),r.appendChild(oe(e)),r},TT:function(e,t){var n=ie(e.ownerDocument,"SPAN",{class:l,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(n,e),n.appendChild(oe(e)),n}},we=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Fe=/^(?:HEAD|META|STYLE)/,Me=new D(null,4|a,function(){return!0}),He=function e(t,i){var r,a,s,d,l,c,h,u,f,p,g,m,v=t.childNodes;for(r=t;q(r);)r=r.parentNode;for(Me.root=r,a=0,s=v.length;a<s;a+=1)if(l=(d=v[a]).nodeName,c=d.nodeType,h=Ie[l],c===n){if(u=d.childNodes.length,h)d=h(d,t);else{if(Fe.test(l)){t.removeChild(d),a-=1,s-=1;continue}if(!we.test(l)&&!q(d)){a-=1,s+=u-1,t.replaceChild(oe(d),d);continue}}u&&e(d,i||"PRE"===l)}else{if(c===o){if(g=d.data,f=!O.test(g.charAt(0)),p=!O.test(g.charAt(g.length-1)),i||!f&&!p)continue;if(f){for(Me.currentNode=d;(m=Me.previousPONode())&&!("IMG"===(l=m.nodeName)||"#text"===l&&O.test(m.data));)if(!q(m)){m=null;break}g=g.replace(/^[ \t\r\n]+/g,m?" ":"")}if(p){for(Me.currentNode=d;(m=Me.nextNode())&&!("IMG"===l||"#text"===l&&O.test(m.data));)if(!q(m)){m=null;break}g=g.replace(/[ \t\r\n]+$/g,m?" ":"")}if(g){d.data=g;continue}}t.removeChild(d),a-=1,s-=1}return t},We=function e(t){for(var i,r=t.childNodes,a=r.length;a--;)(i=r[a]).nodeType!==n||W(i)?i.nodeType!==o||i.data||t.removeChild(i):(e(i),q(i)&&!i.firstChild&&t.removeChild(i))},ze=function(e){return e.nodeType===n?"BR"===e.nodeName:O.test(e.data)},qe=function(e,t){for(var n,o=e.parentNode;q(o);)o=o.parentNode;return(n=new D(o,4|a,ze)).currentNode=e,!!n.nextNode()||t&&!n.previousNode()},Ke=function(e,t,n){var o,i,r,a=e.querySelectorAll("BR"),s=[],d=a.length;for(o=0;o<d;o+=1)s[o]=qe(a[o],n);for(;d--;)(r=(i=a[d]).parentNode)&&(s[d]?q(r)||ae(r,t):te(i))},Ge=function(e,t,n){var o,i,r=t.ownerDocument.body;Ke(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),o=t.innerHTML,i=t.innerText||t.textContent,v&&(i=i.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",i),r.removeChild(t)},Ze=function(e){var t,n,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)e.preventDefault();else{if(this.saveUndoState(l),S||g||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(n=(t=Ce(l,c))===Se(l,c)&&t||c,i=ge(l,c),(r=l.commonAncestorContainer).nodeType===o&&(r=r.parentNode);r&&r!==n;)(a=r.cloneNode(!1)).appendChild(i),i=a,r=r.parentNode;(s=this.createElement("div")).appendChild(i),Ge(d,s,c),e.preventDefault()}this.setSelection(l)}},je=function(e){var t,n,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!S&&!g&&d){for(n=(t=Ce(l,c))===Se(l,c)&&t||c,l=l.cloneRange(),_e(l),Ne(l,n,n,c),i=l.cloneContents(),(r=l.commonAncestorContainer).nodeType===o&&(r=r.parentNode);r&&r!==n;)(a=r.cloneNode(!1)).appendChild(i),i=a,r=r.parentNode;(s=this.createElement("div")).appendChild(i),Ge(d,s,c),e.preventDefault()}};function $e(e){this.isShiftDown=e.shiftKey}var Qe=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(S&&s){for(t=s.length;t--;)!d&&/^image\/.*/.test(s[t].type)&&(c=!0);c||(s=null)}if(s){for(e.preventDefault(),t=s.length;t--;){if(o=(n=s[t]).type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)})}else{if(i=a&&a.types,!S&&i&&(B.call(i,"text/html")>-1||!_&&B.call(i,"text/plain")>-1&&B.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,N=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=C;C=o;)o=C.nextSibling,te(C),(e=C.firstChild)&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u._createRange(g,m,v,N),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)}},Ve=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()};function Ye(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?Ye(e[o],i,n):i);return e}function Xe(e,t){e.nodeType===i&&(e=e.body);var n,o=e.ownerDocument,r=o.defaultView;this._win=r,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,L&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,x?((n=new MutationObserver(this._docWasChanged.bind(this))).observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",ot),this.addEventListener("mousedown",it),this.addEventListener("touchstart",it),this.addEventListener("focus",rt),this._awaitingPaste=!1,this.addEventListener(N?"beforecut":"cut",Ze),this.addEventListener("copy",je),this.addEventListener("keydown",$e),this.addEventListener("keyup",$e),this.addEventListener(N?"beforepaste":"paste",Qe),this.addEventListener("drop",Ve),this.addEventListener(C?"keypress":"keydown",Le),this._keyHandlers=Object.create(Be),this.setConfig(t),N&&(r.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}var Je=Xe.prototype,et=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};Je.setConfig=function(e){return(e=Ye({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},leafNodeNames:P,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?et:null},e,!0)).blockTag=e.blockTag.toUpperCase(),this._config=e,this},Je.createElement=function(e,t,n){return ie(this._doc,e,t,n)},Je.createDefaultBlock=function(e){var t=this._config;return re(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},Je.didError=function(e){console.log(e)},Je.getDocument=function(){return this._doc},Je.getRoot=function(){return this._root},Je.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var tt={pathChange:1,select:1,input:1,undoStateChange:1};Je.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),o=(r=r.slice()).length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},Je.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},Je.handleEvent=function(e){this.fireEvent(e.type,e)},Je.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],tt[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},Je.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],tt[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},Je._createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},Je.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,(t=this._doc.createElement("SPAN")).textContent=h,fe(e,t),o=t.getBoundingClientRect(),(n=t.parentNode).removeChild(t),de(n,e)),o},Je._moveCursorTo=function(e){var t=this._root,n=this._createRange(t,e?0:t.childNodes.length);return _e(n),this.setSelection(n),this},Je.moveCursorToStart=function(){return this._moveCursorTo(!0)},Je.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var nt=function(e){return e._win.getSelection()||null};function ot(){this._restoreSelection=!0}function it(){this._restoreSelection=!1}function rt(){this._restoreSelection&&this.setSelection(this._lastSelection)}Je.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(p&&!this._restoreSelection)ot.call(this),this.blur(),this.focus();else{g&&this._win.focus();var t=nt(this);t&&(t.removeAllRanges(),t.addRange(e))}else ot.call(this);return this},Je.getSelection=function(){var e,t,n,o,i=nt(this),r=this._root;return this._isFocused&&i&&i.rangeCount&&(t=(e=i.getRangeAt(0).cloneRange()).startContainer,n=e.endContainer,t&&W(t)&&e.setStartBefore(t),n&&W(n)&&e.setEndBefore(n)),e&&J(r,e.commonAncestorContainer)?this._lastSelection=e:J((o=(e=this._lastSelection).commonAncestorContainer).ownerDocument,o)||(e=null),e||(e=this._createRange(r.firstChild,0)),e},Je.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,n=new D(e.commonAncestorContainer,4|a,function(t){return ve(e,t,!0)}),i=e.startContainer,r=e.endContainer,s=n.currentNode=i,d="",l=!1;for(n.filter(s)||(s=n.nextNode());s;)s.nodeType===o?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===i&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!q(s))&&(d+="\n",l=!1),s=n.nextNode();return d},Je.getPath=function(){return this._path};var at=function(e,t){for(var n,o,i,r=new D(e,4,function(){return!0},!1);o=r.nextNode();)for(;(i=o.data.indexOf(h))>-1&&(!t||o.parentNode!==t);){if(1===o.length){do{(n=o.parentNode).removeChild(o),o=n,r.currentNode=n}while(q(o)&&!ee(o));break}o.deleteData(i,1)}};Je._didAddZWS=function(){this._hasZWS=!0},Je._removeZWS=function(){this._hasZWS&&(at(this._root),this._hasZWS=!1)},Je._updatePath=function(e,t){if(e){var o,i=e.startContainer,r=e.endContainer;(t||i!==this._lastAnchorNode||r!==this._lastFocusNode)&&(this._lastAnchorNode=i,this._lastFocusNode=r,o=i&&r?i===r?function e(t,o){var i,r,a,h,u="";return t&&t!==o&&(u=e(t.parentNode,o),t.nodeType===n&&(u+=(u?">":"")+t.nodeName,(i=t.id)&&(u+="#"+i),(r=t.className.trim())&&((a=r.split(/\s\s*/)).sort(),u+=".",u+=a.join(".")),(h=t.dir)&&(u+="[dir="+h+"]"),a&&(B.call(a,s)>-1&&(u+="[backgroundColor="+t.style.backgroundColor.replace(/ /g,"")+"]"),B.call(a,d)>-1&&(u+="[color="+t.style.color.replace(/ /g,"")+"]"),B.call(a,l)>-1&&(u+="[fontFamily="+t.style.fontFamily.replace(/ /g,"")+"]"),B.call(a,c)>-1&&(u+="[fontSize="+t.style.fontSize+"]")))),u}(r,this._root):"(selection)":"",this._path!==o&&(this._path=o,this.fireEvent("pathChange",{path:o}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},Je._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},Je.focus=function(){return this._root.focus(),T&&this.fireEvent("focus"),this},Je.blur=function(){return this._root.blur(),T&&this.fireEvent("blur"),this};var st="squire-selection-start",dt="squire-selection-end";Je._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:st,type:"hidden"}),o=this.createElement("INPUT",{id:dt,type:"hidden"});fe(e,n),e.collapse(!1),fe(e,o),2&n.compareDocumentPosition(o)&&(n.id=dt,o.id=st,t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},Je._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#"+st),i=t.querySelector("#"+dt);if(n&&i){var r=n.parentNode,a=i.parentNode,s=B.call(r.childNodes,n),d=B.call(a.childNodes,i);r===a&&(d-=1),te(n),te(i),e||(e=this._doc.createRange()),e.setStart(r,s),e.setEnd(a,d),de(r,e),r!==a&&de(a,e),e.collapsed&&(r=e.startContainer).nodeType===o&&((a=r.childNodes[e.startOffset])&&a.nodeType===o||(a=r.childNodes[e.startOffset-1]),a&&a.nodeType===o&&(e.setStart(a,0),e.collapse(!0)))}return e||null},Je._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},Je._docWasChanged=function(){A&&(H=new WeakMap),this._ignoreAllChanges||(x&&this._ignoreChange?this._ignoreChange=!1:(this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")))},Je._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,o=this._undoIndex,i=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(o+=1),o<this._undoStackLength&&(i.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&o>s&&(i.splice(0,o-s),o=s,this._undoStackLength=s),i[o]=n,this._undoIndex=o,this._undoStackLength+=1,this._isInUndoState=!0}},Je.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},Je.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},Je.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},Je.hasFormat=function(e,t,n){if(e=e.toUpperCase(),t||(t={}),!n&&!(n=this.getSelection()))return!1;!n.collapsed&&n.startContainer.nodeType===o&&n.startOffset===n.startContainer.length&&n.startContainer.nextSibling&&n.setStartBefore(n.startContainer.nextSibling),!n.collapsed&&n.endContainer.nodeType===o&&0===n.endOffset&&n.endContainer.previousSibling&&n.setEndAfter(n.endContainer.previousSibling);var i,r,a=this._root,s=n.commonAncestorContainer;if(X(s,a,e,t))return!0;if(s.nodeType===o)return!1;i=new D(s,4,function(e){return ve(n,e,!0)},!1);for(var d=!1;r=i.nextNode();){if(!X(r,a,e,t))return!1;d=!0}return d},Je.getFontInfo=function(e){var n,i,r,a={color:t,backgroundColor:t,family:t,size:t},s=0;if(!e&&!(e=this.getSelection()))return a;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===o)for(n.nodeType===o&&(n=n.parentNode);s<4&&n;)(i=n.style)&&(!a.color&&(r=i.color)&&(a.color=r,s+=1),!a.backgroundColor&&(r=i.backgroundColor)&&(a.backgroundColor=r,s+=1),!a.family&&(r=i.fontFamily)&&(a.family=r,s+=1),!a.size&&(r=i.fontSize)&&(a.size=r,s+=1)),n=n.parentNode;return a},Je._addFormat=function(e,t,n){var i,r,s,d,l,c,h,u,f=this._root;if(n.collapsed){for(i=re(this.createElement(e,t),f),fe(n,i),n.setStart(i.firstChild,i.firstChild.length),n.collapse(!0),u=i;q(u);)u=u.parentNode;at(u,i)}else{if(r=new D(n.commonAncestorContainer,4|a,function(e){return(e.nodeType===o||"BR"===e.nodeName||"IMG"===e.nodeName)&&ve(n,e,!0)},!1),s=n.startContainer,l=n.startOffset,d=n.endContainer,c=n.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return n;do{!X(h=r.currentNode,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),ne(h,i=this.createElement(e,t)),i.appendChild(h))}while(r.nextNode());d.nodeType!==o&&(h.nodeType===o?(d=h,c=h.length):(d=h.parentNode,c=1)),n=this._createRange(s,l,d,c)}return n},Je._removeFormat=function(e,t,n,i){this._saveRangeToBookmark(n);var r,a=this._doc;n.collapsed&&(k?(r=a.createTextNode(h),this._didAddZWS()):r=a.createTextNode(""),fe(n,r));for(var s=n.commonAncestorContainer;q(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,u=n.endOffset,f=[],p=function(e,t){if(!ve(n,e,!1)){var i,r,a=e.nodeType===o;if(ve(n,e,!0))if(a)e===c&&u!==e.length&&f.push([t,e.splitText(u)]),e===d&&l&&(e.splitText(l),f.push([t,e]));else for(i=e.firstChild;i;i=r)r=i.nextSibling,p(i,t);else"INPUT"===e.nodeName||a&&!e.data||f.push([t,e])}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return ve(n,o,!0)&&Y(o,e,t)});return i||g.forEach(function(e){p(e,e)}),f.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];ne(n,t),t.appendChild(n)}),g.forEach(function(e){ne(e,oe(e))}),this._getRangeAndRemoveBookmark(n),r&&n.collapse(!1),de(s,n),n},Je.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),x||this._docWasChanged(),this):this};var lt={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},ct=function(e,t,n,o){var i=lt[t.nodeName],r=null,a=se(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),Y(a,i,r)||(t=ie(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),ne(a,t),t.appendChild(oe(a)),a=t),a};Je.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=Ce(n,o),r=Se(n,o);if(i&&r)do{if(e(i)||i===r)break}while(i=$(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),x||this._docWasChanged()),this},Je.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,o=this._root;return be(t,o),Ne(t,o,o,o),n=pe(t,o,o),fe(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&ce(t.endContainer.childNodes[t.endOffset],o),ce(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),x||this._docWasChanged(),this};var ht=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!X(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){ne(e,oe(e))}),e},ut=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:st,type:"hidden"}),this.createElement("INPUT",{id:dt,type:"hidden"})])},ft=function(e,t,n){for(var o,i,r,a,s=Z(t,e._root),d=e._config.tagAttributes,l=d[n.toLowerCase()],c=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",c),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),te(o)):ne(o,e.createElement(n,l,[a])),a.appendChild(oe(o)),s.currentNode=a):(i=(o=o.parentNode).nodeName)!==n&&/^[OU]L$/.test(i)&&ne(o,e.createElement(n,l,[oe(o)]))},pt=function(e,t){for(var n=e.commonAncestorContainer,o=e.startContainer,i=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(o===n&&(o=o.childNodes[e.startOffset]),i===n&&(i=i.childNodes[e.endOffset]);o&&o.parentNode!==n;)o=o.parentNode;for(;i&&i.parentNode!==n;)i=i.parentNode;return[n,o,i]};Je.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=pt(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];if(!i||i===o.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=o.nodeName,l=i.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),o.insertBefore(l,i));do{s=i===r?null:i.nextSibling,l.appendChild(i)}while(i=s);return(s=l.nextSibling)&&ce(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),x||this._docWasChanged(),this.focus()},Je.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=pt(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];i||(i=o.firstChild),r||(r=o.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=o.parentNode,d=r.nextSibling?se(o,r.nextSibling,s,t):o.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=o.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=i===r?null:i.nextSibling,o.removeChild(i),l&&"LI"===i.nodeName&&(i=this.createDefaultBlock([oe(i)])),s.insertBefore(i,d)}while(i=a);return o.firstChild||te(o),d&&ce(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),x||this._docWasChanged(),this.focus()},Je._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&K(t)||e.appendChild(this.createDefaultBlock())},Je.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},Je._getHTML=function(){return this._root.innerHTML},Je._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{re(n,t)}while(n=$(n,t));this._ignoreChange=!0},Je.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),b)for(n=t=this._root;n=$(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),b)for(r=s.length;r--;)te(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},Je.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):((t=this.createElement("DIV")).innerHTML=e,(n=this._doc.createDocumentFragment()).appendChild(oe(t))),He(n),Ke(n,a,!1),ae(n,a);for(var s=n;s=$(s,a);)re(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),re(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this._createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,ot.call(this),this._updatePath(d,!0),this},Je.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),q(e))fe(t,e),t.setStartAfter(e);else{for(var n,o=this._root,i=Ce(t,o)||o;i!==o&&!i.nextSibling;)i=i.parentNode;i!==o&&(n=se(i.parentNode,i.nextSibling,o,o)),n?o.insertBefore(e,n):(o.appendChild(e),n=this.createDefaultBlock(),o.appendChild(n)),t.setStart(n,0),t.setEnd(n,0),_e(t)}return this.focus(),this.setSelection(t),this._updatePath(t),x||this._docWasChanged(),this},Je.insertImage=function(e,t){var n=this.createElement("IMG",Ye({src:e},t,!0));return this.insertElement(n),n};var gt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)/i,mt=function(e,t,n){for(var o,i,r,a,s,d,l,c=e.ownerDocument,h=new D(e,4,function(e){return!X(e,t,"A")},!1),u=n._config.tagAttributes.a;o=h.nextNode();)for(i=o.data,r=o.parentNode;a=gt.exec(i);)d=(s=a.index)+a[0].length,s&&(l=c.createTextNode(i.slice(0,s)),r.insertBefore(l,o)),(l=n.createElement("A",Ye({href:a[1]?/^(?:ht|f)tps?:/.test(a[1])?a[1]:"http://"+a[1]:"mailto:"+a[2]},u,!1))).textContent=i.slice(s,d),r.insertBefore(l,o),o.data=i=i.slice(d)};Je.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,h=this.getSelection(),u=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),o=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),(i=this.createElement("DIV")).innerHTML=e,(r=u.createDocumentFragment()).appendChild(oe(i))),this.saveUndoState(h);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},mt(r,r,this),He(r),Ke(r,a,!1),We(r),r.normalize();s=$(s,r);)re(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(me(h,d.fragment,a),x||this._docWasChanged(),h.collapse(!1),this._ensureBottomLine()),this.setSelection(h),this._updatePath(h,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var vt=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};Je.insertPlainText=function(e,t){var n,o,i,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+vt(l[n])+'"';for(h+=">",o=0,i=a.length;o<i;o+=1)r=a[o],r=vt(r).replace(/ (?= )/g,"&nbsp;"),a[o]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var _t=function(e,t,n){return function(){return this[e](t,n),this.focus()}};Je.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},Je.bold=_t("changeFormat",{tag:"B"}),Je.italic=_t("changeFormat",{tag:"I"}),Je.underline=_t("changeFormat",{tag:"U"}),Je.strikethrough=_t("changeFormat",{tag:"S"}),Je.subscript=_t("changeFormat",{tag:"SUB"},{tag:"SUP"}),Je.superscript=_t("changeFormat",{tag:"SUP"},{tag:"SUB"}),Je.removeBold=_t("changeFormat",null,{tag:"B"}),Je.removeItalic=_t("changeFormat",null,{tag:"I"}),Je.removeUnderline=_t("changeFormat",null,{tag:"U"}),Je.removeStrikethrough=_t("changeFormat",null,{tag:"S"}),Je.removeSubscript=_t("changeFormat",null,{tag:"SUB"}),Je.removeSuperscript=_t("changeFormat",null,{tag:"SUP"}),Je.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;fe(n,this._doc.createTextNode(e.slice(o)))}return t=Ye(Ye({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},Je.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},Je.setFontFace=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:l,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:l}}),this.focus()},Je.setFontSize=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:c,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:c}}),this.focus()},Je.setTextColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:d,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:d}}),this.focus()},Je.setHighlightColour=function(e){return this.changeFormat(e?{tag:"SPAN",attributes:{class:s,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:s}}),this.focus()},Je.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},Je.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},Je.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!K(n);)n=n.parentNode;if(n||(be(e,t),n=t),n.nodeType===o)return this;this.saveUndoState(e),Ne(e,n,n,t);for(var i,r,a=n.ownerDocument,s=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=a.createDocumentFragment(),u=a.createDocumentFragment(),f=se(l,c,n,t),p=se(s,d,n,t);p!==f;)i=p.nextSibling,h.appendChild(p),p=i;return function e(t,n,i){var r,a;for(r=n.firstChild;r;r=a){if(a=r.nextSibling,q(r)){if(r.nodeType===o||"BR"===r.nodeName||"IMG"===r.nodeName){i.appendChild(r);continue}}else if(K(r)){i.appendChild(t.createDefaultBlock([e(t,r,t._doc.createDocumentFragment())]));continue}e(t,r,i)}return i}(this,h,u),u.normalize(),p=u.firstChild,i=u.lastChild,r=n.childNodes,p?(n.insertBefore(u,f),d=B.call(r,p),c=B.call(r,i)+1):c=d=B.call(r,f),e.setStart(n,d),e.setEnd(n,c),de(n,e),_e(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},Je.increaseQuoteLevel=_t("modifyBlocks",function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])}),Je.decreaseQuoteLevel=_t("modifyBlocks",ht),Je.makeUnorderedList=_t("modifyBlocks",function(e){return ft(this,e,"UL"),e}),Je.makeOrderedList=_t("modifyBlocks",function(e){return ft(this,e,"OL"),e}),Je.removeList=_t("modifyBlocks",function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),s=e.querySelectorAll("LI"),d=this._root;for(t=0,n=a.length;t<n;t+=1)ae(i=oe(o=a[t]),d),ne(o,i);for(t=0,n=s.length;t<n;t+=1)K(r=s[t])?ne(r,this.createDefaultBlock([oe(r)])):(ae(r,d),ne(r,oe(r)));return e}),Xe.isInline=q,Xe.isBlock=K,Xe.isContainer=G,Xe.getBlockWalker=Z,Xe.getPreviousBlock=j,Xe.getNextBlock=$,Xe.areAlike=V,Xe.hasTagAttributes=Y,Xe.getNearest=X,Xe.isOrContains=J,Xe.detach=te,Xe.replaceWith=ne,Xe.empty=oe,Xe.getNodeBefore=he,Xe.getNodeAfter=ue,Xe.insertNodeInRange=fe,Xe.extractContentsOfRange=pe,Xe.deleteContentsOfRange=ge,Xe.insertTreeFragmentIntoRange=me,Xe.isNodeContainedInRange=ve,Xe.moveRangeBoundariesDownTree=_e,Xe.moveRangeBoundariesUpTree=Ne,Xe.getStartBlockOfRange=Ce,Xe.getEndBlockOfRange=Se,Xe.contentWalker=ye,Xe.rangeDoesStartAtBlockBoundary=Te,Xe.rangeDoesEndAtBlockBoundary=Ee,Xe.expandRangeToBlockBoundaries=be,Xe.onPaste=Qe,Xe.addLinks=mt,Xe.splitBlock=ct,Xe.startSelectionId=st,Xe.endSelectionId=dt,"object"==typeof exports?module.exports=Xe:"function"==typeof define&&define.amd?define(function(){return Xe}):(u.Squire=Xe,top!==u&&"true"===e.documentElement.getAttribute("data-squireinit")&&(u.editor=new Xe(e),u.onEditorLoad&&(u.onEditorLoad(u.editor),u.onEditorLoad=null)))}(document);
>>>>>>> b0ac7d3... Handle all cases of overwriting content
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function i(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function o(e){return e.nodeType===w&&!!he[e.nodeName]}function r(e){switch(e.nodeType){case F:return fe;case w:case H:if(ae&&me.has(e))return me.get(e);break;default:return ue}var t;return t=i(e.childNodes,a)?ce.test(e.nodeName)?fe:pe:ge,ae&&me.set(e,t),t}function a(e){return r(e)===fe}function s(e){return r(e)===pe}function d(e){return r(e)===ge}function l(e,t){var i=new n(t,W,s);return i.currentNode=e,i}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!o(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var i in n)if(e.getAttribute(i)!==n[i])return!1;return!0}function g(e,t,n,i){for(;e&&e!==t;){if(p(e,n,i))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t,n){var i,o,r,a,s,d="";return e&&e!==t&&(d=v(e.parentNode,t,n),e.nodeType===w&&(d+=(d?">":"")+e.nodeName,(i=e.id)&&(d+="#"+i),(o=e.className.trim())&&(r=o.split(/\s\s*/),r.sort(),d+=".",d+=r.join(".")),(a=e.dir)&&(d+="[dir="+a+"]"),r&&(s=n.classNames,de.call(r,s.highlight)>-1&&(d+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),de.call(r,s.colour)>-1&&(d+="[color="+e.style.color.replace(/ /g,"")+"]"),de.call(r,s.fontFamily)>-1&&(d+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),de.call(r,s.fontSize)>-1&&(d+="[fontSize="+e.style.fontSize+"]")))),d}function N(e){var t=e.nodeType;return t===w||t===H?e.childNodes.length:e.length||0}function _(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,i=n?n.length:0;i--;)t.appendChild(e.firstChild);return t}function y(e,n,i,o){var r,a,s,d=e.createElement(n);if(i instanceof Array&&(o=i,i=null),i)for(r in i)i[r]!==t&&d.setAttribute(r,i[r]);if(o)for(a=0,s=o.length;a<s;a+=1)d.appendChild(o[a]);return d}function T(e,t){var n,i,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((i=e.firstChild)&&"BR"!==i.nodeName||(n=r.createDefaultBlock(),i?e.replaceChild(n,i):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(i=e.firstChild;ie&&i&&i.nodeType===F&&!i.data;)e.removeChild(i),i=e.firstChild;i||(ie?(n=s.createTextNode(z),r._didAddZWS()):n=s.createTextNode(""))}else if(ne){for(;e.nodeType!==F&&!o(e);){if(!(i=e.firstChild)){n=s.createTextNode("");break}e=i}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):o(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=y(s,"BR");(i=e.lastElementChild)&&!a(i);)e=i;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,i,o,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,i=s.length;n<i;n+=1)o=s[n],r="BR"===o.nodeName,!r&&a(o)?(c||(c=y(l,h.blockTag,h.blockAttributes)),c.appendChild(o),n-=1,i-=1):(r||c)&&(c||(c=y(l,h.blockTag,h.blockAttributes)),T(c,t),r?e.replaceChild(c,o):(e.insertBefore(c,o),n+=1,i+=1),c=null),d(o)&&E(o,t);return c&&e.appendChild(T(c,t)),e}function b(e,t,n,i){var o,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,i);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(o=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,i,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),T(e,i),T(r,i),(a=e.nextSibling)?o.insertBefore(r,a):o.appendChild(r),b(o,r,n,i)}return t}function k(e,t){for(var n,i,o,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],i=s&&r[s-1],s&&a(n)&&f(n,i)&&!he[n.nodeName])t.startContainer===n&&(t.startContainer=i,t.startOffset+=N(i)),t.endContainer===n&&(t.endContainer=i,t.endOffset+=N(i)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=i,t.startOffset=N(i))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=i,t.endOffset=N(i))),_(n),n.nodeType===F?i.appendData(n.data):d.push(S(n));else if(n.nodeType===w){for(o=d.length;o--;)n.appendChild(d.pop());k(n,t)}}function L(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function x(e,t,n,i){for(var o,r,a,s=t;(o=s.parentNode)&&o!==i&&o.nodeType===w&&1===o.childNodes.length;)s=o;_(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),L(e,n),Y&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function A(e,t){var n,i,o=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(o&&f(o,e)){if(!d(o)){if(!s)return;i=y(a,"DIV"),i.appendChild(S(o)),o.appendChild(i)}_(e),n=!d(e),o.appendChild(S(e)),n&&E(o,t),r&&A(r,t)}else s&&(o=y(a,"DIV"),e.insertBefore(o,r),T(o,t))}function O(e){this.isShiftDown=e.shiftKey}function B(e,t,n){var i,o;if(e||(e={}),t)for(i in t)!n&&i in e||(o=t[i],e[i]=o&&o.constructor===Object?B(e[i],o,n):o);return e}function R(e,t){e.nodeType===M&&(e=e.body);var n,i=e.ownerDocument,o=i.defaultView;this._win=o,this._doc=i,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,oe&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in i?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,re?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(V?"beforecut":"cut",Xe),this.addEventListener("copy",Je),this.addEventListener("keydown",O),this.addEventListener("keyup",O),this.addEventListener(V?"beforepaste":"paste",et),this.addEventListener("drop",tt),this.addEventListener(Y?"keypress":"keydown",De),this._keyHandlers=Object.create(we),this.setConfig(t),V&&(o.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,i=this.parentNode,o=this.length-e;return n?i.insertBefore(t,n):i.appendChild(t),o&&this.deleteData(e,o),t}),e.setAttribute("contenteditable","true");try{i.execCommand("enableObjectResizing",!1,"false"),i.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var i,o;for(i=t.firstChild;i;i=o){if(o=i.nextSibling,a(i)){if(i.nodeType===F||"BR"===i.nodeName||"IMG"===i.nodeName){n.appendChild(i);continue}}else if(s(i)){n.appendChild(e.createDefaultBlock([I(e,i,e._doc.createDocumentFragment())]));continue}I(e,i,n)}return n}var w=1,F=3,M=9,H=11,W=1,z="​",q=e.defaultView,K=navigator.userAgent,G=/Android/.test(K),Z=/iP(?:ad|hone|od)/.test(K),j=/Mac OS X/.test(K),$=/Windows NT/.test(K),Q=/Gecko\//.test(K),V=/Trident\/[456]\./.test(K),Y=!!q.opera,X=/Edge\//.test(K),J=!X&&/WebKit\//.test(K),ee=/Trident\/[4567]\./.test(K),te=j?"meta-":"ctrl-",ne=V||Y,ie=V||J,oe=V,re="undefined"!=typeof MutationObserver,ae="undefined"!=typeof WeakMap,se=/[^ \t\r\n]/,de=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var le={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}};var ce=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,he={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},ue=0,fe=1,pe=2,ge=3,me=ae?new WeakMap:null,ve=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Ne=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},_e=function(e,t){var n,i,o,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,i=n.childNodes,s===a.length?(s=de.call(i,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=de.call(i,a)),a=n):i=a.childNodes,o=i.length,s===o?a.appendChild(t):a.insertBefore(t,i[s]),a===d&&(l+=i.length-o),e.setStart(a,s),e.setEnd(d,l)},Ce=function(e,t,n){var i=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(i,o,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return i=t,o=c?de.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[o],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(i=d,o=d.length,d.appendData(l.data),_(l)),e.setStart(i,o),e.collapse(!0),T(t,n),u},Se=function(e,t){var n,i,o=ke(e,t),r=Le(e,t),a=o!==r;return Ee(e),be(e,o,r,t),n=Ce(e,null,t),Ee(e),a&&(r=Le(e,t),o&&r&&o!==r&&x(o,r,e,t)),o&&T(o,t),i=t.firstChild,i&&"BR"!==i.nodeName?e.collapse(!0):(T(t,t),e.selectNodeContents(t.firstChild)),n},ye=function(e,t,n){var i,o,r,s,l,f,p,m,v,C,S;for(E(t,n),i=t;i=h(i,n);)T(i,n);if(e.collapsed||Se(e,n),Ee(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,o=ke(e,n),m=h(t,t),p=!!o&&u(o),o&&m&&!p&&!g(m,t,"PRE")&&!g(m,t,"TABLE")){if(be(e,o,o,n),e.collapse(!0),l=e.endContainer,f=e.endOffset,Ve(o,n,!1),a(l)&&(v=b(l,f,c(l,n),n),l=v.parentNode,f=de.call(l.childNodes,v)),f!==N(l))for(r=n.ownerDocument.createDocumentFragment();i=l.childNodes[f];)r.appendChild(i);x(l,m,e,n),f=de.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,f)}N(t)&&(p&&(e.setEndBefore(o),e.collapse(!1),_(o)),be(e,s,s,n),v=b(e.endContainer,e.endOffset,s,n),C=v?v.previousSibling:s.lastChild,s.insertBefore(t,v),v?e.setEndBefore(v):e.setEnd(s,N(s)),o=Le(e,n),Ee(e),l=e.endContainer,f=e.endOffset,v&&d(v)&&A(v,n),v=C&&C.nextSibling,v&&d(v)&&A(v,n),e.setEnd(l,f)),r&&(S=e.cloneRange(),x(o,r,S,n),e.setEnd(S.endContainer,S.endOffset)),Ee(e)},Te=function(e,t,n){var i=t.ownerDocument.createRange();if(i.selectNode(t),n){var o=e.compareBoundaryPoints(3,i)>-1,r=e.compareBoundaryPoints(1,i)<1;return!o&&!r}var a=e.compareBoundaryPoints(0,i)<1,s=e.compareBoundaryPoints(2,i)>-1;return a&&s},Ee=function(e){for(var t,n=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[i])&&!o(t);)n=t,i=0;if(a)for(;r.nodeType!==F;){if(!(t=r.childNodes[a-1])||o(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=N(r)}else for(;r.nodeType!==F&&(t=r.firstChild)&&!o(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,i)):(e.setStart(n,i),e.setEnd(r,a))},be=function(e,t,n,i){var o,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==i;)o=r.parentNode,a=de.call(o.childNodes,r),r=o;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===i||d!==N(s))break;o=s.parentNode,d=de.call(o.childNodes,s)+1,s=o}e.setStart(r,a),e.setEnd(s,d)},ke=function(e,t){var n,i=e.startContainer;return a(i)?n=c(i,t):i!==t&&s(i)?n=i:(n=ve(i,e.startOffset),n=h(n,t)),n&&Te(e,n,!0)?n:null},Le=function(e,t){var n,i,o=e.endContainer;if(a(o))n=c(o,t);else if(o!==t&&s(o))n=o;else{if(!(n=Ne(o,e.endOffset))||!m(t,n))for(n=t;i=n.lastChild;)n=i;n=c(n,t)}return n&&Te(e,n,!0)?n:null},xe=new n(null,4|W,function(e){return e.nodeType===F?se.test(e.data):"IMG"===e.nodeName}),Ae=function(e,t){var n,i=e.startContainer,o=e.startOffset;if(xe.root=null,i.nodeType===F){if(o)return!1;n=i}else if(n=Ne(i,o),n&&!m(t,n)&&(n=null),!n&&(n=ve(i,o),n.nodeType===F&&n.length))return!1;return xe.currentNode=n,xe.root=ke(e,t),!xe.previousNode()},Oe=function(e,t){var n,i=e.endContainer,o=e.endOffset;if(xe.root=null,i.nodeType===F){if((n=i.data.length)&&o<n)return!1;xe.currentNode=i}else xe.currentNode=ve(i,o);return xe.root=Le(e,t),!xe.nextNode()},Be=function(e,t){var n,i=ke(e,t),o=Le(e,t);i&&o&&(n=i.parentNode,e.setStart(n,de.call(n.childNodes,i)),n=o.parentNode,e.setEnd(n,de.call(n.childNodes,o)+1))},Re={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},De=function(e){var t=e.keyCode,n=Re[t],i="",o=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),Y&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(i+="alt-"),e.ctrlKey&&(i+="ctrl-"),e.metaKey&&(i+="meta-")),e.shiftKey&&(i+="shift-"),n=i+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,o):o.collapsed||e.ctrlKey||e.metaKey||1!==(e.key||n).length||(this.saveUndoState(o),Se(o,this._root),this._ensureBottomLine(),this.setSelection(o),this._updatePath(o,!0)))},Ue=function(e){return function(t,n){n.preventDefault(),t[e]()}},Pe=function(e,t){return t=t||null,function(n,i){i.preventDefault();var o=n.getSelection();n.hasFormat(e,null,o)?n.changeFormat(null,{tag:e},o):n.changeFormat({tag:e},t,o)}},Ie=function(e,t){try{t||(t=e.getSelection());var n,i=t.startContainer;for(i.nodeType===F&&(i=i.parentNode),n=i;a(n)&&(!n.textContent||n.textContent===z);)i=n,n=i.parentNode;i!==n&&(t.setStart(n,de.call(n.childNodes,i)),t.collapse(!0),n.removeChild(i),s(n)||(n=c(n,e._root)),T(n,e._root),Ee(t)),i===e._root&&(i=i.firstChild)&&"BR"===i.nodeName&&_(i),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},we={enter:function(e,t,n){var i,o,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),_t(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||Se(n,a),!(i=ke(n,a))||/^T[HD]$/.test(i.nodeName))return o=g(n.endContainer,a,"A"),o&&(o=o.parentNode,be(n,o,o,a),n.collapse(!1)),_e(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((o=g(i,a,"LI"))&&(i=o),u(i)){if(g(i,a,"UL")||g(i,a,"OL"))return e.decreaseListLevel(n);if(g(i,a,"BLOCKQUOTE"))return e.modifyBlocks(ut,n)}for(r=lt(e,i,n.startContainer,n.startOffset),at(i),je(i),T(i,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===z)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling)&&"BR"!==s.nodeName;)_(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!Y)break;r=d}n=e.createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var i=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ae(n,i)){t.preventDefault();var o,r=ke(n,i);if(!r)return;if(E(r.parentNode,i),o=c(r,i)){if(!o.isContentEditable)return void _(o);for(x(o,r,n,i),r=o.parentNode;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(r=r.nextSibling)&&A(r,i),e.setSelection(n)}else if(r){if(g(r,i,"UL")||g(r,i,"OL"))return e.decreaseListLevel(n);if(g(r,i,"BLOCKQUOTE"))return e.modifyBlocks(ht,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Ie(e)},0);else t.preventDefault(),Se(n,i),Ie(e,n)},delete:function(e,t,n){var i,o,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Oe(n,l)){if(t.preventDefault(),!(i=ke(n,l)))return;if(E(i.parentNode,l),o=h(i,l)){if(!o.isContentEditable)return void _(o);for(x(i,o,n,l),o=i.parentNode;o!==l&&!o.nextSibling;)o=o.parentNode;o!==l&&(o=o.nextSibling)&&A(o,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),be(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),_(d),Ee(n),void Ie(e,n);e.setSelection(r),setTimeout(function(){Ie(e)},0)}else t.preventDefault(),Se(n,l),Ie(e,n)},tab:function(e,t,n){var i,o,r=e._root;if(e._removeZWS(),n.collapsed&&Ae(n,r))for(i=ke(n,r);o=i.parentNode;){if("UL"===o.nodeName||"OL"===o.nodeName){t.preventDefault(),e.increaseListLevel(n);break}i=o}},"shift-tab":function(e,t,n){var i,o=e._root;e._removeZWS(),n.collapsed&&Ae(n,o)&&(i=n.startContainer,(g(i,o,"UL")||g(i,o,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var i,o;e._recordUndoState(n),_t(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),i=n.endContainer,o=i.parentNode,n.collapsed&&n.endOffset===N(i)&&("A"===i.nodeName?n.setStartAfter(i):"A"!==o.nodeName||i.nextSibling||n.setStartAfter(o)),n.collapsed||(Se(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};j&&Q&&(we["meta-left"]=function(e,t){t.preventDefault();var n=rt(e);n&&n.modify&&n.modify("move","backward","lineboundary")},we["meta-right"]=function(e,t){t.preventDefault();var n=rt(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),j||(we.pageup=function(e){e.moveCursorToStart()},we.pagedown=function(e){e.moveCursorToEnd()}),we[te+"b"]=Pe("B"),we[te+"i"]=Pe("I"),we[te+"u"]=Pe("U"),we[te+"shift-7"]=Pe("S"),we[te+"shift-5"]=Pe("SUB",{tag:"SUP"}),we[te+"shift-6"]=Pe("SUP",{tag:"SUB"}),we[te+"shift-8"]=Ue("makeUnorderedList"),we[te+"shift-9"]=Ue("makeOrderedList"),we[te+"["]=Ue("decreaseQuoteLevel"),we[te+"]"]=Ue("increaseQuoteLevel"),we[te+"y"]=Ue("redo"),we[te+"z"]=Ue("undo"),we[te+"shift-z"]=Ue("redo");var Fe={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Me={backgroundColor:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.highlight,style:"background-color:"+n})}},color:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.colour,style:"color:"+n})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return y(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return y(e,"I")}},fontFamily:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontFamily,style:"font-family:"+n})}},fontSize:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontSize,style:"font-size:"+n})}},textDecoration:{regexp:/^underline/i,replace:function(e){return y(e,"U")}}},He=function(e){return function(t,n){var i=y(t.ownerDocument,e);return n.replaceChild(i,t),i.appendChild(S(t)),i}},We=function(e,t,n){var i,o,r,a,s,d,l=e.style,c=e.ownerDocument;for(i in Me)o=Me[i],(r=l[i])&&o.regexp.test(r)&&(d=o.replace(c,n.classNames,r),s||(s=d),a&&a.appendChild(d),a=d,e.style[i]="");return s&&(a.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(s,e):e.appendChild(s)),a||e},ze={P:We,SPAN:We,STRONG:He("B"),EM:He("I"),INS:He("U"),STRIKE:He("S"),FONT:function(e,t,n){var i,o,r,a,s,d=e.face,l=e.size,c=e.color,h=e.ownerDocument,u=n.classNames;return d&&(i=y(h,"SPAN",{class:u.fontFamily,style:"font-family:"+d}),s=i,a=i),l&&(o=y(h,"SPAN",{class:u.fontSize,style:"font-size:"+Fe[l]+"px"}),s||(s=o),a&&a.appendChild(o),a=o),c&&/^#?([\dA-F]{3}){1,2}$/i.test(c)&&("#"!==c.charAt(0)&&(c="#"+c),r=y(h,"SPAN",{class:u.colour,style:"color:"+c}),s||(s=r),a&&a.appendChild(r),a=r),s||(s=a=y(h,"SPAN")),t.replaceChild(s,e),a.appendChild(S(e)),a},TT:function(e,t,n){var i=y(e.ownerDocument,"SPAN",{class:n.classNames.fontFamily,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(i,e),i.appendChild(S(e)),i}},qe=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Ke=/^(?:HEAD|META|STYLE)/,Ge=new n(null,4|W,function(){return!0}),Ze=function e(t,n,i){var o,r,s,d,l,c,h,u,f,p,g,m,v=t.childNodes;for(o=t;a(o);)o=o.parentNode;for(Ge.root=o,r=0,s=v.length;r<s;r+=1)if(d=v[r],l=d.nodeName,c=d.nodeType,h=ze[l],c===w){if(u=d.childNodes.length,h)d=h(d,t,n);else{if(Ke.test(l)){t.removeChild(d),r-=1,s-=1;continue}if(!qe.test(l)&&!a(d)){r-=1,s+=u-1,t.replaceChild(S(d),d);continue}}u&&e(d,n,i||"PRE"===l)}else{if(c===F){if(g=d.data,f=!se.test(g.charAt(0)),p=!se.test(g.charAt(g.length-1)),i||!f&&!p)continue;if(f){for(Ge.currentNode=d;(m=Ge.previousPONode())&&!("IMG"===(l=m.nodeName)||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/^[ \t\r\n]+/g,m?" ":"")}if(p){for(Ge.currentNode=d;(m=Ge.nextNode())&&!("IMG"===l||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/[ \t\r\n]+$/g,m?" ":"")}if(g){d.data=g;continue}}t.removeChild(d),r-=1,s-=1}return t},je=function e(t){for(var n,i=t.childNodes,r=i.length;r--;)n=i[r],n.nodeType!==w||o(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},$e=function(e){return e.nodeType===w?"BR"===e.nodeName:se.test(e.data)},Qe=function(e,t){for(var i,o=e.parentNode;a(o);)o=o.parentNode;return i=new n(o,4|W,$e),i.currentNode=e,!!i.nextNode()||t&&!i.previousNode()},Ve=function(e,t,n){var i,o,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(i=0;i<l;i+=1)d[i]=Qe(s[i],n);for(;l--;)o=s[l],(r=o.parentNode)&&(d[l]?a(r)||E(r,t):_(o))},Ye=function(e,t,n){var i,o,r=t.ownerDocument.body;Ve(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),r.appendChild(t),i=t.innerHTML,o=t.innerText||t.textContent,$&&(o=o.replace(/\r?\n/g,"\r\n")),e.setData("text/html",i),e.setData("text/plain",o),r.removeChild(t)},Xe=function(e){var t,n,i,o,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),X||Z||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=ke(l,c),n=Le(l,c),i=t===n&&t||c,o=Se(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==i;)a=r.cloneNode(!1),a.appendChild(o),o=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(o),Ye(d,s,c),e.preventDefault()}this.setSelection(l)},Je=function(e){var t,n,i,o,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!X&&!Z&&d){for(t=ke(l,c),n=Le(l,c),i=t===n&&t||c,l=l.cloneRange(),Ee(l),be(l,i,i,c),o=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==i;)a=r.cloneNode(!1),a.appendChild(o),o=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(o),Ye(d,s,c),e.preventDefault()}},et=function(e){var t,n,i,o,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(X&&s){for(t=s.length;t--;)!d&&/^image\/.*/.test(s[t].type)&&(c=!0);c||(s=null)}if(s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],i=n.type,!d&&"text/html"===i)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===i&&(h=n),!d&&/^image\/.*/.test(i)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(o=a&&a.types,!X&&o&&(de.call(o,"text/html")>-1||!Q&&de.call(o,"text/plain")>-1&&de.call(o,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,N=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",i=C;C=i;)i=C.nextSibling,_(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u.createRange(g,m,v,N),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)},tt=function(e){for(var t=e.dataTransfer.types,n=t.length,i=!1,o=!1;n--;)switch(t[n]){case"text/plain":i=!0;break;case"text/html":o=!0;break;default:return}(o||i)&&this.saveUndoState()},nt=R.prototype,it=function(e,t,n){var i=n._doc,o=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return o?i.importNode(o,!0):i.createDocumentFragment()};nt.setConfig=function(e){return e=B({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},classNames:{colour:"colour",fontFamily:"font",fontSize:"size",highlight:"highlight"},leafNodeNames:he,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?it:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},nt.createElement=function(e,t,n){return y(this._doc,e,t,n)},nt.createDefaultBlock=function(e){var t=this._config;return T(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},nt.didError=function(e){console.log(e)},nt.getDocument=function(){return this._doc},nt.getRoot=function(){return this._root},nt.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var ot={pathChange:1,select:1,input:1,undoStateChange:1};nt.fireEvent=function(e,t){var n,i,o,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),i=r.length;i--;){o=r[i];try{o.handleEvent?o.handleEvent(t):o.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},nt.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},nt.handleEvent=function(e){this.fireEvent(e.type,e)},nt.addEventListener=function(e,t){var n=this._events[e],i=this._root;return t?(n||(n=this._events[e]=[],ot[e]||("selectionchange"===e&&(i=this._doc),i.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},nt.removeEventListener=function(e,t){var n,i=this._events[e],o=this._root;if(i){if(t)for(n=i.length;n--;)i[n]===t&&i.splice(n,1);else i.length=0;i.length||(delete this._events[e],ot[e]||("selectionchange"===e&&(o=this._doc),o.removeEventListener(e,this,!0)))}return this},nt.createRange=function(e,t,n,i){if(e instanceof this._win.Range)return e.cloneRange();var o=this._doc.createRange();return o.setStart(e,t),n?o.setEnd(n,i):o.setEnd(e,t),o},nt.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,i=e.getBoundingClientRect();return i&&!i.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=z,_e(e,t),i=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),L(n,e)),i},nt._moveCursorTo=function(e){var t=this._root,n=this.createRange(t,e?0:t.childNodes.length);return Ee(n),this.setSelection(n),this},nt.moveCursorToStart=function(){return this._moveCursorTo(!0)},nt.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var rt=function(e){return e._win.getSelection()||null};nt.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(G&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{Z&&this._win.focus();var t=rt(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},nt.getSelection=function(){var e,t,n,i,r=rt(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&o(t)&&e.setStartBefore(t),n&&o(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,i=e.commonAncestorContainer,m(i.ownerDocument,i)||(e=null)),e||(e=this.createRange(a.firstChild,0)),e},nt.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,i=new n(e.commonAncestorContainer,4|W,function(t){return Te(e,t,!0)}),o=e.startContainer,r=e.endContainer,s=i.currentNode=o,d="",l=!1;for(i.filter(s)||(s=i.nextNode());s;)s.nodeType===F?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===o&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=i.nextNode();return d},nt.getPath=function(){return this._path};var at=function(e,t){for(var i,o,r,s=new n(e,4,function(){return!0},!1);o=s.nextNode();)for(;(r=o.data.indexOf(z))>-1&&(!t||o.parentNode!==t);){if(1===o.length){do{i=o.parentNode,i.removeChild(o),o=i,s.currentNode=i}while(a(o)&&!N(o));break}o.deleteData(r,1)}};nt._didAddZWS=function(){this._hasZWS=!0},nt._removeZWS=function(){this._hasZWS&&(at(this._root),this._hasZWS=!1)},nt._updatePath=function(e,t){if(e){var n,i=e.startContainer,o=e.endContainer;(t||i!==this._lastAnchorNode||o!==this._lastFocusNode)&&(this._lastAnchorNode=i,this._lastFocusNode=o,n=i&&o?i===o?v(o,this._root,this._config):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},nt._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},nt.focus=function(){return this._root.focus(),ee&&this.fireEvent("focus"),this},nt.blur=function(){return this._root.blur(),ee&&this.fireEvent("blur"),this};var st="squire-selection-end";nt._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),i=this.createElement("INPUT",{id:st,type:"hidden"});_e(e,n),e.collapse(!1),_e(e,i),2&n.compareDocumentPosition(i)&&(n.id=st,i.id="squire-selection-start",t=n,n=i,i=t),e.setStartAfter(n),e.setEndBefore(i)},nt._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),i=t.querySelector("#"+st);if(n&&i){var o=n.parentNode,r=i.parentNode,a=de.call(o.childNodes,n),s=de.call(r.childNodes,i);o===r&&(s-=1),_(n),_(i),e||(e=this._doc.createRange()),e.setStart(o,a),e.setEnd(r,s),L(o,e),o!==r&&L(r,e),e.collapsed&&(o=e.startContainer,o.nodeType===F&&(r=o.childNodes[e.startOffset],r&&r.nodeType===F||(r=o.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}
return e||null},nt._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},nt._docWasChanged=function(){if(ae&&(me=new WeakMap),!this._ignoreAllChanges){if(re&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},nt._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,i=this._undoIndex,o=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(i+=1),i<this._undoStackLength&&(o.length=this._undoStackLength=i),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&i>s&&(o.splice(0,i-s),i=s,this._undoStackLength=s),o[i]=n,this._undoIndex=i,this._undoStackLength+=1,this._isInUndoState=!0}},nt.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},nt.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},nt.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},nt.hasFormat=function(e,t,i){if(e=e.toUpperCase(),t||(t={}),!i&&!(i=this.getSelection()))return!1;!i.collapsed&&i.startContainer.nodeType===F&&i.startOffset===i.startContainer.length&&i.startContainer.nextSibling&&i.setStartBefore(i.startContainer.nextSibling),!i.collapsed&&i.endContainer.nodeType===F&&0===i.endOffset&&i.endContainer.previousSibling&&i.setEndAfter(i.endContainer.previousSibling);var o,r,a=this._root,s=i.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===F)return!1;o=new n(s,4,function(e){return Te(i,e,!0)},!1);for(var d=!1;r=o.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},nt.getFontInfo=function(e){var n,i,o,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(i=n.style)&&(!r.color&&(o=i.color)&&(r.color=o,a+=1),!r.backgroundColor&&(o=i.backgroundColor)&&(r.backgroundColor=o,a+=1),!r.family&&(o=i.fontFamily)&&(r.family=o,a+=1),!r.size&&(o=i.fontSize)&&(r.size=o,a+=1)),n=n.parentNode;return r},nt._addFormat=function(e,t,i){var o,r,s,d,l,c,h,u,f=this._root;if(i.collapsed){for(o=T(this.createElement(e,t),f),_e(i,o),i.setStart(o.firstChild,o.firstChild.length),i.collapse(!0),u=o;a(u);)u=u.parentNode;at(u,o)}else{if(r=new n(i.commonAncestorContainer,4|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Te(i,e,!0)},!1),s=i.startContainer,l=i.startOffset,d=i.endContainer,c=i.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return i;do{h=r.currentNode,!g(h,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),o=this.createElement(e,t),C(h,o),o.appendChild(h))}while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),i=this.createRange(s,l,d,c)}return i},nt._removeFormat=function(e,t,n,i){this._saveRangeToBookmark(n);var o,r=this._doc;n.collapsed&&(ie?(o=r.createTextNode(z),this._didAddZWS()):o=r.createTextNode(""),_e(n,o));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Te(n,e,!1)){var i,o,r=e.nodeType===F;if(!Te(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(i=e.firstChild;i;i=o)o=i.nextSibling,f(i,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(i){return Te(n,i,!0)&&p(i,e,t)});return i||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),o&&n.collapse(!1),L(s,n),n},nt.changeFormat=function(e,t,n,i){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,i)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged(),this):this};var dt={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},lt=function(e,t,n,i){var o=dt[t.nodeName],r=null,a=b(n,i,t.parentNode,e._root),s=e._config;return o||(o=s.blockTag,r=s.blockAttributes),p(a,o,r)||(t=y(a.ownerDocument,o,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};nt.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var i=this._root,o=ke(n,i),r=Le(n,i);if(o&&r)do{if(e(o)||o===r)break}while(o=h(o,i));return t&&(this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged()),this},nt.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,i=this._root;return Be(t,i),be(t,i,i,i),n=Ce(t,i,i),_e(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&A(t.endContainer.childNodes[t.endOffset],i),A(t.startContainer.childNodes[t.startOffset],i),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),re||this._docWasChanged(),this};var ct=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},ht=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},ut=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:st,type:"hidden"})])},ft=function(e,t,n){for(var i,o,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;i=s.nextNode();)"LI"===i.parentNode.nodeName&&(i=i.parentNode,s.currentNode=i.lastChild),"LI"!==i.nodeName?(a=e.createElement("LI",h),i.dir&&(a.dir=i.dir),(r=i.previousSibling)&&r.nodeName===n?(r.appendChild(a),_(i)):C(i,e.createElement(n,c,[a])),a.appendChild(S(i)),s.currentNode=a):(i=i.parentNode,(o=i.nodeName)!==n&&/^[OU]L$/.test(o)&&C(i,e.createElement(n,c,[S(i)])))},pt=function(e){return ft(this,e,"UL"),e},gt=function(e){return ft(this,e,"OL"),e},mt=function(e){var t,n,i,o,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)i=a[t],o=S(i),E(o,l),C(i,o);for(t=0,n=d.length;t<n;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([S(r)])):(E(r,l),C(r,S(r)));return e},vt=function(e,t){for(var n=e.commonAncestorContainer,i=e.startContainer,o=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(i===n&&(i=i.childNodes[e.startOffset]),o===n&&(o=o.childNodes[e.endOffset]);i&&i.parentNode!==n;)i=i.parentNode;for(;o&&o.parentNode!==n;)o=o.parentNode;return[n,i,o]};nt.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=vt(e,t);if(!n)return this.focus();var i=n[0],o=n[1],r=n[2];if(!o||o===i.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=i.nodeName,l=o.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),i.insertBefore(l,o));do{s=o===r?null:o.nextSibling,l.appendChild(o)}while(o=s);return s=l.nextSibling,s&&A(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},nt.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=vt(e,t);if(!n)return this.focus();var i=n[0],o=n[1],r=n[2];o||(o=i.firstChild),r||(r=i.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=i.parentNode,d=r.nextSibling?b(i,r.nextSibling,s,t):i.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=i.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=o===r?null:o.nextSibling,i.removeChild(o),l&&"LI"===o.nodeName&&(o=this.createDefaultBlock([S(o)])),s.insertBefore(o,d)}while(o=a);return i.firstChild||_(i),d&&A(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},nt._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},nt.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},nt._getHTML=function(){return this._root.innerHTML},nt._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{T(n,t)}while(n=h(n,t));this._ignoreChange=!0},nt.getHTML=function(e){var t,n,i,o,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ne)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(i=this.createElement("BR"),n.appendChild(i),s.push(i));if(o=this._getHTML().replace(/\u200B/g,""),ne)for(r=s.length;r--;)_(s[r]);return a&&this._getRangeAndRemoveBookmark(a),o},nt.setHTML=function(e){var t,n,i,o=this._config,r=o.isSetHTMLSanitized?o.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),Ze(n,o),Ve(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)T(s,a);for(this._ignoreChange=!0;i=a.lastChild;)a.removeChild(i);a.appendChild(n),T(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this.createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},nt.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))_e(t,e),t.setStartAfter(e);else{for(var n,i,o=this._root,r=ke(t,o)||o;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(n=r.parentNode,i=b(n,r.nextSibling,o,o)),i?o.insertBefore(e,i):(o.appendChild(e),i=this.createDefaultBlock(),o.appendChild(i)),t.setStart(i,0),t.setEnd(i,0),Ee(t)}return this.focus(),this.setSelection(t),this._updatePath(t),re||this._docWasChanged(),this},nt.insertImage=function(e,t){var n=this.createElement("IMG",B({src:e},t,!0));return this.insertElement(n),n};var Nt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)(?:\?[^&?\s]+=[^&?\s]+(?:&[^&?\s]+=[^&?\s]+)*)?/i,_t=function(e,t,i){for(var o,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,4,function(e){return!g(e,t,"A")},!1),f=i._config.tagAttributes.a;o=u.nextNode();)for(r=o.data,a=o.parentNode;s=Nt.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,o)),c=i.createElement("A",B({href:s[1]?/^(?:ht|f)tps?:/i.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[0]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,o),o.data=r=r.slice(l)};nt.insertHTML=function(e,t){var n,i,o,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),i=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&i>-1&&(e=e.slice(n+20,i))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),o=this.createElement("DIV"),o.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(o))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},_t(r,r,this),Ze(r,l),Ve(r,a,!1),je(r),r.normalize();s=h(s,r);)T(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(ye(u,d.fragment,a),re||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var Ct=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};nt.insertPlainText=function(e,t){var n,i,o,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Ct(l[n])+'"';for(h+=">",i=0,o=a.length;i<o;i+=1)r=a[i],r=Ct(r).replace(/ (?= )/g,"&nbsp;"),a[i]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var St=function(e,t,n){return function(){return this[e](t,n),this.focus()}};nt.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},nt.bold=St("changeFormat",{tag:"B"}),nt.italic=St("changeFormat",{tag:"I"}),nt.underline=St("changeFormat",{tag:"U"}),nt.strikethrough=St("changeFormat",{tag:"S"}),nt.subscript=St("changeFormat",{tag:"SUB"},{tag:"SUP"}),nt.superscript=St("changeFormat",{tag:"SUP"},{tag:"SUB"}),nt.removeBold=St("changeFormat",null,{tag:"B"}),nt.removeItalic=St("changeFormat",null,{tag:"I"}),nt.removeUnderline=St("changeFormat",null,{tag:"U"}),nt.removeStrikethrough=St("changeFormat",null,{tag:"S"}),nt.removeSubscript=St("changeFormat",null,{tag:"SUB"}),nt.removeSuperscript=St("changeFormat",null,{tag:"SUP"}),nt.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var i=e.indexOf(":")+1;if(i)for(;"/"===e[i];)i+=1;_e(n,this._doc.createTextNode(e.slice(i)))}return t=B(B({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},nt.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},nt.setFontFace=function(e){var t=this._config.classNames.fontFamily;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},nt.setFontSize=function(e){var t=this._config.classNames.fontSize;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},nt.setTextColour=function(e){var t=this._config.classNames.colour;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},nt.setHighlightColour=function(e){var t=this._config.classNames.highlight;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:t}}),this.focus()},nt.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},nt.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},nt.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Be(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),be(e,n,n,t);for(var i,o,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)i=p.nextSibling,h.appendChild(p),p=i;return I(this,h,u),u.normalize(),p=u.firstChild,i=u.lastChild,o=n.childNodes,p?(n.insertBefore(u,f),d=de.call(o,p),c=de.call(o,i)+1):(d=de.call(o,f),c=d),e.setStart(n,d),e.setEnd(n,c),L(n,e),Ee(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},nt.increaseQuoteLevel=St("modifyBlocks",ct),nt.decreaseQuoteLevel=St("modifyBlocks",ht),nt.makeUnorderedList=St("modifyBlocks",pt),nt.makeOrderedList=St("modifyBlocks",gt),nt.removeList=St("modifyBlocks",mt),R.isInline=a,R.isBlock=s,R.isContainer=d,R.getBlockWalker=l,R.getPreviousBlock=c,R.getNextBlock=h,R.areAlike=f,R.hasTagAttributes=p,R.getNearest=g,R.isOrContains=m,R.detach=_,R.replaceWith=C,R.empty=S,R.getNodeBefore=ve,R.getNodeAfter=Ne,R.insertNodeInRange=_e,R.extractContentsOfRange=Ce,R.deleteContentsOfRange=Se,R.insertTreeFragmentIntoRange=ye,R.isNodeContainedInRange=Te,R.moveRangeBoundariesDownTree=Ee,R.moveRangeBoundariesUpTree=be,R.getStartBlockOfRange=ke,R.getEndBlockOfRange=Le,R.contentWalker=xe,R.rangeDoesStartAtBlockBoundary=Ae,R.rangeDoesEndAtBlockBoundary=Oe,R.expandRangeToBlockBoundaries=Be,R.onPaste=et,R.addLinks=_t,R.splitBlock=lt,R.startSelectionId="squire-selection-start",R.endSelectionId=st,"object"==typeof exports?module.exports=R:"function"==typeof define&&define.amd?define(function(){return R}):(q.Squire=R,top!==q&&"true"===e.documentElement.getAttribute("data-squireinit")&&(q.editor=new R(e),q.onEditorLoad&&(q.onEditorLoad(q.editor),q.onEditorLoad=null)))}(document);
>>>>>>> f059409... Allow class names to be configured
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n}function i(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function o(e){return e.nodeType===w&&!!he[e.nodeName]}function r(e){switch(e.nodeType){case F:return fe;case w:case H:if(ae&&me.has(e))return me.get(e);break;default:return ue}var t;return t=i(e.childNodes,a)?ce.test(e.nodeName)?fe:pe:ge,ae&&me.set(e,t),t}function a(e){return r(e)===fe}function s(e){return r(e)===pe}function d(e){return r(e)===ge}function l(e,t){var i=new n(t,W,s);return i.currentNode=e,i}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!o(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var i in n)if(e.getAttribute(i)!==n[i])return!1;return!0}function g(e,t,n,i){for(;e&&e!==t;){if(p(e,n,i))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t,n){var i,o,r,a,s,d="";return e&&e!==t&&(d=v(e.parentNode,t,n),e.nodeType===w&&(d+=(d?">":"")+e.nodeName,(i=e.id)&&(d+="#"+i),(o=e.className.trim())&&(r=o.split(/\s\s*/),r.sort(),d+=".",d+=r.join(".")),(a=e.dir)&&(d+="[dir="+a+"]"),r&&(s=n.classNames,de.call(r,s.highlight)>-1&&(d+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),de.call(r,s.colour)>-1&&(d+="[color="+e.style.color.replace(/ /g,"")+"]"),de.call(r,s.fontFamily)>-1&&(d+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),de.call(r,s.fontSize)>-1&&(d+="[fontSize="+e.style.fontSize+"]")))),d}function _(e){var t=e.nodeType;return t===w||t===H?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,i=n?n.length:0;i--;)t.appendChild(e.firstChild);return t}function y(e,n,i,o){var r,a,s,d=e.createElement(n);if(i instanceof Array&&(o=i,i=null),i)for(r in i)i[r]!==t&&d.setAttribute(r,i[r]);if(o)for(a=0,s=o.length;a<s;a+=1)d.appendChild(o[a]);return d}function T(e,t){var n,i,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((i=e.firstChild)&&"BR"!==i.nodeName||(n=r.createDefaultBlock(),i?e.replaceChild(n,i):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(i=e.firstChild;ie&&i&&i.nodeType===F&&!i.data;)e.removeChild(i),i=e.firstChild;i||(ie?(n=s.createTextNode(z),r._didAddZWS()):n=s.createTextNode(""))}else if(ne){for(;e.nodeType!==F&&!o(e);){if(!(i=e.firstChild)){n=s.createTextNode("");break}e=i}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):o(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=y(s,"BR");(i=e.lastElementChild)&&!a(i);)e=i;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,i,o,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,i=s.length;n<i;n+=1)o=s[n],r="BR"===o.nodeName,!r&&a(o)?(c||(c=y(l,h.blockTag,h.blockAttributes)),c.appendChild(o),n-=1,i-=1):(r||c)&&(c||(c=y(l,h.blockTag,h.blockAttributes)),T(c,t),r?e.replaceChild(c,o):(e.insertBefore(c,o),n+=1,i+=1),c=null),d(o)&&E(o,t);return c&&e.appendChild(T(c,t)),e}function b(e,t,n,i){var o,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,i);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(o=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,i,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),T(e,i),T(r,i),(a=e.nextSibling)?o.insertBefore(r,a):o.appendChild(r),b(o,r,n,i)}return t}function k(e,t){for(var n,i,o,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],i=s&&r[s-1],s&&a(n)&&f(n,i)&&!he[n.nodeName])t.startContainer===n&&(t.startContainer=i,t.startOffset+=_(i)),t.endContainer===n&&(t.endContainer=i,t.endOffset+=_(i)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=i,t.startOffset=_(i))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=i,t.endOffset=_(i))),N(n),n.nodeType===F?i.appendData(n.data):d.push(S(n));else if(n.nodeType===w){for(o=d.length;o--;)n.appendChild(d.pop());k(n,t)}}function L(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function x(e,t,n,i){for(var o,r,a,s=t;(o=s.parentNode)&&o!==i&&o.nodeType===w&&1===o.childNodes.length;)s=o;N(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),L(e,n),Y&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function A(e,t){var n,i,o=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(o&&f(o,e)){if(!d(o)){if(!s)return;i=y(a,"DIV"),i.appendChild(S(o)),o.appendChild(i)}N(e),n=!d(e),o.appendChild(S(e)),n&&E(o,t),r&&A(r,t)}else s&&(o=y(a,"DIV"),e.insertBefore(o,r),T(o,t))}function O(e){this.isShiftDown=e.shiftKey}function B(e,t,n){var i,o;if(e||(e={}),t)for(i in t)!n&&i in e||(o=t[i],e[i]=o&&o.constructor===Object?B(e[i],o,n):o);return e}function R(e,t){e.nodeType===M&&(e=e.body);var n,i=e.ownerDocument,o=i.defaultView;this._win=o,this._doc=i,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,oe&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in i?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,re?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(V?"beforecut":"cut",Xe),this.addEventListener("copy",Je),this.addEventListener("keydown",O),this.addEventListener("keyup",O),this.addEventListener(V?"beforepaste":"paste",et),this.addEventListener("drop",tt),this.addEventListener(Y?"keypress":"keydown",De),this._keyHandlers=Object.create(we),this.setConfig(t),V&&(o.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,i=this.parentNode,o=this.length-e;return n?i.insertBefore(t,n):i.appendChild(t),o&&this.deleteData(e,o),t}),e.setAttribute("contenteditable","true");try{i.execCommand("enableObjectResizing",!1,"false"),i.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var i,o;for(i=t.firstChild;i;i=o){if(o=i.nextSibling,a(i)){if(i.nodeType===F||"BR"===i.nodeName||"IMG"===i.nodeName){n.appendChild(i);continue}}else if(s(i)){n.appendChild(e.createDefaultBlock([I(e,i,e._doc.createDocumentFragment())]));continue}I(e,i,n)}return n}var w=1,F=3,M=9,H=11,W=1,z="​",q=e.defaultView,K=navigator.userAgent,G=/Android/.test(K),Z=/iP(?:ad|hone|od)/.test(K),j=/Mac OS X/.test(K),$=/Windows NT/.test(K),Q=/Gecko\//.test(K),V=/Trident\/[456]\./.test(K),Y=!!q.opera,X=/Edge\//.test(K),J=!X&&/WebKit\//.test(K),ee=/Trident\/[4567]\./.test(K),te=j?"meta-":"ctrl-",ne=V||Y,ie=V||J,oe=V,re="undefined"!=typeof MutationObserver,ae="undefined"!=typeof WeakMap,se=/[^ \t\r\n]/,de=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var le={1:1,2:2,3:4,8:128,9:256,11:1024};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}};var ce=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,he={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},ue=0,fe=1,pe=2,ge=3,me=ae?new WeakMap:null,ve=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},_e=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Ne=function(e,t){var n,i,o,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,i=n.childNodes,s===a.length?(s=de.call(i,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=de.call(i,a)),a=n):i=a.childNodes,o=i.length,s===o?a.appendChild(t):a.insertBefore(t,i[s]),a===d&&(l+=i.length-o),e.setStart(a,s),e.setEnd(d,l)},Ce=function(e,t,n){var i=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(i,o,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return i=t,o=c?de.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[o],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(i=d,o=d.length,d.appendData(l.data),N(l)),e.setStart(i,o),e.collapse(!0),T(t,n),u},Se=function(e,t){var n,i,o=ke(e,t),r=Le(e,t),a=o!==r;return Ee(e),be(e,o,r,t),n=Ce(e,null,t),Ee(e),a&&(r=Le(e,t),o&&r&&o!==r&&x(o,r,e,t)),o&&T(o,t),i=t.firstChild,i&&"BR"!==i.nodeName?e.collapse(!0):(T(t,t),e.selectNodeContents(t.firstChild)),n},ye=function(e,t,n){var i,o,r,s,l,f,p,m,v,C,S;for(E(t,n),i=t;i=h(i,n);)T(i,n);if(e.collapsed||Se(e,n),Ee(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,o=ke(e,n),m=h(t,t),p=!!o&&u(o),o&&m&&!p&&!g(m,t,"PRE")&&!g(m,t,"TABLE")){if(be(e,o,o,n),e.collapse(!0),l=e.endContainer,f=e.endOffset,Ve(o,n,!1),a(l)&&(v=b(l,f,c(l,n),n),l=v.parentNode,f=de.call(l.childNodes,v)),f!==_(l))for(r=n.ownerDocument.createDocumentFragment();i=l.childNodes[f];)r.appendChild(i);x(l,m,e,n),f=de.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,f)}_(t)&&(p&&(e.setEndBefore(o),e.collapse(!1),N(o)),be(e,s,s,n),v=b(e.endContainer,e.endOffset,s,n),C=v?v.previousSibling:s.lastChild,s.insertBefore(t,v),v?e.setEndBefore(v):e.setEnd(s,_(s)),o=Le(e,n),Ee(e),l=e.endContainer,f=e.endOffset,v&&d(v)&&A(v,n),v=C&&C.nextSibling,v&&d(v)&&A(v,n),e.setEnd(l,f)),r&&(S=e.cloneRange(),x(o,r,S,n),e.setEnd(S.endContainer,S.endOffset)),Ee(e)},Te=function(e,t,n){var i=t.ownerDocument.createRange();if(i.selectNode(t),n){var o=e.compareBoundaryPoints(3,i)>-1,r=e.compareBoundaryPoints(1,i)<1;return!o&&!r}var a=e.compareBoundaryPoints(0,i)<1,s=e.compareBoundaryPoints(2,i)>-1;return a&&s},Ee=function(e){for(var t,n=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[i])&&!o(t);)n=t,i=0;if(a)for(;r.nodeType!==F;){if(!(t=r.childNodes[a-1])||o(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=_(r)}else for(;r.nodeType!==F&&(t=r.firstChild)&&!o(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,i)):(e.setStart(n,i),e.setEnd(r,a))},be=function(e,t,n,i){var o,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==i;)o=r.parentNode,a=de.call(o.childNodes,r),r=o;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===i||d!==_(s))break;o=s.parentNode,d=de.call(o.childNodes,s)+1,s=o}e.setStart(r,a),e.setEnd(s,d)},ke=function(e,t){var n,i=e.startContainer;return a(i)?n=c(i,t):i!==t&&s(i)?n=i:(n=ve(i,e.startOffset),n=h(n,t)),n&&Te(e,n,!0)?n:null},Le=function(e,t){var n,i,o=e.endContainer;if(a(o))n=c(o,t);else if(o!==t&&s(o))n=o;else{if(!(n=_e(o,e.endOffset))||!m(t,n))for(n=t;i=n.lastChild;)n=i;n=c(n,t)}return n&&Te(e,n,!0)?n:null},xe=new n(null,4|W,function(e){return e.nodeType===F?se.test(e.data):"IMG"===e.nodeName}),Ae=function(e,t){var n,i=e.startContainer,o=e.startOffset;if(xe.root=null,i.nodeType===F){if(o)return!1;n=i}else if(n=_e(i,o),n&&!m(t,n)&&(n=null),!n&&(n=ve(i,o),n.nodeType===F&&n.length))return!1;return xe.currentNode=n,xe.root=ke(e,t),!xe.previousNode()},Oe=function(e,t){var n,i=e.endContainer,o=e.endOffset;if(xe.root=null,i.nodeType===F){if((n=i.data.length)&&o<n)return!1;xe.currentNode=i}else xe.currentNode=ve(i,o);return xe.root=Le(e,t),!xe.nextNode()},Be=function(e,t){var n,i=ke(e,t),o=Le(e,t);i&&o&&(n=i.parentNode,e.setStart(n,de.call(n.childNodes,i)),n=o.parentNode,e.setEnd(n,de.call(n.childNodes,o)+1))},Re={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},De=function(e){var t=e.keyCode,n=Re[t],i="",o=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),Y&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(i+="alt-"),e.ctrlKey&&(i+="ctrl-"),e.metaKey&&(i+="meta-")),e.shiftKey&&(i+="shift-"),n=i+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,o):o.collapsed||e.ctrlKey||e.metaKey||1!==(e.key||n).length||(this.saveUndoState(o),Se(o,this._root),this._ensureBottomLine(),this.setSelection(o),this._updatePath(o,!0)))},Ue=function(e){return function(t,n){n.preventDefault(),t[e]()}},Pe=function(e,t){return t=t||null,function(n,i){i.preventDefault();var o=n.getSelection();n.hasFormat(e,null,o)?n.changeFormat(null,{tag:e},o):n.changeFormat({tag:e},t,o)}},Ie=function(e,t){try{t||(t=e.getSelection());var n,i=t.startContainer;for(i.nodeType===F&&(i=i.parentNode),n=i;a(n)&&(!n.textContent||n.textContent===z);)i=n,n=i.parentNode;i!==n&&(t.setStart(n,de.call(n.childNodes,i)),t.collapse(!0),n.removeChild(i),s(n)||(n=c(n,e._root)),T(n,e._root),Ee(t)),i===e._root&&(i=i.firstChild)&&"BR"===i.nodeName&&N(i),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},we={enter:function(e,t,n){var i,o,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),Nt(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||Se(n,a),!(i=ke(n,a))||/^T[HD]$/.test(i.nodeName))return o=g(n.endContainer,a,"A"),o&&(o=o.parentNode,be(n,o,o,a),n.collapse(!1)),Ne(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((o=g(i,a,"LI"))&&(i=o),u(i)){if(g(i,a,"UL")||g(i,a,"OL"))return e.decreaseListLevel(n);if(g(i,a,"BLOCKQUOTE"))return e.modifyBlocks(ut,n)}for(r=lt(e,i,n.startContainer,n.startOffset),at(i),je(i),T(i,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===z)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling)&&"BR"!==s.nodeName;)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!Y)break;r=d}n=e.createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var i=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Ae(n,i)){t.preventDefault();var o,r=ke(n,i);if(!r)return;if(E(r.parentNode,i),o=c(r,i)){if(!o.isContentEditable)return void N(o);for(x(o,r,n,i),r=o.parentNode;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(r=r.nextSibling)&&A(r,i),e.setSelection(n)}else if(r){if(g(r,i,"UL")||g(r,i,"OL"))return e.decreaseListLevel(n);if(g(r,i,"BLOCKQUOTE"))return e.modifyBlocks(ht,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){Ie(e)},0);else t.preventDefault(),Se(n,i),Ie(e,n)},delete:function(e,t,n){var i,o,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Oe(n,l)){if(t.preventDefault(),!(i=ke(n,l)))return;if(E(i.parentNode,l),o=h(i,l)){if(!o.isContentEditable)return void N(o);for(x(i,o,n,l),o=i.parentNode;o!==l&&!o.nextSibling;)o=o.parentNode;o!==l&&(o=o.nextSibling)&&A(o,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),be(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),N(d),Ee(n),void Ie(e,n);e.setSelection(r),setTimeout(function(){Ie(e)},0)}else t.preventDefault(),Se(n,l),Ie(e,n)},tab:function(e,t,n){var i,o,r=e._root;if(e._removeZWS(),n.collapsed&&Ae(n,r))for(i=ke(n,r);o=i.parentNode;){if("UL"===o.nodeName||"OL"===o.nodeName){t.preventDefault(),e.increaseListLevel(n);break}i=o}},"shift-tab":function(e,t,n){var i,o=e._root;e._removeZWS(),n.collapsed&&Ae(n,o)&&(i=n.startContainer,(g(i,o,"UL")||g(i,o,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var i,o;e._recordUndoState(n),Nt(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),i=n.endContainer,o=i.parentNode,n.collapsed&&n.endOffset===_(i)&&("A"===i.nodeName?n.setStartAfter(i):"A"!==o.nodeName||i.nextSibling||n.setStartAfter(o)),n.collapsed||(Se(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};j&&Q&&(we["meta-left"]=function(e,t){t.preventDefault();var n=rt(e);n&&n.modify&&n.modify("move","backward","lineboundary")},we["meta-right"]=function(e,t){t.preventDefault();var n=rt(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),j||(we.pageup=function(e){e.moveCursorToStart()},we.pagedown=function(e){e.moveCursorToEnd()}),we[te+"b"]=Pe("B"),we[te+"i"]=Pe("I"),we[te+"u"]=Pe("U"),we[te+"shift-7"]=Pe("S"),we[te+"shift-5"]=Pe("SUB",{tag:"SUP"}),we[te+"shift-6"]=Pe("SUP",{tag:"SUB"}),we[te+"shift-8"]=Ue("makeUnorderedList"),we[te+"shift-9"]=Ue("makeOrderedList"),we[te+"["]=Ue("decreaseQuoteLevel"),we[te+"]"]=Ue("increaseQuoteLevel"),we[te+"y"]=Ue("redo"),we[te+"z"]=Ue("undo"),we[te+"shift-z"]=Ue("redo");var Fe={1:10,2:13,3:16,4:18,5:24,6:32,7:48},Me={backgroundColor:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.highlight,style:"background-color:"+n})}},color:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.colour,style:"color:"+n})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return y(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return y(e,"I")}},fontFamily:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontFamily,style:"font-family:"+n})}},fontSize:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontSize,style:"font-size:"+n})}},textDecoration:{regexp:/^underline/i,replace:function(e){return y(e,"U")}}},He=function(e){return function(t,n){var i=y(t.ownerDocument,e);return n.replaceChild(i,t),i.appendChild(S(t)),i}},We=function(e,t,n){var i,o,r,a,s,d,l=e.style,c=e.ownerDocument;for(i in Me)o=Me[i],(r=l[i])&&o.regexp.test(r)&&(d=o.replace(c,n.classNames,r),s||(s=d),a&&a.appendChild(d),a=d,e.style[i]="");return s&&(a.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(s,e):e.appendChild(s)),a||e},ze={P:We,SPAN:We,STRONG:He("B"),EM:He("I"),INS:He("U"),STRIKE:He("S"),FONT:function(e,t,n){var i,o,r,a,s,d=e.face,l=e.size,c=e.color,h=e.ownerDocument,u=n.classNames;return d&&(i=y(h,"SPAN",{class:u.fontFamily,style:"font-family:"+d}),s=i,a=i),l&&(o=y(h,"SPAN",{class:u.fontSize,style:"font-size:"+Fe[l]+"px"}),s||(s=o),a&&a.appendChild(o),a=o),c&&/^#?([\dA-F]{3}){1,2}$/i.test(c)&&("#"!==c.charAt(0)&&(c="#"+c),r=y(h,"SPAN",{class:u.colour,style:"color:"+c}),s||(s=r),a&&a.appendChild(r),a=r),s||(s=a=y(h,"SPAN")),t.replaceChild(s,e),a.appendChild(S(e)),a},TT:function(e,t,n){var i=y(e.ownerDocument,"SPAN",{class:n.classNames.fontFamily,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(i,e),i.appendChild(S(e)),i}},qe=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Ke=/^(?:HEAD|META|STYLE)/,Ge=new n(null,4|W,function(){return!0}),Ze=function e(t,n,i){var o,r,s,d,l,c,h,u,f,p,g,m,v=t.childNodes;for(o=t;a(o);)o=o.parentNode;for(Ge.root=o,r=0,s=v.length;r<s;r+=1)if(d=v[r],l=d.nodeName,c=d.nodeType,h=ze[l],c===w){if(u=d.childNodes.length,h)d=h(d,t,n);else{if(Ke.test(l)){t.removeChild(d),r-=1,s-=1;continue}if(!qe.test(l)&&!a(d)){r-=1,s+=u-1,t.replaceChild(S(d),d);continue}}u&&e(d,n,i||"PRE"===l)}else{if(c===F){if(g=d.data,f=!se.test(g.charAt(0)),p=!se.test(g.charAt(g.length-1)),i||!f&&!p)continue;if(f){for(Ge.currentNode=d;(m=Ge.previousPONode())&&!("IMG"===(l=m.nodeName)||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/^[ \t\r\n]+/g,m?" ":"")}if(p){for(Ge.currentNode=d;(m=Ge.nextNode())&&!("IMG"===l||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/[ \t\r\n]+$/g,m?" ":"")}if(g){d.data=g;continue}}t.removeChild(d),r-=1,s-=1}return t},je=function e(t){for(var n,i=t.childNodes,r=i.length;r--;)n=i[r],n.nodeType!==w||o(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},$e=function(e){return e.nodeType===w?"BR"===e.nodeName:se.test(e.data)},Qe=function(e,t){for(var i,o=e.parentNode;a(o);)o=o.parentNode;return i=new n(o,4|W,$e),i.currentNode=e,!!i.nextNode()||t&&!i.previousNode()},Ve=function(e,t,n){var i,o,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(i=0;i<l;i+=1)d[i]=Qe(s[i],n);for(;l--;)o=s[l],(r=o.parentNode)&&(d[l]?a(r)||E(r,t):N(o))},Ye=function(e,t,n,i){var o,r,a=t.ownerDocument.body,s=i.willCutCopy;Ve(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),a.appendChild(t),o=t.innerHTML,r=t.innerText||t.textContent,s&&(o=s(o)),$&&(r=r.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",r),a.removeChild(t)},Xe=function(e){var t,n,i,o,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),X||Z||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=ke(l,c),n=Le(l,c),i=t===n&&t||c,o=Se(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==i;)a=r.cloneNode(!1),a.appendChild(o),o=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(o),Ye(d,s,c,this._config),e.preventDefault()}this.setSelection(l)},Je=function(e){var t,n,i,o,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!X&&!Z&&d){for(t=ke(l,c),n=Le(l,c),i=t===n&&t||c,l=l.cloneRange(),Ee(l),be(l,i,i,c),o=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==i;)a=r.cloneNode(!1),a.appendChild(o),o=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(o),Ye(d,s,c,this._config),e.preventDefault()}},et=function(e){var t,n,i,o,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(X&&s){for(t=s.length;t--;)!d&&/^image\/.*/.test(s[t].type)&&(c=!0);c||(s=null)}if(s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],i=n.type,!d&&"text/html"===i)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===i&&(h=n),!d&&/^image\/.*/.test(i)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(o=a&&a.types,!X&&o&&(de.call(o,"text/html")>-1||!Q&&de.call(o,"text/plain")>-1&&de.call(o,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",i=C;C=i;)i=C.nextSibling,N(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u.createRange(g,m,v,_),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)},tt=function(e){for(var t=e.dataTransfer.types,n=t.length,i=!1,o=!1;n--;)switch(t[n]){case"text/plain":i=!0;break;case"text/html":o=!0;break;default:return}(o||i)&&this.saveUndoState()},nt=R.prototype,it=function(e,t,n){var i=n._doc,o=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return o?i.importNode(o,!0):i.createDocumentFragment()};nt.setConfig=function(e){return e=B({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},classNames:{colour:"colour",fontFamily:"font",fontSize:"size",highlight:"highlight"},leafNodeNames:he,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?it:null,willCutCopy:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},nt.createElement=function(e,t,n){return y(this._doc,e,t,n)},nt.createDefaultBlock=function(e){var t=this._config;return T(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},nt.didError=function(e){console.log(e)},nt.getDocument=function(){return this._doc},nt.getRoot=function(){return this._root},nt.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var ot={pathChange:1,select:1,input:1,undoStateChange:1};nt.fireEvent=function(e,t){var n,i,o,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),i=r.length;i--;){o=r[i];try{o.handleEvent?o.handleEvent(t):o.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},nt.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},nt.handleEvent=function(e){this.fireEvent(e.type,e)},nt.addEventListener=function(e,t){var n=this._events[e],i=this._root;return t?(n||(n=this._events[e]=[],ot[e]||("selectionchange"===e&&(i=this._doc),i.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},nt.removeEventListener=function(e,t){var n,i=this._events[e],o=this._root;if(i){if(t)for(n=i.length;n--;)i[n]===t&&i.splice(n,1);else i.length=0;i.length||(delete this._events[e],ot[e]||("selectionchange"===e&&(o=this._doc),o.removeEventListener(e,this,!0)))}return this},nt.createRange=function(e,t,n,i){if(e instanceof this._win.Range)return e.cloneRange();var o=this._doc.createRange();return o.setStart(e,t),n?o.setEnd(n,i):o.setEnd(e,t),o},nt.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,i=e.getBoundingClientRect();return i&&!i.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=z,Ne(e,t),i=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),L(n,e)),i},nt._moveCursorTo=function(e){var t=this._root,n=this.createRange(t,e?0:t.childNodes.length);return Ee(n),this.setSelection(n),this},nt.moveCursorToStart=function(){return this._moveCursorTo(!0)},nt.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var rt=function(e){return e._win.getSelection()||null};nt.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(G&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{Z&&this._win.focus();var t=rt(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},nt.getSelection=function(){var e,t,n,i,r=rt(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&o(t)&&e.setStartBefore(t),n&&o(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,i=e.commonAncestorContainer,m(i.ownerDocument,i)||(e=null)),e||(e=this.createRange(a.firstChild,0)),e},nt.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,i=new n(e.commonAncestorContainer,4|W,function(t){return Te(e,t,!0)}),o=e.startContainer,r=e.endContainer,s=i.currentNode=o,d="",l=!1;for(i.filter(s)||(s=i.nextNode());s;)s.nodeType===F?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===o&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=i.nextNode();return d},nt.getPath=function(){return this._path};var at=function(e,t){for(var i,o,r,s=new n(e,4,function(){return!0},!1);o=s.nextNode();)for(;(r=o.data.indexOf(z))>-1&&(!t||o.parentNode!==t);){if(1===o.length){do{i=o.parentNode,i.removeChild(o),o=i,s.currentNode=i}while(a(o)&&!_(o));break}o.deleteData(r,1)}};nt._didAddZWS=function(){this._hasZWS=!0},nt._removeZWS=function(){this._hasZWS&&(at(this._root),this._hasZWS=!1)},nt._updatePath=function(e,t){if(e){var n,i=e.startContainer,o=e.endContainer;(t||i!==this._lastAnchorNode||o!==this._lastFocusNode)&&(this._lastAnchorNode=i,this._lastFocusNode=o,n=i&&o?i===o?v(o,this._root,this._config):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},nt._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},nt.focus=function(){return this._root.focus(),ee&&this.fireEvent("focus"),this},nt.blur=function(){return this._root.blur(),ee&&this.fireEvent("blur"),this};var st="squire-selection-end";nt._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),i=this.createElement("INPUT",{id:st,type:"hidden"});Ne(e,n),e.collapse(!1),Ne(e,i),2&n.compareDocumentPosition(i)&&(n.id=st,i.id="squire-selection-start",t=n,n=i,i=t),e.setStartAfter(n),e.setEndBefore(i)},nt._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),i=t.querySelector("#"+st);if(n&&i){var o=n.parentNode,r=i.parentNode,a=de.call(o.childNodes,n),s=de.call(r.childNodes,i);o===r&&(s-=1),N(n),N(i),e||(e=this._doc.createRange()),e.setStart(o,a),e.setEnd(r,s),L(o,e),o!==r&&L(r,e),e.collapsed&&(o=e.startContainer,o.nodeType===F&&(r=o.childNodes[e.startOffset],
r&&r.nodeType===F||(r=o.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},nt._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},nt._docWasChanged=function(){if(ae&&(me=new WeakMap),!this._ignoreAllChanges){if(re&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},nt._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,i=this._undoIndex,o=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(i+=1),i<this._undoStackLength&&(o.length=this._undoStackLength=i),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&i>s&&(o.splice(0,i-s),i=s,this._undoStackLength=s),o[i]=n,this._undoIndex=i,this._undoStackLength+=1,this._isInUndoState=!0}},nt.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},nt.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},nt.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},nt.hasFormat=function(e,t,i){if(e=e.toUpperCase(),t||(t={}),!i&&!(i=this.getSelection()))return!1;!i.collapsed&&i.startContainer.nodeType===F&&i.startOffset===i.startContainer.length&&i.startContainer.nextSibling&&i.setStartBefore(i.startContainer.nextSibling),!i.collapsed&&i.endContainer.nodeType===F&&0===i.endOffset&&i.endContainer.previousSibling&&i.setEndAfter(i.endContainer.previousSibling);var o,r,a=this._root,s=i.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===F)return!1;o=new n(s,4,function(e){return Te(i,e,!0)},!1);for(var d=!1;r=o.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},nt.getFontInfo=function(e){var n,i,o,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(i=n.style)&&(!r.color&&(o=i.color)&&(r.color=o,a+=1),!r.backgroundColor&&(o=i.backgroundColor)&&(r.backgroundColor=o,a+=1),!r.family&&(o=i.fontFamily)&&(r.family=o,a+=1),!r.size&&(o=i.fontSize)&&(r.size=o,a+=1)),n=n.parentNode;return r},nt._addFormat=function(e,t,i){var o,r,s,d,l,c,h,u,f=this._root;if(i.collapsed){for(o=T(this.createElement(e,t),f),Ne(i,o),i.setStart(o.firstChild,o.firstChild.length),i.collapse(!0),u=o;a(u);)u=u.parentNode;at(u,o)}else{if(r=new n(i.commonAncestorContainer,4|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Te(i,e,!0)},!1),s=i.startContainer,l=i.startOffset,d=i.endContainer,c=i.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return i;do{h=r.currentNode,!g(h,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),o=this.createElement(e,t),C(h,o),o.appendChild(h))}while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),i=this.createRange(s,l,d,c)}return i},nt._removeFormat=function(e,t,n,i){this._saveRangeToBookmark(n);var o,r=this._doc;n.collapsed&&(ie?(o=r.createTextNode(z),this._didAddZWS()):o=r.createTextNode(""),Ne(n,o));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Te(n,e,!1)){var i,o,r=e.nodeType===F;if(!Te(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(i=e.firstChild;i;i=o)o=i.nextSibling,f(i,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(i){return Te(n,i,!0)&&p(i,e,t)});return i||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),o&&n.collapse(!1),L(s,n),n},nt.changeFormat=function(e,t,n,i){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,i)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged(),this):this};var dt={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},lt=function(e,t,n,i){var o=dt[t.nodeName],r=null,a=b(n,i,t.parentNode,e._root),s=e._config;return o||(o=s.blockTag,r=s.blockAttributes),p(a,o,r)||(t=y(a.ownerDocument,o,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};nt.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var i=this._root,o=ke(n,i),r=Le(n,i);if(o&&r)do{if(e(o)||o===r)break}while(o=h(o,i));return t&&(this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged()),this},nt.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,i=this._root;return Be(t,i),be(t,i,i,i),n=Ce(t,i,i),Ne(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&A(t.endContainer.childNodes[t.endOffset],i),A(t.startContainer.childNodes[t.startOffset],i),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),re||this._docWasChanged(),this};var ct=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},ht=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},ut=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:st,type:"hidden"})])},ft=function(e,t,n){for(var i,o,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;i=s.nextNode();)"LI"===i.parentNode.nodeName&&(i=i.parentNode,s.currentNode=i.lastChild),"LI"!==i.nodeName?(a=e.createElement("LI",h),i.dir&&(a.dir=i.dir),(r=i.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(i)):C(i,e.createElement(n,c,[a])),a.appendChild(S(i)),s.currentNode=a):(i=i.parentNode,(o=i.nodeName)!==n&&/^[OU]L$/.test(o)&&C(i,e.createElement(n,c,[S(i)])))},pt=function(e){return ft(this,e,"UL"),e},gt=function(e){return ft(this,e,"OL"),e},mt=function(e){var t,n,i,o,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)i=a[t],o=S(i),E(o,l),C(i,o);for(t=0,n=d.length;t<n;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([S(r)])):(E(r,l),C(r,S(r)));return e},vt=function(e,t){for(var n=e.commonAncestorContainer,i=e.startContainer,o=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(i===n&&(i=i.childNodes[e.startOffset]),o===n&&(o=o.childNodes[e.endOffset]);i&&i.parentNode!==n;)i=i.parentNode;for(;o&&o.parentNode!==n;)o=o.parentNode;return[n,i,o]};nt.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=vt(e,t);if(!n)return this.focus();var i=n[0],o=n[1],r=n[2];if(!o||o===i.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=i.nodeName,l=o.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),i.insertBefore(l,o));do{s=o===r?null:o.nextSibling,l.appendChild(o)}while(o=s);return s=l.nextSibling,s&&A(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},nt.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=vt(e,t);if(!n)return this.focus();var i=n[0],o=n[1],r=n[2];o||(o=i.firstChild),r||(r=i.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=i.parentNode,d=r.nextSibling?b(i,r.nextSibling,s,t):i.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=i.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=o===r?null:o.nextSibling,i.removeChild(o),l&&"LI"===o.nodeName&&(o=this.createDefaultBlock([S(o)])),s.insertBefore(o,d)}while(o=a);return i.firstChild||N(i),d&&A(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},nt._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},nt.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},nt._getHTML=function(){return this._root.innerHTML},nt._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{T(n,t)}while(n=h(n,t));this._ignoreChange=!0},nt.getHTML=function(e){var t,n,i,o,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ne)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(i=this.createElement("BR"),n.appendChild(i),s.push(i));if(o=this._getHTML().replace(/\u200B/g,""),ne)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),o},nt.setHTML=function(e){var t,n,i,o=this._config,r=o.isSetHTMLSanitized?o.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),Ze(n,o),Ve(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)T(s,a);for(this._ignoreChange=!0;i=a.lastChild;)a.removeChild(i);a.appendChild(n),T(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this.createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},nt.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))Ne(t,e),t.setStartAfter(e);else{for(var n,i,o=this._root,r=ke(t,o)||o;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(n=r.parentNode,i=b(n,r.nextSibling,o,o)),i?o.insertBefore(e,i):(o.appendChild(e),i=this.createDefaultBlock(),o.appendChild(i)),t.setStart(i,0),t.setEnd(i,0),Ee(t)}return this.focus(),this.setSelection(t),this._updatePath(t),re||this._docWasChanged(),this},nt.insertImage=function(e,t){var n=this.createElement("IMG",B({src:e},t,!0));return this.insertElement(n),n};var _t=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)(?:\?[^&?\s]+=[^&?\s]+(?:&[^&?\s]+=[^&?\s]+)*)?/i,Nt=function(e,t,i){for(var o,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,4,function(e){return!g(e,t,"A")},!1),f=i._config.tagAttributes.a;o=u.nextNode();)for(r=o.data,a=o.parentNode;s=_t.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,o)),c=i.createElement("A",B({href:s[1]?/^(?:ht|f)tps?:/i.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[0]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,o),o.data=r=r.slice(l)};nt.insertHTML=function(e,t){var n,i,o,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),i=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&i>-1&&(e=e.slice(n+20,i))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),o=this.createElement("DIV"),o.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(o))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},Nt(r,r,this),Ze(r,l),Ve(r,a,!1),je(r),r.normalize();s=h(s,r);)T(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(ye(u,d.fragment,a),re||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var Ct=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};nt.insertPlainText=function(e,t){var n,i,o,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+Ct(l[n])+'"';for(h+=">",i=0,o=a.length;i<o;i+=1)r=a[i],r=Ct(r).replace(/ (?= )/g,"&nbsp;"),a[i]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var St=function(e,t,n){return function(){return this[e](t,n),this.focus()}};nt.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},nt.bold=St("changeFormat",{tag:"B"}),nt.italic=St("changeFormat",{tag:"I"}),nt.underline=St("changeFormat",{tag:"U"}),nt.strikethrough=St("changeFormat",{tag:"S"}),nt.subscript=St("changeFormat",{tag:"SUB"},{tag:"SUP"}),nt.superscript=St("changeFormat",{tag:"SUP"},{tag:"SUB"}),nt.removeBold=St("changeFormat",null,{tag:"B"}),nt.removeItalic=St("changeFormat",null,{tag:"I"}),nt.removeUnderline=St("changeFormat",null,{tag:"U"}),nt.removeStrikethrough=St("changeFormat",null,{tag:"S"}),nt.removeSubscript=St("changeFormat",null,{tag:"SUB"}),nt.removeSuperscript=St("changeFormat",null,{tag:"SUP"}),nt.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var i=e.indexOf(":")+1;if(i)for(;"/"===e[i];)i+=1;Ne(n,this._doc.createTextNode(e.slice(i)))}return t=B(B({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},nt.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},nt.setFontFace=function(e){var t=this._config.classNames.fontFamily;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},nt.setFontSize=function(e){var t=this._config.classNames.fontSize;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},nt.setTextColour=function(e){var t=this._config.classNames.colour;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},nt.setHighlightColour=function(e){var t=this._config.classNames.highlight;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:t}}),this.focus()},nt.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},nt.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},nt.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Be(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),be(e,n,n,t);for(var i,o,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)i=p.nextSibling,h.appendChild(p),p=i;return I(this,h,u),u.normalize(),p=u.firstChild,i=u.lastChild,o=n.childNodes,p?(n.insertBefore(u,f),d=de.call(o,p),c=de.call(o,i)+1):(d=de.call(o,f),c=d),e.setStart(n,d),e.setEnd(n,c),L(n,e),Ee(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},nt.increaseQuoteLevel=St("modifyBlocks",ct),nt.decreaseQuoteLevel=St("modifyBlocks",ht),nt.makeUnorderedList=St("modifyBlocks",pt),nt.makeOrderedList=St("modifyBlocks",gt),nt.removeList=St("modifyBlocks",mt),R.isInline=a,R.isBlock=s,R.isContainer=d,R.getBlockWalker=l,R.getPreviousBlock=c,R.getNextBlock=h,R.areAlike=f,R.hasTagAttributes=p,R.getNearest=g,R.isOrContains=m,R.detach=N,R.replaceWith=C,R.empty=S,R.getNodeBefore=ve,R.getNodeAfter=_e,R.insertNodeInRange=Ne,R.extractContentsOfRange=Ce,R.deleteContentsOfRange=Se,R.insertTreeFragmentIntoRange=ye,R.isNodeContainedInRange=Te,R.moveRangeBoundariesDownTree=Ee,R.moveRangeBoundariesUpTree=be,R.getStartBlockOfRange=ke,R.getEndBlockOfRange=Le,R.contentWalker=xe,R.rangeDoesStartAtBlockBoundary=Ae,R.rangeDoesEndAtBlockBoundary=Oe,R.expandRangeToBlockBoundaries=Be,R.onPaste=et,R.addLinks=Nt,R.splitBlock=lt,R.startSelectionId="squire-selection-start",R.endSelectionId=st,"object"==typeof exports?module.exports=R:"function"==typeof define&&define.amd?define(function(){return R}):(q.Squire=R,top!==q&&"true"===e.documentElement.getAttribute("data-squireinit")&&(q.editor=new R(e),q.onEditorLoad&&(q.onEditorLoad(q.editor),q.onEditorLoad=null)))}(document);
>>>>>>> e3e7c17... Add config.willCutCopy option
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n||ce}function i(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function o(e){return e.nodeType===w&&!!ue[e.nodeName]}function r(e){switch(e.nodeType){case F:return pe;case w:case H:if(ae&&ve.has(e))return ve.get(e);break;default:return fe}var t;return t=i(e.childNodes,a)?he.test(e.nodeName)?pe:ge:me,ae&&ve.set(e,t),t}function a(e){return r(e)===pe}function s(e){return r(e)===ge}function d(e){return r(e)===me}function l(e,t){var i=new n(t,W,s);return i.currentNode=e,i}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!o(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var i in n)if(e.getAttribute(i)!==n[i])return!1;return!0}function g(e,t,n,i){for(;e&&e!==t;){if(p(e,n,i))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t,n){var i,o,r,a,s,d="";return e&&e!==t&&(d=v(e.parentNode,t,n),e.nodeType===w&&(d+=(d?">":"")+e.nodeName,(i=e.id)&&(d+="#"+i),(o=e.className.trim())&&(r=o.split(/\s\s*/),r.sort(),d+=".",d+=r.join(".")),(a=e.dir)&&(d+="[dir="+a+"]"),r&&(s=n.classNames,de.call(r,s.highlight)>-1&&(d+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),de.call(r,s.colour)>-1&&(d+="[color="+e.style.color.replace(/ /g,"")+"]"),de.call(r,s.fontFamily)>-1&&(d+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),de.call(r,s.fontSize)>-1&&(d+="[fontSize="+e.style.fontSize+"]")))),d}function _(e){var t=e.nodeType;return t===w||t===H?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,i=n?n.length:0;i--;)t.appendChild(e.firstChild);return t}function y(e,n,i,o){var r,a,s,d=e.createElement(n);if(i instanceof Array&&(o=i,i=null),i)for(r in i)i[r]!==t&&d.setAttribute(r,i[r]);if(o)for(a=0,s=o.length;a<s;a+=1)d.appendChild(o[a]);return d}function T(e,t){var n,i,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((i=e.firstChild)&&"BR"!==i.nodeName||(n=r.createDefaultBlock(),i?e.replaceChild(n,i):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(i=e.firstChild;ie&&i&&i.nodeType===F&&!i.data;)e.removeChild(i),i=e.firstChild;i||(ie?(n=s.createTextNode(z),r._didAddZWS()):n=s.createTextNode(""))}else if(ne){for(;e.nodeType!==F&&!o(e);){if(!(i=e.firstChild)){n=s.createTextNode("");break}e=i}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):o(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=y(s,"BR");(i=e.lastElementChild)&&!a(i);)e=i;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,i,o,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,i=s.length;n<i;n+=1)o=s[n],r="BR"===o.nodeName,!r&&a(o)?(c||(c=y(l,h.blockTag,h.blockAttributes)),c.appendChild(o),n-=1,i-=1):(r||c)&&(c||(c=y(l,h.blockTag,h.blockAttributes)),T(c,t),r?e.replaceChild(c,o):(e.insertBefore(c,o),n+=1,i+=1),c=null),d(o)&&E(o,t);return c&&e.appendChild(T(c,t)),e}function b(e,t,n,i){var o,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,i);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(o=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,i,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),T(e,i),T(r,i),(a=e.nextSibling)?o.insertBefore(r,a):o.appendChild(r),b(o,r,n,i)}return t}function k(e,t){for(var n,i,o,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],i=s&&r[s-1],s&&a(n)&&f(n,i)&&!ue[n.nodeName])t.startContainer===n&&(t.startContainer=i,t.startOffset+=_(i)),t.endContainer===n&&(t.endContainer=i,t.endOffset+=_(i)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=i,t.startOffset=_(i))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=i,t.endOffset=_(i))),N(n),n.nodeType===F?i.appendData(n.data):d.push(S(n));else if(n.nodeType===w){for(o=d.length;o--;)n.appendChild(d.pop());k(n,t)}}function L(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function x(e,t,n,i){for(var o,r,a,s=t;(o=s.parentNode)&&o!==i&&o.nodeType===w&&1===o.childNodes.length;)s=o;N(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),L(e,n),Y&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function A(e,t){var n,i,o=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(o&&f(o,e)){if(!d(o)){if(!s)return;i=y(a,"DIV"),i.appendChild(S(o)),o.appendChild(i)}N(e),n=!d(e),o.appendChild(S(e)),n&&E(o,t),r&&A(r,t)}else s&&(o=y(a,"DIV"),e.insertBefore(o,r),T(o,t))}function O(e){this.isShiftDown=e.shiftKey}function B(e,t,n){var i,o;if(e||(e={}),t)for(i in t)!n&&i in e||(o=t[i],e[i]=o&&o.constructor===Object?B(e[i],o,n):o);return e}function R(e,t){e.nodeType===M&&(e=e.body);var n,i=e.ownerDocument,o=i.defaultView;this._win=o,this._doc=i,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,oe&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in i?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,re?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(V?"beforecut":"cut",Je),this.addEventListener("copy",et),this.addEventListener("keydown",O),this.addEventListener("keyup",O),this.addEventListener(V?"beforepaste":"paste",tt),this.addEventListener("drop",nt),this.addEventListener(Y?"keypress":"keydown",Ue),this._keyHandlers=Object.create(Fe),this.setConfig(t),V&&(o.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,i=this.parentNode,o=this.length-e;return n?i.insertBefore(t,n):i.appendChild(t),o&&this.deleteData(e,o),t}),e.setAttribute("contenteditable","true");try{i.execCommand("enableObjectResizing",!1,"false"),i.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var i,o;for(i=t.firstChild;i;i=o){if(o=i.nextSibling,a(i)){if(i.nodeType===F||"BR"===i.nodeName||"IMG"===i.nodeName){n.appendChild(i);continue}}else if(s(i)){n.appendChild(e.createDefaultBlock([I(e,i,e._doc.createDocumentFragment())]));continue}I(e,i,n)}return n}var w=1,F=3,M=9,H=11,W=1,z="​",q=e.defaultView,K=navigator.userAgent,G=/Android/.test(K),Z=/iP(?:ad|hone|od)/.test(K),j=/Mac OS X/.test(K),$=/Windows NT/.test(K),Q=/Gecko\//.test(K),V=/Trident\/[456]\./.test(K),Y=!!q.opera,X=/Edge\//.test(K),J=!X&&/WebKit\//.test(K),ee=/Trident\/[4567]\./.test(K),te=j?"meta-":"ctrl-",ne=V||Y,ie=V||J,oe=V,re="undefined"!=typeof MutationObserver,ae="undefined"!=typeof WeakMap,se=/[^ \t\r\n]/,de=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var le={1:1,2:2,3:4,8:128,9:256,11:1024},ce=function(){return!0};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}};var he=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,ue={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},fe=0,pe=1,ge=2,me=3,ve=ae?new WeakMap:null,_e=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Ne=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Ce=function(e,t){var n,i,o,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,i=n.childNodes,s===a.length?(s=de.call(i,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=de.call(i,a)),a=n):i=a.childNodes,o=i.length,s===o?a.appendChild(t):a.insertBefore(t,i[s]),a===d&&(l+=i.length-o),e.setStart(a,s),e.setEnd(d,l)},Se=function(e,t,n){var i=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(i,o,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return i=t,o=c?de.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[o],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(i=d,o=d.length,d.appendData(l.data),N(l)),e.setStart(i,o),e.collapse(!0),T(t,n),u},ye=function(e,t){var n,i,o=Le(e,t),r=xe(e,t),a=o!==r;return be(e),ke(e,o,r,t),n=Se(e,null,t),be(e),a&&(r=xe(e,t),o&&r&&o!==r&&x(o,r,e,t)),o&&T(o,t),i=t.firstChild,i&&"BR"!==i.nodeName?e.collapse(!0):(T(t,t),e.selectNodeContents(t.firstChild)),n},Te=function(e,t,n){var i,o,r,s,l,f,p,m,v,C,S;for(E(t,n),i=t;i=h(i,n);)T(i,n);if(e.collapsed||ye(e,n),be(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,o=Le(e,n),m=h(t,t),p=!!o&&u(o),o&&m&&!p&&!g(m,t,"PRE")&&!g(m,t,"TABLE")){if(ke(e,o,o,n),e.collapse(!0),l=e.endContainer,f=e.endOffset,Ye(o,n,!1),a(l)&&(v=b(l,f,c(l,n),n),l=v.parentNode,f=de.call(l.childNodes,v)),f!==_(l))for(r=n.ownerDocument.createDocumentFragment();i=l.childNodes[f];)r.appendChild(i);x(l,m,e,n),f=de.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,f)}_(t)&&(p&&(e.setEndBefore(o),e.collapse(!1),N(o)),ke(e,s,s,n),v=b(e.endContainer,e.endOffset,s,n),C=v?v.previousSibling:s.lastChild,s.insertBefore(t,v),v?e.setEndBefore(v):e.setEnd(s,_(s)),o=xe(e,n),be(e),l=e.endContainer,f=e.endOffset,v&&d(v)&&A(v,n),v=C&&C.nextSibling,v&&d(v)&&A(v,n),e.setEnd(l,f)),r&&(S=e.cloneRange(),x(o,r,S,n),e.setEnd(S.endContainer,S.endOffset)),be(e)},Ee=function(e,t,n){var i=t.ownerDocument.createRange();if(i.selectNode(t),n){var o=e.compareBoundaryPoints(3,i)>-1,r=e.compareBoundaryPoints(1,i)<1;return!o&&!r}var a=e.compareBoundaryPoints(0,i)<1,s=e.compareBoundaryPoints(2,i)>-1;return a&&s},be=function(e){for(var t,n=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[i])&&!o(t);)n=t,i=0;if(a)for(;r.nodeType!==F;){if(!(t=r.childNodes[a-1])||o(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=_(r)}else for(;r.nodeType!==F&&(t=r.firstChild)&&!o(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,i)):(e.setStart(n,i),e.setEnd(r,a))},ke=function(e,t,n,i){var o,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==i;)o=r.parentNode,a=de.call(o.childNodes,r),r=o;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===i||d!==_(s))break;o=s.parentNode,d=de.call(o.childNodes,s)+1,s=o}e.setStart(r,a),e.setEnd(s,d)},Le=function(e,t){var n,i=e.startContainer;return a(i)?n=c(i,t):i!==t&&s(i)?n=i:(n=_e(i,e.startOffset),n=h(n,t)),n&&Ee(e,n,!0)?n:null},xe=function(e,t){var n,i,o=e.endContainer;if(a(o))n=c(o,t);else if(o!==t&&s(o))n=o;else{if(!(n=Ne(o,e.endOffset))||!m(t,n))for(n=t;i=n.lastChild;)n=i;n=c(n,t)}return n&&Ee(e,n,!0)?n:null},Ae=new n(null,4|W,function(e){return e.nodeType===F?se.test(e.data):"IMG"===e.nodeName}),Oe=function(e,t){var n,i=e.startContainer,o=e.startOffset;if(Ae.root=null,i.nodeType===F){if(o)return!1;n=i}else if(n=Ne(i,o),n&&!m(t,n)&&(n=null),!n&&(n=_e(i,o),n.nodeType===F&&n.length))return!1;return Ae.currentNode=n,Ae.root=Le(e,t),!Ae.previousNode()},Be=function(e,t){var n,i=e.endContainer,o=e.endOffset;if(Ae.root=null,i.nodeType===F){if((n=i.data.length)&&o<n)return!1;Ae.currentNode=i}else Ae.currentNode=_e(i,o);return Ae.root=xe(e,t),!Ae.nextNode()},Re=function(e,t){var n,i=Le(e,t),o=xe(e,t);i&&o&&(n=i.parentNode,e.setStart(n,de.call(n.childNodes,i)),n=o.parentNode,e.setEnd(n,de.call(n.childNodes,o)+1))},De={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},Ue=function(e){var t=e.keyCode,n=De[t],i="",o=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),Y&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(i+="alt-"),e.ctrlKey&&(i+="ctrl-"),e.metaKey&&(i+="meta-")),e.shiftKey&&(i+="shift-"),n=i+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,o):o.collapsed||e.ctrlKey||e.metaKey||1!==(e.key||n).length||(this.saveUndoState(o),ye(o,this._root),this._ensureBottomLine(),this.setSelection(o),this._updatePath(o,!0)))},Pe=function(e){return function(t,n){n.preventDefault(),t[e]()}},Ie=function(e,t){return t=t||null,function(n,i){i.preventDefault();var o=n.getSelection();n.hasFormat(e,null,o)?n.changeFormat(null,{tag:e},o):n.changeFormat({tag:e},t,o)}},we=function(e,t){try{t||(t=e.getSelection());var n,i=t.startContainer;for(i.nodeType===F&&(i=i.parentNode),n=i;a(n)&&(!n.textContent||n.textContent===z);)i=n,n=i.parentNode;i!==n&&(t.setStart(n,de.call(n.childNodes,i)),t.collapse(!0),n.removeChild(i),s(n)||(n=c(n,e._root)),T(n,e._root),be(t)),i===e._root&&(i=i.firstChild)&&"BR"===i.nodeName&&N(i),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},Fe={enter:function(e,t,n){var i,o,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),Ct(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||ye(n,a),!(i=Le(n,a))||/^T[HD]$/.test(i.nodeName))return o=g(n.endContainer,a,"A"),o&&(o=o.parentNode,ke(n,o,o,a),n.collapse(!1)),Ce(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((o=g(i,a,"LI"))&&(i=o),u(i)){if(g(i,a,"UL")||g(i,a,"OL"))return e.decreaseListLevel(n);if(g(i,a,"BLOCKQUOTE"))return e.modifyBlocks(ft,n)}for(r=ct(e,i,n.startContainer,n.startOffset),st(i),$e(i),T(i,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===z)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling)&&"BR"!==s.nodeName;)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!Y)break;r=d}n=e.createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},backspace:function(e,t,n){var i=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Oe(n,i)){t.preventDefault();var o,r=Le(n,i);if(!r)return;if(E(r.parentNode,i),o=c(r,i)){if(!o.isContentEditable)return void N(o);for(x(o,r,n,i),r=o.parentNode;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(r=r.nextSibling)&&A(r,i),e.setSelection(n)}else if(r){if(g(r,i,"UL")||g(r,i,"OL"))return e.decreaseListLevel(n);if(g(r,i,"BLOCKQUOTE"))return e.modifyBlocks(ut,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){we(e)},0);else t.preventDefault(),ye(n,i),we(e,n)},delete:function(e,t,n){var i,o,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Be(n,l)){if(t.preventDefault(),!(i=Le(n,l)))return;if(E(i.parentNode,l),o=h(i,l)){if(!o.isContentEditable)return void N(o);for(x(i,o,n,l),o=i.parentNode;o!==l&&!o.nextSibling;)o=o.parentNode;o!==l&&(o=o.nextSibling)&&A(o,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),ke(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),N(d),be(n),void we(e,n);e.setSelection(r),setTimeout(function(){we(e)},0)}else t.preventDefault(),ye(n,l),we(e,n)},tab:function(e,t,n){var i,o,r=e._root;if(e._removeZWS(),n.collapsed&&Oe(n,r))for(i=Le(n,r);o=i.parentNode;){if("UL"===o.nodeName||"OL"===o.nodeName){t.preventDefault(),e.increaseListLevel(n);break}i=o}},"shift-tab":function(e,t,n){var i,o=e._root;e._removeZWS(),n.collapsed&&Oe(n,o)&&(i=n.startContainer,(g(i,o,"UL")||g(i,o,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var i,o;e._recordUndoState(n),Ct(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),i=n.endContainer,o=i.parentNode,n.collapsed&&n.endOffset===_(i)&&("A"===i.nodeName?n.setStartAfter(i):"A"!==o.nodeName||i.nextSibling||n.setStartAfter(o)),n.collapsed||(ye(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};j&&Q&&(Fe["meta-left"]=function(e,t){t.preventDefault();var n=at(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Fe["meta-right"]=function(e,t){t.preventDefault();var n=at(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),j||(Fe.pageup=function(e){e.moveCursorToStart()},Fe.pagedown=function(e){e.moveCursorToEnd()}),Fe[te+"b"]=Ie("B"),Fe[te+"i"]=Ie("I"),Fe[te+"u"]=Ie("U"),Fe[te+"shift-7"]=Ie("S"),Fe[te+"shift-5"]=Ie("SUB",{tag:"SUP"}),Fe[te+"shift-6"]=Ie("SUP",{tag:"SUB"}),Fe[te+"shift-8"]=Pe("makeUnorderedList"),Fe[te+"shift-9"]=Pe("makeOrderedList"),Fe[te+"["]=Pe("decreaseQuoteLevel"),Fe[te+"]"]=Pe("increaseQuoteLevel"),Fe[te+"y"]=Pe("redo"),Fe[te+"z"]=Pe("undo"),Fe[te+"shift-z"]=Pe("redo");var Me={1:10,2:13,3:16,4:18,5:24,6:32,7:48},He={backgroundColor:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.highlight,style:"background-color:"+n})}},color:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.colour,style:"color:"+n})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return y(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return y(e,"I")}},fontFamily:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontFamily,style:"font-family:"+n})}},fontSize:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontSize,style:"font-size:"+n})}},textDecoration:{regexp:/^underline/i,replace:function(e){return y(e,"U")}}},We=function(e){return function(t,n){var i=y(t.ownerDocument,e);return n.replaceChild(i,t),i.appendChild(S(t)),i}},ze=function(e,t,n){var i,o,r,a,s,d,l=e.style,c=e.ownerDocument;for(i in He)o=He[i],(r=l[i])&&o.regexp.test(r)&&(d=o.replace(c,n.classNames,r),s||(s=d),a&&a.appendChild(d),a=d,e.style[i]="");return s&&(a.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(s,e):e.appendChild(s)),a||e},qe={P:ze,SPAN:ze,STRONG:We("B"),EM:We("I"),INS:We("U"),STRIKE:We("S"),FONT:function(e,t,n){var i,o,r,a,s,d=e.face,l=e.size,c=e.color,h=e.ownerDocument,u=n.classNames;return d&&(i=y(h,"SPAN",{class:u.fontFamily,style:"font-family:"+d}),s=i,a=i),l&&(o=y(h,"SPAN",{class:u.fontSize,style:"font-size:"+Me[l]+"px"}),s||(s=o),a&&a.appendChild(o),a=o),c&&/^#?([\dA-F]{3}){1,2}$/i.test(c)&&("#"!==c.charAt(0)&&(c="#"+c),r=y(h,"SPAN",{class:u.colour,style:"color:"+c}),s||(s=r),a&&a.appendChild(r),a=r),s||(s=a=y(h,"SPAN")),t.replaceChild(s,e),a.appendChild(S(e)),a},TT:function(e,t,n){var i=y(e.ownerDocument,"SPAN",{class:n.classNames.fontFamily,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(i,e),i.appendChild(S(e)),i}},Ke=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Ge=/^(?:HEAD|META|STYLE)/,Ze=new n(null,4|W),je=function e(t,n,i){var o,r,s,d,l,c,h,u,f,p,g,m,v=t.childNodes;for(o=t;a(o);)o=o.parentNode;for(Ze.root=o,r=0,s=v.length;r<s;r+=1)if(d=v[r],l=d.nodeName,c=d.nodeType,h=qe[l],c===w){if(u=d.childNodes.length,h)d=h(d,t,n);else{if(Ge.test(l)){t.removeChild(d),r-=1,s-=1;continue}if(!Ke.test(l)&&!a(d)){r-=1,s+=u-1,t.replaceChild(S(d),d);continue}}u&&e(d,n,i||"PRE"===l)}else{if(c===F){if(g=d.data,f=!se.test(g.charAt(0)),p=!se.test(g.charAt(g.length-1)),i||!f&&!p)continue;if(f){for(Ze.currentNode=d;(m=Ze.previousPONode())&&!("IMG"===(l=m.nodeName)||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/^[ \t\r\n]+/g,m?" ":"")}if(p){for(Ze.currentNode=d;(m=Ze.nextNode())&&!("IMG"===l||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/[ \t\r\n]+$/g,m?" ":"")}if(g){d.data=g;continue}}t.removeChild(d),r-=1,s-=1}return t},$e=function e(t){for(var n,i=t.childNodes,r=i.length;r--;)n=i[r],n.nodeType!==w||o(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},Qe=function(e){return e.nodeType===w?"BR"===e.nodeName:se.test(e.data)},Ve=function(e,t){for(var i,o=e.parentNode;a(o);)o=o.parentNode;return i=new n(o,4|W,Qe),i.currentNode=e,!!i.nextNode()||t&&!i.previousNode()},Ye=function(e,t,n){var i,o,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(i=0;i<l;i+=1)d[i]=Ve(s[i],n);for(;l--;)o=s[l],(r=o.parentNode)&&(d[l]?a(r)||E(r,t):N(o))},Xe=function(e,t,n,i){var o,r,a=t.ownerDocument.body,s=i.willCutCopy;Ye(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),a.appendChild(t),o=t.innerHTML,r=t.innerText||t.textContent,s&&(o=s(o)),$&&(r=r.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",r),a.removeChild(t)},Je=function(e){var t,n,i,o,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),X||Z||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Le(l,c),n=xe(l,c),i=t===n&&t||c,o=ye(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==i;)a=r.cloneNode(!1),a.appendChild(o),o=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(o),Xe(d,s,c,this._config),e.preventDefault()}this.setSelection(l)},et=function(e){var t,n,i,o,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!X&&!Z&&d){for(t=Le(l,c),n=xe(l,c),i=t===n&&t||c,l=l.cloneRange(),be(l),ke(l,i,i,c),o=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==i;)a=r.cloneNode(!1),a.appendChild(o),o=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(o),Xe(d,s,c,this._config),e.preventDefault()}},tt=function(e){var t,n,i,o,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(X&&s){for(t=s.length;t--;)!d&&/^image\/.*/.test(s[t].type)&&(c=!0);c||(s=null)}if(s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],i=n.type,!d&&"text/html"===i)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===i&&(h=n),!d&&/^image\/.*/.test(i)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(o=a&&a.types,!X&&o&&(de.call(o,"text/html")>-1||!Q&&de.call(o,"text/plain")>-1&&de.call(o,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",i=C;C=i;)i=C.nextSibling,N(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u.createRange(g,m,v,_),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)},nt=function(e){for(var t=e.dataTransfer.types,n=t.length,i=!1,o=!1;n--;)switch(t[n]){case"text/plain":i=!0;break;case"text/html":o=!0;break;default:return}(o||i)&&this.saveUndoState()},it=R.prototype,ot=function(e,t,n){var i=n._doc,o=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return o?i.importNode(o,!0):i.createDocumentFragment()};it.setConfig=function(e){return e=B({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},classNames:{colour:"colour",fontFamily:"font",fontSize:"size",highlight:"highlight"},leafNodeNames:ue,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?ot:null,willCutCopy:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},it.createElement=function(e,t,n){return y(this._doc,e,t,n)},it.createDefaultBlock=function(e){var t=this._config;return T(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},it.didError=function(e){console.log(e)},it.getDocument=function(){return this._doc},it.getRoot=function(){return this._root},it.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var rt={pathChange:1,select:1,input:1,undoStateChange:1};it.fireEvent=function(e,t){var n,i,o,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),i=r.length;i--;){o=r[i];try{o.handleEvent?o.handleEvent(t):o.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},it.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},it.handleEvent=function(e){this.fireEvent(e.type,e)},it.addEventListener=function(e,t){var n=this._events[e],i=this._root;return t?(n||(n=this._events[e]=[],rt[e]||("selectionchange"===e&&(i=this._doc),i.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},it.removeEventListener=function(e,t){var n,i=this._events[e],o=this._root;if(i){if(t)for(n=i.length;n--;)i[n]===t&&i.splice(n,1);else i.length=0;i.length||(delete this._events[e],rt[e]||("selectionchange"===e&&(o=this._doc),o.removeEventListener(e,this,!0)))}return this},it.createRange=function(e,t,n,i){if(e instanceof this._win.Range)return e.cloneRange();var o=this._doc.createRange();return o.setStart(e,t),n?o.setEnd(n,i):o.setEnd(e,t),o},it.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,i=e.getBoundingClientRect();return i&&!i.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=z,Ce(e,t),i=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),L(n,e)),i},it._moveCursorTo=function(e){var t=this._root,n=this.createRange(t,e?0:t.childNodes.length);return be(n),this.setSelection(n),this},it.moveCursorToStart=function(){return this._moveCursorTo(!0)},it.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var at=function(e){return e._win.getSelection()||null};it.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(G&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{Z&&this._win.focus();var t=at(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},it.getSelection=function(){var e,t,n,i,r=at(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&o(t)&&e.setStartBefore(t),n&&o(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,i=e.commonAncestorContainer,m(i.ownerDocument,i)||(e=null)),e||(e=this.createRange(a.firstChild,0)),e},it.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,i=new n(e.commonAncestorContainer,4|W,function(t){return Ee(e,t,!0)}),o=e.startContainer,r=e.endContainer,s=i.currentNode=o,d="",l=!1;for(i.filter(s)||(s=i.nextNode());s;)s.nodeType===F?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===o&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=i.nextNode();return d},it.getPath=function(){return this._path};var st=function(e,t){for(var i,o,r,s=new n(e,4);o=s.nextNode();)for(;(r=o.data.indexOf(z))>-1&&(!t||o.parentNode!==t);){if(1===o.length){do{i=o.parentNode,i.removeChild(o),o=i,s.currentNode=i}while(a(o)&&!_(o));break}o.deleteData(r,1)}};it._didAddZWS=function(){this._hasZWS=!0},it._removeZWS=function(){this._hasZWS&&(st(this._root),this._hasZWS=!1)},it._updatePath=function(e,t){if(e){var n,i=e.startContainer,o=e.endContainer;(t||i!==this._lastAnchorNode||o!==this._lastFocusNode)&&(this._lastAnchorNode=i,this._lastFocusNode=o,n=i&&o?i===o?v(o,this._root,this._config):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},it._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},it.focus=function(){return this._root.focus(),ee&&this.fireEvent("focus"),this},it.blur=function(){return this._root.blur(),ee&&this.fireEvent("blur"),this};var dt="squire-selection-end";it._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),i=this.createElement("INPUT",{id:dt,type:"hidden"});Ce(e,n),e.collapse(!1),Ce(e,i),2&n.compareDocumentPosition(i)&&(n.id=dt,i.id="squire-selection-start",t=n,n=i,i=t),e.setStartAfter(n),e.setEndBefore(i)},it._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),i=t.querySelector("#"+dt);if(n&&i){var o=n.parentNode,r=i.parentNode,a=de.call(o.childNodes,n),s=de.call(r.childNodes,i);o===r&&(s-=1),N(n),N(i),e||(e=this._doc.createRange()),e.setStart(o,a),e.setEnd(r,s),L(o,e),o!==r&&L(r,e),e.collapsed&&(o=e.startContainer,o.nodeType===F&&(r=o.childNodes[e.startOffset],r&&r.nodeType===F||(r=o.childNodes[e.startOffset-1]),
r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},it._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},it._docWasChanged=function(){if(ae&&(ve=new WeakMap),!this._ignoreAllChanges){if(re&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},it._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,i=this._undoIndex,o=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(i+=1),i<this._undoStackLength&&(o.length=this._undoStackLength=i),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&i>s&&(o.splice(0,i-s),i=s,this._undoStackLength=s),o[i]=n,this._undoIndex=i,this._undoStackLength+=1,this._isInUndoState=!0}},it.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},it.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},it.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},it.hasFormat=function(e,t,i){if(e=e.toUpperCase(),t||(t={}),!i&&!(i=this.getSelection()))return!1;!i.collapsed&&i.startContainer.nodeType===F&&i.startOffset===i.startContainer.length&&i.startContainer.nextSibling&&i.setStartBefore(i.startContainer.nextSibling),!i.collapsed&&i.endContainer.nodeType===F&&0===i.endOffset&&i.endContainer.previousSibling&&i.setEndAfter(i.endContainer.previousSibling);var o,r,a=this._root,s=i.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===F)return!1;o=new n(s,4,function(e){return Ee(i,e,!0)});for(var d=!1;r=o.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},it.getFontInfo=function(e){var n,i,o,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(i=n.style)&&(!r.color&&(o=i.color)&&(r.color=o,a+=1),!r.backgroundColor&&(o=i.backgroundColor)&&(r.backgroundColor=o,a+=1),!r.family&&(o=i.fontFamily)&&(r.family=o,a+=1),!r.size&&(o=i.fontSize)&&(r.size=o,a+=1)),n=n.parentNode;return r},it._addFormat=function(e,t,i){var o,r,s,d,l,c,h,u,f=this._root;if(i.collapsed){for(o=T(this.createElement(e,t),f),Ce(i,o),i.setStart(o.firstChild,o.firstChild.length),i.collapse(!0),u=o;a(u);)u=u.parentNode;st(u,o)}else{if(r=new n(i.commonAncestorContainer,4|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Ee(i,e,!0)}),s=i.startContainer,l=i.startOffset,d=i.endContainer,c=i.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return i;do{h=r.currentNode,!g(h,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),o=this.createElement(e,t),C(h,o),o.appendChild(h))}while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),i=this.createRange(s,l,d,c)}return i},it._removeFormat=function(e,t,n,i){this._saveRangeToBookmark(n);var o,r=this._doc;n.collapsed&&(ie?(o=r.createTextNode(z),this._didAddZWS()):o=r.createTextNode(""),Ce(n,o));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Ee(n,e,!1)){var i,o,r=e.nodeType===F;if(!Ee(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(i=e.firstChild;i;i=o)o=i.nextSibling,f(i,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(i){return Ee(n,i,!0)&&p(i,e,t)});return i||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),o&&n.collapse(!1),L(s,n),n},it.changeFormat=function(e,t,n,i){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,i)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged(),this):this};var lt={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},ct=function(e,t,n,i){var o=lt[t.nodeName],r=null,a=b(n,i,t.parentNode,e._root),s=e._config;return o||(o=s.blockTag,r=s.blockAttributes),p(a,o,r)||(t=y(a.ownerDocument,o,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};it.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var i=this._root,o=Le(n,i),r=xe(n,i);if(o&&r)do{if(e(o)||o===r)break}while(o=h(o,i));return t&&(this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged()),this},it.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,i=this._root;return Re(t,i),ke(t,i,i,i),n=Se(t,i,i),Ce(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&A(t.endContainer.childNodes[t.endOffset],i),A(t.startContainer.childNodes[t.startOffset],i),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),re||this._docWasChanged(),this};var ht=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},ut=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},ft=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:dt,type:"hidden"})])},pt=function(e,t,n){for(var i,o,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;i=s.nextNode();)"LI"===i.parentNode.nodeName&&(i=i.parentNode,s.currentNode=i.lastChild),"LI"!==i.nodeName?(a=e.createElement("LI",h),i.dir&&(a.dir=i.dir),(r=i.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(i)):C(i,e.createElement(n,c,[a])),a.appendChild(S(i)),s.currentNode=a):(i=i.parentNode,(o=i.nodeName)!==n&&/^[OU]L$/.test(o)&&C(i,e.createElement(n,c,[S(i)])))},gt=function(e){return pt(this,e,"UL"),e},mt=function(e){return pt(this,e,"OL"),e},vt=function(e){var t,n,i,o,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)i=a[t],o=S(i),E(o,l),C(i,o);for(t=0,n=d.length;t<n;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([S(r)])):(E(r,l),C(r,S(r)));return e},_t=function(e,t){for(var n=e.commonAncestorContainer,i=e.startContainer,o=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(i===n&&(i=i.childNodes[e.startOffset]),o===n&&(o=o.childNodes[e.endOffset]);i&&i.parentNode!==n;)i=i.parentNode;for(;o&&o.parentNode!==n;)o=o.parentNode;return[n,i,o]};it.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=_t(e,t);if(!n)return this.focus();var i=n[0],o=n[1],r=n[2];if(!o||o===i.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=i.nodeName,l=o.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),i.insertBefore(l,o));do{s=o===r?null:o.nextSibling,l.appendChild(o)}while(o=s);return s=l.nextSibling,s&&A(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},it.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=_t(e,t);if(!n)return this.focus();var i=n[0],o=n[1],r=n[2];o||(o=i.firstChild),r||(r=i.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=i.parentNode,d=r.nextSibling?b(i,r.nextSibling,s,t):i.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=i.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=o===r?null:o.nextSibling,i.removeChild(o),l&&"LI"===o.nodeName&&(o=this.createDefaultBlock([S(o)])),s.insertBefore(o,d)}while(o=a);return i.firstChild||N(i),d&&A(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},it._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},it.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},it._getHTML=function(){return this._root.innerHTML},it._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{T(n,t)}while(n=h(n,t));this._ignoreChange=!0},it.getHTML=function(e){var t,n,i,o,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ne)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(i=this.createElement("BR"),n.appendChild(i),s.push(i));if(o=this._getHTML().replace(/\u200B/g,""),ne)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),o},it.setHTML=function(e){var t,n,i,o=this._config,r=o.isSetHTMLSanitized?o.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),je(n,o),Ye(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)T(s,a);for(this._ignoreChange=!0;i=a.lastChild;)a.removeChild(i);a.appendChild(n),T(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this.createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},it.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))Ce(t,e),t.setStartAfter(e);else{for(var n,i,o=this._root,r=Le(t,o)||o;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(n=r.parentNode,i=b(n,r.nextSibling,o,o)),i?o.insertBefore(e,i):(o.appendChild(e),i=this.createDefaultBlock(),o.appendChild(i)),t.setStart(i,0),t.setEnd(i,0),be(t)}return this.focus(),this.setSelection(t),this._updatePath(t),re||this._docWasChanged(),this},it.insertImage=function(e,t){var n=this.createElement("IMG",B({src:e},t,!0));return this.insertElement(n),n};var Nt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)(?:\?[^&?\s]+=[^&?\s]+(?:&[^&?\s]+=[^&?\s]+)*)?/i,Ct=function(e,t,i){for(var o,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,4,function(e){return!g(e,t,"A")}),f=i._config.tagAttributes.a;o=u.nextNode();)for(r=o.data,a=o.parentNode;s=Nt.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,o)),c=i.createElement("A",B({href:s[1]?/^(?:ht|f)tps?:/i.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[0]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,o),o.data=r=r.slice(l)};it.insertHTML=function(e,t){var n,i,o,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),i=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&i>-1&&(e=e.slice(n+20,i))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),o=this.createElement("DIV"),o.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(o))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},Ct(r,r,this),je(r,l),Ye(r,a,!1),$e(r),r.normalize();s=h(s,r);)T(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Te(u,d.fragment,a),re||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var St=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};it.insertPlainText=function(e,t){var n,i,o,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+St(l[n])+'"';for(h+=">",i=0,o=a.length;i<o;i+=1)r=a[i],r=St(r).replace(/ (?= )/g,"&nbsp;"),a[i]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var yt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};it.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},it.bold=yt("changeFormat",{tag:"B"}),it.italic=yt("changeFormat",{tag:"I"}),it.underline=yt("changeFormat",{tag:"U"}),it.strikethrough=yt("changeFormat",{tag:"S"}),it.subscript=yt("changeFormat",{tag:"SUB"},{tag:"SUP"}),it.superscript=yt("changeFormat",{tag:"SUP"},{tag:"SUB"}),it.removeBold=yt("changeFormat",null,{tag:"B"}),it.removeItalic=yt("changeFormat",null,{tag:"I"}),it.removeUnderline=yt("changeFormat",null,{tag:"U"}),it.removeStrikethrough=yt("changeFormat",null,{tag:"S"}),it.removeSubscript=yt("changeFormat",null,{tag:"SUB"}),it.removeSuperscript=yt("changeFormat",null,{tag:"SUP"}),it.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var i=e.indexOf(":")+1;if(i)for(;"/"===e[i];)i+=1;Ce(n,this._doc.createTextNode(e.slice(i)))}return t=B(B({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},it.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},it.setFontFace=function(e){var t=this._config.classNames.fontFamily;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},it.setFontSize=function(e){var t=this._config.classNames.fontSize;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},it.setTextColour=function(e){var t=this._config.classNames.colour;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},it.setHighlightColour=function(e){var t=this._config.classNames.highlight;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:t}}),this.focus()},it.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},it.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},it.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Re(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),ke(e,n,n,t);for(var i,o,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)i=p.nextSibling,h.appendChild(p),p=i;return I(this,h,u),u.normalize(),p=u.firstChild,i=u.lastChild,o=n.childNodes,p?(n.insertBefore(u,f),d=de.call(o,p),c=de.call(o,i)+1):(d=de.call(o,f),c=d),e.setStart(n,d),e.setEnd(n,c),L(n,e),be(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},it.increaseQuoteLevel=yt("modifyBlocks",ht),it.decreaseQuoteLevel=yt("modifyBlocks",ut),it.makeUnorderedList=yt("modifyBlocks",gt),it.makeOrderedList=yt("modifyBlocks",mt),it.removeList=yt("modifyBlocks",vt),R.isInline=a,R.isBlock=s,R.isContainer=d,R.getBlockWalker=l,R.getPreviousBlock=c,R.getNextBlock=h,R.areAlike=f,R.hasTagAttributes=p,R.getNearest=g,R.isOrContains=m,R.detach=N,R.replaceWith=C,R.empty=S,R.getNodeBefore=_e,R.getNodeAfter=Ne,R.insertNodeInRange=Ce,R.extractContentsOfRange=Se,R.deleteContentsOfRange=ye,R.insertTreeFragmentIntoRange=Te,R.isNodeContainedInRange=Ee,R.moveRangeBoundariesDownTree=be,R.moveRangeBoundariesUpTree=ke,R.getStartBlockOfRange=Le,R.getEndBlockOfRange=xe,R.contentWalker=Ae,R.rangeDoesStartAtBlockBoundary=Oe,R.rangeDoesEndAtBlockBoundary=Be,R.expandRangeToBlockBoundaries=Re,R.onPaste=tt,R.addLinks=Ct,R.splitBlock=ct,R.startSelectionId="squire-selection-start",R.endSelectionId=dt,"object"==typeof exports?module.exports=R:"function"==typeof define&&define.amd?define(function(){return R}):(q.Squire=R,top!==q&&"true"===e.documentElement.getAttribute("data-squireinit")&&(q.editor=new R(e),q.onEditorLoad&&(q.onEditorLoad(q.editor),q.onEditorLoad=null)))}(document);
>>>>>>> 2d5114c... Make TreeWalker filter argument optional
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n||ce}function i(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function o(e){return e.nodeType===w&&!!ue[e.nodeName]}function r(e){switch(e.nodeType){case F:return pe;case w:case H:if(ae&&ve.has(e))return ve.get(e);break;default:return fe}var t;return t=i(e.childNodes,a)?he.test(e.nodeName)?pe:ge:me,ae&&ve.set(e,t),t}function a(e){return r(e)===pe}function s(e){return r(e)===ge}function d(e){return r(e)===me}function l(e,t){var i=new n(t,W,s);return i.currentNode=e,i}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!o(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var i in n)if(e.getAttribute(i)!==n[i])return!1;return!0}function g(e,t,n,i){for(;e&&e!==t;){if(p(e,n,i))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t,n){var i,o,r,a,s,d="";return e&&e!==t&&(d=v(e.parentNode,t,n),e.nodeType===w&&(d+=(d?">":"")+e.nodeName,(i=e.id)&&(d+="#"+i),(o=e.className.trim())&&(r=o.split(/\s\s*/),r.sort(),d+=".",d+=r.join(".")),(a=e.dir)&&(d+="[dir="+a+"]"),r&&(s=n.classNames,de.call(r,s.highlight)>-1&&(d+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),de.call(r,s.colour)>-1&&(d+="[color="+e.style.color.replace(/ /g,"")+"]"),de.call(r,s.fontFamily)>-1&&(d+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),de.call(r,s.fontSize)>-1&&(d+="[fontSize="+e.style.fontSize+"]")))),d}function _(e){var t=e.nodeType;return t===w||t===H?e.childNodes.length:e.length||0}function N(e){var t=e.parentNode;return t&&t.removeChild(e),e}function C(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,i=n?n.length:0;i--;)t.appendChild(e.firstChild);return t}function y(e,n,i,o){var r,a,s,d=e.createElement(n);if(i instanceof Array&&(o=i,i=null),i)for(r in i)i[r]!==t&&d.setAttribute(r,i[r]);if(o)for(a=0,s=o.length;a<s;a+=1)d.appendChild(o[a]);return d}function T(e,t){var n,i,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((i=e.firstChild)&&"BR"!==i.nodeName||(n=r.createDefaultBlock(),i?e.replaceChild(n,i):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(i=e.firstChild;ie&&i&&i.nodeType===F&&!i.data;)e.removeChild(i),i=e.firstChild;i||(ie?(n=s.createTextNode(z),r._didAddZWS()):n=s.createTextNode(""))}else if(ne){for(;e.nodeType!==F&&!o(e);){if(!(i=e.firstChild)){n=s.createTextNode("");break}e=i}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):o(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=y(s,"BR");(i=e.lastElementChild)&&!a(i);)e=i;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,i,o,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,i=s.length;n<i;n+=1)o=s[n],r="BR"===o.nodeName,!r&&a(o)?(c||(c=y(l,h.blockTag,h.blockAttributes)),c.appendChild(o),n-=1,i-=1):(r||c)&&(c||(c=y(l,h.blockTag,h.blockAttributes)),T(c,t),r?e.replaceChild(c,o):(e.insertBefore(c,o),n+=1,i+=1),c=null),d(o)&&E(o,t);return c&&e.appendChild(T(c,t)),e}function b(e,t,n,i){var o,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,i);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(o=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,i,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),T(e,i),T(r,i),(a=e.nextSibling)?o.insertBefore(r,a):o.appendChild(r),b(o,r,n,i)}return t}function k(e,t){for(var n,i,o,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],i=s&&r[s-1],s&&a(n)&&f(n,i)&&!ue[n.nodeName])t.startContainer===n&&(t.startContainer=i,t.startOffset+=_(i)),t.endContainer===n&&(t.endContainer=i,t.endOffset+=_(i)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=i,t.startOffset=_(i))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=i,t.endOffset=_(i))),N(n),n.nodeType===F?i.appendData(n.data):d.push(S(n));else if(n.nodeType===w){for(o=d.length;o--;)n.appendChild(d.pop());k(n,t)}}function L(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};k(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function x(e,t,n,i){for(var o,r,a,s=t;(o=s.parentNode)&&o!==i&&o.nodeType===w&&1===o.childNodes.length;)s=o;N(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),L(e,n),Y&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function A(e,t){var n,i,o=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(o&&f(o,e)){if(!d(o)){if(!s)return;i=y(a,"DIV"),i.appendChild(S(o)),o.appendChild(i)}N(e),n=!d(e),o.appendChild(S(e)),n&&E(o,t),r&&A(r,t)}else s&&(o=y(a,"DIV"),e.insertBefore(o,r),T(o,t))}function O(e){this.isShiftDown=e.shiftKey}function B(e,t,n){var i,o;if(e||(e={}),t)for(i in t)!n&&i in e||(o=t[i],e[i]=o&&o.constructor===Object?B(e[i],o,n):o);return e}function R(e,t){e.nodeType===M&&(e=e.body);var n,i=e.ownerDocument,o=i.defaultView;this._win=o,this._doc=i,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,oe&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in i?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,re?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",D),this.addEventListener("mousedown",U),this.addEventListener("touchstart",U),this.addEventListener("focus",P),this._awaitingPaste=!1,this.addEventListener(V?"beforecut":"cut",Je),this.addEventListener("copy",et),this.addEventListener("keydown",O),this.addEventListener("keyup",O),this.addEventListener(V?"beforepaste":"paste",tt),this.addEventListener("drop",nt),this.addEventListener(Y?"keypress":"keydown",Ue),this._keyHandlers=Object.create(Fe),this.setConfig(t),V&&(o.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,i=this.parentNode,o=this.length-e;return n?i.insertBefore(t,n):i.appendChild(t),o&&this.deleteData(e,o),t}),e.setAttribute("contenteditable","true");try{i.execCommand("enableObjectResizing",!1,"false"),i.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function D(){this._restoreSelection=!0}function U(){this._restoreSelection=!1}function P(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var i,o;for(i=t.firstChild;i;i=o){if(o=i.nextSibling,a(i)){if(i.nodeType===F||"BR"===i.nodeName||"IMG"===i.nodeName){n.appendChild(i);continue}}else if(s(i)){n.appendChild(e.createDefaultBlock([I(e,i,e._doc.createDocumentFragment())]));continue}I(e,i,n)}return n}var w=1,F=3,M=9,H=11,W=1,z="​",q=e.defaultView,K=navigator.userAgent,G=/Android/.test(K),Z=/iP(?:ad|hone|od)/.test(K),j=/Mac OS X/.test(K),$=/Windows NT/.test(K),Q=/Gecko\//.test(K),V=/Trident\/[456]\./.test(K),Y=!!q.opera,X=/Edge\//.test(K),J=!X&&/WebKit\//.test(K),ee=/Trident\/[4567]\./.test(K),te=j?"meta-":"ctrl-",ne=V||Y,ie=V||J,oe=V,re="undefined"!=typeof MutationObserver,ae="undefined"!=typeof WeakMap,se=/[^ \t\r\n]/,de=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var le={1:1,2:2,3:4,8:128,9:256,11:1024},ce=function(){return!0};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,i=this.nodeType,o=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&i&&o(e))return this.currentNode=e,e;t=e}};var he=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,ue={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},fe=0,pe=1,ge=2,me=3,ve=ae?new WeakMap:null,_e=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Ne=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Ce=function(e,t){var n,i,o,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,i=n.childNodes,s===a.length?(s=de.call(i,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=de.call(i,a)),a=n):i=a.childNodes,o=i.length,s===o?a.appendChild(t):a.insertBefore(t,i[s]),a===d&&(l+=i.length-o),e.setStart(a,s),e.setEnd(d,l)},Se=function(e,t,n){var i=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(i,o,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return i=t,o=c?de.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[o],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(i=d,o=d.length,d.appendData(l.data),N(l)),e.setStart(i,o),e.collapse(!0),T(t,n),u},ye=function(e,t){var n,i,o=Le(e,t),r=xe(e,t),a=o!==r;return be(e),ke(e,o,r,t),n=Se(e,null,t),be(e),a&&(r=xe(e,t),o&&r&&o!==r&&x(o,r,e,t)),o&&T(o,t),i=t.firstChild,i&&"BR"!==i.nodeName?e.collapse(!0):(T(t,t),e.selectNodeContents(t.firstChild)),n},Te=function(e,t,n){var i,o,r,s,l,f,p,m,v,C,S;for(E(t,n),i=t;i=h(i,n);)T(i,n);if(e.collapsed||ye(e,n),be(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,o=Le(e,n),m=h(t,t),p=!!o&&u(o),o&&m&&!p&&!g(m,t,"PRE")&&!g(m,t,"TABLE")){if(ke(e,o,o,n),e.collapse(!0),l=e.endContainer,f=e.endOffset,Ye(o,n,!1),a(l)&&(v=b(l,f,c(l,n),n),l=v.parentNode,f=de.call(l.childNodes,v)),f!==_(l))for(r=n.ownerDocument.createDocumentFragment();i=l.childNodes[f];)r.appendChild(i);x(l,m,e,n),f=de.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,f)}_(t)&&(p&&(e.setEndBefore(o),e.collapse(!1),N(o)),ke(e,s,s,n),v=b(e.endContainer,e.endOffset,s,n),C=v?v.previousSibling:s.lastChild,s.insertBefore(t,v),v?e.setEndBefore(v):e.setEnd(s,_(s)),o=xe(e,n),be(e),l=e.endContainer,f=e.endOffset,v&&d(v)&&A(v,n),v=C&&C.nextSibling,v&&d(v)&&A(v,n),e.setEnd(l,f)),r&&(S=e.cloneRange(),x(o,r,S,n),e.setEnd(S.endContainer,S.endOffset)),be(e)},Ee=function(e,t,n){var i=t.ownerDocument.createRange();if(i.selectNode(t),n){var o=e.compareBoundaryPoints(3,i)>-1,r=e.compareBoundaryPoints(1,i)<1;return!o&&!r}var a=e.compareBoundaryPoints(0,i)<1,s=e.compareBoundaryPoints(2,i)>-1;return a&&s},be=function(e){for(var t,n=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[i])&&!o(t);)n=t,i=0;if(a)for(;r.nodeType!==F;){if(!(t=r.childNodes[a-1])||o(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=_(r)}else for(;r.nodeType!==F&&(t=r.firstChild)&&!o(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,i)):(e.setStart(n,i),e.setEnd(r,a))},ke=function(e,t,n,i){var o,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==i;)o=r.parentNode,a=de.call(o.childNodes,r),r=o;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===i||d!==_(s))break;o=s.parentNode,d=de.call(o.childNodes,s)+1,s=o}e.setStart(r,a),e.setEnd(s,d)},Le=function(e,t){var n,i=e.startContainer;return a(i)?n=c(i,t):i!==t&&s(i)?n=i:(n=_e(i,e.startOffset),n=h(n,t)),n&&Ee(e,n,!0)?n:null},xe=function(e,t){var n,i,o=e.endContainer;if(a(o))n=c(o,t);else if(o!==t&&s(o))n=o;else{if(!(n=Ne(o,e.endOffset))||!m(t,n))for(n=t;i=n.lastChild;)n=i;n=c(n,t)}return n&&Ee(e,n,!0)?n:null},Ae=new n(null,4|W,function(e){return e.nodeType===F?se.test(e.data):"IMG"===e.nodeName}),Oe=function(e,t){var n,i=e.startContainer,o=e.startOffset;if(Ae.root=null,i.nodeType===F){if(o)return!1;n=i}else if(n=Ne(i,o),n&&!m(t,n)&&(n=null),!n&&(n=_e(i,o),n.nodeType===F&&n.length))return!1;return Ae.currentNode=n,Ae.root=Le(e,t),!Ae.previousNode()},Be=function(e,t){var n,i=e.endContainer,o=e.endOffset;if(Ae.root=null,i.nodeType===F){if((n=i.data.length)&&o<n)return!1;Ae.currentNode=i}else Ae.currentNode=_e(i,o);return Ae.root=xe(e,t),!Ae.nextNode()},Re=function(e,t){var n,i=Le(e,t),o=xe(e,t);i&&o&&(n=i.parentNode,e.setStart(n,de.call(n.childNodes,i)),n=o.parentNode,e.setEnd(n,de.call(n.childNodes,o)+1))},De={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},Ue=function(e){var t=e.keyCode,n=De[t],i="",o=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),Y&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(i+="alt-"),e.ctrlKey&&(i+="ctrl-"),e.metaKey&&(i+="meta-")),e.shiftKey&&(i+="shift-"),n=i+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,o):o.collapsed||e.ctrlKey||e.metaKey||1!==(e.key||n).length||(this.saveUndoState(o),ye(o,this._root),this._ensureBottomLine(),this.setSelection(o),this._updatePath(o,!0)))},Pe=function(e){return function(t,n){n.preventDefault(),t[e]()}},Ie=function(e,t){return t=t||null,function(n,i){i.preventDefault();var o=n.getSelection();n.hasFormat(e,null,o)?n.changeFormat(null,{tag:e},o):n.changeFormat({tag:e},t,o)}},we=function(e,t){try{t||(t=e.getSelection());var n,i=t.startContainer;for(i.nodeType===F&&(i=i.parentNode),n=i;a(n)&&(!n.textContent||n.textContent===z);)i=n,n=i.parentNode;i!==n&&(t.setStart(n,de.call(n.childNodes,i)),t.collapse(!0),n.removeChild(i),s(n)||(n=c(n,e._root)),T(n,e._root),be(t)),i===e._root&&(i=i.firstChild)&&"BR"===i.nodeName&&N(i),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},Fe={enter:function(e,t,n){var i,o,r,a=e._root;if(t.preventDefault(),e._recordUndoState(n),Ct(n.startContainer,a,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||ye(n,a),!(i=Le(n,a))||t.shiftKey||/^T[HD]$/.test(i.nodeName))return o=g(n.endContainer,a,"A"),o&&(o=o.parentNode,ke(n,o,o,a),n.collapse(!1)),Ce(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((o=g(i,a,"LI"))&&(i=o),u(i)){if(g(i,a,"UL")||g(i,a,"OL"))return e.decreaseListLevel(n);if(g(i,a,"BLOCKQUOTE"))return e.modifyBlocks(ft,n)}for(r=ct(e,i,n.startContainer,n.startOffset),st(i),$e(i),T(i,a);r.nodeType===w;){var s,d=r.firstChild;if("A"===r.nodeName&&(!r.textContent||r.textContent===z)){d=e._doc.createTextNode(""),C(r,d),r=d;break}for(;d&&d.nodeType===F&&!d.data&&(s=d.nextSibling)&&"BR"!==s.nodeName;)N(d),d=s;if(!d||"BR"===d.nodeName||d.nodeType===F&&!Y)break;r=d}n=e.createRange(r,0),e.setSelection(n),e._updatePath(n,!0)},"shift-enter":function(e,t,n){return e._keyHandlers.enter(e,t,n)},backspace:function(e,t,n){var i=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Oe(n,i)){t.preventDefault();var o,r=Le(n,i);if(!r)return;if(E(r.parentNode,i),o=c(r,i)){if(!o.isContentEditable)return void N(o);for(x(o,r,n,i),r=o.parentNode;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(r=r.nextSibling)&&A(r,i),e.setSelection(n)}else if(r){if(g(r,i,"UL")||g(r,i,"OL"))return e.decreaseListLevel(n);if(g(r,i,"BLOCKQUOTE"))return e.modifyBlocks(ut,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){we(e)},0);else t.preventDefault(),ye(n,i),we(e,n)},delete:function(e,t,n){var i,o,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Be(n,l)){if(t.preventDefault(),!(i=Le(n,l)))return;if(E(i.parentNode,l),o=h(i,l)){if(!o.isContentEditable)return void N(o);for(x(i,o,n,l),o=i.parentNode;o!==l&&!o.nextSibling;)o=o.parentNode;o!==l&&(o=o.nextSibling)&&A(o,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),ke(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),N(d),be(n),void we(e,n);e.setSelection(r),setTimeout(function(){we(e)},0)}else t.preventDefault(),ye(n,l),we(e,n)},tab:function(e,t,n){var i,o,r=e._root;if(e._removeZWS(),n.collapsed&&Oe(n,r))for(i=Le(n,r);o=i.parentNode;){if("UL"===o.nodeName||"OL"===o.nodeName){t.preventDefault(),e.increaseListLevel(n);break}i=o}},"shift-tab":function(e,t,n){var i,o=e._root;e._removeZWS(),n.collapsed&&Oe(n,o)&&(i=n.startContainer,(g(i,o,"UL")||g(i,o,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var i,o;e._recordUndoState(n),Ct(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),i=n.endContainer,o=i.parentNode,n.collapsed&&n.endOffset===_(i)&&("A"===i.nodeName?n.setStartAfter(i):"A"!==o.nodeName||i.nextSibling||n.setStartAfter(o)),n.collapsed||(ye(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};j&&Q&&(Fe["meta-left"]=function(e,t){t.preventDefault();var n=at(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Fe["meta-right"]=function(e,t){t.preventDefault();var n=at(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),j||(Fe.pageup=function(e){e.moveCursorToStart()},Fe.pagedown=function(e){e.moveCursorToEnd()}),Fe[te+"b"]=Ie("B"),Fe[te+"i"]=Ie("I"),Fe[te+"u"]=Ie("U"),Fe[te+"shift-7"]=Ie("S"),Fe[te+"shift-5"]=Ie("SUB",{tag:"SUP"}),Fe[te+"shift-6"]=Ie("SUP",{tag:"SUB"}),Fe[te+"shift-8"]=Pe("makeUnorderedList"),Fe[te+"shift-9"]=Pe("makeOrderedList"),Fe[te+"["]=Pe("decreaseQuoteLevel"),Fe[te+"]"]=Pe("increaseQuoteLevel"),Fe[te+"y"]=Pe("redo"),Fe[te+"z"]=Pe("undo"),Fe[te+"shift-z"]=Pe("redo");var Me={1:10,2:13,3:16,4:18,5:24,6:32,7:48},He={backgroundColor:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.highlight,style:"background-color:"+n})}},color:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.colour,style:"color:"+n})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return y(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return y(e,"I")}},fontFamily:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontFamily,style:"font-family:"+n})}},fontSize:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontSize,style:"font-size:"+n})}},textDecoration:{regexp:/^underline/i,replace:function(e){return y(e,"U")}}},We=function(e){return function(t,n){var i=y(t.ownerDocument,e);return n.replaceChild(i,t),i.appendChild(S(t)),i}},ze=function(e,t,n){var i,o,r,a,s,d,l=e.style,c=e.ownerDocument;for(i in He)o=He[i],(r=l[i])&&o.regexp.test(r)&&(d=o.replace(c,n.classNames,r),s||(s=d),a&&a.appendChild(d),a=d,e.style[i]="");return s&&(a.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(s,e):e.appendChild(s)),a||e},qe={P:ze,SPAN:ze,STRONG:We("B"),EM:We("I"),INS:We("U"),STRIKE:We("S"),FONT:function(e,t,n){var i,o,r,a,s,d=e.face,l=e.size,c=e.color,h=e.ownerDocument,u=n.classNames;return d&&(i=y(h,"SPAN",{class:u.fontFamily,style:"font-family:"+d}),s=i,a=i),l&&(o=y(h,"SPAN",{class:u.fontSize,style:"font-size:"+Me[l]+"px"}),s||(s=o),a&&a.appendChild(o),a=o),c&&/^#?([\dA-F]{3}){1,2}$/i.test(c)&&("#"!==c.charAt(0)&&(c="#"+c),r=y(h,"SPAN",{class:u.colour,style:"color:"+c}),s||(s=r),a&&a.appendChild(r),a=r),s||(s=a=y(h,"SPAN")),t.replaceChild(s,e),a.appendChild(S(e)),a},TT:function(e,t,n){var i=y(e.ownerDocument,"SPAN",{class:n.classNames.fontFamily,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(i,e),i.appendChild(S(e)),i}},Ke=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Ge=/^(?:HEAD|META|STYLE)/,Ze=new n(null,4|W),je=function e(t,n,i){var o,r,s,d,l,c,h,u,f,p,g,m,v=t.childNodes;for(o=t;a(o);)o=o.parentNode;for(Ze.root=o,r=0,s=v.length;r<s;r+=1)if(d=v[r],l=d.nodeName,c=d.nodeType,h=qe[l],c===w){if(u=d.childNodes.length,h)d=h(d,t,n);else{if(Ge.test(l)){t.removeChild(d),r-=1,s-=1;continue}if(!Ke.test(l)&&!a(d)){r-=1,s+=u-1,t.replaceChild(S(d),d);continue}}u&&e(d,n,i||"PRE"===l)}else{if(c===F){if(g=d.data,f=!se.test(g.charAt(0)),p=!se.test(g.charAt(g.length-1)),i||!f&&!p)continue;if(f){for(Ze.currentNode=d;(m=Ze.previousPONode())&&!("IMG"===(l=m.nodeName)||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/^[ \t\r\n]+/g,m?" ":"")}if(p){for(Ze.currentNode=d;(m=Ze.nextNode())&&!("IMG"===l||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/[ \t\r\n]+$/g,m?" ":"")}if(g){d.data=g;continue}}t.removeChild(d),r-=1,s-=1}return t},$e=function e(t){for(var n,i=t.childNodes,r=i.length;r--;)n=i[r],n.nodeType!==w||o(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},Qe=function(e){return e.nodeType===w?"BR"===e.nodeName:se.test(e.data)},Ve=function(e,t){for(var i,o=e.parentNode;a(o);)o=o.parentNode;return i=new n(o,4|W,Qe),i.currentNode=e,!!i.nextNode()||t&&!i.previousNode()},Ye=function(e,t,n){var i,o,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(i=0;i<l;i+=1)d[i]=Ve(s[i],n);for(;l--;)o=s[l],(r=o.parentNode)&&(d[l]?a(r)||E(r,t):N(o))},Xe=function(e,t,n,i){var o,r,a=t.ownerDocument.body,s=i.willCutCopy;Ye(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),a.appendChild(t),o=t.innerHTML,r=t.innerText||t.textContent,s&&(o=s(o)),$&&(r=r.replace(/\r?\n/g,"\r\n")),e.setData("text/html",o),e.setData("text/plain",r),a.removeChild(t)},Je=function(e){var t,n,i,o,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),X||Z||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=Le(l,c),n=xe(l,c),i=t===n&&t||c,o=ye(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==i;)a=r.cloneNode(!1),a.appendChild(o),o=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(o),Xe(d,s,c,this._config),e.preventDefault()}this.setSelection(l)},et=function(e){var t,n,i,o,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!X&&!Z&&d){for(t=Le(l,c),n=xe(l,c),i=t===n&&t||c,l=l.cloneRange(),be(l),ke(l,i,i,c),o=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==i;)a=r.cloneNode(!1),a.appendChild(o),o=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(o),Xe(d,s,c,this._config),e.preventDefault()}},tt=function(e){var t,n,i,o,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(X&&s){for(t=s.length;t--;)!d&&/^image\/.*/.test(s[t].type)&&(c=!0);c||(s=null)}if(s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],i=n.type,!d&&"text/html"===i)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===i&&(h=n),!d&&/^image\/.*/.test(i)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(o=a&&a.types,!X&&o&&(de.call(o,"text/html")>-1||!Q&&de.call(o,"text/plain")>-1&&de.call(o,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,C=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(C),p.selectNodeContents(C),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",i=C;C=i;)i=C.nextSibling,N(C),e=C.firstChild,e&&e===C.lastChild&&"DIV"===e.nodeName&&(C=e),n+=C.innerHTML;t=u.createRange(g,m,v,_),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)},nt=function(e){for(var t=e.dataTransfer.types,n=t.length,i=!1,o=!1;n--;)switch(t[n]){case"text/plain":i=!0;break;case"text/html":o=!0;break;default:return}(o||i)&&this.saveUndoState()},it=R.prototype,ot=function(e,t,n){var i=n._doc,o=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return o?i.importNode(o,!0):i.createDocumentFragment()};it.setConfig=function(e){return e=B({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},classNames:{colour:"colour",fontFamily:"font",fontSize:"size",highlight:"highlight"},leafNodeNames:ue,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?ot:null,willCutCopy:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},it.createElement=function(e,t,n){return y(this._doc,e,t,n)},it.createDefaultBlock=function(e){var t=this._config;return T(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},it.didError=function(e){console.log(e)},it.getDocument=function(){return this._doc},it.getRoot=function(){return this._root},it.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var rt={pathChange:1,select:1,input:1,undoStateChange:1};it.fireEvent=function(e,t){var n,i,o,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),i=r.length;i--;){o=r[i];try{o.handleEvent?o.handleEvent(t):o.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},it.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},it.handleEvent=function(e){this.fireEvent(e.type,e)},it.addEventListener=function(e,t){var n=this._events[e],i=this._root;return t?(n||(n=this._events[e]=[],rt[e]||("selectionchange"===e&&(i=this._doc),i.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},it.removeEventListener=function(e,t){var n,i=this._events[e],o=this._root;if(i){if(t)for(n=i.length;n--;)i[n]===t&&i.splice(n,1);else i.length=0;i.length||(delete this._events[e],rt[e]||("selectionchange"===e&&(o=this._doc),o.removeEventListener(e,this,!0)))}return this},it.createRange=function(e,t,n,i){if(e instanceof this._win.Range)return e.cloneRange();var o=this._doc.createRange();return o.setStart(e,t),n?o.setEnd(n,i):o.setEnd(e,t),o},it.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,i=e.getBoundingClientRect();return i&&!i.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=z,Ce(e,t),i=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),L(n,e)),i},it._moveCursorTo=function(e){var t=this._root,n=this.createRange(t,e?0:t.childNodes.length);return be(n),this.setSelection(n),this},it.moveCursorToStart=function(){return this._moveCursorTo(!0)},it.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var at=function(e){return e._win.getSelection()||null};it.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(G&&!this._restoreSelection)D.call(this),this.blur(),this.focus();else{Z&&this._win.focus();var t=at(this);t&&(t.removeAllRanges(),t.addRange(e))}else D.call(this);return this},it.getSelection=function(){var e,t,n,i,r=at(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&o(t)&&e.setStartBefore(t),n&&o(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,i=e.commonAncestorContainer,m(i.ownerDocument,i)||(e=null)),e||(e=this.createRange(a.firstChild,0)),e},it.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,i=new n(e.commonAncestorContainer,4|W,function(t){return Ee(e,t,!0)}),o=e.startContainer,r=e.endContainer,s=i.currentNode=o,d="",l=!1;for(i.filter(s)||(s=i.nextNode());s;)s.nodeType===F?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===o&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=i.nextNode();return d},it.getPath=function(){return this._path};var st=function(e,t){for(var i,o,r,s=new n(e,4);o=s.nextNode();)for(;(r=o.data.indexOf(z))>-1&&(!t||o.parentNode!==t);){if(1===o.length){do{i=o.parentNode,i.removeChild(o),o=i,s.currentNode=i}while(a(o)&&!_(o));break}o.deleteData(r,1)}};it._didAddZWS=function(){this._hasZWS=!0},it._removeZWS=function(){this._hasZWS&&(st(this._root),this._hasZWS=!1)},it._updatePath=function(e,t){if(e){var n,i=e.startContainer,o=e.endContainer;(t||i!==this._lastAnchorNode||o!==this._lastFocusNode)&&(this._lastAnchorNode=i,this._lastFocusNode=o,n=i&&o?i===o?v(o,this._root,this._config):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},it._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},it.focus=function(){return this._root.focus(),ee&&this.fireEvent("focus"),this},it.blur=function(){return this._root.blur(),ee&&this.fireEvent("blur"),this};var dt="squire-selection-end";it._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),i=this.createElement("INPUT",{id:dt,type:"hidden"});Ce(e,n),e.collapse(!1),Ce(e,i),2&n.compareDocumentPosition(i)&&(n.id=dt,i.id="squire-selection-start",t=n,n=i,i=t),e.setStartAfter(n),e.setEndBefore(i)},it._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),i=t.querySelector("#"+dt);if(n&&i){var o=n.parentNode,r=i.parentNode,a=de.call(o.childNodes,n),s=de.call(r.childNodes,i);o===r&&(s-=1),N(n),N(i),e||(e=this._doc.createRange()),e.setStart(o,a),e.setEnd(r,s),L(o,e),o!==r&&L(r,e),e.collapsed&&(o=e.startContainer,
o.nodeType===F&&(r=o.childNodes[e.startOffset],r&&r.nodeType===F||(r=o.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},it._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},it._docWasChanged=function(){if(ae&&(ve=new WeakMap),!this._ignoreAllChanges){if(re&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},it._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,i=this._undoIndex,o=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(i+=1),i<this._undoStackLength&&(o.length=this._undoStackLength=i),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&i>s&&(o.splice(0,i-s),i=s,this._undoStackLength=s),o[i]=n,this._undoIndex=i,this._undoStackLength+=1,this._isInUndoState=!0}},it.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},it.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},it.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},it.hasFormat=function(e,t,i){if(e=e.toUpperCase(),t||(t={}),!i&&!(i=this.getSelection()))return!1;!i.collapsed&&i.startContainer.nodeType===F&&i.startOffset===i.startContainer.length&&i.startContainer.nextSibling&&i.setStartBefore(i.startContainer.nextSibling),!i.collapsed&&i.endContainer.nodeType===F&&0===i.endOffset&&i.endContainer.previousSibling&&i.setEndAfter(i.endContainer.previousSibling);var o,r,a=this._root,s=i.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===F)return!1;o=new n(s,4,function(e){return Ee(i,e,!0)});for(var d=!1;r=o.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},it.getFontInfo=function(e){var n,i,o,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(i=n.style)&&(!r.color&&(o=i.color)&&(r.color=o,a+=1),!r.backgroundColor&&(o=i.backgroundColor)&&(r.backgroundColor=o,a+=1),!r.family&&(o=i.fontFamily)&&(r.family=o,a+=1),!r.size&&(o=i.fontSize)&&(r.size=o,a+=1)),n=n.parentNode;return r},it._addFormat=function(e,t,i){var o,r,s,d,l,c,h,u,f=this._root;if(i.collapsed){for(o=T(this.createElement(e,t),f),Ce(i,o),i.setStart(o.firstChild,o.firstChild.length),i.collapse(!0),u=o;a(u);)u=u.parentNode;st(u,o)}else{if(r=new n(i.commonAncestorContainer,4|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Ee(i,e,!0)}),s=i.startContainer,l=i.startOffset,d=i.endContainer,c=i.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return i;do{h=r.currentNode,!g(h,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),o=this.createElement(e,t),C(h,o),o.appendChild(h))}while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),i=this.createRange(s,l,d,c)}return i},it._removeFormat=function(e,t,n,i){this._saveRangeToBookmark(n);var o,r=this._doc;n.collapsed&&(ie?(o=r.createTextNode(z),this._didAddZWS()):o=r.createTextNode(""),Ce(n,o));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Ee(n,e,!1)){var i,o,r=e.nodeType===F;if(!Ee(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(i=e.firstChild;i;i=o)o=i.nextSibling,f(i,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(i){return Ee(n,i,!0)&&p(i,e,t)});return i||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];C(n,t),t.appendChild(n)}),g.forEach(function(e){C(e,S(e))}),this._getRangeAndRemoveBookmark(n),o&&n.collapse(!1),L(s,n),n},it.changeFormat=function(e,t,n,i){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,i)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged(),this):this};var lt={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},ct=function(e,t,n,i){var o=lt[t.nodeName],r=null,a=b(n,i,t.parentNode,e._root),s=e._config;return o||(o=s.blockTag,r=s.blockAttributes),p(a,o,r)||(t=y(a.ownerDocument,o,r),a.dir&&(t.dir=a.dir),C(a,t),t.appendChild(S(a)),a=t),a};it.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var i=this._root,o=Le(n,i),r=xe(n,i);if(o&&r)do{if(e(o)||o===r)break}while(o=h(o,i));return t&&(this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged()),this},it.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,i=this._root;return Re(t,i),ke(t,i,i,i),n=Se(t,i,i),Ce(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&A(t.endContainer.childNodes[t.endOffset],i),A(t.startContainer.childNodes[t.startOffset],i),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),re||this._docWasChanged(),this};var ht=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},ut=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){C(e,S(e))}),e},ft=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:dt,type:"hidden"})])},pt=function(e,t,n){for(var i,o,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;i=s.nextNode();)"LI"===i.parentNode.nodeName&&(i=i.parentNode,s.currentNode=i.lastChild),"LI"!==i.nodeName?(a=e.createElement("LI",h),i.dir&&(a.dir=i.dir),(r=i.previousSibling)&&r.nodeName===n?(r.appendChild(a),N(i)):C(i,e.createElement(n,c,[a])),a.appendChild(S(i)),s.currentNode=a):(i=i.parentNode,(o=i.nodeName)!==n&&/^[OU]L$/.test(o)&&C(i,e.createElement(n,c,[S(i)])))},gt=function(e){return pt(this,e,"UL"),e},mt=function(e){return pt(this,e,"OL"),e},vt=function(e){var t,n,i,o,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)i=a[t],o=S(i),E(o,l),C(i,o);for(t=0,n=d.length;t<n;t+=1)r=d[t],s(r)?C(r,this.createDefaultBlock([S(r)])):(E(r,l),C(r,S(r)));return e},_t=function(e,t){for(var n=e.commonAncestorContainer,i=e.startContainer,o=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(i===n&&(i=i.childNodes[e.startOffset]),o===n&&(o=o.childNodes[e.endOffset]);i&&i.parentNode!==n;)i=i.parentNode;for(;o&&o.parentNode!==n;)o=o.parentNode;return[n,i,o]};it.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=_t(e,t);if(!n)return this.focus();var i=n[0],o=n[1],r=n[2];if(!o||o===i.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=i.nodeName,l=o.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),i.insertBefore(l,o));do{s=o===r?null:o.nextSibling,l.appendChild(o)}while(o=s);return s=l.nextSibling,s&&A(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},it.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=_t(e,t);if(!n)return this.focus();var i=n[0],o=n[1],r=n[2];o||(o=i.firstChild),r||(r=i.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=i.parentNode,d=r.nextSibling?b(i,r.nextSibling,s,t):i.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=i.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=o===r?null:o.nextSibling,i.removeChild(o),l&&"LI"===o.nodeName&&(o=this.createDefaultBlock([S(o)])),s.insertBefore(o,d)}while(o=a);return i.firstChild||N(i),d&&A(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},it._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},it.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},it._getHTML=function(){return this._root.innerHTML},it._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{T(n,t)}while(n=h(n,t));this._ignoreChange=!0},it.getHTML=function(e){var t,n,i,o,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ne)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(i=this.createElement("BR"),n.appendChild(i),s.push(i));if(o=this._getHTML().replace(/\u200B/g,""),ne)for(r=s.length;r--;)N(s[r]);return a&&this._getRangeAndRemoveBookmark(a),o},it.setHTML=function(e){var t,n,i,o=this._config,r=o.isSetHTMLSanitized?o.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),je(n,o),Ye(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)T(s,a);for(this._ignoreChange=!0;i=a.lastChild;)a.removeChild(i);a.appendChild(n),T(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this.createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,D.call(this),this._updatePath(d,!0),this},it.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))Ce(t,e),t.setStartAfter(e);else{for(var n,i,o=this._root,r=Le(t,o)||o;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(n=r.parentNode,i=b(n,r.nextSibling,o,o)),i?o.insertBefore(e,i):(o.appendChild(e),i=this.createDefaultBlock(),o.appendChild(i)),t.setStart(i,0),t.setEnd(i,0),be(t)}return this.focus(),this.setSelection(t),this._updatePath(t),re||this._docWasChanged(),this},it.insertImage=function(e,t){var n=this.createElement("IMG",B({src:e},t,!0));return this.insertElement(n),n};var Nt=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)(?:\?[^&?\s]+=[^&?\s]+(?:&[^&?\s]+=[^&?\s]+)*)?/i,Ct=function(e,t,i){for(var o,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,4,function(e){return!g(e,t,"A")}),f=i._config.tagAttributes.a;o=u.nextNode();)for(r=o.data,a=o.parentNode;s=Nt.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,o)),c=i.createElement("A",B({href:s[1]?/^(?:ht|f)tps?:/i.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[0]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,o),o.data=r=r.slice(l)};it.insertHTML=function(e,t){var n,i,o,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),i=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&i>-1&&(e=e.slice(n+20,i))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),o=this.createElement("DIV"),o.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(o))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},Ct(r,r,this),je(r,l),Ye(r,a,!1),$e(r),r.normalize();s=h(s,r);)T(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Te(u,d.fragment,a),re||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var St=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};it.insertPlainText=function(e,t){var n,i,o,r,a=e.split("\n"),s=this._config,d=s.blockTag,l=s.blockAttributes,c="</"+d+">",h="<"+d;for(n in l)h+=" "+n+'="'+St(l[n])+'"';for(h+=">",i=0,o=a.length;i<o;i+=1)r=a[i],r=St(r).replace(/ (?= )/g,"&nbsp;"),a[i]=h+(r||"<BR>")+c;return this.insertHTML(a.join(""),t)};var yt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};it.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},it.bold=yt("changeFormat",{tag:"B"}),it.italic=yt("changeFormat",{tag:"I"}),it.underline=yt("changeFormat",{tag:"U"}),it.strikethrough=yt("changeFormat",{tag:"S"}),it.subscript=yt("changeFormat",{tag:"SUB"},{tag:"SUP"}),it.superscript=yt("changeFormat",{tag:"SUP"},{tag:"SUB"}),it.removeBold=yt("changeFormat",null,{tag:"B"}),it.removeItalic=yt("changeFormat",null,{tag:"I"}),it.removeUnderline=yt("changeFormat",null,{tag:"U"}),it.removeStrikethrough=yt("changeFormat",null,{tag:"S"}),it.removeSubscript=yt("changeFormat",null,{tag:"SUB"}),it.removeSuperscript=yt("changeFormat",null,{tag:"SUP"}),it.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var i=e.indexOf(":")+1;if(i)for(;"/"===e[i];)i+=1;Ce(n,this._doc.createTextNode(e.slice(i)))}return t=B(B({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},it.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},it.setFontFace=function(e){var t=this._config.classNames.fontFamily;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},it.setFontSize=function(e){var t=this._config.classNames.fontSize;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},it.setTextColour=function(e){var t=this._config.classNames.colour;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},it.setHighlightColour=function(e){var t=this._config.classNames.highlight;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:t}}),this.focus()},it.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},it.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()},it.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(Re(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),ke(e,n,n,t);for(var i,o,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)i=p.nextSibling,h.appendChild(p),p=i;return I(this,h,u),u.normalize(),p=u.firstChild,i=u.lastChild,o=n.childNodes,p?(n.insertBefore(u,f),d=de.call(o,p),c=de.call(o,i)+1):(d=de.call(o,f),c=d),e.setStart(n,d),e.setEnd(n,c),L(n,e),be(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},it.increaseQuoteLevel=yt("modifyBlocks",ht),it.decreaseQuoteLevel=yt("modifyBlocks",ut),it.makeUnorderedList=yt("modifyBlocks",gt),it.makeOrderedList=yt("modifyBlocks",mt),it.removeList=yt("modifyBlocks",vt),R.isInline=a,R.isBlock=s,R.isContainer=d,R.getBlockWalker=l,R.getPreviousBlock=c,R.getNextBlock=h,R.areAlike=f,R.hasTagAttributes=p,R.getNearest=g,R.isOrContains=m,R.detach=N,R.replaceWith=C,R.empty=S,R.getNodeBefore=_e,R.getNodeAfter=Ne,R.insertNodeInRange=Ce,R.extractContentsOfRange=Se,R.deleteContentsOfRange=ye,R.insertTreeFragmentIntoRange=Te,R.isNodeContainedInRange=Ee,R.moveRangeBoundariesDownTree=be,R.moveRangeBoundariesUpTree=ke,R.getStartBlockOfRange=Le,R.getEndBlockOfRange=xe,R.contentWalker=Ae,R.rangeDoesStartAtBlockBoundary=Oe,R.rangeDoesEndAtBlockBoundary=Be,R.expandRangeToBlockBoundaries=Re,R.onPaste=tt,R.addLinks=Ct,R.splitBlock=ct,R.startSelectionId="squire-selection-start",R.endSelectionId=dt,"object"==typeof exports?module.exports=R:"function"==typeof define&&define.amd?define(function(){return R}):(q.Squire=R,top!==q&&"true"===e.documentElement.getAttribute("data-squireinit")&&(q.editor=new R(e),q.onEditorLoad&&(q.onEditorLoad(q.editor),q.onEditorLoad=null)))}(document);
>>>>>>> e071501... Make shift-enter always just add <br>
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n||ce}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!ue[e.nodeName]}function r(e){switch(e.nodeType){case F:return pe;case w:case H:if(ae&&ve.has(e))return ve.get(e);break;default:return fe}var t;return t=o(e.childNodes,a)?he.test(e.nodeName)?pe:ge:me,ae&&ve.set(e,t),t}function a(e){return r(e)===pe}function s(e){return r(e)===ge}function d(e){return r(e)===me}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function g(e,t,n,o){for(;e&&e!==t;){if(p(e,n,o))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t,n){var o,i,r,a,s,d="";return e&&e!==t&&(d=v(e.parentNode,t,n),e.nodeType===w&&(d+=(d?">":"")+e.nodeName,(o=e.id)&&(d+="#"+o),(i=e.className.trim())&&(r=i.split(/\s\s*/),r.sort(),d+=".",d+=r.join(".")),(a=e.dir)&&(d+="[dir="+a+"]"),r&&(s=n.classNames,de.call(r,s.highlight)>-1&&(d+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),de.call(r,s.colour)>-1&&(d+="[color="+e.style.color.replace(/ /g,"")+"]"),de.call(r,s.fontFamily)>-1&&(d+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),de.call(r,s.fontSize)>-1&&(d+="[fontSize="+e.style.fontSize+"]")))),d}function _(e){var t=e.nodeType;return t===w||t===H?e.childNodes.length:e.length||0}function C(e){var t=e.parentNode;return t&&t.removeChild(e),e}function N(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function y(e,n,o,i){var r,a,s,d=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)o[r]!==t&&d.setAttribute(r,o[r]);if(i)for(a=0,s=i.length;a<s;a+=1)d.appendChild(i[a]);return d}function T(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;oe&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(oe?(n=s.createTextNode(z),r._didAddZWS()):n=s.createTextNode(""))}else if(ne){for(;e.nodeType!==F&&!i(e);){if(!(o=e.firstChild)){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=y(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;n<o;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=y(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=y(l,h.blockTag,h.blockAttributes)),T(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&E(i,t);return c&&e.appendChild(T(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),T(e,o),T(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function x(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&f(n,o)&&!ue[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=_(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=_(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=_(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=_(o))),C(n),n.nodeType===F?o.appendData(n.data):d.push(S(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());x(n,t)}}function k(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};x(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function A(e,t,n,o){for(var i,r,a,s=t;(i=s.parentNode)&&i!==o&&i.nodeType===w&&1===i.childNodes.length;)s=i;C(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),k(e,n),Y&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function L(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&f(i,e)){if(!d(i)){if(!s)return;o=y(a,"DIV"),o.appendChild(S(i)),i.appendChild(o)}C(e),n=!d(e),i.appendChild(S(e)),n&&E(i,t),r&&L(r,t)}else s&&(i=y(a,"DIV"),e.insertBefore(i,r),T(i,t))}function B(e){this.isShiftDown=e.shiftKey}function O(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?O(e[o],i,n):i);return e}function D(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,ie&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,re?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",R),this.addEventListener("mousedown",P),this.addEventListener("touchstart",P),this.addEventListener("focus",U),this._awaitingPaste=!1,this.addEventListener(V?"beforecut":"cut",Je),this.addEventListener("copy",et),this.addEventListener("keydown",B),this.addEventListener("keyup",B),this.addEventListener(V?"beforepaste":"paste",tt),this.addEventListener("drop",nt),this.addEventListener(Y?"keypress":"keydown",Pe),this._keyHandlers=Object.create(Fe),this.setConfig(t),V&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function R(){this._restoreSelection=!0}function P(){this._restoreSelection=!1}function U(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([I(e,o,e._doc.createDocumentFragment())]));continue}I(e,o,n)}return n}var w=1,F=3,M=9,H=11,W=1,z="​",q=e.defaultView,K=navigator.userAgent,G=/Android/.test(K),Z=/iP(?:ad|hone|od)/.test(K),j=/Mac OS X/.test(K),$=/Windows NT/.test(K),Q=/Gecko\//.test(K),V=/Trident\/[456]\./.test(K),Y=!!q.opera,X=/Edge\//.test(K),J=!X&&/WebKit\//.test(K),ee=/Trident\/[4567]\./.test(K),te=j?"meta-":"ctrl-",ne=V||Y,oe=V||J,ie=V,re="undefined"!=typeof MutationObserver,ae="undefined"!=typeof WeakMap,se=/[^ \t\r\n]/,de=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var le={1:1,2:2,3:4,8:128,9:256,11:1024},ce=function(){return!0};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(le[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var he=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,ue={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},fe=0,pe=1,ge=2,me=3,ve=ae?new WeakMap:null,_e=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Ce=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Ne=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=de.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=de.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},Se=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c=b(r,a,t,n),h=b(o,i,t,n),u=t.ownerDocument.createDocumentFragment();h!==c;)s=h.nextSibling,u.appendChild(h),h=s;return o=t,i=c?de.call(t.childNodes,c):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,d.appendData(l.data),C(l)),e.setStart(o,i),e.collapse(!0),T(t,n),u},ye=function(e,t){var n,o,i=ke(e,t),r=Ae(e,t),a=i!==r;return be(e),xe(e,i,r,t),n=Se(e,null,t),be(e),a&&(r=Ae(e,t),i&&r&&i!==r&&A(i,r,e,t)),i&&T(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(T(t,t),e.selectNodeContents(t.firstChild)),n},Te=function(e,t,n){var o,i,r,s,l,f,p,m,v,N,S;for(E(t,n),o=t;o=h(o,n);)T(o,n);if(e.collapsed||ye(e,n),be(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,i=ke(e,n),m=h(t,t),p=!!i&&u(i),i&&m&&!p&&!g(m,t,"PRE")&&!g(m,t,"TABLE")){if(xe(e,i,i,n),e.collapse(!0),l=e.endContainer,f=e.endOffset,Ye(i,n,!1),a(l)&&(v=b(l,f,c(l,n),n),l=v.parentNode,f=de.call(l.childNodes,v)),f!==_(l))for(r=n.ownerDocument.createDocumentFragment();o=l.childNodes[f];)r.appendChild(o);A(l,m,e,n),f=de.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,f)}_(t)&&(p&&(e.setEndBefore(i),e.collapse(!1),C(i)),xe(e,s,s,n),v=b(e.endContainer,e.endOffset,s,n),N=v?v.previousSibling:s.lastChild,s.insertBefore(t,v),v?e.setEndBefore(v):e.setEnd(s,_(s)),i=Ae(e,n),be(e),l=e.endContainer,f=e.endOffset,v&&d(v)&&L(v,n),v=N&&N.nextSibling,v&&d(v)&&L(v,n),e.setEnd(l,f)),r&&(S=e.cloneRange(),A(i,r,S,n),e.setEnd(S.endContainer,S.endOffset)),be(e)},Ee=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(3,o)>-1,r=e.compareBoundaryPoints(1,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(0,o)<1,s=e.compareBoundaryPoints(2,o)>-1;return a&&s},be=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o])&&!i(t);)n=t,o=0;if(a)for(;r.nodeType!==F;){if(!(t=r.childNodes[a-1])||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=_(r)}else for(;r.nodeType!==F&&(t=r.firstChild)&&!i(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},xe=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=de.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==_(s))break;i=s.parentNode,d=de.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},ke=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=_e(o,e.startOffset),n=h(n,t)),n&&Ee(e,n,!0)?n:null},Ae=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(!(n=Ce(i,e.endOffset))||!m(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Ee(e,n,!0)?n:null},Le=new n(null,4|W,function(e){return e.nodeType===F?se.test(e.data):"IMG"===e.nodeName}),Be=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(Le.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Ce(o,i),n&&!m(t,n)&&(n=null),!n&&(n=_e(o,i),n.nodeType===F&&n.length))return!1;return Le.currentNode=n,Le.root=ke(e,t),!Le.previousNode()},Oe=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(Le.root=null,o.nodeType===F){if((n=o.data.length)&&i<n)return!1;Le.currentNode=o}else Le.currentNode=_e(o,i);return Le.root=Ae(e,t),!Le.nextNode()},De=function(e,t){var n,o=ke(e,t),i=Ae(e,t);o&&i&&(n=o.parentNode,e.setStart(n,de.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,de.call(n.childNodes,i)+1))},Re={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},Pe=function(e){var t=e.keyCode,n=Re[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),Y&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):i.collapsed||e.ctrlKey||e.metaKey||1!==(e.key||n).length||(this.saveUndoState(i),ye(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},Ue=function(e){return function(t,n){n.preventDefault(),t[e]()}},Ie=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},we=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===z);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,de.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),T(n,e._root),be(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&C(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},Fe={enter:function(e,t,n){var o,i,r,a,s,d=e._root;if(t.preventDefault(),e._recordUndoState(n),Nt(n.startContainer,d,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||ye(n,d),(o=ke(n,d))&&(i=g(o,d,"PRE")))return be(n),r=n.startContainer,a=n.startOffset,r.nodeType!==F&&(r=e._doc.createTextNode(""),i.insertBefore(r,i.firstChild)),t.shiftKey||"\n"!==r.data.charAt(a-1)&&!Be(n,d)||"\n"!==r.data.charAt(a)&&!Oe(n,d)?(r.insertData(a,"\n"),T(i,d),r.length===a+1?n.setStartAfter(r):n.setStart(r,a+1)):(r.deleteData(a&&a-1,a?2:1),s=b(r,a&&a-1,d,d),r=s.previousSibling,r.textContent||C(r),r=e.createDefaultBlock(),s.parentNode.insertBefore(r,s),s.textContent||C(s),n.setStart(r,0)),n.collapse(!0),e.setSelection(n),e._updatePath(n,!0),void e._docWasChanged();if(!o||t.shiftKey||/^T[HD]$/.test(o.nodeName))return i=g(n.endContainer,d,"A"),i&&(i=i.parentNode,xe(n,i,i,d),n.collapse(!1)),Ne(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=g(o,d,"LI"))&&(o=i),u(o)){if(g(o,d,"UL")||g(o,d,"OL"))return e.decreaseListLevel(n);if(g(o,d,"BLOCKQUOTE"))return e.modifyBlocks(ft,n)}for(s=ct(e,o,n.startContainer,n.startOffset),st(o),$e(o),T(o,d);s.nodeType===w;){var l,c=s.firstChild;if("A"===s.nodeName&&(!s.textContent||s.textContent===z)){c=e._doc.createTextNode(""),N(s,c),s=c;break}for(;c&&c.nodeType===F&&!c.data&&(l=c.nextSibling)&&"BR"!==l.nodeName;)C(c),c=l;if(!c||"BR"===c.nodeName||c.nodeType===F&&!Y)break;s=c}n=e.createRange(s,0),e.setSelection(n),e._updatePath(n,!0)},"shift-enter":function(e,t,n){return e._keyHandlers.enter(e,t,n)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Be(n,o)){t.preventDefault();var i,r=ke(n,o);if(!r)return;if(E(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void C(i);for(A(i,r,n,o),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&L(r,o),e.setSelection(n)}else if(r){if(g(r,o,"UL")||g(r,o,"OL"))return e.decreaseListLevel(n);if(g(r,o,"BLOCKQUOTE"))return e.modifyBlocks(ut,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){we(e)},0);else t.preventDefault(),ye(n,o),we(e,n)},delete:function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Oe(n,l)){if(t.preventDefault(),!(o=ke(n,l)))return;if(E(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void C(i);for(A(o,i,n,l),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&L(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),xe(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),C(d),be(n),void we(e,n);e.setSelection(r),setTimeout(function(){we(e)},0)}else t.preventDefault(),ye(n,l),we(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&Be(n,r))for(o=ke(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.increaseListLevel(n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&Be(n,i)&&(o=n.startContainer,(g(o,i,"UL")||g(o,i,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var o,i;e._recordUndoState(n),Nt(n.startContainer,e._root,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,i=o.parentNode,n.collapsed&&n.endOffset===_(o)&&("A"===o.nodeName?n.setStartAfter(o):"A"!==i.nodeName||o.nextSibling||n.setStartAfter(i)),n.collapsed||(ye(n,e._root),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};j&&Q&&(Fe["meta-left"]=function(e,t){t.preventDefault();var n=at(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Fe["meta-right"]=function(e,t){t.preventDefault();var n=at(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),j||(Fe.pageup=function(e){e.moveCursorToStart()},Fe.pagedown=function(e){e.moveCursorToEnd()}),Fe[te+"b"]=Ie("B"),Fe[te+"i"]=Ie("I"),Fe[te+"u"]=Ie("U"),Fe[te+"shift-7"]=Ie("S"),Fe[te+"shift-5"]=Ie("SUB",{tag:"SUP"}),Fe[te+"shift-6"]=Ie("SUP",{tag:"SUB"}),Fe[te+"shift-8"]=Ue("makeUnorderedList"),Fe[te+"shift-9"]=Ue("makeOrderedList"),Fe[te+"["]=Ue("decreaseQuoteLevel"),Fe[te+"]"]=Ue("increaseQuoteLevel"),Fe[te+"d"]=Ue("toggleCode"),Fe[te+"y"]=Ue("redo"),Fe[te+"z"]=Ue("undo"),Fe[te+"shift-z"]=Ue("redo");var Me={1:10,2:13,3:16,4:18,5:24,6:32,7:48},He={backgroundColor:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.highlight,style:"background-color:"+n})}},color:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.colour,style:"color:"+n})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return y(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return y(e,"I")}},fontFamily:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontFamily,style:"font-family:"+n})}},fontSize:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontSize,style:"font-size:"+n})}},textDecoration:{regexp:/^underline/i,replace:function(e){return y(e,"U")}}},We=function(e){return function(t,n){var o=y(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(S(t)),o}},ze=function(e,t,n){var o,i,r,a,s,d,l=e.style,c=e.ownerDocument;for(o in He)i=He[o],(r=l[o])&&i.regexp.test(r)&&(d=i.replace(c,n.classNames,r),s||(s=d),a&&a.appendChild(d),a=d,e.style[o]="");return s&&(a.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(s,e):e.appendChild(s)),a||e},qe={P:ze,SPAN:ze,STRONG:We("B"),EM:We("I"),INS:We("U"),STRIKE:We("S"),FONT:function(e,t,n){var o,i,r,a,s,d=e.face,l=e.size,c=e.color,h=e.ownerDocument,u=n.classNames;return d&&(o=y(h,"SPAN",{class:u.fontFamily,style:"font-family:"+d}),s=o,a=o),l&&(i=y(h,"SPAN",{class:u.fontSize,style:"font-size:"+Me[l]+"px"}),s||(s=i),a&&a.appendChild(i),a=i),c&&/^#?([\dA-F]{3}){1,2}$/i.test(c)&&("#"!==c.charAt(0)&&(c="#"+c),r=y(h,"SPAN",{class:u.colour,style:"color:"+c}),s||(s=r),a&&a.appendChild(r),a=r),s||(s=a=y(h,"SPAN")),t.replaceChild(s,e),a.appendChild(S(e)),a},TT:function(e,t,n){var o=y(e.ownerDocument,"SPAN",{class:n.classNames.fontFamily,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(o,e),o.appendChild(S(e)),o}},Ke=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Ge=/^(?:HEAD|META|STYLE)/,Ze=new n(null,4|W),je=function e(t,n,o){var i,r,s,d,l,c,h,u,f,p,g,m,v=t.childNodes;for(i=t;a(i);)i=i.parentNode;for(Ze.root=i,r=0,s=v.length;r<s;r+=1)if(d=v[r],l=d.nodeName,c=d.nodeType,h=qe[l],c===w){if(u=d.childNodes.length,h)d=h(d,t,n);else{if(Ge.test(l)){t.removeChild(d),r-=1,s-=1;continue}if(!Ke.test(l)&&!a(d)){r-=1,s+=u-1,t.replaceChild(S(d),d);continue}}u&&e(d,n,o||"PRE"===l)}else{if(c===F){if(g=d.data,f=!se.test(g.charAt(0)),p=!se.test(g.charAt(g.length-1)),o||!f&&!p)continue;if(f){for(Ze.currentNode=d;(m=Ze.previousPONode())&&!("IMG"===(l=m.nodeName)||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/^[ \t\r\n]+/g,m?" ":"")}if(p){for(Ze.currentNode=d;(m=Ze.nextNode())&&!("IMG"===l||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/[ \t\r\n]+$/g,m?" ":"")}if(g){d.data=g;continue}}t.removeChild(d),r-=1,s-=1}return t},$e=function e(t){for(var n,o=t.childNodes,r=o.length;r--;)n=o[r],n.nodeType!==w||i(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},Qe=function(e){return e.nodeType===w?"BR"===e.nodeName:se.test(e.data)},Ve=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,4|W,Qe),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},Ye=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;o<l;o+=1)d[o]=Ve(s[o],n);for(;l--;)i=s[l],(r=i.parentNode)&&(d[l]?a(r)||E(r,t):C(i))},Xe=function(e,t,n,o){var i,r,a=t.ownerDocument.body,s=o.willCutCopy;Ye(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),a.appendChild(t),i=t.innerHTML,r=t.innerText||t.textContent,s&&(i=s(i)),$&&(r=r.replace(/\r?\n/g,"\r\n")),e.setData("text/html",i),e.setData("text/plain",r),a.removeChild(t)},Je=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),X||Z||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=ke(l,c),n=Ae(l,c),o=t===n&&t||c,i=ye(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),Xe(d,s,c,this._config),e.preventDefault()}this.setSelection(l)},et=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!X&&!Z&&d){for(t=ke(l,c),n=Ae(l,c),o=t===n&&t||c,l=l.cloneRange(),be(l),xe(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),Xe(d,s,c,this._config),e.preventDefault()}},tt=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(X&&s){for(t=s.length;t--;)!d&&/^image\/.*/.test(s[t].type)&&(c=!0);c||(s=null)}if(s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!X&&i&&(de.call(i,"text/html")>-1||!Q&&de.call(i,"text/plain")>-1&&de.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,N=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(N),p.selectNodeContents(N),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=N;N=o;)o=N.nextSibling,C(N),e=N.firstChild,e&&e===N.lastChild&&"DIV"===e.nodeName&&(N=e),n+=N.innerHTML;t=u.createRange(g,m,v,_),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)},nt=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},ot=D.prototype,it=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};ot.setConfig=function(e){return e=O({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},classNames:{colour:"colour",fontFamily:"font",fontSize:"size",highlight:"highlight"},leafNodeNames:ue,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?it:null,willCutCopy:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},ot.createElement=function(e,t,n){return y(this._doc,e,t,n)},ot.createDefaultBlock=function(e){var t=this._config;return T(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},ot.didError=function(e){console.log(e)},ot.getDocument=function(){return this._doc},ot.getRoot=function(){return this._root},ot.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var rt={pathChange:1,select:1,input:1,undoStateChange:1};ot.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},ot.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},ot.handleEvent=function(e){this.fireEvent(e.type,e)},ot.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],rt[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},ot.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],rt[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},ot.createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},ot.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=z,Ne(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),k(n,e)),o},ot._moveCursorTo=function(e){var t=this._root,n=this.createRange(t,e?0:t.childNodes.length);return be(n),this.setSelection(n),this},ot.moveCursorToStart=function(){return this._moveCursorTo(!0)},ot.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var at=function(e){return e._win.getSelection()||null};ot.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(G&&!this._restoreSelection)R.call(this),this.blur(),this.focus();else{Z&&this._win.focus();var t=at(this);t&&(t.removeAllRanges(),t.addRange(e))}else R.call(this);return this},ot.getSelection=function(){var e,t,n,o,r=at(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,o=e.commonAncestorContainer,m(o.ownerDocument,o)||(e=null)),e||(e=this.createRange(a.firstChild,0)),e},ot.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,o=new n(e.commonAncestorContainer,4|W,function(t){return Ee(e,t,!0)}),i=e.startContainer,r=e.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===i&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},ot.getPath=function(){return this._path};var st=function(e,t){for(var o,i,r,s=new n(e,4);i=s.nextNode();)for(;(r=i.data.indexOf(z))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do{o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o}while(a(i)&&!_(i));break}i.deleteData(r,1)}};ot._didAddZWS=function(){this._hasZWS=!0},ot._removeZWS=function(){this._hasZWS&&(st(this._root),this._hasZWS=!1)},ot._updatePath=function(e,t){if(e){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?v(i,this._root,this._config):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},ot._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},ot.focus=function(){return this._root.focus(),ee&&this.fireEvent("focus"),this},ot.blur=function(){return this._root.blur(),ee&&this.fireEvent("blur"),this};var dt="squire-selection-end";ot._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",
type:"hidden"}),o=this.createElement("INPUT",{id:dt,type:"hidden"});Ne(e,n),e.collapse(!1),Ne(e,o),2&n.compareDocumentPosition(o)&&(n.id=dt,o.id="squire-selection-start",t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},ot._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),o=t.querySelector("#"+dt);if(n&&o){var i=n.parentNode,r=o.parentNode,a=de.call(i.childNodes,n),s=de.call(r.childNodes,o);i===r&&(s-=1),C(n),C(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),k(i,e),i!==r&&k(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},ot._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},ot._docWasChanged=function(){if(ae&&(ve=new WeakMap),!this._ignoreAllChanges){if(re&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},ot._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,o=this._undoIndex,i=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(o+=1),o<this._undoStackLength&&(i.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&o>s&&(i.splice(0,o-s),o=s,this._undoStackLength=s),i[o]=n,this._undoIndex=o,this._undoStackLength+=1,this._isInUndoState=!0}},ot.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},ot.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},ot.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},ot.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,4,function(e){return Ee(o,e,!0)});for(var d=!1;r=i.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},ot.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},ot._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f=this._root;if(o.collapsed){for(i=T(this.createElement(e,t),f),Ne(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),u=i;a(u);)u=u.parentNode;st(u,i)}else{if(r=new n(o.commonAncestorContainer,4|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Ee(o,e,!0)}),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do{h=r.currentNode,!g(h,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),N(h,i),i.appendChild(h))}while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this.createRange(s,l,d,c)}return o},ot._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(oe?(i=r.createTextNode(z),this._didAddZWS()):i=r.createTextNode(""),Ne(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Ee(n,e,!1)){var o,i,r=e.nodeType===F;if(!Ee(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,f(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Ee(n,o,!0)&&p(o,e,t)});return o||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];N(n,t),t.appendChild(n)}),g.forEach(function(e){N(e,S(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),k(s,n),n},ot.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged(),this):this};var lt={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},ct=function(e,t,n,o){var i=lt[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),p(a,i,r)||(t=y(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),N(a,t),t.appendChild(S(a)),a=t),a};ot.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=ke(n,o),r=Ae(n,o);if(i&&r)do{if(e(i)||i===r)break}while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged()),this},ot.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,o=this._root;return De(t,o),xe(t,o,o,o),n=Se(t,o,o),Ne(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&L(t.endContainer.childNodes[t.endOffset],o),L(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),re||this._docWasChanged(),this};var ht=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},ut=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){N(e,S(e))}),e},ft=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:dt,type:"hidden"})])},pt=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),C(o)):N(o,e.createElement(n,c,[a])),a.appendChild(S(o)),s.currentNode=a):(o=o.parentNode,(i=o.nodeName)!==n&&/^[OU]L$/.test(i)&&N(o,e.createElement(n,c,[S(o)])))},gt=function(e){return pt(this,e,"UL"),e},mt=function(e){return pt(this,e,"OL"),e},vt=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)o=a[t],i=S(o),E(i,l),N(o,i);for(t=0,n=d.length;t<n;t+=1)r=d[t],s(r)?N(r,this.createDefaultBlock([S(r)])):(E(r,l),N(r,S(r)));return e},_t=function(e,t){for(var n=e.commonAncestorContainer,o=e.startContainer,i=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(o===n&&(o=o.childNodes[e.startOffset]),i===n&&(i=i.childNodes[e.endOffset]);o&&o.parentNode!==n;)o=o.parentNode;for(;i&&i.parentNode!==n;)i=i.parentNode;return[n,o,i]};ot.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=_t(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];if(!i||i===o.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=o.nodeName,l=i.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),o.insertBefore(l,i));do{s=i===r?null:i.nextSibling,l.appendChild(i)}while(i=s);return s=l.nextSibling,s&&L(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},ot.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=_t(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];i||(i=o.firstChild),r||(r=o.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=o.parentNode,d=r.nextSibling?b(o,r.nextSibling,s,t):o.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=o.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=i===r?null:i.nextSibling,o.removeChild(i),l&&"LI"===i.nodeName&&(i=this.createDefaultBlock([S(i)])),s.insertBefore(i,d)}while(i=a);return o.firstChild||C(o),d&&L(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},ot._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},ot.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},ot._getHTML=function(){return this._root.innerHTML},ot._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{T(n,t)}while(n=h(n,t));this._ignoreChange=!0},ot.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ne)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ne)for(r=s.length;r--;)C(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},ot.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),je(n,i),Ye(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)T(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),T(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this.createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,R.call(this),this._updatePath(d,!0),this},ot.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))Ne(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=ke(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),be(t)}return this.focus(),this.setSelection(t),this._updatePath(t),re||this._docWasChanged(),this},ot.insertImage=function(e,t){var n=this.createElement("IMG",O({src:e},t,!0));return this.insertElement(n),n};var Ct=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)(?:\?[^&?\s]+=[^&?\s]+(?:&[^&?\s]+=[^&?\s]+)*)?/i,Nt=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,4,function(e){return!g(e,t,"A")}),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=Ct.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",O({href:s[1]?/^(?:ht|f)tps?:/i.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[0]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};ot.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),o=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},Nt(r,r,this),je(r,l),Ye(r,a,!1),$e(r),r.normalize();s=h(s,r);)T(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Te(u,d.fragment,a),re||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var St=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};ot.insertPlainText=function(e,t){var n=this.getSelection();if(n.collapsed&&g(n.startContainer,this._root,"PRE")){var o,i,r=n.startContainer,a=n.startOffset;return r&&r.nodeType===F||(o=this._doc.createTextNode(""),r.insertBefore(o,r.childNodes[a]),r=o,a=0),i={text:e,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},t&&this.fireEvent("willPaste",i),i.defaultPrevented||(e=i.text,r.insertData(a,e),n.setStart(r,a+e.length),n.collapse(!0)),this.setSelection(n),this}var s,d,l,c,h=e.split("\n"),u=this._config,f=u.blockTag,p=u.blockAttributes,m="</"+f+">",v="<"+f;for(s in p)v+=" "+s+'="'+St(p[s])+'"';for(v+=">",d=0,l=h.length;d<l;d+=1)c=h[d],c=St(c).replace(/ (?= )/g,"&nbsp;"),h[d]=v+(c||"<BR>")+m;return this.insertHTML(h.join(""),t)};var yt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};ot.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},ot.bold=yt("changeFormat",{tag:"B"}),ot.italic=yt("changeFormat",{tag:"I"}),ot.underline=yt("changeFormat",{tag:"U"}),ot.strikethrough=yt("changeFormat",{tag:"S"}),ot.subscript=yt("changeFormat",{tag:"SUB"},{tag:"SUP"}),ot.superscript=yt("changeFormat",{tag:"SUP"},{tag:"SUB"}),ot.removeBold=yt("changeFormat",null,{tag:"B"}),ot.removeItalic=yt("changeFormat",null,{tag:"I"}),ot.removeUnderline=yt("changeFormat",null,{tag:"U"}),ot.removeStrikethrough=yt("changeFormat",null,{tag:"S"}),ot.removeSubscript=yt("changeFormat",null,{tag:"SUB"}),ot.removeSuperscript=yt("changeFormat",null,{tag:"SUP"}),ot.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;Ne(n,this._doc.createTextNode(e.slice(o)))}return t=O(O({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},ot.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},ot.setFontFace=function(e){var t=this._config.classNames.fontFamily;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},ot.setFontSize=function(e){var t=this._config.classNames.fontSize;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},ot.setTextColour=function(e){var t=this._config.classNames.colour;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},ot.setHighlightColour=function(e){var t=this._config.classNames.highlight;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:t}}),this.focus()},ot.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},ot.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()};var Tt=function(e){for(var t,o=this._root,i=this._doc,r=i.createDocumentFragment(),a=l(e,o);t=a.nextNode();){var s,d,c=t.querySelectorAll("BR"),h=[],u=c.length;for(s=0;s<u;s+=1)h[s]=Ve(c[s],!1);for(;u--;)d=c[u],h[u]?N(d,i.createTextNode("\n")):C(d);for(c=t.querySelectorAll("CODE"),u=c.length;u--;)C(c[u]);r.childNodes.length&&r.appendChild(i.createTextNode("\n")),r.appendChild(S(t))}for(a=new n(r,4);t=a.nextNode();)t.data=t.data.replace(/ /g," ");return r.normalize(),T(this.createElement("PRE",this._config.tagAttributes.pre,[r]),o)},Et=function(e){for(var t,o,i,r,a,s,d=this._doc,l=this._root,c=e.querySelectorAll("PRE"),h=c.length;h--;){for(t=c[h],o=new n(t,4);i=o.nextNode();){for(r=i.data,r=r.replace(/ (?= )/g," "),a=d.createDocumentFragment();(s=r.indexOf("\n"))>-1;)a.appendChild(d.createTextNode(r.slice(0,s))),a.appendChild(d.createElement("BR")),r=r.slice(s+1);i.parentNode.insertBefore(a,i),i.data=r}E(t,l),N(t,S(t))}return e};ot.code=function(){var e=this.getSelection();return e.collapsed||d(e.commonAncestorContainer)?this.modifyBlocks(Tt,e):this.changeFormat({tag:"CODE",attributes:this._config.tagAttributes.code},null,e),this.focus()},ot.removeCode=function(){var e=this.getSelection();return g(e.commonAncestorContainer,this._root,"PRE")?this.modifyBlocks(Et,e):this.changeFormat(null,{tag:"CODE"},e),this.focus()},ot.toggleCode=function(){return this.hasFormat("PRE")||this.hasFormat("CODE")?this.removeCode():this.code(),this},ot.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(De(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),xe(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return I(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=de.call(i,p),c=de.call(i,o)+1):(d=de.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),k(n,e),be(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},ot.increaseQuoteLevel=yt("modifyBlocks",ht),ot.decreaseQuoteLevel=yt("modifyBlocks",ut),ot.makeUnorderedList=yt("modifyBlocks",gt),ot.makeOrderedList=yt("modifyBlocks",mt),ot.removeList=yt("modifyBlocks",vt),D.isInline=a,D.isBlock=s,D.isContainer=d,D.getBlockWalker=l,D.getPreviousBlock=c,D.getNextBlock=h,D.areAlike=f,D.hasTagAttributes=p,D.getNearest=g,D.isOrContains=m,D.detach=C,D.replaceWith=N,D.empty=S,D.getNodeBefore=_e,D.getNodeAfter=Ce,D.insertNodeInRange=Ne,D.extractContentsOfRange=Se,D.deleteContentsOfRange=ye,D.insertTreeFragmentIntoRange=Te,D.isNodeContainedInRange=Ee,D.moveRangeBoundariesDownTree=be,D.moveRangeBoundariesUpTree=xe,D.getStartBlockOfRange=ke,D.getEndBlockOfRange=Ae,D.contentWalker=Le,D.rangeDoesStartAtBlockBoundary=Be,D.rangeDoesEndAtBlockBoundary=Oe,D.expandRangeToBlockBoundaries=De,D.onPaste=tt,D.addLinks=Nt,D.splitBlock=ct,D.startSelectionId="squire-selection-start",D.endSelectionId=dt,"object"==typeof exports?module.exports=D:"function"==typeof define&&define.amd?define(function(){return D}):(q.Squire=D,top!==q&&"true"===e.documentElement.getAttribute("data-squireinit")&&(q.editor=new D(e),q.onEditorLoad&&(q.onEditorLoad(q.editor),q.onEditorLoad=null)))}(document);
>>>>>>> 625d101... Add support for <pre>/<code> formatting
=======
!function(e,t){"use strict";function n(e,t,n){this.root=this.currentNode=e,this.nodeType=t,this.filter=n||ce}function o(e,t){for(var n=e.length;n--;)if(!t(e[n]))return!1;return!0}function i(e){return e.nodeType===w&&!!ue[e.nodeName]}function r(e){switch(e.nodeType){case F:return pe;case w:case H:if(ae&&ve.has(e))return ve.get(e);break;default:return fe}var t;return t=o(e.childNodes,a)?he.test(e.nodeName)?pe:ge:me,ae&&ve.set(e,t),t}function a(e){return r(e)===pe}function s(e){return r(e)===ge}function d(e){return r(e)===me}function l(e,t){var o=new n(t,W,s);return o.currentNode=e,o}function c(e,t){return e=l(e,t).previousNode(),e!==t?e:null}function h(e,t){return e=l(e,t).nextNode(),e!==t?e:null}function u(e){return!e.textContent&&!e.querySelector("IMG")}function f(e,t){return!i(e)&&e.nodeType===t.nodeType&&e.nodeName===t.nodeName&&"A"!==e.nodeName&&e.className===t.className&&(!e.style&&!t.style||e.style.cssText===t.style.cssText)}function p(e,t,n){if(e.nodeName!==t)return!1;for(var o in n)if(e.getAttribute(o)!==n[o])return!1;return!0}function g(e,t,n,o){for(;e&&e!==t;){if(p(e,n,o))return e;e=e.parentNode}return null}function m(e,t){for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function v(e,t,n){var o,i,r,a,s,d="";return e&&e!==t&&(d=v(e.parentNode,t,n),e.nodeType===w&&(d+=(d?">":"")+e.nodeName,(o=e.id)&&(d+="#"+o),(i=e.className.trim())&&(r=i.split(/\s\s*/),r.sort(),d+=".",d+=r.join(".")),(a=e.dir)&&(d+="[dir="+a+"]"),r&&(s=n.classNames,de.call(r,s.highlight)>-1&&(d+="[backgroundColor="+e.style.backgroundColor.replace(/ /g,"")+"]"),de.call(r,s.colour)>-1&&(d+="[color="+e.style.color.replace(/ /g,"")+"]"),de.call(r,s.fontFamily)>-1&&(d+="[fontFamily="+e.style.fontFamily.replace(/ /g,"")+"]"),de.call(r,s.fontSize)>-1&&(d+="[fontSize="+e.style.fontSize+"]")))),d}function _(e){var t=e.nodeType;return t===w||t===H?e.childNodes.length:e.length||0}function C(e){var t=e.parentNode;return t&&t.removeChild(e),e}function N(e,t){var n=e.parentNode;n&&n.replaceChild(t,e)}function S(e){for(var t=e.ownerDocument.createDocumentFragment(),n=e.childNodes,o=n?n.length:0;o--;)t.appendChild(e.firstChild);return t}function y(e,n,o,i){var r,a,s,d=e.createElement(n);if(o instanceof Array&&(i=o,o=null),o)for(r in o)o[r]!==t&&d.setAttribute(r,o[r]);if(i)for(a=0,s=i.length;a<s;a+=1)d.appendChild(i[a]);return d}function T(e,t){var n,o,r=t.__squire__,s=e.ownerDocument,d=e;if(e===t&&((o=e.firstChild)&&"BR"!==o.nodeName||(n=r.createDefaultBlock(),o?e.replaceChild(n,o):e.appendChild(n),e=n,n=null)),e.nodeType===F)return d;if(a(e)){for(o=e.firstChild;oe&&o&&o.nodeType===F&&!o.data;)e.removeChild(o),o=e.firstChild;o||(oe?(n=s.createTextNode(z),r._didAddZWS()):n=s.createTextNode(""))}else if(ne){for(;e.nodeType!==F&&!i(e);){if(!(o=e.firstChild)){n=s.createTextNode("");break}e=o}e.nodeType===F?/^ +$/.test(e.data)&&(e.data=""):i(e)&&e.parentNode.insertBefore(s.createTextNode(""),e)}else if(!e.querySelector("BR"))for(n=y(s,"BR");(o=e.lastElementChild)&&!a(o);)e=o;if(n)try{e.appendChild(n)}catch(t){r.didError({name:"Squire: fixCursor – "+t,message:"Parent: "+e.nodeName+"/"+e.innerHTML+" appendChild: "+n.nodeName})}return d}function E(e,t){var n,o,i,r,s=e.childNodes,l=e.ownerDocument,c=null,h=t.__squire__._config;for(n=0,o=s.length;n<o;n+=1)i=s[n],r="BR"===i.nodeName,!r&&a(i)?(c||(c=y(l,h.blockTag,h.blockAttributes)),c.appendChild(i),n-=1,o-=1):(r||c)&&(c||(c=y(l,h.blockTag,h.blockAttributes)),T(c,t),r?e.replaceChild(c,i):(e.insertBefore(c,i),n+=1,o+=1),c=null),d(i)&&E(i,t);return c&&e.appendChild(T(c,t)),e}function b(e,t,n,o){var i,r,a,s=e.nodeType;if(s===F&&e!==n)return b(e.parentNode,e.splitText(t),n,o);if(s===w){if("number"==typeof t&&(t=t<e.childNodes.length?e.childNodes[t]:null),e===n)return t;for(i=e.parentNode,r=e.cloneNode(!1);t;)a=t.nextSibling,r.appendChild(t),t=a;return"OL"===e.nodeName&&g(e,o,"BLOCKQUOTE")&&(r.start=(+e.start||1)+e.childNodes.length-1),T(e,o),T(r,o),(a=e.nextSibling)?i.insertBefore(r,a):i.appendChild(r),b(i,r,n,o)}return t}function x(e,t){for(var n,o,i,r=e.childNodes,s=r.length,d=[];s--;)if(n=r[s],o=s&&r[s-1],s&&a(n)&&f(n,o)&&!ue[n.nodeName])t.startContainer===n&&(t.startContainer=o,t.startOffset+=_(o)),t.endContainer===n&&(t.endContainer=o,t.endOffset+=_(o)),t.startContainer===e&&(t.startOffset>s?t.startOffset-=1:t.startOffset===s&&(t.startContainer=o,t.startOffset=_(o))),t.endContainer===e&&(t.endOffset>s?t.endOffset-=1:t.endOffset===s&&(t.endContainer=o,t.endOffset=_(o))),C(n),n.nodeType===F?o.appendData(n.data):d.push(S(n));else if(n.nodeType===w){for(i=d.length;i--;)n.appendChild(d.pop());x(n,t)}}function k(e,t){if(e.nodeType===F&&(e=e.parentNode),e.nodeType===w){var n={startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset};x(e,n),t.setStart(n.startContainer,n.startOffset),t.setEnd(n.endContainer,n.endOffset)}}function A(e,t,n,o){for(var i,r,a,s=t;(i=s.parentNode)&&i!==o&&i.nodeType===w&&1===i.childNodes.length;)s=i;C(s),a=e.childNodes.length,r=e.lastChild,r&&"BR"===r.nodeName&&(e.removeChild(r),a-=1),e.appendChild(S(t)),n.setStart(e,a),n.collapse(!0),k(e,n),Y&&(r=e.lastChild)&&"BR"===r.nodeName&&e.removeChild(r)}function L(e,t){var n,o,i=e.previousSibling,r=e.firstChild,a=e.ownerDocument,s="LI"===e.nodeName;if(!s||r&&/^[OU]L$/.test(r.nodeName))if(i&&f(i,e)){if(!d(i)){if(!s)return;o=y(a,"DIV"),o.appendChild(S(i)),i.appendChild(o)}C(e),n=!d(e),i.appendChild(S(e)),n&&E(i,t),r&&L(r,t)}else s&&(i=y(a,"DIV"),e.insertBefore(i,r),T(i,t))}function B(e){this.isShiftDown=e.shiftKey}function O(e,t,n){var o,i;if(e||(e={}),t)for(o in t)!n&&o in e||(i=t[o],e[o]=i&&i.constructor===Object?O(e[o],i,n):i);return e}function D(e,t){e.nodeType===M&&(e=e.body);var n,o=e.ownerDocument,i=o.defaultView;this._win=i,this._doc=o,this._root=e,this._events={},this._isFocused=!1,this._lastSelection=null,ie&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in o?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,re?(n=new MutationObserver(this._docWasChanged.bind(this)),n.observe(e,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=n):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",R),this.addEventListener("mousedown",P),this.addEventListener("touchstart",P),this.addEventListener("focus",U),this._awaitingPaste=!1,this.addEventListener(V?"beforecut":"cut",Je),this.addEventListener("copy",et),this.addEventListener("keydown",B),this.addEventListener("keyup",B),this.addEventListener(V?"beforepaste":"paste",tt),this.addEventListener("drop",nt),this.addEventListener(Y?"keypress":"keydown",Pe),this._keyHandlers=Object.create(Fe),this.setConfig(t),V&&(i.Text.prototype.splitText=function(e){var t=this.ownerDocument.createTextNode(this.data.slice(e)),n=this.nextSibling,o=this.parentNode,i=this.length-e;return n?o.insertBefore(t,n):o.appendChild(t),i&&this.deleteData(e,i),t}),e.setAttribute("contenteditable","true");try{o.execCommand("enableObjectResizing",!1,"false"),o.execCommand("enableInlineTableEditing",!1,"false")}catch(e){}e.__squire__=this,this.setHTML("")}function R(){this._restoreSelection=!0}function P(){this._restoreSelection=!1}function U(){this._restoreSelection&&this.setSelection(this._lastSelection)}function I(e,t,n){var o,i;for(o=t.firstChild;o;o=i){if(i=o.nextSibling,a(o)){if(o.nodeType===F||"BR"===o.nodeName||"IMG"===o.nodeName){n.appendChild(o);continue}}else if(s(o)){n.appendChild(e.createDefaultBlock([I(e,o,e._doc.createDocumentFragment())]));continue}I(e,o,n)}return n}var w=1,F=3,M=9,H=11,W=1,z="​",q=e.defaultView,K=navigator.userAgent,G=/Android/.test(K),Z=/iP(?:ad|hone|od)/.test(K),j=/Mac OS X/.test(K),$=/Windows NT/.test(K),Q=/Gecko\//.test(K),V=/Trident\/[456]\./.test(K),Y=!!q.opera,X=/Edge\//.test(K),J=!X&&/WebKit\//.test(K),ee=/Trident\/[4567]\./.test(K),te=j?"meta-":"ctrl-",ne=V||Y,oe=V||J,ie=V,re="undefined"!=typeof MutationObserver,ae="undefined"!=typeof WeakMap,se=/[^ \t\r\n]/,de=Array.prototype.indexOf;Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t});var le={1:1,2:2,3:4,8:128,9:256,11:1024},ce=function(){return!0};n.prototype.nextNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.firstChild;!e&&t&&t!==n;)(e=t.nextSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousNode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){if(t===n)return null;if(e=t.previousSibling)for(;t=e.lastChild;)e=t;else e=t.parentNode;if(!e)return null;if(le[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}},n.prototype.previousPONode=function(){for(var e,t=this.currentNode,n=this.root,o=this.nodeType,i=this.filter;;){for(e=t.lastChild;!e&&t&&t!==n;)(e=t.previousSibling)||(t=t.parentNode);if(!e)return null;if(le[e.nodeType]&o&&i(e))return this.currentNode=e,e;t=e}};var he=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,ue={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1},fe=0,pe=1,ge=2,me=3,ve=ae?new WeakMap:null,_e=function(e,t){for(var n=e.childNodes;t&&e.nodeType===w;)e=n[t-1],n=e.childNodes,t=n.length;return e},Ce=function(e,t){if(e.nodeType===w){var n=e.childNodes;if(t<n.length)e=n[t];else{for(;e&&!e.nextSibling;)e=e.parentNode;e&&(e=e.nextSibling)}}return e},Ne=function(e,t){var n,o,i,r,a=e.startContainer,s=e.startOffset,d=e.endContainer,l=e.endOffset;a.nodeType===F?(n=a.parentNode,o=n.childNodes,s===a.length?(s=de.call(o,a)+1,e.collapsed&&(d=n,l=s)):(s&&(r=a.splitText(s),d===a?(l-=s,d=r):d===n&&(l+=1),a=r),s=de.call(o,a)),a=n):o=a.childNodes,i=o.length,s===i?a.appendChild(t):a.insertBefore(t,o[s]),a===d&&(l+=o.length-i),e.setStart(a,s),e.setEnd(d,l)},Se=function(e,t,n){var o=e.startContainer,i=e.startOffset,r=e.endContainer,a=e.endOffset;t||(t=e.commonAncestorContainer),t.nodeType===F&&(t=t.parentNode);for(var s,d,l,c,h,u=b(r,a,t,n),f=b(o,i,t,n),p=t.ownerDocument.createDocumentFragment();f!==u;)s=f.nextSibling,p.appendChild(f),f=s;return o=t,i=u?de.call(t.childNodes,u):t.childNodes.length,l=t.childNodes[i],d=l&&l.previousSibling,d&&d.nodeType===F&&l.nodeType===F&&(o=d,i=d.length,c=d.data,h=l.data," "===c.charAt(c.length-1)&&" "===h.charAt(0)&&(h=" "+h.slice(1)),d.appendData(h),C(l)),e.setStart(o,i),e.collapse(!0),T(t,n),p},ye=function(e,t){var n,o,i=ke(e,t),r=Ae(e,t),a=i!==r;return be(e),xe(e,i,r,t),n=Se(e,null,t),be(e),a&&(r=Ae(e,t),i&&r&&i!==r&&A(i,r,e,t)),i&&T(i,t),o=t.firstChild,o&&"BR"!==o.nodeName?e.collapse(!0):(T(t,t),e.selectNodeContents(t.firstChild)),n},Te=function(e,t,n){var o,i,r,s,l,f,p,m,v,N,S;for(E(t,n),o=t;o=h(o,n);)T(o,n);if(e.collapsed||ye(e,n),be(e),e.collapse(!1),s=g(e.endContainer,n,"BLOCKQUOTE")||n,i=ke(e,n),m=h(t,t),p=!!i&&u(i),i&&m&&!p&&!g(m,t,"PRE")&&!g(m,t,"TABLE")){if(xe(e,i,i,n),e.collapse(!0),l=e.endContainer,f=e.endOffset,Ye(i,n,!1),a(l)&&(v=b(l,f,c(l,n),n),l=v.parentNode,f=de.call(l.childNodes,v)),f!==_(l))for(r=n.ownerDocument.createDocumentFragment();o=l.childNodes[f];)r.appendChild(o);A(l,m,e,n),f=de.call(l.parentNode.childNodes,l)+1,l=l.parentNode,e.setEnd(l,f)}_(t)&&(p&&(e.setEndBefore(i),e.collapse(!1),C(i)),xe(e,s,s,n),v=b(e.endContainer,e.endOffset,s,n),N=v?v.previousSibling:s.lastChild,s.insertBefore(t,v),v?e.setEndBefore(v):e.setEnd(s,_(s)),i=Ae(e,n),be(e),l=e.endContainer,f=e.endOffset,v&&d(v)&&L(v,n),v=N&&N.nextSibling,v&&d(v)&&L(v,n),e.setEnd(l,f)),r&&(S=e.cloneRange(),A(i,r,S,n),e.setEnd(S.endContainer,S.endOffset)),be(e)},Ee=function(e,t,n){var o=t.ownerDocument.createRange();if(o.selectNode(t),n){var i=e.compareBoundaryPoints(3,o)>-1,r=e.compareBoundaryPoints(1,o)<1;return!i&&!r}var a=e.compareBoundaryPoints(0,o)<1,s=e.compareBoundaryPoints(2,o)>-1;return a&&s},be=function(e){for(var t,n=e.startContainer,o=e.startOffset,r=e.endContainer,a=e.endOffset,s=!0;n.nodeType!==F&&(t=n.childNodes[o])&&!i(t);)n=t,o=0;if(a)for(;r.nodeType!==F;){if(!(t=r.childNodes[a-1])||i(t)){if(s&&t&&"BR"===t.nodeName){a-=1,s=!1;continue}break}r=t,a=_(r)}else for(;r.nodeType!==F&&(t=r.firstChild)&&!i(t);)r=t;e.collapsed?(e.setStart(r,a),e.setEnd(n,o)):(e.setStart(n,o),e.setEnd(r,a))},xe=function(e,t,n,o){var i,r=e.startContainer,a=e.startOffset,s=e.endContainer,d=e.endOffset,l=!0;for(t||(t=e.commonAncestorContainer),n||(n=t);!a&&r!==t&&r!==o;)i=r.parentNode,a=de.call(i.childNodes,r),r=i;for(;;){if(l&&s.nodeType!==F&&s.childNodes[d]&&"BR"===s.childNodes[d].nodeName&&(d+=1,l=!1),s===n||s===o||d!==_(s))break;i=s.parentNode,d=de.call(i.childNodes,s)+1,s=i}e.setStart(r,a),e.setEnd(s,d)},ke=function(e,t){var n,o=e.startContainer;return a(o)?n=c(o,t):o!==t&&s(o)?n=o:(n=_e(o,e.startOffset),n=h(n,t)),n&&Ee(e,n,!0)?n:null},Ae=function(e,t){var n,o,i=e.endContainer;if(a(i))n=c(i,t);else if(i!==t&&s(i))n=i;else{if(!(n=Ce(i,e.endOffset))||!m(t,n))for(n=t;o=n.lastChild;)n=o;n=c(n,t)}return n&&Ee(e,n,!0)?n:null},Le=new n(null,4|W,function(e){return e.nodeType===F?se.test(e.data):"IMG"===e.nodeName}),Be=function(e,t){var n,o=e.startContainer,i=e.startOffset;if(Le.root=null,o.nodeType===F){if(i)return!1;n=o}else if(n=Ce(o,i),n&&!m(t,n)&&(n=null),!n&&(n=_e(o,i),n.nodeType===F&&n.length))return!1;return Le.currentNode=n,Le.root=ke(e,t),!Le.previousNode()},Oe=function(e,t){var n,o=e.endContainer,i=e.endOffset;if(Le.root=null,o.nodeType===F){if((n=o.data.length)&&i<n)return!1;Le.currentNode=o}else Le.currentNode=_e(o,i);return Le.root=Ae(e,t),!Le.nextNode()},De=function(e,t){var n,o=ke(e,t),i=Ae(e,t);o&&i&&(n=o.parentNode,e.setStart(n,de.call(n.childNodes,o)),n=i.parentNode,e.setEnd(n,de.call(n.childNodes,i)+1))},Re={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},Pe=function(e){var t=e.keyCode,n=Re[t],o="",i=this.getSelection();e.defaultPrevented||(n||(n=String.fromCharCode(t).toLowerCase(),/^[A-Za-z0-9]$/.test(n)||(n="")),Y&&46===e.which&&(n="."),111<t&&t<124&&(n="f"+(t-111)),"backspace"!==n&&"delete"!==n&&(e.altKey&&(o+="alt-"),e.ctrlKey&&(o+="ctrl-"),e.metaKey&&(o+="meta-")),e.shiftKey&&(o+="shift-"),n=o+n,this._keyHandlers[n]?this._keyHandlers[n](this,e,i):i.collapsed||e.ctrlKey||e.metaKey||1!==(e.key||n).length||(this.saveUndoState(i),ye(i,this._root),this._ensureBottomLine(),this.setSelection(i),this._updatePath(i,!0)))},Ue=function(e){return function(t,n){n.preventDefault(),t[e]()}},Ie=function(e,t){return t=t||null,function(n,o){o.preventDefault();var i=n.getSelection();n.hasFormat(e,null,i)?n.changeFormat(null,{tag:e},i):n.changeFormat({tag:e},t,i)}},we=function(e,t){try{t||(t=e.getSelection());var n,o=t.startContainer;for(o.nodeType===F&&(o=o.parentNode),n=o;a(n)&&(!n.textContent||n.textContent===z);)o=n,n=o.parentNode;o!==n&&(t.setStart(n,de.call(n.childNodes,o)),t.collapse(!0),n.removeChild(o),s(n)||(n=c(n,e._root)),T(n,e._root),be(t)),o===e._root&&(o=o.firstChild)&&"BR"===o.nodeName&&C(o),e._ensureBottomLine(),e.setSelection(t),e._updatePath(t,!0)}catch(t){e.didError(t)}},Fe={enter:function(e,t,n){var o,i,r,a,s,d=e._root;if(t.preventDefault(),e._recordUndoState(n),Nt(n.startContainer,d,e),e._removeZWS(),e._getRangeAndRemoveBookmark(n),n.collapsed||ye(n,d),(o=ke(n,d))&&(i=g(o,d,"PRE")))return be(n),r=n.startContainer,a=n.startOffset,r.nodeType!==F&&(r=e._doc.createTextNode(""),i.insertBefore(r,i.firstChild)),t.shiftKey||"\n"!==r.data.charAt(a-1)&&!Be(n,d)||"\n"!==r.data.charAt(a)&&!Oe(n,d)?(r.insertData(a,"\n"),T(i,d),r.length===a+1?n.setStartAfter(r):n.setStart(r,a+1)):(r.deleteData(a&&a-1,a?2:1),s=b(r,a&&a-1,d,d),r=s.previousSibling,r.textContent||C(r),r=e.createDefaultBlock(),s.parentNode.insertBefore(r,s),s.textContent||C(s),n.setStart(r,0)),n.collapse(!0),e.setSelection(n),e._updatePath(n,!0),void e._docWasChanged();if(!o||t.shiftKey||/^T[HD]$/.test(o.nodeName))return i=g(n.endContainer,d,"A"),i&&(i=i.parentNode,xe(n,i,i,d),n.collapse(!1)),Ne(n,e.createElement("BR")),n.collapse(!1),e.setSelection(n),void e._updatePath(n,!0);if((i=g(o,d,"LI"))&&(o=i),u(o)){if(g(o,d,"UL")||g(o,d,"OL"))return e.decreaseListLevel(n);if(g(o,d,"BLOCKQUOTE"))return e.modifyBlocks(ft,n)}for(s=ct(e,o,n.startContainer,n.startOffset),st(o),$e(o),T(o,d);s.nodeType===w;){var l,c=s.firstChild;if("A"===s.nodeName&&(!s.textContent||s.textContent===z)){c=e._doc.createTextNode(""),N(s,c),s=c;break}for(;c&&c.nodeType===F&&!c.data&&(l=c.nextSibling)&&"BR"!==l.nodeName;)C(c),c=l;if(!c||"BR"===c.nodeName||c.nodeType===F&&!Y)break;s=c}n=e.createRange(s,0),e.setSelection(n),e._updatePath(n,!0)},"shift-enter":function(e,t,n){return e._keyHandlers.enter(e,t,n)},backspace:function(e,t,n){var o=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Be(n,o)){t.preventDefault();var i,r=ke(n,o);if(!r)return;if(E(r.parentNode,o),i=c(r,o)){if(!i.isContentEditable)return void C(i);for(A(i,r,n,o),r=i.parentNode;r!==o&&!r.nextSibling;)r=r.parentNode;r!==o&&(r=r.nextSibling)&&L(r,o),e.setSelection(n)}else if(r){if(g(r,o,"UL")||g(r,o,"OL"))return e.decreaseListLevel(n);if(g(r,o,"BLOCKQUOTE"))return e.modifyBlocks(ut,n);e.setSelection(n),e._updatePath(n,!0)}}else e.setSelection(n),setTimeout(function(){we(e)},0);else t.preventDefault(),ye(n,o),we(e,n)},delete:function(e,t,n){var o,i,r,a,s,d,l=e._root;if(e._removeZWS(),e.saveUndoState(n),n.collapsed)if(Oe(n,l)){if(t.preventDefault(),!(o=ke(n,l)))return;if(E(o.parentNode,l),i=h(o,l)){if(!i.isContentEditable)return void C(i);for(A(o,i,n,l),i=o.parentNode;i!==l&&!i.nextSibling;)i=i.parentNode;i!==l&&(i=i.nextSibling)&&L(i,l),e.setSelection(n),e._updatePath(n,!0)}}else{if(r=n.cloneRange(),xe(n,l,l,l),a=n.endContainer,s=n.endOffset,a.nodeType===w&&(d=a.childNodes[s])&&"IMG"===d.nodeName)return t.preventDefault(),C(d),be(n),void we(e,n);e.setSelection(r),setTimeout(function(){we(e)},0)}else t.preventDefault(),ye(n,l),we(e,n)},tab:function(e,t,n){var o,i,r=e._root;if(e._removeZWS(),n.collapsed&&Be(n,r))for(o=ke(n,r);i=o.parentNode;){if("UL"===i.nodeName||"OL"===i.nodeName){t.preventDefault(),e.increaseListLevel(n);break}o=i}},"shift-tab":function(e,t,n){var o,i=e._root;e._removeZWS(),n.collapsed&&Be(n,i)&&(o=n.startContainer,(g(o,i,"UL")||g(o,i,"OL"))&&(t.preventDefault(),e.decreaseListLevel(n)))},space:function(e,t,n){var o,i=e._root;if(e._recordUndoState(n),Nt(n.startContainer,i,e),e._getRangeAndRemoveBookmark(n),o=n.endContainer,n.collapsed&&n.endOffset===_(o))do{if("A"===o.nodeName){n.setStartAfter(o);break}}while(!o.nextSibling&&(o=o.parentNode)&&o!==i);n.collapsed||(ye(n,i),e._ensureBottomLine(),e.setSelection(n),e._updatePath(n,!0)),e.setSelection(n)},left:function(e){e._removeZWS()},right:function(e){e._removeZWS()}};j&&Q&&(Fe["meta-left"]=function(e,t){t.preventDefault();var n=at(e);n&&n.modify&&n.modify("move","backward","lineboundary")},Fe["meta-right"]=function(e,t){t.preventDefault();var n=at(e);n&&n.modify&&n.modify("move","forward","lineboundary")}),j||(Fe.pageup=function(e){e.moveCursorToStart()},Fe.pagedown=function(e){e.moveCursorToEnd()}),Fe[te+"b"]=Ie("B"),Fe[te+"i"]=Ie("I"),Fe[te+"u"]=Ie("U"),Fe[te+"shift-7"]=Ie("S"),Fe[te+"shift-5"]=Ie("SUB",{tag:"SUP"}),Fe[te+"shift-6"]=Ie("SUP",{tag:"SUB"}),Fe[te+"shift-8"]=Ue("makeUnorderedList"),Fe[te+"shift-9"]=Ue("makeOrderedList"),Fe[te+"["]=Ue("decreaseQuoteLevel"),Fe[te+"]"]=Ue("increaseQuoteLevel"),Fe[te+"d"]=Ue("toggleCode"),Fe[te+"y"]=Ue("redo"),Fe[te+"z"]=Ue("undo"),Fe[te+"shift-z"]=Ue("redo");var Me={1:10,2:13,3:16,4:18,5:24,6:32,7:48},He={backgroundColor:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.highlight,style:"background-color:"+n})}},color:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.colour,style:"color:"+n})}},fontWeight:{regexp:/^bold|^700/i,replace:function(e){return y(e,"B")}},fontStyle:{regexp:/^italic/i,replace:function(e){return y(e,"I")}},fontFamily:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontFamily,style:"font-family:"+n})}},fontSize:{regexp:se,replace:function(e,t,n){return y(e,"SPAN",{class:t.fontSize,style:"font-size:"+n})}},textDecoration:{regexp:/^underline/i,replace:function(e){return y(e,"U")}}},We=function(e){return function(t,n){var o=y(t.ownerDocument,e);return n.replaceChild(o,t),o.appendChild(S(t)),o}},ze=function(e,t,n){var o,i,r,a,s,d,l=e.style,c=e.ownerDocument;for(o in He)i=He[o],(r=l[o])&&i.regexp.test(r)&&(d=i.replace(c,n.classNames,r),s||(s=d),a&&a.appendChild(d),a=d,e.style[o]="");return s&&(a.appendChild(S(e)),"SPAN"===e.nodeName?t.replaceChild(s,e):e.appendChild(s)),a||e},qe={P:ze,SPAN:ze,STRONG:We("B"),EM:We("I"),INS:We("U"),STRIKE:We("S"),FONT:function(e,t,n){var o,i,r,a,s,d=e.face,l=e.size,c=e.color,h=e.ownerDocument,u=n.classNames;return d&&(o=y(h,"SPAN",{class:u.fontFamily,style:"font-family:"+d}),s=o,a=o),l&&(i=y(h,"SPAN",{class:u.fontSize,style:"font-size:"+Me[l]+"px"}),s||(s=i),a&&a.appendChild(i),a=i),c&&/^#?([\dA-F]{3}){1,2}$/i.test(c)&&("#"!==c.charAt(0)&&(c="#"+c),r=y(h,"SPAN",{class:u.colour,style:"color:"+c}),s||(s=r),a&&a.appendChild(r),a=r),s||(s=a=y(h,"SPAN")),t.replaceChild(s,e),a.appendChild(S(e)),a},TT:function(e,t,n){var o=y(e.ownerDocument,"SPAN",{class:n.classNames.fontFamily,style:'font-family:menlo,consolas,"courier new",monospace'});return t.replaceChild(o,e),o.appendChild(S(e)),o}},Ke=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,Ge=/^(?:HEAD|META|STYLE)/,Ze=new n(null,4|W),je=function e(t,n,o){var i,r,s,d,l,c,h,u,f,p,g,m,v=t.childNodes;for(i=t;a(i);)i=i.parentNode;for(Ze.root=i,r=0,s=v.length;r<s;r+=1)if(d=v[r],l=d.nodeName,c=d.nodeType,h=qe[l],c===w){if(u=d.childNodes.length,h)d=h(d,t,n);else{if(Ge.test(l)){t.removeChild(d),r-=1,s-=1;continue}if(!Ke.test(l)&&!a(d)){r-=1,s+=u-1,t.replaceChild(S(d),d);continue}}u&&e(d,n,o||"PRE"===l)}else{if(c===F){if(g=d.data,f=!se.test(g.charAt(0)),p=!se.test(g.charAt(g.length-1)),o||!f&&!p)continue;if(f){for(Ze.currentNode=d;(m=Ze.previousPONode())&&!("IMG"===(l=m.nodeName)||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/^[ \t\r\n]+/g,m?" ":"")}if(p){for(Ze.currentNode=d;(m=Ze.nextNode())&&!("IMG"===l||"#text"===l&&se.test(m.data));)if(!a(m)){m=null;break}g=g.replace(/[ \t\r\n]+$/g,m?" ":"")}if(g){d.data=g;continue}}t.removeChild(d),r-=1,s-=1}return t},$e=function e(t){for(var n,o=t.childNodes,r=o.length;r--;)n=o[r],n.nodeType!==w||i(n)?n.nodeType!==F||n.data||t.removeChild(n):(e(n),a(n)&&!n.firstChild&&t.removeChild(n))},Qe=function(e){return e.nodeType===w?"BR"===e.nodeName:se.test(e.data)},Ve=function(e,t){for(var o,i=e.parentNode;a(i);)i=i.parentNode;return o=new n(i,4|W,Qe),o.currentNode=e,!!o.nextNode()||t&&!o.previousNode()},Ye=function(e,t,n){var o,i,r,s=e.querySelectorAll("BR"),d=[],l=s.length;for(o=0;o<l;o+=1)d[o]=Ve(s[o],n);for(;l--;)i=s[l],(r=i.parentNode)&&(d[l]?a(r)||E(r,t):C(i))},Xe=function(e,t,n,o){var i,r,a=t.ownerDocument.body,s=o.willCutCopy;Ye(t,n,!0),t.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),a.appendChild(t),i=t.innerHTML,r=t.innerText||t.textContent,s&&(i=s(i)),$&&(r=r.replace(/\r?\n/g,"\r\n")),e.setData("text/html",i),e.setData("text/plain",r),a.removeChild(t)},Je=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root,h=this;if(l.collapsed)return void e.preventDefault();if(this.saveUndoState(l),X||Z||!d)setTimeout(function(){try{h._ensureBottomLine()}catch(e){h.didError(e)}},0);else{for(t=ke(l,c),n=Ae(l,c),o=t===n&&t||c,i=ye(l,c),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),Xe(d,s,c,this._config),e.preventDefault()}this.setSelection(l)},et=function(e){var t,n,o,i,r,a,s,d=e.clipboardData,l=this.getSelection(),c=this._root;if(!X&&!Z&&d){for(t=ke(l,c),n=Ae(l,c),o=t===n&&t||c,l=l.cloneRange(),be(l),xe(l,o,o,c),i=l.cloneContents(),r=l.commonAncestorContainer,r.nodeType===F&&(r=r.parentNode);r&&r!==o;)a=r.cloneNode(!1),a.appendChild(i),i=a,r=r.parentNode;s=this.createElement("div"),s.appendChild(i),Xe(d,s,c,this._config),e.preventDefault()}},tt=function(e){var t,n,o,i,r,a=e.clipboardData,s=a&&a.items,d=this.isShiftDown,l=!1,c=!1,h=null,u=this;if(X&&s){for(t=s.length;t--;)!d&&/^image\/.*/.test(s[t].type)&&(c=!0);c||(s=null)}if(s){for(e.preventDefault(),t=s.length;t--;){if(n=s[t],o=n.type,!d&&"text/html"===o)return void n.getAsString(function(e){u.insertHTML(e,!0)});"text/plain"===o&&(h=n),!d&&/^image\/.*/.test(o)&&(c=!0)}return void(c?(this.fireEvent("dragover",{dataTransfer:a,preventDefault:function(){l=!0}}),l&&this.fireEvent("drop",{dataTransfer:a})):h&&h.getAsString(function(e){u.insertPlainText(e,!0)}))}if(i=a&&a.types,!X&&i&&(de.call(i,"text/html")>-1||!Q&&de.call(i,"text/plain")>-1&&de.call(i,"text/rtf")<0))return e.preventDefault(),void(!d&&(r=a.getData("text/html"))?this.insertHTML(r,!0):((r=a.getData("text/plain"))||(r=a.getData("text/uri-list")))&&this.insertPlainText(r,!0));this._awaitingPaste=!0;var f=this._doc.body,p=this.getSelection(),g=p.startContainer,m=p.startOffset,v=p.endContainer,_=p.endOffset,N=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});f.appendChild(N),p.selectNodeContents(N),this.setSelection(p),setTimeout(function(){try{u._awaitingPaste=!1;for(var e,t,n="",o=N;N=o;)o=N.nextSibling,C(N),e=N.firstChild,e&&e===N.lastChild&&"DIV"===e.nodeName&&(N=e),n+=N.innerHTML;t=u.createRange(g,m,v,_),u.setSelection(t),n&&u.insertHTML(n,!0)}catch(e){u.didError(e)}},0)},nt=function(e){for(var t=e.dataTransfer.types,n=t.length,o=!1,i=!1;n--;)switch(t[n]){case"text/plain":o=!0;break;case"text/html":i=!0;break;default:return}(i||o)&&this.saveUndoState()},ot=D.prototype,it=function(e,t,n){var o=n._doc,i=e?DOMPurify.sanitize(e,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return i?o.importNode(i,!0):o.createDocumentFragment()};ot.setConfig=function(e){return e=O({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},classNames:{colour:"colour",fontFamily:"font",fontSize:"size",highlight:"highlight"},leafNodeNames:ue,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?it:null,willCutCopy:null},e,!0),e.blockTag=e.blockTag.toUpperCase(),this._config=e,this},ot.createElement=function(e,t,n){return y(this._doc,e,t,n)},ot.createDefaultBlock=function(e){var t=this._config;return T(this.createElement(t.blockTag,t.blockAttributes,e),this._root)},ot.didError=function(e){console.log(e)},ot.getDocument=function(){return this._doc},ot.getRoot=function(){return this._root},ot.modifyDocument=function(e){var t=this._mutation;t&&(t.takeRecords().length&&this._docWasChanged(),t.disconnect()),this._ignoreAllChanges=!0,e(),this._ignoreAllChanges=!1,t&&(t.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var rt={pathChange:1,select:1,input:1,undoStateChange:1};ot.fireEvent=function(e,t){var n,o,i,r=this._events[e];if(/^(?:focus|blur)/.test(e))if(n=this._root===this._doc.activeElement,"focus"===e){if(!n||this._isFocused)return this;this._isFocused=!0}else{if(n||!this._isFocused)return this;this._isFocused=!1}if(r)for(t||(t={}),t.type!==e&&(t.type=e),r=r.slice(),o=r.length;o--;){i=r[o];try{i.handleEvent?i.handleEvent(t):i.call(this,t)}catch(t){t.details="Squire: fireEvent error. Event type: "+e,this.didError(t)}}return this},ot.destroy=function(){var e,t=this._events;for(e in t)this.removeEventListener(e);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},ot.handleEvent=function(e){this.fireEvent(e.type,e)},ot.addEventListener=function(e,t){var n=this._events[e],o=this._root;return t?(n||(n=this._events[e]=[],rt[e]||("selectionchange"===e&&(o=this._doc),o.addEventListener(e,this,!0))),n.push(t),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+e}),this)},ot.removeEventListener=function(e,t){var n,o=this._events[e],i=this._root;if(o){if(t)for(n=o.length;n--;)o[n]===t&&o.splice(n,1);else o.length=0;o.length||(delete this._events[e],rt[e]||("selectionchange"===e&&(i=this._doc),i.removeEventListener(e,this,!0)))}return this},ot.createRange=function(e,t,n,o){if(e instanceof this._win.Range)return e.cloneRange();var i=this._doc.createRange();return i.setStart(e,t),n?i.setEnd(n,o):i.setEnd(e,t),i},ot.getCursorPosition=function(e){if(!e&&!(e=this.getSelection())||!e.getBoundingClientRect)return null;var t,n,o=e.getBoundingClientRect();return o&&!o.top&&(this._ignoreChange=!0,t=this._doc.createElement("SPAN"),t.textContent=z,Ne(e,t),o=t.getBoundingClientRect(),n=t.parentNode,n.removeChild(t),k(n,e)),o},ot._moveCursorTo=function(e){var t=this._root,n=this.createRange(t,e?0:t.childNodes.length);return be(n),this.setSelection(n),this},ot.moveCursorToStart=function(){return this._moveCursorTo(!0)},ot.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var at=function(e){return e._win.getSelection()||null};ot.setSelection=function(e){if(e)if(this._lastSelection=e,this._isFocused)if(G&&!this._restoreSelection)R.call(this),this.blur(),this.focus();else{Z&&this._win.focus();var t=at(this);t&&(t.removeAllRanges(),t.addRange(e))}else R.call(this);return this},ot.getSelection=function(){var e,t,n,o,r=at(this),a=this._root;return this._isFocused&&r&&r.rangeCount&&(e=r.getRangeAt(0).cloneRange(),t=e.startContainer,n=e.endContainer,t&&i(t)&&e.setStartBefore(t),n&&i(n)&&e.setEndBefore(n)),e&&m(a,e.commonAncestorContainer)?this._lastSelection=e:(e=this._lastSelection,o=e.commonAncestorContainer,m(o.ownerDocument,o)||(e=null)),e||(e=this.createRange(a.firstChild,0)),e},ot.getSelectedText=function(){var e=this.getSelection();if(!e||e.collapsed)return"";var t,o=new n(e.commonAncestorContainer,4|W,function(t){return Ee(e,t,!0)}),i=e.startContainer,r=e.endContainer,s=o.currentNode=i,d="",l=!1;for(o.filter(s)||(s=o.nextNode());s;)s.nodeType===F?(t=s.data)&&/\S/.test(t)&&(s===r&&(t=t.slice(0,e.endOffset)),s===i&&(t=t.slice(e.startOffset)),d+=t,l=!0):("BR"===s.nodeName||l&&!a(s))&&(d+="\n",l=!1),s=o.nextNode();return d},ot.getPath=function(){return this._path};var st=function(e,t){for(var o,i,r,s=new n(e,4);i=s.nextNode();)for(;(r=i.data.indexOf(z))>-1&&(!t||i.parentNode!==t);){if(1===i.length){do{o=i.parentNode,o.removeChild(i),i=o,s.currentNode=o}while(a(i)&&!_(i));break}i.deleteData(r,1)}};ot._didAddZWS=function(){this._hasZWS=!0},ot._removeZWS=function(){this._hasZWS&&(st(this._root),this._hasZWS=!1)},ot._updatePath=function(e,t){if(e){var n,o=e.startContainer,i=e.endContainer;(t||o!==this._lastAnchorNode||i!==this._lastFocusNode)&&(this._lastAnchorNode=o,this._lastFocusNode=i,n=o&&i?o===i?v(i,this._root,this._config):"(selection)":"",this._path!==n&&(this._path=n,this.fireEvent("pathChange",{path:n}))),this.fireEvent(e.collapsed?"cursor":"select",{range:e})}},ot._updatePathOnEvent=function(e){var t=this;t._isFocused&&!t._willUpdatePath&&(t._willUpdatePath=!0,setTimeout(function(){t._willUpdatePath=!1,t._updatePath(t.getSelection())},0))},ot.focus=function(){return this._root.focus(),ee&&this.fireEvent("focus"),this},ot.blur=function(){return this._root.blur(),ee&&this.fireEvent("blur"),this};var dt="squire-selection-end"
;ot._saveRangeToBookmark=function(e){var t,n=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),o=this.createElement("INPUT",{id:dt,type:"hidden"});Ne(e,n),e.collapse(!1),Ne(e,o),2&n.compareDocumentPosition(o)&&(n.id=dt,o.id="squire-selection-start",t=n,n=o,o=t),e.setStartAfter(n),e.setEndBefore(o)},ot._getRangeAndRemoveBookmark=function(e){var t=this._root,n=t.querySelector("#squire-selection-start"),o=t.querySelector("#"+dt);if(n&&o){var i=n.parentNode,r=o.parentNode,a=de.call(i.childNodes,n),s=de.call(r.childNodes,o);i===r&&(s-=1),C(n),C(o),e||(e=this._doc.createRange()),e.setStart(i,a),e.setEnd(r,s),k(i,e),i!==r&&k(r,e),e.collapsed&&(i=e.startContainer,i.nodeType===F&&(r=i.childNodes[e.startOffset],r&&r.nodeType===F||(r=i.childNodes[e.startOffset-1]),r&&r.nodeType===F&&(e.setStart(r,0),e.collapse(!0))))}return e||null},ot._keyUpDetectChange=function(e){var t=e.keyCode;e.ctrlKey||e.metaKey||e.altKey||!(t<16||t>20)||!(t<33||t>45)||this._docWasChanged()},ot._docWasChanged=function(){if(ae&&(ve=new WeakMap),!this._ignoreAllChanges){if(re&&this._ignoreChange)return void(this._ignoreChange=!1);this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")}},ot._recordUndoState=function(e,t){if(!this._isInUndoState||t){var n,o=this._undoIndex,i=this._undoStack,r=this._config.undo,a=r.documentSizeThreshold,s=r.undoLimit;t||(o+=1),o<this._undoStackLength&&(i.length=this._undoStackLength=o),e&&this._saveRangeToBookmark(e),n=this._getHTML(),a>-1&&2*n.length>a&&s>-1&&o>s&&(i.splice(0,o-s),o=s,this._undoStackLength=s),i[o]=n,this._undoIndex=o,this._undoStackLength+=1,this._isInUndoState=!0}},ot.saveUndoState=function(e){return e===t&&(e=this.getSelection()),this._recordUndoState(e,this._isInUndoState),this._getRangeAndRemoveBookmark(e),this},ot.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var e=this._getRangeAndRemoveBookmark();e&&this.setSelection(e),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},ot.redo=function(){var e=this._undoIndex,t=this._undoStackLength;if(e+1<t&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var n=this._getRangeAndRemoveBookmark();n&&this.setSelection(n),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:e+2<t}),this.fireEvent("input")}return this},ot.hasFormat=function(e,t,o){if(e=e.toUpperCase(),t||(t={}),!o&&!(o=this.getSelection()))return!1;!o.collapsed&&o.startContainer.nodeType===F&&o.startOffset===o.startContainer.length&&o.startContainer.nextSibling&&o.setStartBefore(o.startContainer.nextSibling),!o.collapsed&&o.endContainer.nodeType===F&&0===o.endOffset&&o.endContainer.previousSibling&&o.setEndAfter(o.endContainer.previousSibling);var i,r,a=this._root,s=o.commonAncestorContainer;if(g(s,a,e,t))return!0;if(s.nodeType===F)return!1;i=new n(s,4,function(e){return Ee(o,e,!0)});for(var d=!1;r=i.nextNode();){if(!g(r,a,e,t))return!1;d=!0}return d},ot.getFontInfo=function(e){var n,o,i,r={color:t,backgroundColor:t,family:t,size:t},a=0;if(!e&&!(e=this.getSelection()))return r;if(n=e.commonAncestorContainer,e.collapsed||n.nodeType===F)for(n.nodeType===F&&(n=n.parentNode);a<4&&n;)(o=n.style)&&(!r.color&&(i=o.color)&&(r.color=i,a+=1),!r.backgroundColor&&(i=o.backgroundColor)&&(r.backgroundColor=i,a+=1),!r.family&&(i=o.fontFamily)&&(r.family=i,a+=1),!r.size&&(i=o.fontSize)&&(r.size=i,a+=1)),n=n.parentNode;return r},ot._addFormat=function(e,t,o){var i,r,s,d,l,c,h,u,f=this._root;if(o.collapsed){for(i=T(this.createElement(e,t),f),Ne(o,i),o.setStart(i.firstChild,i.firstChild.length),o.collapse(!0),u=i;a(u);)u=u.parentNode;st(u,i)}else{if(r=new n(o.commonAncestorContainer,4|W,function(e){return(e.nodeType===F||"BR"===e.nodeName||"IMG"===e.nodeName)&&Ee(o,e,!0)}),s=o.startContainer,l=o.startOffset,d=o.endContainer,c=o.endOffset,r.currentNode=s,r.filter(s)||(s=r.nextNode(),l=0),!s)return o;do{h=r.currentNode,!g(h,f,e,t)&&(h===d&&h.length>c&&h.splitText(c),h===s&&l&&(h=h.splitText(l),d===s&&(d=h,c-=l),s=h,l=0),i=this.createElement(e,t),N(h,i),i.appendChild(h))}while(r.nextNode());d.nodeType!==F&&(h.nodeType===F?(d=h,c=h.length):(d=h.parentNode,c=1)),o=this.createRange(s,l,d,c)}return o},ot._removeFormat=function(e,t,n,o){this._saveRangeToBookmark(n);var i,r=this._doc;n.collapsed&&(oe?(i=r.createTextNode(z),this._didAddZWS()):i=r.createTextNode(""),Ne(n,i));for(var s=n.commonAncestorContainer;a(s);)s=s.parentNode;var d=n.startContainer,l=n.startOffset,c=n.endContainer,h=n.endOffset,u=[],f=function(e,t){if(!Ee(n,e,!1)){var o,i,r=e.nodeType===F;if(!Ee(n,e,!0))return void("INPUT"===e.nodeName||r&&!e.data||u.push([t,e]));if(r)e===c&&h!==e.length&&u.push([t,e.splitText(h)]),e===d&&l&&(e.splitText(l),u.push([t,e]));else for(o=e.firstChild;o;o=i)i=o.nextSibling,f(o,t)}},g=Array.prototype.filter.call(s.getElementsByTagName(e),function(o){return Ee(n,o,!0)&&p(o,e,t)});return o||g.forEach(function(e){f(e,e)}),u.forEach(function(e){var t=e[0].cloneNode(!1),n=e[1];N(n,t),t.appendChild(n)}),g.forEach(function(e){N(e,S(e))}),this._getRangeAndRemoveBookmark(n),i&&n.collapse(!1),k(s,n),n},ot.changeFormat=function(e,t,n,o){return n||(n=this.getSelection())?(this.saveUndoState(n),t&&(n=this._removeFormat(t.tag.toUpperCase(),t.attributes||{},n,o)),e&&(n=this._addFormat(e.tag.toUpperCase(),e.attributes||{},n)),this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged(),this):this};var lt={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},ct=function(e,t,n,o){var i=lt[t.nodeName],r=null,a=b(n,o,t.parentNode,e._root),s=e._config;return i||(i=s.blockTag,r=s.blockAttributes),p(a,i,r)||(t=y(a.ownerDocument,i,r),a.dir&&(t.dir=a.dir),N(a,t),t.appendChild(S(a)),a=t),a};ot.forEachBlock=function(e,t,n){if(!n&&!(n=this.getSelection()))return this;t&&this.saveUndoState(n);var o=this._root,i=ke(n,o),r=Ae(n,o);if(i&&r)do{if(e(i)||i===r)break}while(i=h(i,o));return t&&(this.setSelection(n),this._updatePath(n,!0),re||this._docWasChanged()),this},ot.modifyBlocks=function(e,t){if(!t&&!(t=this.getSelection()))return this;this._recordUndoState(t,this._isInUndoState);var n,o=this._root;return De(t,o),xe(t,o,o,o),n=Se(t,o,o),Ne(t,e.call(this,n)),t.endOffset<t.endContainer.childNodes.length&&L(t.endContainer.childNodes[t.endOffset],o),L(t.startContainer.childNodes[t.startOffset],o),this._getRangeAndRemoveBookmark(t),this.setSelection(t),this._updatePath(t,!0),re||this._docWasChanged(),this};var ht=function(e){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[e])},ut=function(e){var t=this._root,n=e.querySelectorAll("blockquote");return Array.prototype.filter.call(n,function(e){return!g(e.parentNode,t,"BLOCKQUOTE")}).forEach(function(e){N(e,S(e))}),e},ft=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:dt,type:"hidden"})])},pt=function(e,t,n){for(var o,i,r,a,s=l(t,e._root),d=e._config.tagAttributes,c=d[n.toLowerCase()],h=d.li;o=s.nextNode();)"LI"===o.parentNode.nodeName&&(o=o.parentNode,s.currentNode=o.lastChild),"LI"!==o.nodeName?(a=e.createElement("LI",h),o.dir&&(a.dir=o.dir),(r=o.previousSibling)&&r.nodeName===n?(r.appendChild(a),C(o)):N(o,e.createElement(n,c,[a])),a.appendChild(S(o)),s.currentNode=a):(o=o.parentNode,(i=o.nodeName)!==n&&/^[OU]L$/.test(i)&&N(o,e.createElement(n,c,[S(o)])))},gt=function(e){return pt(this,e,"UL"),e},mt=function(e){return pt(this,e,"OL"),e},vt=function(e){var t,n,o,i,r,a=e.querySelectorAll("UL, OL"),d=e.querySelectorAll("LI"),l=this._root;for(t=0,n=a.length;t<n;t+=1)o=a[t],i=S(o),E(i,l),N(o,i);for(t=0,n=d.length;t<n;t+=1)r=d[t],s(r)?N(r,this.createDefaultBlock([S(r)])):(E(r,l),N(r,S(r)));return e},_t=function(e,t){for(var n=e.commonAncestorContainer,o=e.startContainer,i=e.endContainer;n&&n!==t&&!/^[OU]L$/.test(n.nodeName);)n=n.parentNode;if(!n||n===t)return null;for(o===n&&(o=o.childNodes[e.startOffset]),i===n&&(i=i.childNodes[e.endOffset]);o&&o.parentNode!==n;)o=o.parentNode;for(;i&&i.parentNode!==n;)i=i.parentNode;return[n,o,i]};ot.increaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=_t(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];if(!i||i===o.firstChild)return this.focus();this._recordUndoState(e,this._isInUndoState);var a,s,d=o.nodeName,l=i.previousSibling;l.nodeName!==d&&(a=this._config.tagAttributes[d.toLowerCase()],l=this.createElement(d,a),o.insertBefore(l,i));do{s=i===r?null:i.nextSibling,l.appendChild(i)}while(i=s);return s=l.nextSibling,s&&L(s,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},ot.decreaseListLevel=function(e){if(!e&&!(e=this.getSelection()))return this.focus();var t=this._root,n=_t(e,t);if(!n)return this.focus();var o=n[0],i=n[1],r=n[2];i||(i=o.firstChild),r||(r=o.lastChild),this._recordUndoState(e,this._isInUndoState);var a,s=o.parentNode,d=r.nextSibling?b(o,r.nextSibling,s,t):o.nextSibling;if(s!==t&&"LI"===s.nodeName){for(s=s.parentNode;d;)a=d.nextSibling,r.appendChild(d),d=a;d=o.parentNode.nextSibling}var l=!/^[OU]L$/.test(s.nodeName);do{a=i===r?null:i.nextSibling,o.removeChild(i),l&&"LI"===i.nodeName&&(i=this.createDefaultBlock([S(i)])),s.insertBefore(i,d)}while(i=a);return o.firstChild||C(o),d&&L(d,t),this._getRangeAndRemoveBookmark(e),this.setSelection(e),this._updatePath(e,!0),re||this._docWasChanged(),this.focus()},ot._ensureBottomLine=function(){var e=this._root,t=e.lastElementChild;t&&t.nodeName===this._config.blockTag&&s(t)||e.appendChild(this.createDefaultBlock())},ot.setKeyHandler=function(e,t){return this._keyHandlers[e]=t,this},ot._getHTML=function(){return this._root.innerHTML},ot._setHTML=function(e){var t=this._root,n=t;n.innerHTML=e;do{T(n,t)}while(n=h(n,t));this._ignoreChange=!0},ot.getHTML=function(e){var t,n,o,i,r,a,s=[];if(e&&(a=this.getSelection())&&this._saveRangeToBookmark(a),ne)for(t=this._root,n=t;n=h(n,t);)n.textContent||n.querySelector("BR")||(o=this.createElement("BR"),n.appendChild(o),s.push(o));if(i=this._getHTML().replace(/\u200B/g,""),ne)for(r=s.length;r--;)C(s[r]);return a&&this._getRangeAndRemoveBookmark(a),i},ot.setHTML=function(e){var t,n,o,i=this._config,r=i.isSetHTMLSanitized?i.sanitizeToDOMFragment:null,a=this._root;"function"==typeof r?n=r(e,!1,this):(t=this.createElement("DIV"),t.innerHTML=e,n=this._doc.createDocumentFragment(),n.appendChild(S(t))),je(n,i),Ye(n,a,!1),E(n,a);for(var s=n;s=h(s,a);)T(s,a);for(this._ignoreChange=!0;o=a.lastChild;)a.removeChild(o);a.appendChild(n),T(a,a),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var d=this._getRangeAndRemoveBookmark()||this.createRange(a.firstChild,0);return this.saveUndoState(d),this._lastSelection=d,R.call(this),this._updatePath(d,!0),this},ot.insertElement=function(e,t){if(t||(t=this.getSelection()),t.collapse(!0),a(e))Ne(t,e),t.setStartAfter(e);else{for(var n,o,i=this._root,r=ke(t,i)||i;r!==i&&!r.nextSibling;)r=r.parentNode;r!==i&&(n=r.parentNode,o=b(n,r.nextSibling,i,i)),o?i.insertBefore(e,o):(i.appendChild(e),o=this.createDefaultBlock(),i.appendChild(o)),t.setStart(o,0),t.setEnd(o,0),be(t)}return this.focus(),this.setSelection(t),this._updatePath(t),re||this._docWasChanged(),this},ot.insertImage=function(e,t){var n=this.createElement("IMG",O({src:e},t,!0));return this.insertElement(n),n};var Ct=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)(?:\?[^&?\s]+=[^&?\s]+(?:&[^&?\s]+=[^&?\s]+)*)?/i,Nt=function(e,t,o){for(var i,r,a,s,d,l,c,h=e.ownerDocument,u=new n(e,4,function(e){return!g(e,t,"A")}),f=o._config.tagAttributes.a;i=u.nextNode();)for(r=i.data,a=i.parentNode;s=Ct.exec(r);)d=s.index,l=d+s[0].length,d&&(c=h.createTextNode(r.slice(0,d)),a.insertBefore(c,i)),c=o.createElement("A",O({href:s[1]?/^(?:ht|f)tps?:/i.test(s[1])?s[1]:"http://"+s[1]:"mailto:"+s[0]},f,!1)),c.textContent=r.slice(d,l),a.insertBefore(c,i),i.data=r=r.slice(l)};ot.insertHTML=function(e,t){var n,o,i,r,a,s,d,l=this._config,c=l.isInsertedHTMLSanitized?l.sanitizeToDOMFragment:null,u=this.getSelection(),f=this._doc;"function"==typeof c?r=c(e,t,this):(t&&(n=e.indexOf("\x3c!--StartFragment--\x3e"),o=e.lastIndexOf("\x3c!--EndFragment--\x3e"),n>-1&&o>-1&&(e=e.slice(n+20,o))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(e)&&(e="<TR>"+e+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(e)&&(e="<TABLE>"+e+"</TABLE>"),i=this.createElement("DIV"),i.innerHTML=e,r=f.createDocumentFragment(),r.appendChild(S(i))),this.saveUndoState(u);try{for(a=this._root,s=r,d={fragment:r,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},Nt(r,r,this),je(r,l),Ye(r,a,!1),$e(r),r.normalize();s=h(s,r);)T(s,a);t&&this.fireEvent("willPaste",d),d.defaultPrevented||(Te(u,d.fragment,a),re||this._docWasChanged(),u.collapse(!1),this._ensureBottomLine()),this.setSelection(u),this._updatePath(u,!0),t&&this.focus()}catch(e){this.didError(e)}return this};var St=function(e){return e.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};ot.insertPlainText=function(e,t){var n=this.getSelection();if(n.collapsed&&g(n.startContainer,this._root,"PRE")){var o,i,r=n.startContainer,a=n.startOffset;return r&&r.nodeType===F||(o=this._doc.createTextNode(""),r.insertBefore(o,r.childNodes[a]),r=o,a=0),i={text:e,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},t&&this.fireEvent("willPaste",i),i.defaultPrevented||(e=i.text,r.insertData(a,e),n.setStart(r,a+e.length),n.collapse(!0)),this.setSelection(n),this}var s,d,l,c,h=e.split("\n"),u=this._config,f=u.blockTag,p=u.blockAttributes,m="</"+f+">",v="<"+f;for(s in p)v+=" "+s+'="'+St(p[s])+'"';for(v+=">",d=0,l=h.length;d<l;d+=1)c=h[d],c=St(c).replace(/ (?= )/g,"&nbsp;"),h[d]=v+(c||"<BR>")+m;return this.insertHTML(h.join(""),t)};var yt=function(e,t,n){return function(){return this[e](t,n),this.focus()}};ot.addStyles=function(e){if(e){var t=this._doc.documentElement.firstChild,n=this.createElement("STYLE",{type:"text/css"});n.appendChild(this._doc.createTextNode(e)),t.appendChild(n)}return this},ot.bold=yt("changeFormat",{tag:"B"}),ot.italic=yt("changeFormat",{tag:"I"}),ot.underline=yt("changeFormat",{tag:"U"}),ot.strikethrough=yt("changeFormat",{tag:"S"}),ot.subscript=yt("changeFormat",{tag:"SUB"},{tag:"SUP"}),ot.superscript=yt("changeFormat",{tag:"SUP"},{tag:"SUB"}),ot.removeBold=yt("changeFormat",null,{tag:"B"}),ot.removeItalic=yt("changeFormat",null,{tag:"I"}),ot.removeUnderline=yt("changeFormat",null,{tag:"U"}),ot.removeStrikethrough=yt("changeFormat",null,{tag:"S"}),ot.removeSubscript=yt("changeFormat",null,{tag:"SUB"}),ot.removeSuperscript=yt("changeFormat",null,{tag:"SUP"}),ot.makeLink=function(e,t){var n=this.getSelection();if(n.collapsed){var o=e.indexOf(":")+1;if(o)for(;"/"===e[o];)o+=1;Ne(n,this._doc.createTextNode(e.slice(o)))}return t=O(O({href:e},t,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:t},{tag:"A"},n),this.focus()},ot.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},ot.setFontFace=function(e){var t=this._config.classNames.fontFamily;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-family: "+e+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},ot.setFontSize=function(e){var t=this._config.classNames.fontSize;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"font-size: "+("number"==typeof e?e+"px":e)}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},ot.setTextColour=function(e){var t=this._config.classNames.colour;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"color:"+e}}:null,{tag:"SPAN",attributes:{class:t}}),this.focus()},ot.setHighlightColour=function(e){var t=this._config.classNames.highlight;return this.changeFormat(e?{tag:"SPAN",attributes:{class:t,style:"background-color:"+e}}:e,{tag:"SPAN",attributes:{class:t}}),this.focus()},ot.setTextAlignment=function(e){return this.forEachBlock(function(t){var n=t.className.split(/\s+/).filter(function(e){return!!e&&!/^align/.test(e)}).join(" ");e?(t.className=n+" align-"+e,t.style.textAlign=e):(t.className=n,t.style.textAlign="")},!0),this.focus()},ot.setTextDirection=function(e){return this.forEachBlock(function(t){e?t.dir=e:t.removeAttribute("dir")},!0),this.focus()};var Tt=function(e){for(var t,o=this._root,i=this._doc,r=i.createDocumentFragment(),a=l(e,o);t=a.nextNode();){var s,d,c=t.querySelectorAll("BR"),h=[],u=c.length;for(s=0;s<u;s+=1)h[s]=Ve(c[s],!1);for(;u--;)d=c[u],h[u]?N(d,i.createTextNode("\n")):C(d);for(c=t.querySelectorAll("CODE"),u=c.length;u--;)C(c[u]);r.childNodes.length&&r.appendChild(i.createTextNode("\n")),r.appendChild(S(t))}for(a=new n(r,4);t=a.nextNode();)t.data=t.data.replace(/ /g," ");return r.normalize(),T(this.createElement("PRE",this._config.tagAttributes.pre,[r]),o)},Et=function(e){for(var t,o,i,r,a,s,d=this._doc,l=this._root,c=e.querySelectorAll("PRE"),h=c.length;h--;){for(t=c[h],o=new n(t,4);i=o.nextNode();){for(r=i.data,r=r.replace(/ (?= )/g," "),a=d.createDocumentFragment();(s=r.indexOf("\n"))>-1;)a.appendChild(d.createTextNode(r.slice(0,s))),a.appendChild(d.createElement("BR")),r=r.slice(s+1);i.parentNode.insertBefore(a,i),i.data=r}E(t,l),N(t,S(t))}return e};ot.code=function(){var e=this.getSelection();return e.collapsed||d(e.commonAncestorContainer)?this.modifyBlocks(Tt,e):this.changeFormat({tag:"CODE",attributes:this._config.tagAttributes.code},null,e),this.focus()},ot.removeCode=function(){var e=this.getSelection();return g(e.commonAncestorContainer,this._root,"PRE")?this.modifyBlocks(Et,e):this.changeFormat(null,{tag:"CODE"},e),this.focus()},ot.toggleCode=function(){return this.hasFormat("PRE")||this.hasFormat("CODE")?this.removeCode():this.code(),this},ot.removeAllFormatting=function(e){if(!e&&!(e=this.getSelection())||e.collapsed)return this;for(var t=this._root,n=e.commonAncestorContainer;n&&!s(n);)n=n.parentNode;if(n||(De(e,t),n=t),n.nodeType===F)return this;this.saveUndoState(e),xe(e,n,n,t);for(var o,i,r=n.ownerDocument,a=e.startContainer,d=e.startOffset,l=e.endContainer,c=e.endOffset,h=r.createDocumentFragment(),u=r.createDocumentFragment(),f=b(l,c,n,t),p=b(a,d,n,t);p!==f;)o=p.nextSibling,h.appendChild(p),p=o;return I(this,h,u),u.normalize(),p=u.firstChild,o=u.lastChild,i=n.childNodes,p?(n.insertBefore(u,f),d=de.call(i,p),c=de.call(i,o)+1):(d=de.call(i,f),c=d),e.setStart(n,d),e.setEnd(n,c),k(n,e),be(e),this.setSelection(e),this._updatePath(e,!0),this.focus()},ot.increaseQuoteLevel=yt("modifyBlocks",ht),ot.decreaseQuoteLevel=yt("modifyBlocks",ut),ot.makeUnorderedList=yt("modifyBlocks",gt),ot.makeOrderedList=yt("modifyBlocks",mt),ot.removeList=yt("modifyBlocks",vt),D.isInline=a,D.isBlock=s,D.isContainer=d,D.getBlockWalker=l,D.getPreviousBlock=c,D.getNextBlock=h,D.areAlike=f,D.hasTagAttributes=p,D.getNearest=g,D.isOrContains=m,D.detach=C,D.replaceWith=N,D.empty=S,D.getNodeBefore=_e,D.getNodeAfter=Ce,D.insertNodeInRange=Ne,D.extractContentsOfRange=Se,D.deleteContentsOfRange=ye,D.insertTreeFragmentIntoRange=Te,D.isNodeContainedInRange=Ee,D.moveRangeBoundariesDownTree=be,D.moveRangeBoundariesUpTree=xe,D.getStartBlockOfRange=ke,D.getEndBlockOfRange=Ae,D.contentWalker=Le,D.rangeDoesStartAtBlockBoundary=Be,D.rangeDoesEndAtBlockBoundary=Oe,D.expandRangeToBlockBoundaries=De,D.onPaste=tt,D.addLinks=Nt,D.splitBlock=ct,D.startSelectionId="squire-selection-start",D.endSelectionId=dt,"object"==typeof exports?module.exports=D:"function"==typeof define&&define.amd?define(function(){return D}):(q.Squire=D,top!==q&&"true"===e.documentElement.getAttribute("data-squireinit")&&(q.editor=new D(e),q.onEditorLoad&&(q.onEditorLoad(q.editor),q.onEditorLoad=null)))}(document);
>>>>>>> b14ae45... Escape <a> on space even if in nested tags
